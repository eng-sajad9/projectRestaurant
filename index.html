<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ù‡ÙŠ Ù‡ÙŠ </title>
  <meta name="description" content="Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØºÙŠØ§Ø¨Ù‡Ù… Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©. Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø¹Ø±Ø¨ÙŠ Ù…Ø¬Ø§Ù†ÙŠ ÙˆØ³Ù‡Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….">
  <meta name="keywords" content="Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ±, Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù, Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø­Ø¶ÙˆØ±, Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù, Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†, Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ù‡ÙŠ Ù‡ÙŠ, Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±, attendance system, employee attendance, Ø­Ø¶ÙˆØ± Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ, Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¯ÙˆØ§Ù…, Ù†Ø¸Ø§Ù… Ø¯ÙˆØ§Ù…, Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ù…Ø¬Ø§Ù†ÙŠ, Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø¹Ø±Ø¨ÙŠ">
  <meta name="robots" content="index, follow">
  <script src="crypto-utils.js"></script>
  <style>
    #adminPanel {
      box-shadow: 0 2px 12px rgba(151, 86, 86, 0.067);
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      background-color: #f4f4f4;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 700px;
      margin: auto;
      padding: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    h2 { text-align: center; color: #333; }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background-color: #0056b3; }
    button:active { background-color: #1976d2; }
    #mainContent, #adminPanel { display: none; }
    #attendanceTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #attendanceTable th {
      border: 1px solid #000000;
      padding: 10px 8px;
      text-align: center;
      background: #000000;
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.5px;
      border-bottom: 2.5px solid #000000;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      transition: background 0.2s;
      box-shadow: 0 2px 8px #e3eafc;
    }
    @media (max-width: 767px) {
      #attendanceTable th {
        font-size: 15px;
        padding: 7px 4px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
      }
    }
    #attendanceTable td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
    .editor-tag { font-size: 12px; color: #555; }
    .error { color: red; text-align: center; margin: 10px 0; }
    .loading { text-align: center; color: #666; margin: 10px 0; }
    #adminPanel { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
    #adminPanel h3 { margin-top: 0; text-align: center; }
    table#usersTable, table#employeesTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table#usersTable th, table#usersTable td,
    table#employeesTable th, table#employeesTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .small-button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 3px;
    }
    .btn-edit { background-color: #28a745; color: white; border: none; }
    .btn-delete { background-color: #dc3545; color: white; border: none; }
    .btn-toggle { background-color: #ffc107; color: black; border: none; }
    @media (max-width: 767px) {
      .container { padding: 10px; }
      input, button, select { font-size: 14px; padding: 8px; }
      #attendanceTable th, #attendanceTable td { font-size: 18px; padding: 3px; }
    }
    .tooltip-wrapper { position: relative; display: inline-block; cursor: help; }
    .tooltip-wrapper .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #361fa7;
      color: #fff;
      text-align: right;
      padding: 8px;
      border-radius: 6px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      right: 50%;
      transform: translateX(50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      line-height: 1.4;
    }
    .tooltip-wrapper.show .tooltip-text { visibility: visible; opacity: 1; }
    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }
    .checkbox-label input[type="checkbox"] {
      transform: none;
      vertical-align: middle;
      margin: 0;
    }
    #sidebarMenu {
      position: fixed;
      top: 0;
      right: 0;
      width: 0;
      height: 100vh;
      background: #fff;
      box-shadow: -2px 0 12px #0002;
      overflow-x: hidden;
  transition: width 0.13s cubic-bezier(.4,1.4,.6,1), padding-top 0.13s cubic-bezier(.4,1.4,.6,1);
      z-index: 5000;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding-top: 0;
    }
    #sidebarMenu.open {
      width: 210px;
      padding-top: 30px;
    }
    #sidebarMenu .sidebar-header {
      width: 100%;
      padding: 14px 18px 8px 18px;
      background: #007bff;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      text-align: right;
      border-bottom: 1px solid #eee;
      letter-spacing: 0.5px;
    }
    #sidebarMenu button {
      width: 88%;
      margin: 8px 6%;
      padding: 8px;
      font-size: 15px;
      border-radius: 6px;
      border: none;
      background: #f4f4f4;
      color: #333;
      cursor: pointer;
      text-align: right;
  transition: background 0.08s;
    }
    #sidebarMenu button:hover {
      background: #e0e0e0;
      transition: background 0.08s;
    }
    #sidebarToggleBtn, #sidebarCloseBtn {
      position: fixed;
      top: 14px;
      right: 14px;
      width: 34px;
      height: 34px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      z-index: 5100;
      box-shadow: 0 2px 8px #0002;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    #sidebarCloseBtn {
      background: rgba(0,0,0,0.08);
      color: #333;
      font-size: 18px;
      border: none;
      box-shadow: none;
      width: 30px;
      height: 30px;
      right: 18px;
      top: 18px;
      opacity: 0.7;
    }
    #sidebarCloseBtn:hover {
      background: #f4f4f4;
      opacity: 1;
    }
    @media (max-width: 600px) {
      #sidebarMenu.open {
        width: 75vw;
        max-width: 340px;
        min-width: 180px;
        border-top-left-radius: 18px;
        border-bottom-left-radius: 18px;
        transition: width 0.13s cubic-bezier(.4,1.4,.6,1);
      }
      #sidebarMenu {
        transition: width 0.13s cubic-bezier(.4,1.4,.6,1), padding-top 0.13s cubic-bezier(.4,1.4,.6,1);
        border-top-left-radius: 18px;
        border-bottom-left-radius: 18px;
      }
      #sidebarToggleBtn, #sidebarCloseBtn { right: 8px; top: 8px; }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… -->
  <div id="dayDetailsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:10000;align-items:center;justify-content:center;">
    <div style="background:#fff;max-width:420px;width:97vw;max-height:90vh;overflow:auto;border-radius:16px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;">
      <button id="closeDayDetailsModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
      <div id="dayDetailsTitle" style="font-size:20px;color:#1976d2;font-weight:600;text-align:center;margin-bottom:12px;"></div>
      <div id="dayDetailsTable"></div>
      <div id="dayDetailsStatus" style="margin-top:10px;font-size:14px;text-align:center;"></div>
    </div>
  </div>
  <!-- Ø¹Ù†ØµØ± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ -->
  <div id="loaderSpinner" style="display:none;justify-content:center;align-items:center;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.55);z-index:99999;">
    <div style="display:flex;flex-direction:column;align-items:center;">
      <svg width="70" height="70" viewBox="0 0 50 50" style="margin-bottom:14px;">
        <circle cx="25" cy="25" r="20" fill="none" stroke="#e3eafc" stroke-width="6"/>
        <circle cx="25" cy="25" r="20" fill="none" stroke="#1976d2" stroke-width="6" stroke-linecap="round" stroke-dasharray="60 90" stroke-dashoffset="0">
          <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.8s" repeatCount="indefinite"/>
        </circle>
      </svg>
      <div style="color:#1976d2;font-size:20px;font-weight:600;letter-spacing:0.5px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>
      <div style="color:#555;font-size:15px;margin-top:7px;">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†</div>
    </div>
  </div>

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginBox">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="off" />
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off" />
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginMessage"></div>
    <div style="text-align:center; margin-top:10px; font-size:14px; color:#555; font-style:italic; line-height:1.3;">
      Ø¨ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø³Ø¬Ø§Ø¯ Ø±Ø´ÙŠØ¯<br />
      insta: e ._ mg
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
  <div id="mainContent">
    <h2>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± </h2>
    <button id="btnDownloadPDF" style="margin-bottom:10px;" onclick="downloadPDF()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ PDF</button>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th id="dateHeaderTh" style="background: linear-gradient(90deg, #e3f0ff 0%, #cbe6ff 100%); color: #1976d2; font-weight: bold; font-size: 18px; border-bottom: 2.5px solid #90caf9; letter-spacing: 0.5px; display:none;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
<style>
  .day-details-table { width:100%; border-collapse:collapse; margin-bottom:8px; }
  .day-details-table th, .day-details-table td { border:1px solid #e0e0e0; padding:7px 4px; text-align:center; }
  .day-details-table th { background:#e3f0ff; color:#1976d2; font-size:16px; }
  .day-details-select { width:100%; padding:6px; border-radius:6px; border:1px solid #ccc; font-size:15px; }
  .day-details-user { font-size:13px; color:#888; }
  .day-details-time { font-size:12px; color:#aaa; }
  @media (max-width:600px) { .day-details-table th, .day-details-table td { font-size:13px; padding:5px 2px; } }
</style>
    <button onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <button onclick="logout()" style="background-color: #dc3545; margin-top: 10px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  <h3 style="margin-top:20px;">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
  <div id="statsBox">â€”</div>
  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
  <div id="empStatsBelowTable" style="margin:30px 0 0 0;"></div>
  </div>

  <!-- Ù…ÙƒØ§Ù† Ø¸Ù‡ÙˆØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø£Ø³ÙÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
  <div id="empStatsBelowTable" style="margin:30px 0 0 0;"></div>
  <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù€ Admin -->
  <div id="adminPanel" style="display:none">
    <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
    <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
    <input type="text" id="newEmployeeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯" />
    <button onclick="addEmployee()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
    <table id="employeesTable">
      <thead>
        <tr><th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø­Ø°Ù</th></tr>
      </thead>
      <tbody id="employeesBody"></tbody>
    </table>
    <hr />
    <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
    <input type="text" id="newUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" />
    <input type="password" id="newUserPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <label class="checkbox-label">
      <input type="checkbox" id="newUserCanEdit" checked />ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    </label>
    <button onclick="addUser()">â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…</button>
    <table id="usersTable">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (ØªØ¹Ø¯ÙŠÙ„ØŸ)</th>
          <th>ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
          <th>Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
    <button id="toggleEmpStatsBtn" style="background:#17a2b8;color:white;font-size:13px;padding:7px 12px;margin-bottom:10px;cursor:pointer;">
      ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    </button>
    <div id="empStatsTab" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:2000;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:500px;width:95vw;max-height:90vh;overflow:auto;border-radius:12px;box-shadow:0 8px 32px #0002;padding:25px 20px 20px 20px;position:relative;">
        <button id="closeEmpStatsTab" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
        <h3 style="text-align:center;margin-bottom:18px;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
        <div id="empStatsTabContent"></div>
      </div>
    </div>
    <button id="btnDeleteData" style="background-color:#dc3545; color:white; font-size:12px; padding:5px 10px; margin-top:15px; cursor:pointer;">
      ğŸ—‘ï¸ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
    </button>
    <!-- Ø£Ø¶Ù Ø²Ø± Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø¹Ø¯ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <button id="btnFeaturesTab" style="background:#673ab7;color:white;font-size:13px;padding:7px 12px;margin-bottom:10px;cursor:pointer;">
      â­ï¸Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
    </button>
    <div id="featuresTab" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:3000;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:520px;width:97vw;max-height:92vh;overflow:auto;border-radius:14px;box-shadow:0 8px 32px #0002;padding:25px 18px 18px 18px;position:relative;">
        <button id="closeFeaturesTab" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#673ab7;">â­ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h3>
        <div id="featuresTabContent"></div>
      </div>
    </div>
    <style>
      @media (max-width: 600px) {
        #featuresTab > div {
          max-width: 99vw !important;
          padding: 10px 2vw 10px 2vw !important;
        }
        #featuresTab h3 { font-size: 18px !important; }
      }
      .feature-section {
        background: #f6f8fa;
        border-radius: 10px;
        margin-bottom: 18px;
        padding: 13px 12px;
        box-shadow: 0 1px 6px #0001;
      }
      .feature-section h4 {
        margin: 0 0 7px 0;
        color: #3f51b5;
        font-size: 16px;
      }
      .activity-log-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 7px;
        font-size: 14px;
      }
      .activity-log-table th, .activity-log-table td {
        border: 1px solid #ccc;
        padding: 5px 4px;
        text-align: center;
      }
      .activity-log-table th {
        background: #ede7f6;
        color: #673ab7;
      }
    </style>
  </div>
</div>

<!-- ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù„Ù„Ù€ sidebarMenu Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø± -->
<button id="sidebarToggleBtn" style="display:none;">â˜°</button>
<button id="sidebarCloseBtn" style="display:none;">âœ–</button>
<div id="sidebarMenu">
  <div class="sidebar-header" id="sidebarUserName"></div>
  <button onclick="saveData()" style="background:#0dc149;color:white;"> ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
  <button onclick="logout()" style="background:#dc3545;color:white;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  <button id="sidebarAdminBtn" style="background:#000000;color:white;display:none;">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  <button id="sidebarMonthsManagerBtn" style="background:#1976d2;color:white;display:none;margin-top:2px;">ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø±</button>
  <button id="sidebarEmpStatsBtn" style="background:#17a2b8;color:white;display:none;">ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
  <button id="sidebarNotificationsBtn" style="background:#ff4081;color:white;display:none;">ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
  <button id="sidebarDeleteDataBtn" style="background:#dc3545;color:white;display:none;">ğŸ—‘ï¸ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</button>
  <button id="sidebarFeaturesTabBtn" style="background:#673ab7;color:white;display:none;">â­ï¸Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</button>
  <button id="sidebarChangePassBtn" style="background:#2196f3;color:white;">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
  <!-- Ø£Ø¶Ù Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
  <button id="sidebarUserControlBtn" style="background:#009688;color:white;display:none;">ğŸ‘¥ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</button>
  <!-- Ø²Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
  <button id="sidebarNotesBtn" style="background:#ffb300;color:#333;display:none;">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
  <!-- Ø²Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· -->
  <button id="sidebarNotesSettingsBtn" style="background:#ff9800;color:#222;display:none;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
  <!-- Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->

</div>
<script>
// Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…
function showDayDetailsModal(dayKey, dayLabel) {
  const modal = document.getElementById("dayDetailsModal");
  const titleDiv = document.getElementById("dayDetailsTitle");
  const tableDiv = document.getElementById("dayDetailsTable");
  const statusDiv = document.getElementById("dayDetailsStatus");
  titleDiv.textContent = `ØªÙØ§ØµÙŠÙ„ ÙŠÙˆÙ…: ${dayLabel}`;
  statusDiv.textContent = "";
  const monthKey = `${year}_${(month+1).toString().padStart(2,'0')}`;
  db.ref(`dayDetails/${monthKey}/${dayKey}`).once("value").then(snap => {
    const data = snap.val() || {};
    // Ø§Ø³ØªØ®Ø¯Ù… DocumentFragment Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
    const fragment = document.createDocumentFragment();
    // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const table = document.createElement('table');
    table.className = 'day-details-table';
    const thead = document.createElement('thead');
    thead.innerHTML = `<tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</th><th>Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„</th></tr>`;
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    employees.forEach(emp => {
      const val = data[emp]?.value || "";
      const user = data[emp]?.user || "â€”";
      const time = data[emp]?.time || "â€”";
      const tr = document.createElement('tr');
      // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù
      const tdEmp = document.createElement('td');
      tdEmp.textContent = emp;
      tr.appendChild(tdEmp);
      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      const tdSelect = document.createElement('td');
      const select = document.createElement('select');
      select.className = 'day-details-select';
      select.setAttribute('data-emp', emp);
      ["â€”", "600", "22", "Ù…Ø´ØªØ±ÙƒØ©", "âŒ"].forEach(optionVal => {
        const option = document.createElement('option');
        option.value = optionVal === "â€”" ? "" : optionVal;
        option.textContent = optionVal;
        if (val === option.value) option.selected = true;
        select.appendChild(option);
      });
      tdSelect.appendChild(select);
      tr.appendChild(tdSelect);
      // Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„
      const tdEdit = document.createElement('td');
      let userColor = (user === "admin") ? "#1fa745" : (user === "â€”" ? "#555" : "#dc3545");
      function toEnglishDate(str) {
        if (!str || str === "â€”") return "â€”";
        return str.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)).replace(/ØŒ/g, ",");
      }
      tdEdit.innerHTML = `<span class='day-details-user' style='color:${userColor};font-weight:bold;'>${user}</span><br><span class='day-details-time' style='color:#000;'>${toEnglishDate(time)}</span>`;
      tr.appendChild(tdEdit);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    fragment.appendChild(table);
    // Ø²Ø± Ø§Ù„Ø­ÙØ¸
    const saveBtn = document.createElement('button');
    saveBtn.id = 'saveDayDetailsBtn';
    saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
    saveBtn.style = 'background:#1976d2;color:white;padding:8px 18px;border:none;border-radius:7px;font-size:16px;margin-top:8px;cursor:pointer;';
    fragment.appendChild(saveBtn);
    tableDiv.innerHTML = '';
    tableDiv.appendChild(fragment);
    modal.style.display = "flex";
    document.getElementById("closeDayDetailsModal").onclick = function() { modal.style.display = "none"; };
    saveBtn.onclick = function() {
      const selects = tableDiv.querySelectorAll(".day-details-select");
      const updates = {};
      let changed = false;
      employees.forEach(emp => {
        const sel = Array.from(selects).find(s => s.getAttribute("data-emp") === emp);
        const newValue = sel ? sel.value : "";
        const oldValue = data[emp]?.value || "";
        if (newValue !== oldValue) {
          updates[emp] = { value: newValue, user: currentUser, time: new Date().toLocaleString('ar-EG') };
          changed = true;
        } else if (data[emp]) {
          updates[emp] = data[emp];
        }
      });
      if (!changed) {
        statusDiv.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù„Ø­ÙØ¸Ù‡.";
        return;
      }
      db.ref(`dayDetails/${monthKey}/${dayKey}`).set(updates).then(()=>{
        statusDiv.textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
        setTimeout(()=>{ modal.style.display = "none"; }, 900);
      });
    };
  });
}
// Ø¯Ø§Ù„Ø© ØªØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù‡Ùˆ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
function isCurrentMonthSelected() {
  const now = new Date();
  return (month === now.getMonth() && year === now.getFullYear());
}

// Ø¯Ø§Ù„Ø© Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
function preventEditIfNotCurrentMonth() {
  if (!isCurrentMonthSelected()) {
    alert('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø­Ø°Ù Ø£Ùˆ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.');
    return false;
  }
  return true;
}
  // Ø²Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
document.getElementById("sidebarNotesSettingsBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  setTimeout(showNotesSettingsTab, 100);
};

  // Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
  function showNotesSettingsTab() {
    let modal = document.getElementById("notesSettingsModal");
    if (!modal) {
      modal = document.createElement("div");
      modal.id = "notesSettingsModal";
      modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:8000;display:flex;align-items:center;justify-content:center;`;
      modal.innerHTML = `
        <div style=\"background:#fff;max-width:440px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:30px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;border:2px solid #ff9800;\">
          <button id=\"closeNotesSettingsBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">âœ–</button>
          <div style=\"font-size:20px;color:#ff9800;margin-bottom:18px;font-weight:600;text-align:center;\">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          <div id=\"notesSettingsContent\" style=\"overflow-y:auto;max-height:60vh;\">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <style>
          @media (max-width: 600px) {
            #notesSettingsModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
            #notesSettingsModal div { font-size:16px !important; }
          }
          #closeNotesSettingsBtn:hover { background:#b71c1c !important; }
        </style>
      `;
      document.body.appendChild(modal);
      document.getElementById("closeNotesSettingsBtn").onclick = function() { modal.remove(); };
    } else {
      modal.style.display = "flex";
    }
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù…
    db.ref("users").once("value").then(snapshot => {
      const users = snapshot.val() || {};
      let html = `<table style='width:100%;border-collapse:collapse;margin-bottom:10px;'>
        <tr><th style='background:#f6f6f6;'>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th style='background:#f6f6f6;'>ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr>`;
      Object.entries(users).forEach(([username, data]) => {
        if (username === "admin") return;
        const perm = data.notesPermission || "edit";
        html += `<tr>
          <td style='padding:7px 4px;'>${username}</td>
          <td style='padding:7px 4px;'>
            <select data-user='${username}' class='notePermSelect' style='font-size:15px;'>
              <option value='edit' ${perm==="edit"?"selected":""}>ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</option>
              <option value='read' ${perm==="read"?"selected":""}>Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</option>
              <option value='none' ${perm==="none"?"selected":""}>Ù…Ø®ÙÙŠ ØªÙ…Ø§Ù…Ù‹Ø§</option>
            </select>
          </td>
        </tr>`;
      });
      html += `</table><div style='font-size:13px;color:#555;'>Ø­Ø¯Ø¯ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±ÙŠ.</div>`;
      document.getElementById("notesSettingsContent").innerHTML = html;
      Array.from(document.getElementsByClassName("notePermSelect")).forEach(sel => {
        sel.onchange = function() {
          const user = sel.getAttribute("data-user");
          const val = sel.value;
          db.ref("users/"+user+"/notesPermission").set(val).then(()=>{
            logActivity("ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª","ØªÙ… ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: "+user+" Ø¥Ù„Ù‰: "+(val==="edit"?"ØªØ¹Ø¯ÙŠÙ„":val==="read"?"Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·":"Ù…Ø®ÙÙŠ"));
            updateSidebarVisibility();
          });
        };
      });
    });
  }
  // Ø²Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
  document.getElementById("sidebarNotesBtn").onclick = function() {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(showNotesTab, 100);
  };

  // ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
  function showNotesTab() {
    let notesTab = document.getElementById("notesTab");
    if (!notesTab) {
      notesTab = document.createElement("div");
      notesTab.id = "notesTab";
      notesTab.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:7000;display:flex;align-items:center;justify-content:center;`;
      notesTab.innerHTML = `
        <div style=\"background:#fff;max-width:430px;width:97vw;border-radius:16px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;\">
          <button id=\"closeNotesTabBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">âœ–</button>
          <div style=\"font-size:20px;color:#333;margin-bottom:18px;font-weight:600;text-align:center;\">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
          <div id=\"notesTabContent\" style=\"overflow-y:auto;max-height:60vh;\"></div>
        </div>
        <style>
          @media (max-width: 600px) {
            #notesTab > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
            #notesTab div { font-size:16px !important; }
          }
          #closeNotesTabBtn:hover { background:#b71c1c !important; }
        </style>
      `;
      document.body.appendChild(notesTab);
      document.getElementById("closeNotesTabBtn").onclick = function() { notesTab.remove(); };
    } else {
      notesTab.style.display = "flex";
    }
    renderNotesTabContent();
  }

  // Ø¹Ø±Ø¶ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
  function renderNotesTabContent() {
    // Ø¥Ø°Ø§ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©ØŒ Ø£Ø¸Ù‡Ø±Ù‡Ø§ Ù‡Ù†Ø§ÙƒØŒ ÙˆØ¥Ù„Ø§ Ø£Ø¸Ù‡Ø±Ù‡Ø§ Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    let notesDiv = document.getElementById("notesTabContent");
    let notesSection = document.getElementById("notesSection");
    if (notesSection && notesSection.style.display !== "none") {
      notesDiv = notesSection.querySelector("#notesTabContent");
    }
    notesDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ Ø§Ù„Ø­Ø¶ÙˆØ±ØŒ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
    Promise.all([
      db.ref("notes").once("value"),
      db.ref("attendance").once("value"),
      db.ref("salaries").once("value"),
      db.ref("users/"+currentUser).once("value")
    ]).then(([notesSnap, attSnap, salSnap, userSnap]) => {
      const notes = notesSnap.val() || {};
      const attendance = attSnap.val() || {};
      const salaries = salSnap.val() || {};
      const userData = userSnap.val() || {};
      const perm = userData.notesPermission || "edit";
      // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
      const stats = {};
      employees.forEach(emp => { stats[emp] = { shift: 0, half: 0, vac: 0 }; });
      Object.entries(attendance).forEach(([dateStr, day]) => {
        // ÙÙ‚Ø· Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        let parts = dateStr.split("-");
        if (parts.length === 3) {
          let dYear = parseInt(parts[0]);
          let dMonth = parseInt(parts[1]) - 1;
          if (dYear === year && dMonth === month) {
            employees.forEach(emp => {
              const val = day[emp];
              if (val === "Ø´ÙØª") stats[emp].shift++;
              if (val === "Ù†Øµ") stats[emp].half++;
              if (val === "âŒ") stats[emp].vac++;
            });
          }
        }
      });
      let html = "";
      employees.forEach(emp => {
        let noteVal = notes[emp] ? notes[emp] : "";
        let isEmpty = noteVal.trim() === "";
        html += `<div class="note-box" style="border:1.5px solid #e3eafc; margin:18px 0 22px 0; border-radius:13px; background:linear-gradient(135deg,#f8fafc 70%,#e3eafc 100%); box-shadow:0 2px 12px #3f51b511; transition:box-shadow 0.2s;">`;
        // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù
        html += `<div style=\"font-weight:700; color:#3f51b5; font-size:18px; padding:13px 16px 0 16px; letter-spacing:0.2px;\">ğŸ‘¤ ${emp}</div>`;
        // Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙˆØ²Ø± Ø§Ù„Ø­ÙØ¸
        if (perm === "edit") {
          html += `<textarea id='noteInput_${emp}' style='width:94%;min-height:60px;margin:13px 3%;border-radius:8px;border:1.2px solid #bfc7e3;padding:9px;font-size:15.5px;resize:vertical;background:#fff;transition:border 0.2s;'>${noteVal}</textarea>`;
          html += `<div style='display:flex;align-items:center;justify-content:space-between;margin:0 3% 13px 3%;'>`;
          html += isEmpty ? `<span style='color:#b0b0b0;font-size:13px;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>ğŸ›ˆ</span>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø¹Ø¯</span>` : `<span style='color:#607d8b;font-size:13px;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>ğŸ“</span>ØªÙ…Øª Ø¢Ø®Ø± Ù…Ø±Ø§Ø¬Ø¹Ø©</span>`;
          html += `<button class='saveNoteBtn' data-emp='${emp}' style='background:linear-gradient(90deg,#3f51b5 60%,#5c6bc0 100%);color:white;padding:7px 22px;border:none;border-radius:7px;font-size:15.5px;cursor:pointer;box-shadow:0 2px 8px #3f51b522;font-weight:600;transition:background 0.2s;'>ğŸ’¾ Ø­ÙØ¸</button>`;
          html += `</div>`;
        } else if (perm === "read") {
          html += `<textarea id='noteInput_${emp}' style='width:94%;min-height:60px;margin:13px 3%;border-radius:8px;border:1.2px solid #bfc7e3;padding:9px;font-size:15.5px;background:#f5f7fa;resize:vertical;' readonly>${noteVal}</textarea>`;
          html += isEmpty ? `<div style='color:#b0b0b0;font-size:13px;padding:0 3% 13px 3%;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>ğŸ›ˆ</span>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø¹Ø¯</div>` : `<div style='color:#607d8b;font-size:13px;padding:0 3% 13px 3%;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>ğŸ“</span>ØªÙ…Øª Ø¢Ø®Ø± Ù…Ø±Ø§Ø¬Ø¹Ø©</div>`;
        } else {
          html += `<div style='color:#888;font-size:14px;padding:13px;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>`;
        }
        html += `</div>`;
      });
      notesDiv.innerHTML = html;
      // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø£Ø¸Ù‡Ø± Ø§Ù„Ù‚Ø³Ù…
      if (notesSection) notesSection.style.display = "block";
      if (perm === "edit") {
        Array.from(document.getElementsByClassName("saveNoteBtn")).forEach(btn => {
          btn.onclick = function() {
            const emp = btn.getAttribute("data-emp");
            const noteVal = document.getElementById(`noteInput_${emp}`).value;
            db.ref("notes/" + emp).set(noteVal).then(() => {
              btn.textContent = "âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸";
              setTimeout(() => { btn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©"; }, 1200);
              logActivity(
                "ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…ÙˆØ¸Ù",
                `<span style='color:#007bff;font-weight:bold;'>${emp}</span> | <span style='color:#ffb300;'>${noteVal.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`,
                { type: "note", emp: emp }
              );
            });
          };
        });
      }
    });
  }
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ©
  document.addEventListener("DOMContentLoaded", function() {
  // Ù‡Ø¬Ø±Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
  if (typeof migrateAllPlaintextUsers === "function") {
    migrateAllPlaintextUsers();
  }
    db.ref("users/"+currentUser).once("value").then(snap=>{
      const data = snap.val()||{};
      const perm = data.notesPermission || "edit";
      if (perm === "edit" || perm === "read") {
        let notesSection = document.getElementById("notesSection");
        if (notesSection) {
          notesSection.style.display = "block";
          renderNotesTabContent();
        }
      }
    });
  });
  // ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± ÙˆØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  function updateSidebarVisibility() {
    const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
    const sidebarMenu = document.getElementById("sidebarMenu");
    const sidebarCloseBtn = document.getElementById("sidebarCloseBtn");
    const isAdmin = currentUserRole === "admin";
// Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·
    ["sidebarAdminBtn","sidebarMonthsManagerBtn","sidebarEmpStatsBtn","sidebarDeleteDataBtn","sidebarFeaturesTabBtn","sidebarChangePassBtn","sidebarUserControlBtn","sidebarNotesSettingsBtn","sidebarNotificationsBtn"].forEach(id=>{
// Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
document.getElementById("sidebarNotificationsBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  setTimeout(showNotificationsManager, 100);
};

function showNotificationsManager() {
  let modal = document.getElementById("notificationsManagerModal");
  if (modal) { modal.style.display = "flex"; return; }
  modal = document.createElement("div");
  modal.id = "notificationsManagerModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9100;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style="background:#fff;max-width:420px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;">
      <button id="closeNotificationsManagerBtn" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
      <div style="font-size:21px;color:#ff4081;margin-bottom:10px;font-weight:700;text-align:center;letter-spacing:0.2px;">ğŸ”” Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</div>
      <div style="margin-bottom:10px;">
        <label style="font-size:15px;font-weight:500;">Ø§Ù„Ù…Ø³ØªÙ„Ù…:
          <select id="notificationTarget" multiple style="width:100%;padding:7px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;margin-top:5px;min-height:38px;max-height:120px;overflow:auto;"></select>
          <div style="font-size:12px;color:#888;margin-top:3px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…ÙˆØ¸Ù Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ø¹ Ctrl Ø£Ùˆ Shift</div>
        </label>
      </div>
      <textarea id="notificationMsg" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§..." style="width:100%;min-height:60px;border-radius:7px;border:1px solid #ccc;padding:7px;font-size:15px;margin-bottom:10px;"></textarea>
      <button id="sendNotificationBtn" style="background:#ff4081;color:white;padding:9px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;font-weight:600;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
    </div>
    <style>
      @media (max-width: 600px) {
        #notificationsManagerModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #notificationsManagerModal div { font-size:16px !important; }
      }
      #closeNotificationsManagerBtn:hover { background:#b71c1c !important; }
      #sendNotificationBtn:hover { background:#c51162 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("closeNotificationsManagerBtn").onclick = function() { modal.style.display = "none"; };
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  db.ref("users").once("value").then(snap=>{
    const users = snap.val()||{};
    let sel = document.getElementById("notificationTarget");
    sel.innerHTML = `<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>`;
    Object.keys(users).forEach(u=>{
      if(u!=="admin") sel.innerHTML += `<option value="${u}">${u}</option>`;
    });
  });
  document.getElementById("sendNotificationBtn").onclick = function() {
    const sel = document.getElementById("notificationTarget");
    const selected = Array.from(sel.selectedOptions).map(opt=>opt.value);
    const msg = document.getElementById("notificationMsg").value.trim();
    if(!msg) return alert("âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");
    const notif = {msg,time:Date.now(),from:currentUser};
    if(selected.includes("all")) {
      db.ref("notifications/all").set(notif).then(()=>{
        alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹");
        modal.style.display = "none";
      });
    } else if(selected.length>0) {
      let promises = selected.map(u=>db.ref("notifications/"+u).set(notif));
      Promise.all(promises).then(()=>{
        alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†");
        modal.style.display = "none";
      });
    } else {
      alert("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
    }
  };
}
// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
window.listenForNotifications = function listenForNotifications() {
  if(!currentUser) return;
  // ØªØ¬Ø§Ù‡Ù„ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
  if(currentUser === 'admin') return;
  // Ø¥Ø´Ø¹Ø§Ø± Ù…Ø®ØµØµ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  db.ref("notifications/"+currentUser).on("value", snap => {
    const notif = snap.val();
    if(notif) showNotificationPopup(notif,()=>{
      db.ref("notifications/"+currentUser).remove();
    });
  });
  // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù… Ù„Ù„Ø¬Ù…ÙŠØ¹
  db.ref("notifications/all").on("value", snap => {
    const notif = snap.val();
    if(notif) showNotificationPopup(notif,()=>{
      db.ref("notifications/all").remove();
    });
  });
}

// Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±
function showNotificationPopup(notif, onOk) {
  let old = document.getElementById("notificationPopup");
  if(old) old.remove();
  const modal = document.createElement("div");
  modal.id = "notificationPopup";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:12000;display:flex;align-items:center;justify-content:center;`;
  let sender = notif.from === 'admin' ? 'Ø§Ù„Ù…Ø¯ÙŠØ±' : (notif.from||'');
  modal.innerHTML = `
    <div style="background:linear-gradient(135deg,#e8eaf6 60%,#c5cae9 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #3f51b522;position:relative;text-align:center;animation:fadeIn 0.3s;">
      <button id="closeNotifPopupBtn" style="position:absolute;top:10px;left:10px;background:#3f51b5;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
      <div style="font-size:21px;color:#3f51b5;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;">ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ù…Ù† ${sender}</div>
      <div style="font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#e3eafc;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #3f51b511;">${notif.msg.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
      <button id="notifOkBtn" style="background:linear-gradient(90deg,#3f51b5 60%,#5c6bc0 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #3f51b522;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;">Ø­Ø³Ù†Ù‹Ø§</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #notificationPopup > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #notificationPopup div { font-size:16px !important; }
      }
      #closeNotifPopupBtn:hover { background:#283593 !important; }
      #notifOkBtn:hover { background:#283593 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("notifOkBtn").onclick = () => { modal.remove(); if(onOk) onOk(); };
  document.getElementById("closeNotifPopupBtn").onclick = () => { modal.remove(); if(onOk) onOk(); };
}
      const el = document.getElementById(id);
      if (el) el.style.display = isAdmin ? "block" : "none";
    });
// Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
document.getElementById("sidebarMonthsManagerBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  setTimeout(showMonthsManagerModal, 100);
};

function showMonthsManagerModal() {
  let modal = document.getElementById("monthsManagerModal");
  if (modal) { modal.style.display = "flex"; return; }
  modal = document.createElement("div");
  modal.id = "monthsManagerModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9000;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div id="monthsManagerModalInner" style="background:#fff;max-width:480px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:24px 10px 14px 10px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;">
      <button id="closeMonthsManagerBtn" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
      <div style="font-size:21px;color:#1976d2;margin-bottom:10px;font-weight:700;text-align:center;letter-spacing:0.2px;">ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø±</div>
      <div id="monthsManagerContent" style="overflow-x:auto;max-height:60vh;padding-bottom:4px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div style="margin-top:12px;text-align:center;display:flex;flex-wrap:wrap;gap:7px;justify-content:center;">
        <button id="addNewMonthBtn" style="background:#1976d2;color:white;padding:10px 16px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">â• Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø±</button>
        <button id="toggleAutoMonthBtn" style="background:#ffb300;color:#333;padding:10px 16px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">â€”</button>
      </div>
      <div style="font-size:13px;color:#888;margin-top:10px;text-align:center;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø±ØŒ Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§ØŒ Ø¥Ø®ÙØ§Ø¦Ù‡Ø§ØŒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ Ù†Ø³Ø® Ø£Ùˆ Ø­Ø°Ù Ø´Ù‡Ø±ØŒ ÙˆØ§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ù‡Ù†Ø§.</div>
    </div>
    <style>
      #monthsManagerModalInner table {
        width: 100%;
        border-collapse: collapse;
        font-size: 15px;
        margin-bottom: 8px;
        background: #fafbfc;
      }
      #monthsManagerModalInner th, #monthsManagerModalInner td {
        border: 1px solid #e0e0e0;
        padding: 7px 4px;
        text-align: center;
      }
      #monthsManagerModalInner th {
        background: #e3f0ff;
        color: #1976d2;
        font-size: 15px;
      }
      #monthsManagerModalInner td {
        font-size: 15px;
      }
      #monthsManagerModalInner button.advMonthBtn {
        padding: 4px 10px;
        font-size: 14px;
        border-radius: 6px;
        margin: 0 2px;
      }
      @media (max-width: 600px) {
        #monthsManagerModalInner {
          max-width: 99vw !important;
          padding: 10px 2vw 10px 2vw !important;
        }
        #monthsManagerModalInner table, #monthsManagerModalInner th, #monthsManagerModalInner td {
          font-size: 13px !important;
          padding: 5px 2px !important;
        }
        #monthsManagerModalInner button, #monthsManagerModalInner .advMonthBtn {
          font-size: 13px !important;
          padding: 7px 8px !important;
        }
      }
      #closeMonthsManagerBtn:hover { background:#b71c1c !important; }
      #addNewMonthBtn:hover { background:#1565c0 !important; color:#fff; }
      #toggleAutoMonthBtn:hover { background:#ff9800 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("closeMonthsManagerBtn").onclick = function() { modal.style.display = "none"; };
  loadMonthsManagerContent();
}

function loadMonthsManagerContent() {
  const contentDiv = document.getElementById("monthsManagerContent");
  contentDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  Promise.all([
    db.ref("monthsSettings").once("value"),
    db.ref("attendance").once("value"),
    db.ref("employees").once("value"),
    db.ref("monthsNotes").once("value"),
    db.ref("activityLog").once("value")
  ]).then(([settingsSnap, attSnap, empSnap, notesSnap, logSnap]) => {
    const settings = settingsSnap.val() || { auto: true, closed: {}, hidden: {} };
    const data = attSnap.val() || {};
    const allEmployees = empSnap.val() || {};
    const monthsNotes = notesSnap.val() || {};
    const activityLog = logSnap.val() || {};
    const monthsSet = new Set();
    Object.keys(data).forEach(key => {
      const parts = key.split("-");
      if (parts.length === 3) {
        const m = parseInt(parts[1]) - 1;
        const y = parseInt(parts[0]);
        monthsSet.add(`${y}-${m}`);
      }
    });
    if (settings.manual && Array.isArray(settings.manual)) {
      settings.manual.forEach(m => monthsSet.add(m));
    }
    const monthsArr = Array.from(monthsSet).sort((a,b)=>{
      const [ya,ma]=a.split('-').map(Number), [yb,mb]=b.split('-').map(Number);
      return ya!==yb?ya-yb:ma-mb;
    });
    let html = `<table style='width:100%;border-collapse:collapse;margin-bottom:10px;'>
      <tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥ØºÙ„Ø§Ù‚</th><th>Ø¥Ø®ÙØ§Ø¡</th><th>Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</th></tr>`;
    monthsArr.forEach(m => {
      const [y,mo] = m.split('-');
      const label = `${arMonths[parseInt(mo)]} ${y}`;
      const isClosed = settings.closed && settings.closed[m];
      const isHidden = settings.hidden && settings.hidden[m];
      const isDefault = settings.defaultMonth === m;
      // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
    let empKey = `employees_${y}_${(parseInt(mo)+1).toString().padStart(2,'0')}`;
    let empArr = allEmployees[empKey] ? Object.values(allEmployees[empKey]) : [];
    let empCount = empArr.length;
    let daysCount = Object.keys(data).filter(k => k.startsWith(`${y}-${parseInt(mo)+1}`)).length;
      html += `<tr>
        <td><span style="font-weight:bold;">${label}</span><br><span style="font-size:12px;color:#888;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${empCount} | Ø£ÙŠØ§Ù…: ${daysCount}</span></td>
        <td>${isClosed ? '<span style="color:#d32f2f;font-weight:bold;">Ù…ØºÙ„Ù‚</span>' : '<span style="color:#388e3c;font-weight:bold;">Ù…ÙØªÙˆØ­</span>'}${isDefault ? '<br><span style="color:#1976d2;font-size:12px;">Ø§ÙØªØ±Ø§Ø¶ÙŠ</span>':''}</td>
        <td><input type='checkbox' data-month='${m}' class='closeMonthChk' ${isClosed?'checked':''}></td>
        <td><input type='checkbox' data-month='${m}' class='hideMonthChk' ${isHidden?'checked':''}></td>
        <td>
          <button class='advMonthBtn' data-month='${m}' style='background:#eee;color:#333;font-size:13px;padding:3px 8px;border-radius:5px;border:none;cursor:pointer;'>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø©</button>
        </td>
      </tr>`;
    });
    html += `</table>`;
    contentDiv.innerHTML = html;
    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    Array.from(document.getElementsByClassName('closeMonthChk')).forEach(chk => {
      chk.onchange = function() {
        const m = chk.getAttribute('data-month');
        db.ref('monthsSettings/closed/'+m).set(chk.checked);
      };
    });
    Array.from(document.getElementsByClassName('hideMonthChk')).forEach(chk => {
      chk.onchange = function() {
        const m = chk.getAttribute('data-month');
        db.ref('monthsSettings/hidden/'+m).set(chk.checked);
      };
    });
    // Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„ÙƒÙ„ Ø´Ù‡Ø±
    Array.from(document.getElementsByClassName('advMonthBtn')).forEach(btn => {
      btn.onclick = function() {
        const m = btn.getAttribute('data-month');
        showMonthAdvancedOptions(m, monthsArr, settings, data, allEmployees, monthsNotes, activityLog);
      };
    });
  });
  // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯
  document.getElementById('addNewMonthBtn').onclick = function() {
    let now = new Date();
    let y = now.getFullYear(), m = now.getMonth();
    let nextM = m+1, nextY = y;
    if (nextM > 11) { nextM = 0; nextY++; }
    const key = `${nextY}-${nextM}`;
    db.ref('monthsSettings/manual').once('value').then(snap => {
      let arr = snap.val() || [];
      if (!arr.includes(key)) arr.push(key);
      db.ref('monthsSettings/manual').set(arr).then(loadMonthsManagerContent);
    });
  };
  // Ø²Ø± ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  db.ref('monthsSettings/auto').once('value').then(snap => {
    const auto = snap.val() !== false;
    const btn = document.getElementById('toggleAutoMonthBtn');
    btn.textContent = auto ? 'ğŸ”„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ù…ÙØ¹Ù„' : 'â¸ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ù…Ø¹Ø·Ù„';
    btn.style.background = auto ? '#ffb300' : '#bdbdbd';
    btn.onclick = function() {
      db.ref('monthsSettings/auto').set(!auto).then(loadMonthsManagerContent);
    };
  });
}

// Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„ÙƒÙ„ Ø´Ù‡Ø±
function showMonthAdvancedOptions(m, monthsArr, settings, data, allEmployees, monthsNotes, activityLog) {
  let advModal = document.getElementById("monthAdvModal");
  if (advModal) advModal.remove();
  advModal = document.createElement("div");
  advModal.id = "monthAdvModal";
  advModal.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9500;display:flex;align-items:center;justify-content:center;";
  const [y, mo] = m.split('-');
  const label = `${arMonths[parseInt(mo)]} ${y}`;
  let empKey = `employees_${y}_${(parseInt(mo)+1).toString().padStart(2,'0')}`;
  let empCount = allEmployees[empKey] ? Object.values(allEmployees[empKey]).length : 0;
  let daysCount = Object.keys(data).filter(k => k.startsWith(`${y}-${parseInt(mo)+1}`)).length;
  let note = monthsNotes[m] || "";
  let isClosed = settings.closed && settings.closed[m];
  let isHidden = settings.hidden && settings.hidden[m];
  let isDefault = settings.defaultMonth === m;
  let closeMsg = settings.closeMsg && settings.closeMsg[m] ? settings.closeMsg[m] : "";
  // Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø·
  let monthLog = Object.values(activityLog).filter(l => l.month === m || (l.details && l.details.includes(m)));
  advModal.innerHTML = `
    <div style="background:#fff;max-width:440px;width:97vw;border-radius:16px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;">
      <button id="closeMonthAdvModalBtn" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
      <div style="font-size:20px;color:#1976d2;margin-bottom:10px;font-weight:600;text-align:center;">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø´Ù‡Ø±: ${label}</div>
      <div style="font-size:13px;color:#888;margin-bottom:8px;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${empCount} | Ø£ÙŠØ§Ù…: ${daysCount}</div>
      <label style="font-size:15px;font-weight:500;">Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø±:
        <input id="renameMonthInput" type="text" value="${label}" style="width:70%;margin:0 0 8px 0;padding:5px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;">
        <button id="renameMonthBtn" style="background:#1976d2;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">ØªØºÙŠÙŠØ±</button>
      </label>
      <label style="font-size:15px;font-weight:500;">Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©:
        <textarea id="monthNoteInput" style="width:95%;min-height:40px;margin:0 0 8px 0;border-radius:6px;border:1px solid #ccc;font-size:15px;">${note}</textarea>
        <button id="saveMonthNoteBtn" style="background:#ffb300;color:#333;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">Ø­ÙØ¸</button>
      </label>
      <label style="font-size:15px;font-weight:500;">Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ù‚ÙÙ„ Ø§Ù„Ø´Ù‡Ø±:
        <input id="closeMsgInput" type="text" value="${closeMsg}" style="width:80%;margin:0 0 8px 0;padding:5px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;">
        <button id="saveCloseMsgBtn" style="background:#d32f2f;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">Ø­ÙØ¸</button>
      </label>
      <div style="margin:8px 0 0 0;display:flex;gap:7px;flex-wrap:wrap;">
        <button id="setDefaultMonthBtn" style="background:${isDefault?'#1976d2':'#eee'};color:${isDefault?'#fff':'#333'};padding:4px 10px;border:none;border-radius:6px;font-size:14px;">${isDefault?'Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹':'ØªØ¹ÙŠÙŠÙ† ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ'}</button>
        <button id="copyMonthBtn" style="background:#2196f3;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø´Ù‡Ø± Ø¢Ø®Ø±</button>
        <button id="deleteMonthBtn" style="background:#dc3545;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±</button>
        <button id="restoreMonthBtn" style="background:#388e3c;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;display:${isHidden?'inline-block':'none'};">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ù‡Ø±</button>
      </div>
      <div style="margin:12px 0 0 0;">
        <b>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±:</b>
        <div style="max-height:90px;overflow:auto;border:1px solid #eee;border-radius:7px;padding:5px 7px;background:#fafafa;font-size:13px;">
          ${monthLog.length ? monthLog.map(l=>`<div style='border-bottom:1px solid #eee;margin-bottom:3px;'>${l.time||''} - ${l.user||''}: ${l.action||''}</div>`).join('') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª.'}
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(advModal);
  document.getElementById("closeMonthAdvModalBtn").onclick = function() { advModal.remove(); };
  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ© (ÙÙ‚Ø· ÙˆØ§Ø¬Ù‡Ø©ØŒ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…)
  document.getElementById("renameMonthBtn").onclick = function() {
    const newName = document.getElementById("renameMonthInput").value.trim();
    if (!newName) return alert("âŒ Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹");
    db.ref('monthsSettings/renames/'+m).set(newName).then(()=>{
      alert('âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙ‚Ø·');
      advModal.remove();
      loadMonthsManagerContent();
    });
  };
  // Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©
  document.getElementById("saveMonthNoteBtn").onclick = function() {
    const noteVal = document.getElementById("monthNoteInput").value;
    db.ref('monthsNotes/'+m).set(noteVal).then(()=>{
      alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
    });
  };
  // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„
  document.getElementById("saveCloseMsgBtn").onclick = function() {
    const msg = document.getElementById("closeMsgInput").value;
    db.ref('monthsSettings/closeMsg/'+m).set(msg).then(()=>{
      alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
    });
  };
  // ØªØ¹ÙŠÙŠÙ† ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
  document.getElementById("setDefaultMonthBtn").onclick = function() {
    db.ref('monthsSettings/defaultMonth').set(m).then(()=>{
      alert('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ù‡Ø± ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ');
      advModal.remove();
      loadMonthsManagerContent();
    });
  };
  // Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ù‡Ø±
  document.getElementById("copyMonthBtn").onclick = function() {
    let target = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‡Ø¯Ù (Ù…Ø«Ø§Ù„: 2025-8)');
    if (!target || !/^\d{4}-\d{1,2}$/.test(target)) return alert('âŒ ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    // Ù†Ø³Ø® Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    let srcEmpKey = empKey;
    let tgtEmpKey = `employees_${target.split('-')[0]}_${(parseInt(target.split('-')[1])+1).toString().padStart(2,'0')}`;
    db.ref(srcEmpKey).once('value').then(snap=>{
      db.ref(tgtEmpKey).set(snap.val()||[]);
    });
    // Ù†Ø³Ø® Ø§Ù„Ø­Ø¶ÙˆØ±
    Object.keys(data).filter(k=>k.startsWith(`${y}-${parseInt(mo)+1}`)).forEach(dayKey=>{
      let tgtDayKey = target+'-'+dayKey.split('-')[2];
      db.ref('attendance/'+tgtDayKey).set(data[dayKey]);
    });
    alert('âœ… ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±');
  };
  // Ø­Ø°Ù Ø´Ù‡Ø±
  document.getElementById("deleteMonthBtn").onclick = function() {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.')) return;
    // Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    db.ref(empKey).remove();
    // Ø­Ø°Ù Ø§Ù„Ø­Ø¶ÙˆØ±
    Object.keys(data).filter(k=>k.startsWith(`${y}-${parseInt(mo)+1}`)).forEach(dayKey=>{
      db.ref('attendance/'+dayKey).remove();
    });
    // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
    db.ref('monthsNotes/'+m).remove();
    // Ø­Ø°Ù Ù…Ù† monthsSettings.manual Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¯ÙˆÙŠ
    db.ref('monthsSettings/manual').once('value').then(snap=>{
      let arr = snap.val()||[];
      arr = arr.filter(x=>x!==m);
      db.ref('monthsSettings/manual').set(arr);
    });
    alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±');
    advModal.remove();
    loadMonthsManagerContent();
  };
  // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø´Ù‡Ø± Ù…Ø®ÙÙŠ
  document.getElementById("restoreMonthBtn").onclick = function() {
    db.ref('monthsSettings/hidden/'+m).set(false).then(()=>{
      alert('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ù‡Ø±');
      advModal.remove();
      loadMonthsManagerContent();
    });
  };
}

    // Ø²Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ© (edit Ø£Ùˆ read)
    db.ref("users/"+currentUser).once("value").then(snap=>{
      const data = snap.val()||{};
      const perm = data.notesPermission || "edit";
      const notesBtn = document.getElementById("sidebarNotesBtn");
      if (notesBtn) {
        if (perm === "edit" || perm === "read") {
          notesBtn.style.display = "block";
        } else {
          notesBtn.style.display = "none";
        }
      }
    });

    // Ø²Ø± Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ©
    db.ref("users/" + currentUser).once("value").then(snapshot => {
      const data = snapshot.val() || {};
      let logBtn = document.getElementById("sidebarUserLogBtn");
      if (data.canViewLog) {
        if (!logBtn) {
          logBtn = document.createElement("button");
          logBtn.id = "sidebarUserLogBtn";
          logBtn.style = "background:#673ab7;color:white;";
          logBtn.textContent = "ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª";
          logBtn.onclick = function() {
            document.getElementById("sidebarMenu").classList.remove("open");
            // Ù†Ø§ÙØ°Ø© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            let modal = document.getElementById("userLogModal");
            if (!modal) {
              modal = document.createElement("div");
              modal.id = "userLogModal";
              modal.style.position = "fixed";
              modal.style.top = "0";
              modal.style.left = "0";
              modal.style.width = "100vw";
              modal.style.height = "100vh";
              modal.style.background = "rgba(0,0,0,0.35)";
              modal.style.zIndex = "7000";
              modal.style.display = "flex";
              modal.style.alignItems = "center";
              modal.style.justifyContent = "center";
              modal.innerHTML = `
                <div style="background:#fff;max-width:400px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;">
                  <button id="closeUserLogModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">âœ–</button>
                  <h3 style="text-align:center;margin-bottom:18px;color:#673ab7;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
                  <div id="userLogContent">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
              `;
              document.body.appendChild(modal);
              document.getElementById("closeUserLogModal").onclick = function() {
                modal.style.display = "none";
              };
            } else {
              modal.style.display = "flex";
            }
            // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·
            db.ref("activityLog").orderByChild("user").equalTo(currentUser).limitToLast(30).once("value").then(snapshot => {
              const log = snapshot.val() || {};
              let html = `<table class="activity-log-table">
                <tr>
                  <th>Ø§Ù„ÙˆÙ‚Øª</th>
                  <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                </tr>`;
              Object.values(log).reverse().forEach(item => {
                html += `<tr>
                  <td>${toEnglishNumbers(item.time || "")}</td>
                  <td>${item.action || ""}</td>
                  <td>${item.details || ""}</td>
                </tr>`;
              });
              html += `</table>`;
              document.getElementById("userLogContent").innerHTML = html;
            });
          };
          sidebarMenu.appendChild(logBtn);
        } else {
          logBtn.style.display = "block";
        }
      } else {
        if (logBtn) logBtn.style.display = "none";
      }
    });

    if (localStorage.getItem('loggedUser')) {
      sidebarToggleBtn.style.display = sidebarMenu.classList.contains("open") ? "none" : "flex";
      sidebarCloseBtn.style.display = sidebarMenu.classList.contains("open") ? "flex" : "none";
    } else {
      sidebarToggleBtn.style.display = "none";
      sidebarCloseBtn.style.display = "none";
      sidebarMenu.classList.remove("open");
    }
  }
  // Ø²Ø± ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
  document.getElementById("sidebarToggleBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.add("open");
    document.getElementById("sidebarToggleBtn").style.display = "none";
    document.getElementById("sidebarCloseBtn").style.display = "flex";
    // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const sidebarUserName = document.getElementById("sidebarUserName");
    sidebarUserName.textContent = currentUser ? "ğŸ‘¤ " + currentUser : "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
    updateSidebarVisibility();
  };
  // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
  document.getElementById("sidebarCloseBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    document.getElementById("sidebarCloseBtn").style.display = "none";
    document.getElementById("sidebarToggleBtn").style.display = "flex";
    updateSidebarVisibility();
  };
  // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¨Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©
  document.getElementById("sidebarAdminBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>document.getElementById("toggleAdminBtn").click(),100);
  };
  document.getElementById("sidebarEmpStatsBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>document.getElementById("toggleEmpStatsBtn").click(),100);
  };
  document.getElementById("sidebarDeleteDataBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>document.getElementById("btnDeleteData").click(),100);
  };
  document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>{
      document.getElementById("btnFeaturesTab").click();
      document.getElementById("featuresTab").style.display = "flex";
      const featuresTabContent = document.getElementById("featuresTabContent");
      featuresTabContent.innerHTML = `
        <div class="feature-section">
          <h4>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h4>
          <div id="activityLogBox">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <div class="feature-section">
          <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
          <ul style="margin:0;padding:0 0 0 15px;">
            <li>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${employees.length}</b></li>
            <li>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${currentUser}</b></li>
            <li>Ø§Ù„Ø¯ÙˆØ±: <b>${currentUserRole}</b></li>
          </ul>
        </div>
      `;
      db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
        const log = snapshot.val() || {};
        let html = `<table class="activity-log-table">
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
            <th>Ø§Ù„ÙˆØµÙ</th>
          </tr>`;
        Object.values(log).reverse().forEach(item => {
          html += `<tr>
            <td>${toEnglishNumbers(item.time || "")}</td>
            <td>${item.user || ""}</td>
            <td>${item.action || ""}</td>
            <td>${item.details || ""}</td>
          </tr>`;
        });
        html += `</table>`;
        document.getElementById("activityLogBox").innerHTML = html;
      });
      // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
      const closeBtn = document.getElementById("closeFeaturesTab");
      if (closeBtn) {
        closeBtn.onclick = () => {
          document.getElementById("featuresTab").style.display = "none";
        };
      }
    },100);
  };
  // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
  document.addEventListener("DOMContentLoaded", () => {
    ["btnDownloadPDF", "toggleAdminBtn", "toggleEmpStatsBtn", "btnDeleteData", "btnFeaturesTab"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    });
    updateSidebarVisibility();
  });
  window.addEventListener("storage", updateSidebarVisibility);
  window.addEventListener("focus", updateSidebarVisibility);
  setInterval(updateSidebarVisibility, 1000);
</script>
<!-- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->

<!-- Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª - ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<script>
// Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
function logActivity(action, details, extra = {}) {
  const now = new Date();
  const time = toEnglishNumbers(now.toLocaleDateString('ar-EG')) + ' ' + toEnglishNumbers(now.toLocaleTimeString('ar-EG'));
  let style = "";
  if (extra && extra.type === "note") {
    style = "background:#fffde7;border-left:5px solid #ffb300;";
  }
  db.ref("activityLog").push({
    time,
    action,
    details,
    user: currentUser,
    ...extra,
    style
  });
}

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
function toEnglishNumbers(str) {
  return str.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
}

// Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ± ÙØ¹Ù„ÙŠ
async function saveData() {
  if (!currentUserCanEdit) {
    alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");
    return;
  }
  const days = getDays();
  // Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø· Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
  let monthEmployees = employees.slice();
  try {
    const attendanceSnapshot = await db.ref("attendance").once("value");
    const savedData = attendanceSnapshot.val() || {};
    const updatedData = {...savedData};
    let changes = [];
    let anyChange = false;
    days.forEach((day, dayIndex) => {
      if (!updatedData[day.key]) updatedData[day.key] = {};
      let dayChanged = false;
      monthEmployees.forEach((employee, empIndex) => {
        const selectElement = document.getElementById(`d${dayIndex}e${empIndex}`);
        if (selectElement) {
          const newValue = selectElement.value;
          const oldValue = savedData[day.key] ? savedData[day.key][employee] : "";
          if (newValue !== oldValue) {
            updatedData[day.key][employee] = newValue;
            dayChanged = true;
            anyChange = true;
            changes.push({
              user: currentUser,
              day: day.key,
              employee,
              old: oldValue,
              new: newValue,
              time: new Date().toLocaleString('ar-EG')
            });
          }
        }
      });
      if (dayChanged) {
        updatedData[day.key].__editor = currentUser;
        const now = new Date();
        const ts = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
        updatedData[day.key].__editedAt = ts;
      }
    });
    if (!anyChange) {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù„Ø­ÙØ¸Ù‡.");
      return;
    }
    await db.ref("attendance").set(updatedData);
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
    generateTable();
    changes.forEach(change => {
      logActivity(
        "ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±",
        `
          <span style="color:#007bff;font-weight:bold;">${change.user}</span>
          Ù‚Ø§Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸Ù
          <span style="color:#673ab7;font-weight:bold;">${change.employee}</span>
          ÙÙŠ Ø§Ù„ÙŠÙˆÙ…
          <span style="color:#009688;font-weight:bold;">${change.day}</span>
          Ù…Ù†
          <span style="background:#d4edda;padding:2px 6px;border-radius:5px;">${change.old || "Ø¨Ø¯ÙˆÙ†"}</span>
          Ø¥Ù„Ù‰
          <span style="background:#fff9db;padding:2px 6px;border-radius:5px;">${change.new || "Ø¨Ø¯ÙˆÙ†"}</span>
        `,
        { time: change.time, user: change.user }
      );
    });
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  }
}

// Ø²Ø± Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© + Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("btnFeaturesTab").click();
  document.getElementById("featuresTab").style.display = "flex";
  const featuresTabContent = document.getElementById("featuresTabContent");
  featuresTabContent.innerHTML = `
    <div class="feature-section">
      <h4>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h4>
      <div id="activityLogBox">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    <div class="feature-section">
      <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
      <ul style="margin:0;padding:0 0 0 15px;">
        <li>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${employees.length}</b></li>
        <li>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${currentUser}</b></li>
        <li>Ø§Ù„Ø¯ÙˆØ±: <b>${currentUserRole}</b></li>
      </ul>
    </div>
  `;
  db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
      const log = snapshot.val() || {};
      let html = `<table class="activity-log-table" style="width:100%;border-collapse:collapse;">
        <tr>
          <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„ÙˆÙ‚Øª</th>
          <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„Ù†Ø´Ø§Ø·</th>
          <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„ÙˆØµÙ</th>
        </tr>`;
      Object.values(log).reverse().forEach(item => {
        html += `<tr style='${item.style || ""}'>
          <td>${toEnglishNumbers(item.time || "")}</td>
          <td>${item.user || ""}</td>
          <td>${item.action || ""}</td>
          <td>${item.details || ""}</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById("activityLogBox").innerHTML = html;
  });
  // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
  const closeBtn = document.getElementById("closeFeaturesTab");
  if (closeBtn) {
    closeBtn.onclick = () => {
      document.getElementById("featuresTab").style.display = "none";
    };
  }
};


// Ù†Ø§ÙØ°Ø© ØªØ­ÙƒÙ… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
document.getElementById("sidebarUserControlBtn").onclick = function() {
  // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©
  let modal = document.getElementById("userLogControlModal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "userLogControlModal";
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100vw";
    modal.style.height = "100vh";
    modal.style.background = "rgba(0,0,0,0.35)";
    modal.style.zIndex = "8000";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.innerHTML = `
      <div style="background:#fff;max-width:420px;width:95vw;border-radius:14px;box-shadow:0 8px 32px #0002;padding:28px 20px 20px 20px;position:relative;">
        <button id="closeUserLogControlModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#009688;">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
        <div id="userLogControlContent" style="min-height:70px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById("closeUserLogControlModal").onclick = function() {
      modal.style.display = "none";
    };
  } else {
    modal.style.display = "flex";
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù…
  db.ref("users").once("value").then(snapshot => {
    const users = snapshot.val() || {};
    let html = `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <th style="background:#f6f6f6;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th style="background:#f6f6f6;">Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</th>
      </tr>`;
    Object.entries(users).forEach(([username, data]) => {
      if (username === "admin") return; // Ù„Ø§ ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ± Ù†ÙØ³Ù‡
      html += `<tr>
        <td style="padding:7px 4px;">${username}</td>
        <td style="padding:7px 4px;">
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" ${data.canViewLog ? "checked" : ""} onchange="window.setUserLogAccess('${username}', this.checked)">
            <span style="font-size:13px;color:${data.canViewLog ? '#28a745':'#dc3545'};">${data.canViewLog ? 'Ù…ÙØ¹Ù„':'Ù…Ø¹Ø·Ù„'}</span>
          </label>
        </td>
      </tr>`;
    });
    html += `</table>
      <div style="margin-top:10px;font-size:13px;color:#555;">
        Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙŠØ¸Ù‡Ø± Ø²Ø± Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.<br>
        Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø·ÙŠÙ„ ÙŠØ®ØªÙÙŠ Ø§Ù„Ø²Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
      </div>`;
    document.getElementById("userLogControlContent").innerHTML = html;
    window.setUserLogAccess = function(username, enabled) {
      db.ref("users/" + username + "/canViewLog").set(enabled).then(() => {
        logActivity("ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª", `ØªÙ… ${enabled ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„'} Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username}`);
        updateSidebarVisibility();
      });
    };
  });
}
</script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ==========
const firebaseConfig = {
  apiKey: "AIzaSyDh8KquT-8Slr6B5SAGoyGj2zOEusyiEg4",
  authDomain: "sjad-b3946.firebaseapp.com",
  databaseURL: "https://sjad-b3946-default-rtdb.firebaseio.com",
  projectId: "sjad-b3946",
  storageBucket: "sjad-b3946.appspot.com",
  messagingSenderId: "1001672753514",
  appId: "1:1001672753514:web:eac813b6e25621f5d16513",
  measurementId: "G-EV0NVW2036"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function clearDatabase() {
  // Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±
  let passModal = document.getElementById("adminPassModal");
  if (passModal) passModal.remove();
  passModal = document.createElement("div");
  passModal.id = "adminPassModal";
  passModal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  passModal.innerHTML = `
    <div style=\"background:#fff;max-width:350px;width:90vw;padding:22px 18px 18px 18px;border-radius:14px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;\">
      <button id=\"closeAdminPassModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">âœ–</button>
      <div style=\"font-size:17px;color:#333;margin-bottom:18px;\">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯:</div>
      <input id=\"adminPassInput\" type=\"password\" style=\"width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;\" />
      <button id=\"adminPassConfirmBtn\" style=\"background:#007bff;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;\">ØªØ£ÙƒÙŠØ¯</button>
    </div>
  `;
  document.body.appendChild(passModal);
  document.getElementById("adminPassConfirmBtn").onclick = function() {
    const adminPass = document.getElementById("adminPassInput").value;
    passModal.remove();
    db.ref("users/admin/password").once("value").then(async snapshot => {
      const realAdminPass = snapshot.val();
      const ok = await verifyPassword(realAdminPass, adminPass);
      if (!ok) {
        alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
        return;
      }
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) {
        db.ref('/').remove()
          .then(async () => {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø­ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø´ÙØ±Ø©
            const hashObj = await hashPassword('admin');
            await db.ref('users/admin').set({
              password: hashObj,
              role: 'admin',
              canEdit: true
            });
            alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.');
          })
          .catch(err => alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­: ' + err.message));
      }
    });
  };
  document.getElementById("closeAdminPassModalBtn").onclick = function() { passModal.remove(); };
}


let employees = [];
// ========== Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ========== (Ù…Ø¹ Ù…Ø±Ø§Ù‚Ø¨Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
document.addEventListener("DOMContentLoaded", function() {
  // Ù…ÙŠØ²Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ ØªÙ… Ø­Ø°ÙÙ‡
  db.ref("users/admin").once("value").then(async snap => {
    if (!snap.exists()) {
      let hashObj = null;
      if (typeof hashPassword === "function") {
        hashObj = await hashPassword("admin");
      } else {
        hashObj = "admin";
      }
      await db.ref("users/admin").set({
        password: hashObj,
        role: "admin",
        canEdit: true
      });
      console.log("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: admin/admin");
    }
  });

  // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
  var loader = document.getElementById("loaderSpinner");
  if (localStorage.getItem('loggedUser')) {
    loader.style.display = "flex";
    const userObj = JSON.parse(localStorage.getItem('loggedUser'));
    currentUser = userObj.user;
    currentUserRole = userObj.role;
    currentUserCanEdit = userObj.canEdit;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    if (currentUserRole === "admin") {
      document.getElementById("adminPanel").style.display = "block";
      loadUsers();
      loadEmployeesTable();
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }
    // Ø¬Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª allowedStatsEmps Ùˆ canViewSalary ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙÙŠ window.currentUserData
    db.ref("users/"+currentUser).once("value").then(snap => {
      window.currentUserData = snap.val() || {};
      // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø¥Ø®ÙÙ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      loadEmployees().then(() => {
        generateTable();
        if (typeof tryShowUserEmpStats === "function") tryShowUserEmpStats();
      });
    });
    if (typeof checkForcedLogoutOnLogin === "function") checkForcedLogoutOnLogin(currentUser);
    if (typeof updateSidebarVisibility === "function") updateSidebarVisibility();
    if (typeof loadAvailableMonths === "function") loadAvailableMonths();
    listenForNotifications();

    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
    if (currentUser !== "admin") {
      db.ref("users/" + currentUser + "/canEdit").on("value", function(snap) {
        const newCanEdit = !!snap.val();
        if (currentUserCanEdit !== newCanEdit) {
          currentUserCanEdit = newCanEdit;
          if (!window.currentUserData) window.currentUserData = {};
          window.currentUserData.canEdit = newCanEdit;
          updateEditabilityUI(newCanEdit);
          generateTable();
          if (!currentUserCanEdit) {
            showPermissionRevokedModal();
          }
        }
      });
    }

    function updateEditabilityUI(canEdit) {
      document.querySelectorAll('select[data-attendance-select]').forEach(sel => {
        sel.disabled = !canEdit;
      });
      document.querySelectorAll('.btn-edit, .btn-save, .btn-delete, .btn-add').forEach(btn => {
        btn.disabled = !canEdit;
        if (!canEdit) btn.classList.add('disabled');
        else btn.classList.remove('disabled');
      });
    }
    ["allowedStatsEmps","canViewSalary"].forEach(key => {
      db.ref("users/"+currentUser+"/"+key).on("value", function(snap) {
        if (!window.currentUserData) window.currentUserData = {};
        window.currentUserData[key] = snap.val();
        db.ref("attendance").once("value").then(snap2 => {
          calculateStats(snap2.val() || {});
          if (typeof renderUserEmpStats === "function") renderUserEmpStats();
        });
      });
    });
  }
});
const statuses = ["", "Ø´ÙØª", "Ù†Øµ", "âŒ"];
let month = new Date().getMonth();
const year = new Date().getFullYear();
const arMonths = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø¥Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
let currentUser = "";
let currentUserRole = "";
let currentUserCanEdit = false;

// ========== Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª ==========
function logActivity(action, details, extra = {}) {
  const now = new Date();
  const time = toEnglishNumbers(now.toLocaleDateString('ar-EG')) + ' ' + toEnglishNumbers(now.toLocaleTimeString('ar-EG'));
  db.ref("activityLog").push({ time, action, details, user: currentUser, ...extra });
}

// ========== Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
function setSession(userObj) {
  currentUser = userObj.user;
  currentUserRole = userObj.role;
  currentUserCanEdit = userObj.canEdit;
  localStorage.setItem('loggedUser', JSON.stringify(userObj));
}
function clearSession() {
  currentUser = "";
  currentUserRole = "";
  currentUserCanEdit = false;
  localStorage.removeItem('loggedUser');
}

// ========== Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
function showMessage(message, isError = false) {
  const messageDiv = document.getElementById("loginMessage");
  if (!message) {
    messageDiv.innerHTML = "";
    messageDiv.className = "";
    return;
  }
  if (isError) {
    messageDiv.innerHTML = `
      <div style='animation:fadeIn 0.4s; background:linear-gradient(135deg,#fff6f6 60%,#ffe3e3 100%); border-radius:16px; box-shadow:0 6px 24px #d32f2f33; padding:22px 28px; display:flex; align-items:center; gap:18px; border:2.5px solid #d32f2f; margin:16px 0; position:relative;'>
        <span style='display:inline-block; animation:shake 0.5s;'>
          <svg width="38" height="38" viewBox="0 0 38 38" style="display:block;">
            <circle cx="19" cy="19" r="17" fill="#fff" stroke="#d32f2f" stroke-width="2.5"/>
            <line x1="12" y1="12" x2="26" y2="26" stroke="#d32f2f" stroke-width="3.5" stroke-linecap="round">
              <animate attributeName="stroke" values="#d32f2f;#ff1744;#d32f2f" dur="1.2s" repeatCount="indefinite"/>
            </line>
            <line x1="26" y1="12" x2="12" y2="26" stroke="#d32f2f" stroke-width="3.5" stroke-linecap="round">
              <animate attributeName="stroke" values="#d32f2f;#ff1744;#d32f2f" dur="1.2s" repeatCount="indefinite"/>
            </line>
          </svg>
        </span>
        <span style='color:#d32f2f; font-weight:bold; font-size:19px; letter-spacing:0.5px; text-shadow:0 2px 8px #d32f2f22;'>${message}</span>
      </div>
      <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
        @keyframes shake { 0% { transform:translateX(0);} 25% { transform:translateX(-4px);} 50% { transform:translateX(4px);} 75% { transform:translateX(-2px);} 100% { transform:translateX(0);} }
      </style>
    `;
    messageDiv.className = "error";
  } else if (message.includes("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")) {
    messageDiv.innerHTML = `
      <div style='animation:fadeIn 0.4s; background:#f6f8fa; border-radius:12px; box-shadow:0 2px 12px #1976d222; padding:13px 18px; display:flex; align-items:center; gap:10px; border:1.5px solid #1976d2; margin:8px 0;'>
        <span class='login-spinner' style='width:24px;height:24px;display:inline-block;'>
          <svg width='24' height='24' viewBox='0 0 50 50' style='animation:spin 0.8s linear infinite;'>
            <circle cx='25' cy='25' r='20' fill='none' stroke='#e3eafc' stroke-width='6'/>
            <circle cx='25' cy='25' r='20' fill='none' stroke='#1976d2' stroke-width='6' stroke-linecap='round' stroke-dasharray='60 90' stroke-dashoffset='0'/>
          </svg>
        </span>
        <span style='color:#1976d2; font-weight:bold; font-size:16px;'>${message}</span>
      </div>
      <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
        @keyframes spin { 100% { transform:rotate(360deg);} }
      </style>
    `;
    messageDiv.className = "loading";
  } else {
    messageDiv.innerHTML = `
      <div style='animation:fadeIn 0.4s; background:#e3f0ff; border-radius:12px; box-shadow:0 2px 12px #1976d222; padding:13px 18px; display:flex; align-items:center; gap:10px; border:1.5px solid #1976d2; margin:8px 0;'>
        <span style='color:#1976d2; font-weight:bold; font-size:16px;'>${message}</span>
      </div>
      <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
      </style>
    `;
    messageDiv.className = "loading";
  }
}

// ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ==========
function login() {
  const username = document.getElementById("username").value.trim().toLowerCase();
  const password = document.getElementById("password").value.trim();
  if (!username || !password) return showMessage(" ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", true);
  showMessage(" Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
  db.ref("users/" + username).once("value").then(async snapshot => {
    if (!snapshot.exists()) throw new Error("User not found");
    const userData = snapshot.val();
    const storedPass = userData.password;
    console.log("[LOGIN DEBUG] username:", username);
    console.log("[LOGIN DEBUG] entered password:", password);
    console.log("[LOGIN DEBUG] stored password object:", storedPass);
    const ok = await verifyPassword(storedPass, password);
    console.log("[LOGIN DEBUG] verifyPassword result:", ok);
    if (!ok) throw new Error("Wrong password");
    // Ø¥Ø°Ø§ legacyØŒ Ø­Ø¯Ø« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙˆØ±Ø§Ù‹ Ø¥Ù„Ù‰ ØµÙŠØºØ© hash
    if (typeof storedPass === 'string') {
      const hashObj = await hashPassword(password);
      await db.ref("users/" + username + "/password").set(hashObj);
    }
    setSession({user: username, role: userData.role || "user", canEdit: userData.canEdit !== undefined ? userData.canEdit : true});
    showMessage("");
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    loadEmployees().then(generateTable);
    if (currentUserRole === "admin") {
      document.getElementById("adminPanel").style.display = "block";
      loadUsers();
      loadEmployeesTable();
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }
    checkForcedLogoutOnLogin(username);
  }).catch(error => {
    showMessage(error.message === "User not found" ? "âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" : "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©", true);
    console.error("[LOGIN ERROR]", error);
  });
}

function logout() {
  clearSession();
  document.getElementById("loginBox").style.display = "block";
  document.getElementById("mainContent").style.display = "none";
  document.getElementById("adminPanel").style.display = "none";
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  showMessage("");
}

// ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ==========
function loadEmployees() {
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
  document.getElementById("loaderSpinner").style.display = "flex";
  // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
  const empKey = `employees_${year}_${(month+1).toString().padStart(2,'0')}`;
  return db.ref(empKey).once("value").then(snapshot => {
    employees = snapshot.exists() ? Object.values(snapshot.val()) : [];
    const theadRow = document.querySelector("#attendanceTable thead tr");
    while (theadRow.children.length > 1) theadRow.removeChild(theadRow.lastChild);
    // Make all header cells (including 'Ø§Ù„ØªØ§Ø±ÙŠØ®') unified in color and style
    // First, update the first th ("Ø§Ù„ØªØ§Ø±ÙŠØ®")
    if (theadRow.children.length > 0) {
      const firstTh = theadRow.children[0];
      firstTh.style.background = '#e3f0ff'; // calm blue
      firstTh.style.color = '#222'; // black text
      firstTh.style.fontWeight = 'bold';
      firstTh.style.fontSize = '17px';
      firstTh.style.border = '1px solid #b0bec5'; // add grid border
      firstTh.style.boxShadow = 'none';
      firstTh.style.letterSpacing = '0.5px';
      firstTh.style.borderRadius = '0';
      firstTh.style.transition = 'background 0.2s';
    }
    employees.forEach(emp => {
      const th = document.createElement("th");
      th.textContent = emp;
      th.style.background = '#e3f0ff'; // calm blue
      th.style.color = '#222'; // black text
      th.style.fontWeight = 'bold';
      th.style.fontSize = '17px';
      th.style.border = '1px solid #b0bec5'; // add grid border
      th.style.boxShadow = 'none';
      th.style.letterSpacing = '0.5px';
      th.style.borderRadius = '0';
      th.style.transition = 'background 0.2s';
      theadRow.appendChild(th);
    });
    loadEmployeesTable();
    // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(function(){ document.getElementById("loaderSpinner").style.display = "none"; }, 350);
  });
}

// ========== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ==========
// Ù†Ø³Ø® Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù…Ø¹ Ø§Ø­ØªØ±Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø±
function ensureMonthEmployees() {
  const empKey = `employees_${year}_${(month+1).toString().padStart(2, '0')}`;
  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø±
  return db.ref('monthsSettings').once('value').then(settingsSnap => {
    const settings = settingsSnap.val() || { auto: true };
    const key = `${year}-${month}`;
    // Ø¥Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù…Ø®ÙÙŠ Ø£Ùˆ Ù…ØºÙ„Ù‚ Ù„Ø§ ØªÙ†Ø´Ø¦Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    if ((settings.hidden && settings.hidden[key]) || (settings.closed && settings.closed[key])) return;
    // Ø¥Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹Ø·Ù„ØŒ Ù„Ø§ ØªÙ†Ø´Ø¦ Ø§Ù„Ø´Ù‡Ø± Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
    if (settings.auto === false && (!settings.manual || !settings.manual.includes(key))) return;
    return db.ref(empKey).once("value").then(snap => {
      if (!snap.exists()) {
        // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
        let prevMonth = month - 1;
        let prevYear = year;
        if (prevMonth < 0) { prevMonth = 11; prevYear -= 1; }
        const prevEmpKey = `employees_${prevYear}_${(prevMonth+1).toString().padStart(2, '0')}`;
        return db.ref(prevEmpKey).once("value").then(prevSnap => {
          if (prevSnap.exists()) {
            return db.ref(empKey).set(prevSnap.val());
          }
        });
      }
    });
  });
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø£Ùˆ Ø§Ù„Ø³Ù†Ø©
window.addEventListener("DOMContentLoaded", ensureMonthEmployees);
function getDays() {
  const days = [];
  let date = new Date(year, month, 1);
  while (date.getMonth() === month) {
    const dayKey = `${year}-${month + 1}-${date.getDate()}`;
    const dayLabel = `${date.getDate()} ${arMonths[month]} (${date.toLocaleDateString('ar-EG', {weekday: 'long'})})`;
    days.push({key: dayKey, label: dayLabel});
    date.setDate(date.getDate() + 1);
  }
  return days;
}

function generateTable() {
  // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
  document.getElementById("loaderSpinner").style.display = "flex";
  const days = getDays();
  // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
  document.querySelector("#mainContent h2").textContent = `ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± - ${arMonths[month]}`;
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  // Ø¥Ø®ÙØ§Ø¡ Ø±Ø£Ø³ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  var dateHeader = document.getElementById("dateHeaderTh");
  if(dateHeader) dateHeader.style.display = "none";
  db.ref("attendance").once("value").then(snapshot => {
    const savedData = snapshot.val() || {};
    // Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø· Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
    let monthEmployees = employees.slice();
    days.forEach((day, dayIndex) => {
      const row = document.createElement("tr");
      const dateCell = document.createElement("td");
      let dateContent = toEnglishNumbers(day.label);
      if (savedData[day.key] && savedData[day.key].__editor) {
        const ts = savedData[day.key].__editedAt || "";
        const editor = savedData[day.key].__editor;
        const color = (editor === "admin") ? "#1fa745" : "#dc3545";
        dateContent += `<div class='editor-tag' style="color:${color};font-weight:bold;">
          ğŸ–Šï¸ ${editor}${ts ? ' - ' + toEnglishNumbers(ts) : ''}
        </div>`;
      }
      // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…ØŒ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
      dateCell.innerHTML = `<span style='cursor:pointer;' onclick='showDayDetailsModal("${day.key}", "${day.label}")'>${dateContent}</span>`;
      row.appendChild(dateCell);
      monthEmployees.forEach((employee, empIndex) => {
        const cell = document.createElement("td");
        const select = document.createElement("select");
        select.id = `d${dayIndex}e${empIndex}`;
        statuses.forEach(status => {
          const option = document.createElement("option");
          option.value = status;
          option.textContent = status;
          select.appendChild(option);
        });
        if (savedData[day.key] && savedData[day.key][employee] !== undefined) {
          select.value = savedData[day.key][employee];
        }
        if (select.value === "Ø´ÙØª") {
          cell.style.background = "#d4edda";
        } else if (select.value === "Ù†Øµ") {
          cell.style.background = "#fff9db";
        } else if (select.value === "âŒ") {
          cell.style.background = "#ffe3e3";
          cell.style.color = "#d32f2f";
          select.style.color = "#d32f2f";
        } else {
          cell.style.color = "";
          select.style.color = "";
        }
        if (!currentUserCanEdit || !isCurrentMonthSelected()) {
          select.setAttribute('disabled','disabled');
          select.addEventListener('change', (e)=>{ e.target.value = savedData[day.key] ? savedData[day.key][employee] : ""; });
        }
        select.addEventListener('change', function() {
          if (this.value === "Ø´ÙØª") {
            cell.style.background = "#d4edda";
            cell.style.color = "";
            select.style.color = "";
          } else if (this.value === "Ù†Øµ") {
            cell.style.background = "#fff9db";
            cell.style.color = "";
            select.style.color = "";
          } else if (this.value === "âŒ") {
            cell.style.background = "#ffe3e3";
            cell.style.color = "#d32f2f";
            select.style.color = "#d32f2f";
          } else {
            cell.style.background = "";
            cell.style.color = "";
            select.style.color = "";
          }
        });
        cell.appendChild(select);
        row.appendChild(cell);
      });
      tbody.appendChild(row);
    });
    // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ©
    const saveBtn = document.querySelector('button[onclick="saveData()"]');
    if (saveBtn) saveBtn.disabled = (!currentUserCanEdit || !isCurrentMonthSelected());
    calculateStats(savedData);
    if (typeof renderUserEmpStats === "function") renderUserEmpStats();
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø£Ø³ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    if(dateHeader) dateHeader.style.display = "";
    // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    setTimeout(function(){ document.getElementById("loaderSpinner").style.display = "none"; }, 350);
  });
  // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ select Ùˆinput Ùˆtextarea ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ø°Ø§ ÙÙ‚Ø¯Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
  setTimeout(()=>{
    if (!currentUserCanEdit || !isCurrentMonthSelected()) {
      document.querySelectorAll('#mainContent select, #mainContent input, #mainContent textarea').forEach(el=>{
        el.setAttribute('disabled','disabled');
      });
      const saveBtn = document.querySelector('button[onclick="saveData()"]');
      if (saveBtn) saveBtn.disabled = true;
    } else {
      document.querySelectorAll('#mainContent select, #mainContent input, #mainContent textarea').forEach(el=>{
        el.removeAttribute('disabled');
      });
      const saveBtn = document.querySelector('button[onclick="saveData()"]');
      if (saveBtn) saveBtn.disabled = false;
    }
  }, 100);
}

// ========== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
async function saveData() {
  if (!isCurrentMonthSelected()) {
    alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚.");
    return;
  }
  if (!currentUserCanEdit) {
    alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");
    return;
  }
  const days = getDays();
  try {
    const attendanceSnapshot = await db.ref("attendance").once("value");
    const savedData = attendanceSnapshot.val() || {};
    const updatedData = {...savedData};
    let changes = [];
    let anyChange = false;
    days.forEach((day, dayIndex) => {
      if (!updatedData[day.key]) updatedData[day.key] = {};
      let dayChanged = false;
      employees.forEach((employee, empIndex) => {
        const selectElement = document.getElementById(`d${dayIndex}e${empIndex}`);
        if (selectElement) {
          const newValue = selectElement.value;
          const oldValue = savedData[day.key] ? savedData[day.key][employee] : "";
          if (newValue !== oldValue) {
            updatedData[day.key][employee] = newValue;
            dayChanged = true;
            anyChange = true;
            changes.push({
              user: currentUser,
              day: day.key,
              employee,
              old: oldValue,
              new: newValue,
              time: new Date().toLocaleString('ar-EG')
            });
          }
        }
      });
      if (dayChanged) {
        updatedData[day.key].__editor = currentUser;
        const now = new Date();
        const ts = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
        updatedData[day.key].__editedAt = ts;
      }
    });
    if (!anyChange) {
      alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù„Ø­ÙØ¸Ù‡.");
      return;
    }
    await db.ref("attendance").set(updatedData);
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
    generateTable();
    changes.forEach(change => {
      logActivity(
        "ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±",
        `
          <span style="color:#007bff;font-weight:bold;">${change.user}</span>
          Ù‚Ø§Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸Ù
          <span style="color:#673ab7;font-weight:bold;">${change.employee}</span>
          ÙÙŠ Ø§Ù„ÙŠÙˆÙ…
          <span style="color:#009688;font-weight:bold;">${change.day}</span>
          Ù…Ù†
          <span style="background:#d4edda;padding:2px 6px;border-radius:5px;">${change.old || "Ø¨Ø¯ÙˆÙ†"}</span>
          Ø¥Ù„Ù‰
          <span style="background:#fff9db;padding:2px 6px;border-radius:5px;">${change.new || "Ø¨Ø¯ÙˆÙ†"}</span>
        `,
        { time: change.time, user: change.user }
      );
    });
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  }
}

// ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ==========
// ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ========== 
// Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ø­ØªØ±Ø§ÙÙŠØ©
function showConfirmModal(message, onConfirm, onCancel) {
  let oldModal = document.getElementById("customConfirmModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "customConfirmModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:#fff;max-width:370px;width:92vw;padding:26px 18px 20px 18px;border-radius:16px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeConfirmModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;\">âœ–</button>
      <div style=\"font-size:18px;color:#333;margin-bottom:20px;font-weight:500;\">${message}</div>
      <div style=\"display:flex;gap:12px;justify-content:center;\">
        <button id=\"confirmModalYes\" style=\"background:#007bff;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #007bff22;transition:background 0.2s;\">ØªØ£ÙƒÙŠØ¯</button>
        <button id=\"confirmModalNo\" style=\"background:#6c757d;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #6c757d22;transition:background 0.2s;\">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #customConfirmModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #customConfirmModal div { font-size:16px !important; }
      }
      #closeConfirmModalBtn:hover { background:#b71c1c !important; }
      #confirmModalYes:hover { background:#0056b3 !important; }
      #confirmModalNo:hover { background:#343a40 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("confirmModalYes").onclick = () => { modal.remove(); if (onConfirm) onConfirm(); };
  document.getElementById("confirmModalNo").onclick = () => { modal.remove(); if (onCancel) onCancel(); };
  document.getElementById("closeConfirmModalBtn").onclick = () => { modal.remove(); if (onCancel) onCancel(); };
}
// ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function loadUsers() {
  const snapshot = await db.ref("users").once("value");
  const users = snapshot.val() || {};
  const tbody = document.getElementById("usersBody");
  tbody.innerHTML = "";
  Object.entries(users).forEach(([username, data]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${username}</td>
      <td>${data.canEdit ? "Ù†Ø¹Ù…" : "Ù„Ø§"}</td>
      <td>
        <button class="small-button btn-toggle" onclick="toggleUserEdit('${username}', ${data.canEdit})">
          ${data.canEdit ? "Ù‚ÙÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"}
        </button>
      </td>
      <td>
        ${username === currentUser ? "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù†ÙØ³Ùƒ" : `<button class="small-button btn-delete" onclick="deleteUser('${username}')">Ø­Ø°Ù</button>`}
      </td>
      <td>
        ${username === currentUser ? "â€”" : `<button class="small-button btn-delete" style="background:#ff9800;" onclick="forceLogoutUser('${username}')">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>`}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function forceLogoutUser(username) {
  if (username === currentUser) {
    alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ù†ÙØ³Ùƒ Ø¥Ø¬Ø¨Ø§Ø±ÙŠÙ‹Ø§.");
    return;
  }
  showConfirmModal(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username} Ø¥Ø¬Ø¨Ø§Ø±ÙŠÙ‹Ø§ØŸ`, async () => {
    try {
      await db.ref("forcedLogout/" + username).set(true);
      alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ.");
      logActivity("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ", username);
    } catch (err) {
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ");
      console.error(err);
    }
  });
}

// ØªØ¨Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function toggleUserEdit(username, currentCanEdit) {
  if (username === currentUser) {
    alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØªÙƒ Ø§Ù„Ø®Ø§ØµØ©.");
    return;
  }
  await db.ref("users/" + username + "/canEdit").set(!currentCanEdit);
  loadUsers();
}

// Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø£Ù†ÙŠÙ‚Ø© ÙˆØ¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆØ±Ø§Ù‹
async function deleteUser(username) {
  if (username === currentUser) {
    showPermissionRevokedModal("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù†ÙØ³Ùƒ.");
    return;
  }
  showDeleteUserModal(username);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¯Ø§Ø¦Ù…Ø§Ù‹
async function ensureAdminAccount() {
  const snap = await db.ref("users").once("value");
  const users = snap.val() || {};
  if (!users.admin) {
    const hashObj = await hashPassword('admin');
    await db.ref('users/admin').set({
      password: hashObj,
      role: 'admin',
      canEdit: true
    });
  }
}

function showDeleteUserModal(username) {
  let oldModal = document.getElementById("deleteUserModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "deleteUserModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#fff7f7 60%,#fce4ec 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #e5737333;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeDeleteUserModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#e57373;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;box-shadow:0 2px 8px #e5737322;\">âœ–</button>
      <div style=\"font-size:21px;color:#d32f2f;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#fff3f3;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #e5737311;\">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <b style='color:#d32f2f;'>${username}</b>ØŸ<br>Ø³ÙŠØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ù‡ ÙÙˆØ±Ø§Ù‹ ÙˆÙ„Ù† ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø£Ù†Ø´Ø£ØªÙ‡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.</div>
      <button id=\"deleteUserConfirmBtn\" style=\"background:linear-gradient(90deg,#d32f2f 60%,#e57373 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #d32f2f22;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;\">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #deleteUserModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #deleteUserModal div { font-size:16px !important; }
      }
      #closeDeleteUserModalBtn:hover { background:#b71c1c !important; }
      #deleteUserConfirmBtn:hover { background:#b71c1c !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("deleteUserConfirmBtn").onclick = async () => {
    await db.ref("users/" + username).remove();
    await ensureAdminAccount();
    await db.ref("forcedLogout/" + username).set(true);
    if (username === currentUser) {
      localStorage.setItem('accountDeleted', 'true');
      clearSession && clearSession();
      location.reload();
      return;
    }
    loadUsers();
    logActivity("Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…", username);
    modal.remove();
  };
// Ø±Ø³Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", function() {
  if (localStorage.getItem('accountDeleted')) {
    localStorage.removeItem('accountDeleted');
    showAccountDeletedModal();
  }
});

// Ù†Ø§ÙØ°Ø© Ø±Ø³Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨
function showAccountDeletedModal() {
  const modal = document.createElement("div");
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style="background:#fff3f3;padding:24px 18px;border-radius:12px;box-shadow:0 4px 20px #0002;text-align:center;">
      <div style="font-size:20px;color:#d32f2f;margin-bottom:12px;">âŒ ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ</div>
      <div style="font-size:15px;color:#444;">ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.</div>
      <button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:8px;cursor:pointer;">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  `;
  document.body.appendChild(modal);
}
// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¥Ø°Ø§ accountDeleted=true ÙÙŠ localStorageØŒ Ø£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙ‚Ø·
document.addEventListener("DOMContentLoaded", function() {
  if (localStorage.getItem('accountDeleted')) {
    localStorage.removeItem('accountDeleted');
    showAccountDeletedModal();
  }
});
  document.getElementById("closeDeleteUserModalBtn").onclick = () => { modal.remove(); };
}

// ØªØ­Ø¯ÙŠØ« showPermissionRevokedModal Ù„Ù‚Ø¨ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
const _oldShowPermissionRevokedModal = window.showPermissionRevokedModal;
window.showPermissionRevokedModal = function(msg) {
  if (!msg) return _oldShowPermissionRevokedModal();
  let oldModal = document.getElementById("permRevokedModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "permRevokedModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#f7faff 60%,#e3eafc 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #1976d233;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closePermRevokedModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#e57373;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;box-shadow:0 2px 8px #e5737322;\">âœ–</button>
      <div style=\"font-size:19px;color:#d32f2f;margin-bottom:16px;font-weight:600;\">${msg}</div>
      <button id=\"permRevokedOkBtn\" style=\"background:linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #1976d222;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;\">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #permRevokedModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #permRevokedModal div { font-size:16px !important; }
      }
      #closePermRevokedModalBtn:hover { background:#b71c1c !important; }
      #permRevokedOkBtn:hover { background:#1565c0 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("permRevokedOkBtn").onclick = () => { modal.remove(); };
  document.getElementById("closePermRevokedModalBtn").onclick = () => { modal.remove(); };
};

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
async function addUser() {
  if (!preventEditIfNotCurrentMonth()) return;
  const username = document.getElementById("newUserName").value.trim().toLowerCase();
  const password = document.getElementById("newUserPass").value.trim();
  const canEdit = document.getElementById("newUserCanEdit").checked;
  if (!username || !password) {
    alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
    return;
  }
  const snapshot = await db.ref("users/" + username).once("value");
  if (snapshot.exists()) {
    alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹");
    return;
  }
  try {
    const hashObj = await hashPassword(password);
    await db.ref("users/" + username).set({ password: hashObj, role: "user", canEdit });
    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPass").value = "";
    document.getElementById("newUserCanEdit").checked = true;
    loadUsers();
  } catch (err) {
    console.error(err);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
  }
}

// ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ==========
function addEmployee() {
  if (!preventEditIfNotCurrentMonth()) return;
  const name = document.getElementById("newEmployeeName").value.trim();
  if (!name) { alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù"); return; }
  if (employees.includes(name)) { alert("âŒ Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹"); return; }
  employees.push(name);
  const empKey = `employees_${year}_${(month+1).toString().padStart(2,'0')}`;
  db.ref(empKey).set(employees).then(() => {
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù ÙÙ‚Ø· Ø¥Ù„Ù‰ Ø£ÙŠØ§Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ ÙˆÙ„ÙŠØ³ ÙƒÙ„ attendance
    if (!isCurrentMonthSelected()) {
      alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­ (Ù„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø£ÙŠ Ø¬Ø¯ÙˆÙ„ Ø­Ø¶ÙˆØ±)");
      document.getElementById("newEmployeeName").value = "";
      loadEmployeesTable();
      generateTable();
      return;
    }
    db.ref("attendance").once("value").then(snapshot => {
      const attendance = snapshot.val() || {};
      // Ø£Ø¶Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙÙ‚Ø· Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
      Object.keys(attendance).forEach(dayKey => {
        const parts = dayKey.split("-");
        if (parts.length === 3) {
          const dYear = parseInt(parts[0]);
          const dMonth = parseInt(parts[1]) - 1;
          if (dYear === year && dMonth === month) {
            if (!attendance[dayKey][name]) attendance[dayKey][name] = "";
          }
        }
      });
      return db.ref("attendance").set(attendance);
    }).then(() => {
      alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­ (Ù„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)");
      document.getElementById("newEmployeeName").value = "";
      loadEmployeesTable();
      generateTable();
    });
  }).catch(err => {
    console.error(err);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù");
  });
}
function loadEmployeesTable() {
  const tbody = document.getElementById("employeesBody");
  tbody.innerHTML = "";
  employees.forEach((emp, idx) => {
    const tr = document.createElement("tr");
    const nameTd = document.createElement("td");
    nameTd.textContent = emp;
    nameTd.id = `employeeName_${idx}`;
    const actionsTd = document.createElement("td");
    const editBtn = document.createElement("button");
    editBtn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
    editBtn.className = "small-button btn-edit";
    editBtn.onclick = () => enableEmployeeEdit(idx);
    actionsTd.appendChild(editBtn);
    // Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    if (isCurrentMonthSelected()) {
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Ø­Ø°Ù";
      deleteBtn.className = "small-button btn-delete";
      deleteBtn.onclick = () => deleteEmployee(idx);
      actionsTd.appendChild(deleteBtn);
    }
    tr.appendChild(nameTd);
    tr.appendChild(actionsTd);
    tbody.appendChild(tr);
  });
}
function enableEmployeeEdit(index) {
  if (!preventEditIfNotCurrentMonth()) return;
  const nameTd = document.getElementById(`employeeName_${index}`);
  const oldName = nameTd.textContent;
  nameTd.innerHTML = "";
  const input = document.createElement("input");
  input.type = "text";
  input.value = oldName;
  input.style.width = "80%";
  nameTd.appendChild(input);
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸";
  saveBtn.className = "small-button btn-edit";
  saveBtn.style.marginLeft = "5px";
  saveBtn.onclick = () => {
    if (!preventEditIfNotCurrentMonth()) return;
    const newName = input.value.trim();
    if (!newName) { alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹"); return; }
    if (employees.includes(newName)) { alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹"); return; }
    // Ù†Ù‚Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    db.ref("attendance").once("value").then(snapshot => {
      const attendance = snapshot.val() || {};
      Object.keys(attendance).forEach(dayKey => {
        if (attendance[dayKey][oldName] !== undefined) {
          attendance[dayKey][newName] = attendance[dayKey][oldName];
          delete attendance[dayKey][oldName];
        }
      });
      employees[index] = newName;
      // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø­Ø¶ÙˆØ±
      return Promise.all([
        db.ref("employees").set(employees),
        db.ref("attendance").set(attendance)
      ]);
    }).then(() => {
      alert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆÙ†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±Ù‡ Ø¨Ù†Ø¬Ø§Ø­");
      loadEmployeesTable();
      generateTable();
    }).catch(err => {
      console.error(err);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù");
    });
  };
  nameTd.appendChild(saveBtn);
}

// ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ==========
function calculateStats(savedData) {
  // Ø¬Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
  db.ref("users/" + currentUser).once("value").then(userSnap => {
    const userData = userSnap.val() || {};
    const isAdmin = userData.role === "admin";
    const allowedEmps = isAdmin ? employees.slice() : (userData.allowedStatsEmps || []);
    const canViewSalary = isAdmin ? true : !!userData.canViewSalary;
    // Ø¨Ù†Ø§Ø¡ counts ÙÙ‚Ø· Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ÙŠÙ†
    const counts = {};
    allowedEmps.forEach(e=>{ counts[e]={'Ø´ÙØª':0,'Ù†Øµ':0,'âŒ':0}; });
    // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
    Object.entries(savedData).forEach(([dateStr, day]) => {
      let parts = dateStr.split("-");
      if (parts.length === 3) {
        let dYear = parseInt(parts[0]);
        let dMonth = parseInt(parts[1]) - 1;
        if (dYear === year && dMonth === month) {
          allowedEmps.forEach(e=>{
            const val = day[e];
            if (val && counts[e][val] !== undefined) counts[e][val] += 1;
          });
        }
      }
    });
    const bestShift = Object.entries(counts).sort((a,b)=>b[1]["Ø´ÙØª"]-a[1]["Ø´ÙØª"])[0];
    const bestHalf  = Object.entries(counts).sort((a,b)=>b[1]["Ù†Øµ"]-a[1]["Ù†Øµ"])[0];
    const mostX     = Object.entries(counts).sort((a,b)=>b[1]["âŒ"]-a[1]["âŒ"])[0];
    const statsDiv = document.getElementById('statsBox');
    statsDiv.innerHTML = `
      <p>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù Ø´ÙØª: <b>${bestShift ? bestShift[0]+` (${bestShift[1]["Ø´ÙØª"]})` : 'â€”'}</b></p>
      <p>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù Ù†Øµ: <b>${bestHalf ? bestHalf[0]+` (${bestHalf[1]["Ù†Øµ"]})` : 'â€”'}</b></p>
      <p>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù âŒ: <b>${mostX ? mostX[0]+` (${mostX[1]["âŒ"]})` : 'â€”'}</b></p>`;

    // Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ„ Ù…ÙˆØ¸Ù Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨ØªØµÙ…ÙŠÙ… Ø­Ø¯ÙŠØ« Ù…Ø¹ Ø§Ù„Ø±Ø§ØªØ¨
    const empStatsDiv = document.getElementById('empStatsBelowTable');
    if (empStatsDiv) {
      let html = `<div class="emp-stats-bar-official">
        <table class="emp-stats-table-official">
          <thead>
            <tr>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø´ÙØª</th>
              <th>Ù†Øµ</th>
              <th>Ø¥Ø¬Ø§Ø²Ø©</th>
              ${canViewSalary ? '<th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙƒÙ„ÙŠ</th>' : ''}
            </tr>
          </thead>
          <tbody>`;
      allowedEmps.forEach(emp => {
        const shift = counts[emp]["Ø´ÙØª"] || 0;
        const half = counts[emp]["Ù†Øµ"] || 0;
        const vac = counts[emp]["âŒ"] || 0;
        const salary = (shift * 20000) + (half * 10000);
        html += `<tr>
          <td class="emp-name-official">${emp}</td>
          <td class="emp-stat-official shift">${shift}</td>
          <td class="emp-stat-official half">${half}</td>
          <td class="emp-stat-official vac">${vac}</td>
          ${canViewSalary ? `<td class="emp-salary-official">${salary.toLocaleString()} Ø¯.Ø¹</td>` : ''}
        </tr>`;
      });
      html += `</tbody></table></div>`;
      empStatsDiv.innerHTML = html;
    }
  });
    // CSS Ø§Ø­ØªØ±Ø§ÙÙŠ ÙˆÙ…ØªØ¬Ø§ÙˆØ¨
    if (!document.getElementById('empStatsProStyle')) {
      const style = document.createElement('style');
      style.id = 'empStatsProStyle';
      style.innerHTML = `
        .emp-stats-bar-official {
          width: 100%;
          margin: 0 auto 18px auto;
          background: #f8f9fa;
          border-radius: 12px;
          box-shadow: 0 1px 8px #e3eafc33;
          padding: 0 0 8px 0;
          overflow-x: auto;
        }
        .emp-stats-table-official {
          width: 100%;
          border-collapse: collapse;
          font-size: 16px;
          background: none;
        }
        .emp-stats-table-official th, .emp-stats-table-official td {
          border: 1px solid #e0e0e0;
          padding: 8px 10px;
          text-align: center;
        }
        .emp-stats-table-official th {
          background: #e3f0ff;
          color: #1976d2;
          font-weight: bold;
          font-size: 17px;
        }
        .emp-name-official {
          color: #1976d2;
          font-weight: 600;
        }
        .emp-stat-official.shift { color: #28a745; font-weight: 500; }
        .emp-stat-official.half { color: #ff9800; font-weight: 500; }
        .emp-stat-official.vac { color: #d32f2f; font-weight: 500; }
        .emp-salary-official {
          color: #388e3c;
          font-weight: bold;
          background: #e8fbe8;
          border-radius: 6px;
        }
        @media (max-width: 900px) {
          .emp-stats-table-official th, .emp-stats-table-official td { font-size: 14px; padding: 6px 4px; }
        }
        @media (max-width: 600px) {
          .emp-stats-bar-official { border-radius: 7px; }
          .emp-stats-table-official th, .emp-stats-table-official td { font-size: 13px; padding: 5px 2px; }
        }
      `;
      document.head.appendChild(style);
    }
    // ØªØ£Ø«ÙŠØ± ripple Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø·ÙˆØ±
    if (!window.rippleEffect) {
      window.rippleEffect = function(e, el) {
        // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø©
        if (el.classList.contains('ripple-active')) return;
        el.classList.add('ripple-active');
        let rect = el.getBoundingClientRect();
        let ripple = document.createElement('span');
        ripple.className = 'ripple';
        let size = Math.max(rect.width, rect.height) * 1.1;
        ripple.style.width = ripple.style.height = size + 'px';
        let x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left - size/2;
        let y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top - size/2;
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        el.appendChild(ripple);
        setTimeout(()=>{ ripple.remove(); el.classList.remove('ripple-active'); }, 700);
      }
    }
  // ...existing code...
}

  // Ø²Ø± Ù„ØªØ±Ø­ÙŠÙ„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
// ========== Tabs Ù„Ù„Ø£Ø´Ù‡Ø± ==========

// Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ù„Ø£Ø´Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ø±ÙŠ Ø­Ø¯ÙŠØ«
const monthsFab = document.createElement("div");
monthsFab.id = "monthsFab";
monthsFab.innerHTML = `<button id="fabMainMonth" class="fab-month"></button><div id="fabMonthsList" style="display:none;"></div>`;
monthsFab.style.position = "fixed";
monthsFab.style.bottom = "22px";
monthsFab.style.left = "22px";
monthsFab.style.zIndex = "9999";
document.body.appendChild(monthsFab);

function loadAvailableMonths() {
  Promise.all([
    db.ref("attendance").once("value"),
    db.ref("monthsSettings/manual").once("value"),
    db.ref("monthsSettings/hidden").once("value"),
    db.ref("users/" + (currentUser || "")).once("value")
  ]).then(([attSnap, manualSnap, hiddenSnap, userSnap]) => {
    const data = attSnap.val() || {};
    const manual = manualSnap.val() || [];
    const hidden = hiddenSnap.val() || {};
    const user = userSnap.val() || {};
    const isAdmin = user.role === "admin";
    const monthsSet = new Set();
    Object.keys(data).forEach(key => {
      const parts = key.split("-");
      if (parts.length === 3) {
        const m = parseInt(parts[1]) - 1;
        const y = parseInt(parts[0]);
        monthsSet.add(`${y}-${m}`);
      }
    });
    manual.forEach(m => monthsSet.add(m));
    let monthsArr = Array.from(monthsSet).sort((a,b)=>{
      const [ya,ma]=a.split('-').map(Number), [yb,mb]=b.split('-').map(Number);
      return ya!==yb?ya-yb:ma-mb;
    });
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø®ÙÙŠØ© Ø¹Ù† ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙŠØ±
    if (!isAdmin) {
      monthsArr = monthsArr.filter(m => !hidden[m]);
    }
    renderMonthFab(monthsArr);
  });
}

function renderMonthFab(months) {
  const fabBtn = document.getElementById("fabMainMonth");
  const fabList = document.getElementById("fabMonthsList");
  // Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙ‚Ø·
  fabBtn.textContent = "ğŸ“…";
  fabBtn.title = `ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø±`;
  fabBtn.style.background = "#007bff";
  fabBtn.style.color = "white";
  fabBtn.style.fontWeight = "bold";
  fabBtn.style.fontSize = "20px";
  fabBtn.style.boxShadow = "0 2px 8px #007bff44";
  fabBtn.style.transition = "box-shadow 0.2s";
  fabBtn.onmouseenter = ()=>fabBtn.style.boxShadow = "0 4px 16px #007bff77";
  fabBtn.onmouseleave = ()=>fabBtn.style.boxShadow = "0 2px 8px #007bff44";
  fabBtn.onclick = function() {
    fabList.style.display = fabList.style.display === "none" ? "flex" : "none";
  };
  fabList.innerHTML = "";
  fabList.style.position = "absolute";
  fabList.style.bottom = "60px";
  fabList.style.left = "0";
  fabList.style.flexDirection = "column";
  fabList.style.gap = "8px";
  fabList.style.alignItems = "flex-start";
  fabList.style.transition = "all 0.2s";
  // ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
  fabList.style.background = "#fff";
  fabList.style.borderRadius = "12px";
  fabList.style.boxShadow = "0 4px 16px #007bff22";
  fabList.style.padding = "8px 6px";
  fabList.style.minWidth = "48px";
  fabList.style.maxHeight = "60vh";
  fabList.style.overflowY = "auto";
  months.slice().reverse().forEach(m => {
    const [y, mo] = m.split('-');
    const btn = document.createElement("button");
    btn.textContent = `${parseInt(mo)+1}-${y}`; // Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©
    btn.className = "fab-month fab-month-mini";
    btn.style.background = (parseInt(y) === year && parseInt(mo) === month) ? "#007bff" : "#f4f4f4";
    btn.style.color = (parseInt(y) === year && parseInt(mo) === month) ? "white" : "#333";
    btn.title = `${arMonths[parseInt(mo)]} ${y}`;
    btn.style.margin = "2px 0";
    btn.onclick = function() {
      month = parseInt(mo);
      window.year = parseInt(y);
      generateTable();
      renderMonthFab(months);
      fabList.style.display = "none";
    };
    fabList.appendChild(btn);
  });
  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§ (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
  document.addEventListener('click', function fabListClose(e) {
    if (!fabList.contains(e.target) && e.target !== fabBtn) {
      fabList.style.display = "none";
      document.removeEventListener('click', fabListClose);
    }
  });
}

// CSS Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
const fabStyle = document.createElement("style");
fabStyle.innerHTML = `
  .fab-month {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    outline: none;
    box-shadow: 0 2px 8px #007bff44;
    background: #007bff;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0;
    transition: box-shadow 0.2s, background 0.2s, color 0.2s;
  }
  .fab-month-mini {
    width: 36px;
    height: 36px;
    font-size: 16px;
    margin-bottom: 2px;
    background: #f4f4f4;
    color: #333;
    border: 2px solid #007bff22;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s, border 0.2s;
  }
  .fab-month-mini:hover {
    background: #007bff;
    color: white;
    border: 2px solid #007bff;
  }
  @media (max-width: 600px) {
    #monthsFab {
      left: 8px !important;
      bottom: 8px !important;
    }
    .fab-month, .fab-month-mini {
      width: 34px !important;
      height: 34px !important;
      font-size: 15px !important;
    }
    #fabMonthsList {
      min-width: 38px !important;
      padding: 5px 2px !important;
      border-radius: 10px !important;
      box-shadow: 0 2px 8px #007bff22 !important;
      gap: 4px !important;
    }
  }
`;
document.head.appendChild(fabStyle);
if (localStorage.getItem('loggedUser')) { loadAvailableMonths(); }

// ========== Ø²Ø± ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ==========
const toggleAdminBtn = document.createElement("button");
toggleAdminBtn.id = "toggleAdminBtn";
toggleAdminBtn.textContent = "âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…";
toggleAdminBtn.style.backgroundColor = "#6c757d";
toggleAdminBtn.style.color = "white";
toggleAdminBtn.style.border = "none";
toggleAdminBtn.style.width = "100%";
toggleAdminBtn.style.padding = "10px";
toggleAdminBtn.style.marginTop = "15px";
toggleAdminBtn.style.fontSize = "16px";
toggleAdminBtn.style.borderRadius = "5px";
toggleAdminBtn.style.cursor = "pointer";
toggleAdminBtn.style.transition = "background 0.2s ease";
toggleAdminBtn.onmouseover = () => { toggleAdminBtn.style.backgroundColor = "#5a6268"; };
toggleAdminBtn.onmouseout = () => {
  if (adminPanel.style.maxHeight === "0px") toggleAdminBtn.style.backgroundColor = "#6c757d";
};
const logoutBtn = document.querySelector("button[onclick='logout()']");
logoutBtn.parentNode.insertBefore(toggleAdminBtn, logoutBtn);
const adminPanel = document.getElementById("adminPanel");
adminPanel.style.maxHeight = "0px";
adminPanel.style.overflow = "hidden";
adminPanel.style.transition = "max-height 0.4s ease";
toggleAdminBtn.onclick = () => {
  if (adminPanel.style.maxHeight === "0px") {
    adminPanel.style.maxHeight = adminPanel.scrollHeight + "px";
    toggleAdminBtn.style.backgroundColor = "green";
    setTimeout(() => {
      adminPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 200);
  } else {
    adminPanel.style.maxHeight = "0px";
    toggleAdminBtn.style.backgroundColor = "#6c757d";
  }
};

// ========== Ø­Ø°Ù Ù…ØªÙ‚Ø¯Ù… ==========
function advancedDelete() {
  // Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ø¶Ø­Ø©
  let modal = document.getElementById("deleteChoiceModal");
  if (modal) modal.remove();
  modal = document.createElement("div");
  modal.id = "deleteChoiceModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:#fff;max-width:370px;width:92vw;padding:26px 18px 20px 18px;border-radius:16px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeDeleteChoiceModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;\">âœ–</button>
      <div style=\"font-size:18px;color:#333;margin-bottom:20px;font-weight:500;\">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªÙ†ÙÙŠØ°Ù‡Ø§:</div>
      <div style=\"display:flex;flex-direction:column;gap:10px;align-items:center;\">
        <button class=\"deleteOpBtn\" data-op=\"1\" style=\"background:#e91e63;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">1 - Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙ‚Ø·</button>
        <button class=\"deleteOpBtn\" data-op=\"2\" style=\"background:#9c27b0;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">2 - Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button class=\"deleteOpBtn\" data-op=\"3\" style=\"background:#ff9800;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">3 - Ø­Ø°Ù Ø§Ù„ØªØ§Ø´ÙŠØ±Ø§Øª (Ø´ÙØªØŒ Ù†ØµØŒ âŒ)</button>
        <button class=\"deleteOpBtn\" data-op=\"4\" style=\"background:#009688;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">4 - Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</button>
        <button class=\"deleteOpBtn\" data-op=\"5\" style=\"background:#607d8b;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">5 - Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button onclick=\"clearDatabase()\" style=\"background:#e53935;color:white;margin-top:10px;width:100%;font-size:15px;padding:8px 0;border-radius:7px;\">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  document.getElementById("closeDeleteChoiceModalBtn").onclick = function() { modal.remove(); };
  Array.from(document.getElementsByClassName("deleteOpBtn")).forEach(btn => {
    btn.onclick = function() {
      const choice = btn.getAttribute("data-op");
      modal.remove();
      // Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±
      let passModal = document.getElementById("adminPassModal");
      if (passModal) passModal.remove();
      passModal = document.createElement("div");
      passModal.id = "adminPassModal";
      passModal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
      passModal.innerHTML = `
        <div style=\"background:#fff;max-width:350px;width:90vw;padding:22px 18px 18px 18px;border-radius:14px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;\">
          <button id=\"closeAdminPassModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">âœ–</button>
          <div style=\"font-size:17px;color:#333;margin-bottom:18px;\">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯:</div>
          <input id=\"adminPassInput\" type=\"password\" style=\"width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;\" />
          <button id=\"adminPassConfirmBtn\" style=\"background:#007bff;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;\">ØªØ£ÙƒÙŠØ¯</button>
        </div>
      `;
      document.body.appendChild(passModal);
      document.getElementById("adminPassConfirmBtn").onclick = async function() {
        const adminPass = document.getElementById("adminPassInput").value;
        passModal.remove();
        const snapshot = await db.ref("users/admin/password").once("value");
        const realAdminPass = snapshot.val();
        const ok = await verifyPassword(realAdminPass, adminPass);
        if (!ok) {
          alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
          return;
        }
        // Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ
        showConfirmModal("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!", () => {
          switch(choice) {
            case "1":
              db.ref("employees").remove()
                .then(() => alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙ‚Ø·."))
                .catch(e => alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: " + e.message));
              break;
            case "2":
              db.ref("users").remove()
                .then(() => alert("âœ… ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†."))
                .catch(e => alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: " + e.message));
              break;
            case "3":
              db.ref("attendance").remove()
                .then(() => alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ§Ø´ÙŠØ±Ø§Øª."))
                .catch(e => alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ§Ø´ÙŠØ±Ø§Øª: " + e.message));
              break;
            case "4":
              db.ref("activityLog").remove()
                .then(() => alert("âœ… ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª."))
                .catch(e => alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª: " + e.message));
              break;
            case "5":
              Promise.all([
                db.ref("employees").remove(),
                db.ref("attendance").remove(),
                db.ref("activityLog").remove(),
                db.ref("users").once("value").then(snapshot => {
                  const users = snapshot.val() || {};
                  const updates = {};
                  Object.keys(users).forEach(username => {
                    if (username !== currentUser) updates[username] = null;
                  });
                  return db.ref("users").update(updates);
                })
              ]).then(() => {
                alert("âœ… ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø§ Ø¹Ø¯Ø§ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.");
              }).catch(e => {
                alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
              });
              break;
          }
        });
      };
      document.getElementById("closeAdminPassModalBtn").onclick = function() { passModal.remove(); };
    };
  });
}
document.addEventListener("DOMContentLoaded", () => {
  const btnDeleteData = document.getElementById("btnDeleteData");
  if (btnDeleteData) btnDeleteData.addEventListener("click", advancedDelete);
});

// ========== Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
function checkForcedLogoutOnLogin(userKey) {
  return db.ref("forcedLogout/" + userKey).once("value").then(snapshot => {
    if (snapshot.exists()) {
      localStorage.removeItem('loggedUser');
      db.ref("users/" + userKey).once("value").then(userSnap => {
        if (!userSnap.exists()) {
          showAccountDeletedModal();
        } else {
          showForcedLogoutModal();
        }
      });
      db.ref("forcedLogout/" + userKey).remove();
      setTimeout(()=>location.reload(), 2500);
      return true;
    }
    return false;
  });
}

// Ù†Ø§ÙØ°Ø© Ø£Ù†ÙŠÙ‚Ø© Ø¹Ù†Ø¯ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±
function showAccountDeletedModal() {
  let oldModal = document.getElementById("accountDeletedModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "accountDeletedModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#fff7f7 60%,#fce4ec 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #e5737333;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <div style=\"font-size:21px;color:#d32f2f;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">ğŸš« ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#fff3f3;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #e5737311;\">ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.<br>Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.</div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #accountDeletedModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #accountDeletedModal div { font-size:16px !important; }
      }
    </style>
  `;
  document.body.appendChild(modal);
}

// Ù†Ø§ÙØ°Ø© Ø£Ù†ÙŠÙ‚Ø© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¬Ø¨Ø§Ø±ÙŠÙ‹Ø§ (Ø§Ø­ØªÙŠØ§Ø·)
function showForcedLogoutModal() {
  let oldModal = document.getElementById("forcedLogoutModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "forcedLogoutModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#f7faff 60%,#e3eafc 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #1976d233;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <div style=\"font-size:21px;color:#1976d2;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">ğŸšª ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#f3f7ff;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #1976d211;\">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.<br>Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø­ØªÙ‰ ØªØ¹ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #forcedLogoutModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #forcedLogoutModal div { font-size:16px !important; }
      }
    </style>
  `;
  document.body.appendChild(modal);
}
if (localStorage.getItem('loggedUser')) {
  const savedUser = JSON.parse(localStorage.getItem('loggedUser'));
  checkForcedLogoutOnLogin(savedUser.user);
}
setInterval(() => {
  if (currentUser) {
    db.ref("forcedLogout/" + currentUser).once("value").then(snapshot => {
      if (snapshot.exists()) {
        localStorage.removeItem('loggedUser');
        showForcedLogoutModal();
        db.ref("forcedLogout/" + currentUser).remove();
        setTimeout(()=>location.reload(), 2500);
      }
    });
  }
}, 3000);

// ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ==========
function setEmpStatsEnabled(enabled) {
  db.ref("settings/showEmpStats").set(enabled ? true : false);
}
function getEmpStatsEnabled() {
  return db.ref("settings/showEmpStats").once("value").then(snap => !!snap.val());
}
function setEmpStatsMode(mode, value) {
  db.ref("settings/empStatsMode").set({mode, value: value || ""});
}
function getEmpStatsMode() {
  return db.ref("settings/empStatsMode").once("value").then(snap => snap.val() || {mode:"all",value:""});
}
// Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ù…Ø¯ÙŠØ±
document.getElementById("toggleEmpStatsBtn").onclick = function() {
  let tab = document.getElementById("empStatsTab");
  tab.style.display = "flex";
  document.getElementById("closeEmpStatsTab").onclick = function() { tab.style.display = "none"; };
  renderEmpStatsTabContent();
};

// Ø¹Ø±Ø¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
function renderEmpStatsTabContent() {
  const contentDiv = document.getElementById("empStatsTabContent");
  contentDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  Promise.all([
    db.ref("users").once("value"),
    db.ref(`employees_${year}_${(month+1).toString().padStart(2,'0')}`).once("value")
  ]).then(([usersSnap, empsSnap]) => {
    const users = usersSnap.val() || {};
    // Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø´Ù‡Ø±ÙŠ
    const employeesList = empsSnap.exists() ? Object.values(empsSnap.val()) : [];
    let html = `<div style='font-size:15px;color:#333;margin-bottom:10px;text-align:center;'>ØªØ­ÙƒÙ… Ø¨Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>`;
    html += `<table style='width:100%;border-collapse:collapse;'>
      <tr style='background:#f6f6f6;'>
        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¹Ø±Ø¶Ù‡Ù…</th>
        <th>Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§ØªØ¨</th>
      </tr>`;
    Object.entries(users).forEach(([username, data]) => {
      if (username === "admin") return;
      const allowedEmps = data.allowedStatsEmps || [];
      const canViewSalary = !!data.canViewSalary;
      html += `<tr>
        <td style='padding:7px 4px;'>${username}</td>
        <td style='padding:7px 4px;'>
          <select multiple data-user='${username}' class='allowedEmpsSelect' style='width:140px;min-height:38px;font-size:15px;'>
            ${employeesList.map(emp => `<option value='${emp}' ${allowedEmps.includes(emp)?"selected":""}>${emp}</option>`).join("")}
          </select>
        </td>
        <td style='padding:7px 4px;text-align:center;'>
  <label style='display:inline-flex;align-items:center;gap:7px;'>
    <span style='font-size:15px;color:#1976d2;'>Ø§Ù„Ø±ÙˆØ§ØªØ¨</span>
    <input type='checkbox' data-user='${username}' class='canViewSalaryCheckbox' ${canViewSalary?"checked":""} />
  </label>
</td>
      </tr>`;
    });
    html += `</table><div style='font-size:13px;color:#555;margin-top:8px;'>Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¹Ø±Ø¶Ù‡Ù… Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙˆØ®ÙŠØ§Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§ØªØ¨. Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±ÙŠ.</div>`;
    contentDiv.innerHTML = html;

    // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¹Ø±Ø¶Ù‡Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
    Array.from(document.getElementsByClassName("allowedEmpsSelect")).forEach(sel => {
      sel.onchange = function() {
        const user = sel.getAttribute("data-user");
        const selected = Array.from(sel.selectedOptions).map(opt => opt.value);
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db.ref("users/"+user+"/allowedStatsEmps").set(selected).then(()=>{
          logActivity("ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†","ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¹Ø±Ø¶Ù‡Ù… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: "+user+" Ø¥Ù„Ù‰: "+selected.join(", "));
        });
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…ØªØ£Ø«Ø±ØŒ Ø­Ø¯Ø« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        if (user === currentUser) {
          // ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
          if (window.currentUserData) window.currentUserData.allowedStatsEmps = selected;
          // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹
          db.ref("attendance").once("value").then(snap => {
            calculateStats(snap.val() || {});
          });
        }
      };
    });
    // Ø­ÙØ¸ Ø®ÙŠØ§Ø± Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
    Array.from(document.getElementsByClassName("canViewSalaryCheckbox")).forEach(chk => {
      chk.onchange = function() {
        const user = chk.getAttribute("data-user");
        const val = chk.checked;
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db.ref("users/"+user+"/canViewSalary").set(val).then(()=>{
          logActivity("ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±ÙˆØ§ØªØ¨","ØªÙ… ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: "+user+" Ø¥Ù„Ù‰: "+(val?"Ù†Ø¹Ù…":"Ù„Ø§"));
        });
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…ØªØ£Ø«Ø±ØŒ Ø­Ø¯Ø« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
        if (user === currentUser) {
          if (window.currentUserData) window.currentUserData.canViewSalary = val;
          db.ref("attendance").once("value").then(snap => {
            calculateStats(snap.val() || {});
          });
        }
      };
    });
    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ (Realtime)
    if (typeof window._statsPermsListenerSet === "undefined") {
      window._statsPermsListenerSet = true;
      ["allowedStatsEmps","canViewSalary"].forEach(key => {
        db.ref("users/"+currentUser+"/"+key).on("value", function() {
          db.ref("attendance").once("value").then(snap => {
            calculateStats(snap.val() || {});
          });
        });
      });
    }
  });
}

// ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ==========
const userEmpStatsDiv = document.createElement("div");
userEmpStatsDiv.id = "userEmpStatsDiv";
userEmpStatsDiv.style.margin = "20px 0";
userEmpStatsDiv.style.padding = "10px";
userEmpStatsDiv.style.background = "#f8f9fa";
userEmpStatsDiv.style.border = "1px solid #ddd";
userEmpStatsDiv.style.borderRadius = "7px";
userEmpStatsDiv.style.display = "none";
document.getElementById("mainContent").appendChild(userEmpStatsDiv);

function renderUserEmpStats() {
  Promise.all([getEmpStatsEnabled(), getEmpStatsMode()]).then(([enabled, modeObj]) => {
    if (!enabled) {
      userEmpStatsDiv.style.display = "none";
      return;
    }
    let allow = false, onlyEmp = null;
    if (modeObj.mode === "all") allow = true;
    else if (modeObj.mode === "user" && currentUser === modeObj.value) allow = true;
    else if (modeObj.mode === "employee") { allow = true; onlyEmp = modeObj.value; }
    if (!allow) { userEmpStatsDiv.style.display = "none"; return; }
    let html = `
      <b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</b>
      <div id='userEmpStatsGrid' style='margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:13px;'></div>
      <style>
        @media (max-width:600px){
          #userEmpStatsGrid{grid-template-columns:1fr;gap:8px;}
        }
        .emp-card{background:#f8f9fa;border-radius:10px;box-shadow:0 1px 6px #0001;padding:15px 10px;display:flex;flex-direction:column;align-items:center;transition:box-shadow 0.2s;}
        .emp-card .emp-name{font-weight:bold;font-size:16px;color:#007bff;margin-bottom:7px;}
        .emp-card .emp-stats{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
        .emp-card .stat{display:flex;align-items:center;gap:4px;font-size:14px;background:#fff;border-radius:6px;padding:4px 9px;margin:2px 0;box-shadow:0 1px 3px #0001;}
        .emp-card .stat.shift{color:#28a745;}
        .emp-card .stat.half{color:#ffc107;}
        .emp-card .stat.absent{color:#dc3545;}
      </style>
    `;
    userEmpStatsDiv.innerHTML = html;
    const gridDiv = document.getElementById("userEmpStatsGrid");
    gridDiv.innerHTML = "<div style='text-align:center;width:100%;color:#888;'>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>";
    db.ref("attendance").once("value").then(snapshot => {
      const data = snapshot.val() || {};
      // Ø§Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„Ù…ØªØ£Ø«Ø±
      let allowedEmps, canViewSalary;
      if (typeof window.currentUserData !== "undefined") {
        allowedEmps = window.currentUserData.allowedStatsEmps || [];
        canViewSalary = !!window.currentUserData.canViewSalary;
      } else {
        allowedEmps = [];
        canViewSalary = false;
      }
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ ÙŠØ±Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹
      let showEmps = (currentUserRole === "admin") ? window.monthEmployees : allowedEmps;
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ ÙŠØ±Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹
      if (!Array.isArray(showEmps) || showEmps.length === 0) showEmps = window.monthEmployees;
      // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¸ÙÙŠÙ†
      if (!Array.isArray(showEmps) || showEmps.length === 0) {
        gridDiv.innerHTML = "<div style='text-align:center;width:100%;color:#888;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>";
        userEmpStatsDiv.style.display = "block";
        return;
      }
      // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ± Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
      let hasAttendance = false;
      Object.entries(data).forEach(([dateStr, day]) => {
        let parts = dateStr.split("-");
        if (parts.length === 3) {
          let dYear = parseInt(parts[0]);
          let dMonth = parseInt(parts[1]) - 1;
          if (dYear === year && dMonth === month) hasAttendance = true;
        }
      });
      if (!hasAttendance) {
        gridDiv.innerHTML = "<div style='text-align:center;width:100%;color:#888;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>";
        userEmpStatsDiv.style.display = "block";
        return;
      }
      gridDiv.innerHTML = "";
      showEmps.forEach(emp => {
        if (onlyEmp && emp !== onlyEmp) return;
        let shift=0, half=0, x=0;
        Object.entries(data).forEach(([dateStr, day]) => {
          let parts = dateStr.split("-");
          if (parts.length === 3) {
            let dYear = parseInt(parts[0]);
            let dMonth = parseInt(parts[1]) - 1;
            if (dYear === year && dMonth === month) {
              if (day[emp] === "Ø´ÙØª") shift++;
              if (day[emp] === "Ù†Øµ") half++;
              if (day[emp] === "âŒ") x++;
            }
          }
        });
        const salary = (shift * 20000) + (half * 10000);
        const card = document.createElement("div");
        card.className = "emp-card";
        card.innerHTML = `
          <div class='emp-name'>${emp}</div>
          <div class='emp-stats'>
            <div class='stat shift'>âœ… Ø´ÙØª: <b>${shift}</b></div>
            <div class='stat half'>ğŸŒ“ Ù†Øµ: <b>${half}</b></div>
            <div class='stat absent'>ğŸ–ï¸ Ø§Ø¬Ø§Ø²Ø©: <b>${x}</b></div>
          </div>
          ${canViewSalary || currentUserRole === "admin" ? `<div class='emp-salary' style='margin-top:8px;font-size:15px;color:#222;background:#e3f7e3;padding:6px 0;border-radius:7px;width:100%;text-align:center;'>ğŸ’° Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙƒÙ„ÙŠ: <b>${salary.toLocaleString()} Ø¯.Ø¹</b></div>` : ""}
        `;
        gridDiv.appendChild(card);
      });
      userEmpStatsDiv.style.display = "block";
    });
  });
}
function tryShowUserEmpStats() {
if (typeof window.monthEmployees !== "undefined" && window.monthEmployees.length > 0) renderUserEmpStats();
}
const origLoadEmployees = loadEmployees;
loadEmployees = function() {
  return origLoadEmployees.apply(this, arguments).then(() => {
    if (typeof window.monthEmployees !== "undefined" && window.monthEmployees.length > 0) {
      renderUserEmpStats();
    }
  });
};
if (localStorage.getItem('loggedUser')) tryShowUserEmpStats();
db.ref("settings/empStatsMode").on("value", () => renderUserEmpStats());

// ========== ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± ==========
// ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
function changeAdminPassword() {
  const oldPass = document.getElementById("adminOldPass").value;
  const newPass = document.getElementById("adminNewPass").value;
  const statusDiv = document.getElementById("adminPassStatus");
  if (currentUserRole !== "admin") {
    statusDiv.textContent = "âŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ…ÙƒÙ†Ù‡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
    return;
  }
  if (!oldPass || !newPass) {
    statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.";
    return;
  }
  db.ref("users/admin/password").once("value").then(snapshot => {
    if (!snapshot.exists() || snapshot.val() !== oldPass) {
      statusDiv.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
      return;
    }
    db.ref("users/admin/password").set(newPass).then(() => {
      statusDiv.textContent = "âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
      document.getElementById("adminOldPass").value = "";
      document.getElementById("adminNewPass").value = "";
      logActivity("ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±", `ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† Ù‚Ø¨Ù„: ${currentUser}`);
    });
  }).catch(() => {
    statusDiv.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
  });
}

// ========== Ø­Ø°Ù Ù…ÙˆØ¸Ù ==========
// ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù
function deleteEmployee(index) {
  if (!preventEditIfNotCurrentMonth()) return;
  if (currentUserRole !== "admin") {
    alert("âŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.");
    return;
  }
  const empName = employees[index];
  if (!empName) {
    alert("âŒ Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
    return;
  }
  showConfirmModal(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù "${empName}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±Ù‡ Ø£ÙŠØ¶Ø§.`, () => {
    if (!preventEditIfNotCurrentMonth()) return;
    employees.splice(index, 1);
    const empKey = `employees_${year}_${(month+1).toString().padStart(2,'0')}`;
    db.ref(empKey).set(employees)
      .then(() => {
        db.ref("attendance").once("value").then(snapshot => {
          const attendance = snapshot.val() || {};
          Object.keys(attendance).forEach(dayKey => {
            if (attendance[dayKey][empName] !== undefined) {
              delete attendance[dayKey][empName];
            }
          });
          return db.ref("attendance").set(attendance);
        }).then(() => {
          alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±Ù‡ Ø¨Ù†Ø¬Ø§Ø­.");
          loadEmployeesTable();
          generateTable();
          logActivity("Ø­Ø°Ù Ù…ÙˆØ¸Ù", `ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù: ${empName} ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±Ù‡`);
        });
      })
      .catch(err => {
        console.error(err);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù.");
      });
  });
}

// ========== Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
// ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„
function backupData() {
  document.getElementById("backupStatus").textContent = "Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ø³Ø®Ø©...";
  Promise.all([
    db.ref("employees").once("value"),
    db.ref("attendance").once("value"),
    db.ref("users").once("value")
  ]).then(([empSnap, attSnap, usersSnap]) => {
    const data = {
      employees: empSnap.val() || {},
      attendance: attSnap.val() || {},
      users: usersSnap.val() || {}
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "backup-" + new Date().toISOString().slice(0,10) + ".json";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 500);
    document.getElementById("backupStatus").textContent = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.";
    logActivity("ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  }).catch((err) => {
    document.getElementById("backupStatus").textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ.";
    console.error("Backup error:", err);
  });
}
</script>

<!-- Ø¥Ø¶Ø§ÙØ©: Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
<div id="changePassModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:6000;align-items:center;justify-content:center;">
  <div style="background:#fff;max-width:340px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;">
    <button id="closeChangePassModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">âœ–</button>
    <h3 style="text-align:center;margin-bottom:18px;color:#2196f3;">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
    <div id="changePassForm"></div>
    <div id="changePassStatus" style="margin-top:10px;font-size:14px;text-align:center;"></div>
  </div>
</div>
<script>
// ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
document.getElementById("sidebarChangePassBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  showChangePassForm();
};

function showChangePassForm() {
  const modal = document.getElementById("changePassModal");
  const formDiv = document.getElementById("changePassForm");
  const statusDiv = document.getElementById("changePassStatus");
  statusDiv.textContent = "";
  // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ù†ÙØ³Ù‡
  if (currentUserRole === "admin") {
    db.ref("users").once("value").then(snapshot => {
      const users = snapshot.val() || {};
      let html = `<div style='margin-bottom:10px;font-size:15px;color:#1976d2;font-weight:bold;'>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±</div>
        <label style='font-size:14px;'>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
        <select id="changePassUser" style="width:100%;margin-bottom:10px;">`;
      Object.keys(users).forEach(u => {
        html += `<option value="${u}" ${u===currentUser?'selected':''}>${u}${u==='admin'?' (Ù…Ø¯ÙŠØ±)':''}</option>`;
      });
      html += `</select>
        <label style='font-size:14px;'>Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:</label>
        <input type="text" id="changeUserName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-bottom:8px;" />
        <label style='font-size:14px;'>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©:</label>
        <input type="password" id="changePassNew" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-bottom:8px;" />
        <button id="changeUserSubmit" style="background:#2196f3;color:white;width:100%;margin-top:8px;font-size:16px;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        <button id="resetPassBtn" style="background:#ff9800;color:white;width:100%;margin-top:8px;font-size:16px;">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)</button>
        <div style='margin-top:10px;font-size:13px;color:#555;'>ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø³Ù‡ÙˆÙ„Ø©.<br>Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ Ù†Ø³ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.</div>`;
      formDiv.innerHTML = html;
      modal.style.display = "flex";
      // ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      document.getElementById("changeUserSubmit").onclick = async function() {
        const user = document.getElementById("changePassUser").value;
        const newPass = document.getElementById("changePassNew").value;
        const newUserName = document.getElementById("changeUserName").value.trim();
        let changed = false;
        // ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ù… ÙŠÙƒÙ† Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§
        if (newUserName && !users[newUserName]) {
          const userDataSnap = await db.ref("users/" + user).once("value");
          const userData = userDataSnap.val();
          await db.ref("users/" + newUserName).set(userData);
          await db.ref("users/" + user).remove();
          statusDiv.textContent = `âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰: ${newUserName}`;
          logActivity("ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…", `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ${user} Ø¥Ù„Ù‰ ${newUserName} Ø¨ÙˆØ§Ø³Ø·Ø©: ${currentUser}`);
          changed = true;
        } else if (newUserName && users[newUserName]) {
          statusDiv.textContent = "âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.";
          return;
        }
        // ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©
        if (newPass) {
          const hashObj = await hashPassword(newPass);
          const targetUser = newUserName && !users[newUserName] ? newUserName : user;
          await db.ref("users/" + targetUser + "/password").set(hashObj);
          statusDiv.textContent += (changed ? "<br>" : "") + "âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
          logActivity("ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±", `ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${targetUser} Ø¨ÙˆØ§Ø³Ø·Ø©: ${currentUser}`);
          changed = true;
        }
        if (!changed) {
          statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.";
        }
        document.getElementById("changePassNew").value = "";
        document.getElementById("changeUserName").value = "";
      };
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      document.getElementById("resetPassBtn").onclick = async function() {
        const user = document.getElementById("changePassUser").value;
        let newPass = "";
        // Ù†Ø§ÙØ°Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        let passModal = document.createElement("div");
        passModal.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:center;justify-content:center;";
        passModal.innerHTML = `<div style='background:#fff;max-width:340px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;text-align:center;'>
          <h3 style='color:#ff9800;margin-bottom:12px;'>Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
          <div style='margin-bottom:10px;font-size:15px;'>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… <b style='color:#1976d2;'>${user}</b>:</div>
          <input type='password' id='newPassInput' style='width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;' placeholder='ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©' />
          <button id='confirmNewPassBtn' style='background:#2196f3;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;'>ØªØ£ÙƒÙŠØ¯</button>
          <button id='cancelNewPassBtn' style='background:#dc3545;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;margin-left:8px;'>Ø¥Ù„ØºØ§Ø¡</button>
        </div>`;
        document.body.appendChild(passModal);
        document.getElementById('confirmNewPassBtn').onclick = async function() {
          newPass = document.getElementById('newPassInput').value;
          if (!newPass) {
            statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.";
            passModal.remove();
            return;
          }
          const hashObj = await hashPassword(newPass);
          await db.ref("users/" + user + "/password").set(hashObj);
          statusDiv.textContent = "âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
          logActivity("Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±", `ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user} Ø¨ÙˆØ§Ø³Ø·Ø©: ${currentUser}`);
          passModal.remove();
        };
        document.getElementById('cancelNewPassBtn').onclick = function() {
          passModal.remove();
        };
      };
    });
  } else {
    let html = `
      <input type="text" id="changeUserName" placeholder="Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-bottom:8px;" />
      <input type="password" id="changePassOld" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" style="margin-bottom:8px;" />
      <input type="password" id="changePassNew" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" style="margin-bottom:8px;" />
      <button id="changePassSubmit" style="background:#2196f3;color:white;width:100%;margin-top:8px;">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
      <button id="resetPassBtn" style="background:#ff9800;color:white;width:100%;margin-top:8px;">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¥Ø°Ø§ Ù†Ø³ÙŠØª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)</button>`;
    formDiv.innerHTML = html;
    modal.style.display = "flex";
    document.getElementById("changePassSubmit").onclick = async function() {
      const oldPass = document.getElementById("changePassOld").value;
      const newPass = document.getElementById("changePassNew").value;
      const newUserName = document.getElementById("changeUserName").value.trim();
      if (!oldPass || !newPass) return statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.";
      const passSnap = await db.ref("users/" + currentUser + "/password").once("value");
      const stored = passSnap.val();
      const ok = await verifyPassword(stored, oldPass);
      if (!ok) return statusDiv.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
      const hashObj = await hashPassword(newPass);
      await db.ref("users/" + currentUser + "/password").set(hashObj);
      // ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ù… ÙŠÙƒÙ† Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§
      const usersSnap = await db.ref("users").once("value");
      const users = usersSnap.val() || {};
      if (newUserName && !users[newUserName]) {
        const userDataSnap = await db.ref("users/" + currentUser).once("value");
        const userData = userDataSnap.val();
        await db.ref("users/" + newUserName).set(userData);
        await db.ref("users/" + currentUser).remove();
        statusDiv.textContent = `âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰: ${newUserName}`;
        logActivity("ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…", `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ${currentUser} Ø¥Ù„Ù‰ ${newUserName}`);
      } else {
        statusDiv.textContent = "âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
      }
      logActivity("ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±", `ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser}`);
      document.getElementById("changePassOld").value = "";
      document.getElementById("changePassNew").value = "";
      document.getElementById("changeUserName").value = "";
    };
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ø°Ø§ Ù†Ø³ÙŠØª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    document.getElementById("resetPassBtn").onclick = async function() {
      const newPass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
      if (!newPass) return statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.";
      const hashObj = await hashPassword(newPass);
      await db.ref("users/" + currentUser + "/password").set(hashObj);
      statusDiv.textContent = "âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
      logActivity("Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±", `ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser}`);
    };
  }
}
document.getElementById("closeChangePassModal").onclick = function() {
  document.getElementById("changePassModal").style.display = "none";
};

// ========== ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± ========== 
// ØªÙ… Ø¯Ù…Ø¬ Ø¯Ø§Ù„Ø© updateSidebarVisibility ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…Ø¹ Ù…Ù†Ø·Ù‚ Ù…ÙˆØ­Ø¯ ÙˆØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±

// ========== ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ==========
document.getElementById("sidebarToggleBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.add("open");
  document.getElementById("sidebarToggleBtn").style.display = "none";
  document.getElementById("sidebarCloseBtn").style.display = "flex";
  // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  const sidebarUserName = document.getElementById("sidebarUserName");
  sidebarUserName.textContent = currentUser ? "ğŸ‘¤ " + currentUser : "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
  updateSidebarVisibility();
};
document.getElementById("sidebarCloseBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("sidebarCloseBtn").style.display = "none";
  document.getElementById("sidebarToggleBtn").style.display = "flex";
  updateSidebarVisibility();
};

// ========== Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¨Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠØ© ==========
document.getElementById("sidebarAdminBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("toggleAdminBtn").click();
};
document.getElementById("sidebarEmpStatsBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("toggleEmpStatsBtn").click();
};
document.getElementById("sidebarDeleteDataBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("btnDeleteData").click();
};
document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("btnFeaturesTab").click();
  document.getElementById("featuresTab").style.display = "flex";
  const featuresTabContent = document.getElementById("featuresTabContent");
  featuresTabContent.innerHTML = `
    <div class="feature-section">
      <h4>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h4>
      <div id="activityLogBox">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    <div class="feature-section">
      <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
      <ul style="margin:0;padding:0 0 0 15px;">
        <li>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${employees.length}</b></li>
        <li>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${currentUser}</b></li>
        <li>Ø§Ù„Ø¯ÙˆØ±: <b>${currentUserRole}</b></li>
      </ul>
    </div>
  `;
  db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
    const log = snapshot.val() || {};
    let html = `<table class="activity-log-table">
      <tr>
        <th>Ø§Ù„ÙˆÙ‚Øª</th>
        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
        <th>Ø§Ù„ÙˆØµÙ</th>
      </tr>`;
    Object.values(log).reverse().forEach(item => {
      html += `<tr>
        <td>${toEnglishNumbers(item.time || "")}</td>
        <td>${item.user || ""}</td>
        <td>${item.action || ""}</td>
        <td>${item.details || ""}</td>
      </tr>`;
    });
    html += `</table>`;
    document.getElementById("activityLogBox").innerHTML = html;
  });
  // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
  const closeBtn = document.getElementById("closeFeaturesTab");
  if (closeBtn) {
    closeBtn.onclick = () => {
      document.getElementById("featuresTab").style.display = "none";
    };
  }
};

// Ù†Ø§ÙØ°Ø© ØªØ­ÙƒÙ… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
document.getElementById("sidebarUserControlBtn").onclick = function() {
  // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©
  let modal = document.getElementById("userLogControlModal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "userLogControlModal";
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100vw";
    modal.style.height = "100vh";
    modal.style.background = "rgba(0,0,0,0.35)";
    modal.style.zIndex = "8000";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.innerHTML = `
      <div style="background:#fff;max-width:420px;width:95vw;border-radius:14px;box-shadow:0 8px 32px #0002;padding:28px 20px 20px 20px;position:relative;">
        <button id="closeUserLogControlModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#009688;">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
        <div id="userLogControlContent" style="min-height:70px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById("closeUserLogControlModal").onclick = function() {
      modal.style.display = "none";
    };
  } else {
    modal.style.display = "flex";
  }

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù…
  db.ref("users").once("value").then(snapshot => {
    const users = snapshot.val() || {};
    let html = `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <th style="background:#f6f6f6;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th style="background:#f6f6f6;">Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</th>
        <th style="background:#f6f6f6;">Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
      </tr>`;
    Object.entries(users).forEach(([username, data]) => {
      if (username === "admin") return; // Ù„Ø§ ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ± Ù†ÙØ³Ù‡
      html += `<tr>
        <td style="padding:7px 4px;">${username}</td>
        <td style="padding:7px 4px;">
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" ${data.canViewLog ? "checked" : ""} onchange="window.setUserLogAccess('${username}', this.checked)">
            <span style="font-size:13px;color:${data.canViewLog ? '#28a745':'#dc3545'};">${data.canViewLog ? 'Ù…ÙØ¹Ù„':'Ù…Ø¹Ø·Ù„'}</span>
          </label>
        </td>
        <td style="padding:7px 4px;">
          <select onchange="window.setUserLogType('${username}', this.value)" style="font-size:13px;">
            <option value="all" ${!data.logViewType || data.logViewType==="all" ? "selected" : ""}>ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„</option>
            <option value="self" ${data.logViewType==="self" ? "selected" : ""}>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·</option>
          </select>
        </td>
      </tr>`;
    });
    html += `</table>
      <div style="margin-top:10px;font-size:13px;color:#555;">
        Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙŠØ¸Ù‡Ø± Ø²Ø± Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.<br>
        Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:<br>
        <b>ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„:</b> ÙŠØ±Ù‰ ÙƒÙ„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.<br>
        <b>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·:</b> ÙŠØ±Ù‰ ÙÙ‚Ø· Ù†Ø´Ø§Ø·Ø§ØªÙ‡ Ù‡Ùˆ.<br>
        Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø·ÙŠÙ„ ÙŠØ®ØªÙÙŠ Ø§Ù„Ø²Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
      </div>`;
    document.getElementById("userLogControlContent").innerHTML = html;
    window.setUserLogAccess = function(username, enabled) {
      db.ref("users/" + username + "/canViewLog").set(enabled).then(() => {
        logActivity("ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª", `ØªÙ… ${enabled ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„'} Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username}`);
        updateSidebarVisibility();
      });
    };
    window.setUserLogType = function(username, type) {
      db.ref("users/" + username + "/logViewType").set(type).then(() => {
        logActivity("ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ ØµÙ„Ø§Ø­ÙŠØ© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª", `ØªÙ… ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username} Ø¥Ù„Ù‰: ${type === 'all' ? 'ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„' : 'Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·'}`);
        updateSidebarVisibility();
      });
    };
  });
}
</script>
</body>
</html>
