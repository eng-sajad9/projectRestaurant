<!DOCTYPE html>
<html lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ù‡ÙŠ Ù‡ÙŠ</title>
    <meta
      name="description"
      content="Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØºÙŠØ§Ø¨Ù‡Ù… Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©. Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø¹Ø±Ø¨ÙŠ Ù…Ø¬Ø§Ù†ÙŠ ÙˆØ³Ù‡Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…."
    />
    <meta
      name="keywords"
      content="Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ±, Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù, Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø­Ø¶ÙˆØ±, Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù, Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†, Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± Ù‡ÙŠ Ù‡ÙŠ, Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ±, attendance system, employee attendance, Ø­Ø¶ÙˆØ± Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ, Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¯ÙˆØ§Ù…, Ù†Ø¸Ø§Ù… Ø¯ÙˆØ§Ù…, Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ù…Ø¬Ø§Ù†ÙŠ, Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø¹Ø±Ø¨ÙŠ"
    />
    <meta name="robots" content="index, follow" />
    <script src="crypto-utils.js"></script>
    <!-- Ù…ÙƒØªØ¨Ø© jsPDF Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª PDF Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.plugin.standard_fonts_metrics.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.plugin.split_text_to_size.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.plugin.from_html.min.js"></script>
    <!-- Ù…ÙƒØªØ¨Ø© html2canvas Ù„ØªØ­ÙˆÙŠÙ„ HTML Ø¥Ù„Ù‰ ØµÙˆØ±Ø© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      /* Maintenance overlay */
      #maintenanceOverlay {
        display: none;
        position: fixed;
        inset: 0; /* top:0; right:0; bottom:0; left:0; */
        background: rgba(0,0,0,0.98); /* darker to hide the system thoroughly */
        z-index: 2147483646; /* very high, but below modals that use 2147483000+ optionally */
        color: #fff;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 18px;
        pointer-events: all; /* block interaction underlay */
        transition: opacity 260ms cubic-bezier(0.2,0.9,0.1,1), backdrop-filter 260ms cubic-bezier(0.2,0.9,0.1,1);
        opacity: 0;
      }
      /* floating, rotating background gradient */
      #maintenanceOverlay .overlay-bg { position:absolute; inset:0; pointer-events:none; overflow:hidden; }
      #maintenanceOverlay .overlay-bg:before{
        content:''; position:absolute; inset:-30% -30% -30% -30%; background: radial-gradient(ellipse at 20% 30%, rgba(124,58,237,0.12) 0%, transparent 15%), radial-gradient(ellipse at 80% 70%, rgba(10, 132, 255, 0.08) 0%, transparent 18%); transform: rotate(8deg); animation: bgDrift 14s linear infinite; filter: blur(20px);
      }
      @keyframes bgDrift{ 0% { transform: rotate(0deg) translateY(0px) } 50% { transform: rotate(12deg) translateY(-8px)} 100% { transform: rotate(0deg) translateY(0px)} }

      /* sparkles */
      #maintenanceOverlay .sparkles{ position:absolute; inset:0; pointer-events:none; }
      #maintenanceOverlay .sparkles span{ display:block; position:absolute; width:10px; height:10px; background: radial-gradient(circle at 30% 30%, #fff 0%, #ffd6ff 35%, rgba(255,255,255,0) 70%); border-radius:50%; opacity:0; transform: translateY(0) scale(0.6); box-shadow: 0 0 14px 6px rgba(255, 255, 255, 0.03); filter: blur(0.6px); }
      #maintenanceOverlay .sparkles span:nth-child(1){ left: 8%; top: 38%; animation: sparkle 2200ms ease-in-out 200ms infinite; }
      #maintenanceOverlay .sparkles span:nth-child(2){ left: 22%; top: 18%; animation: sparkle 2600ms ease-in-out 640ms infinite; animation-duration: 2600ms; }
      #maintenanceOverlay .sparkles span:nth-child(3){ left: 45%; top: 62%; animation: sparkle 1980ms ease-in-out 1100ms infinite; }
      #maintenanceOverlay .sparkles span:nth-child(4){ left: 68%; top: 26%; animation: sparkle 2400ms ease-in-out 430ms infinite; }
      #maintenanceOverlay .sparkles span:nth-child(5){ left: 85%; top: 50%; animation: sparkle 2100ms ease-in-out 290ms infinite; }
      #maintenanceOverlay .sparkles span:nth-child(6){ left: 50%; top: 12%; animation: sparkle 3000ms ease-in-out 970ms infinite; }
      @keyframes sparkle { 0% { opacity: 0; transform: translateY(0) scale(0.6) rotate(0deg); } 30% { opacity: 1; transform: translateY(-8px) scale(1) rotate(8deg); } 70% { opacity: 0.6; transform: translateY(-2px) scale(0.9) rotate(-8deg); } 100% { opacity: 0; transform: translateY(0) scale(0.6) rotate(0deg); } }
      #maintenanceOverlay .box { max-width: 640px; width: 96%; }
      /* container box: slightly translucent to keep dark tone while making text readable */
      #maintenanceOverlay .box {
        background: rgba(6, 6, 6, 0.6);
        padding: 18px 20px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.04);
        box-shadow: 0 12px 40px rgba(0,0,0,0.6);
        backdrop-filter: blur(6px);
        transform: translateY(16px) scale(0.98);
        opacity: 0;
        transition: transform 420ms cubic-bezier(0.2,0.9,0.1,1), opacity 420ms cubic-bezier(0.2,0.9,0.1,1), box-shadow 420ms cubic-bezier(0.2,0.9,0.1,1);
      }
      /* Outer glow */
      #maintenanceOverlay .box::before{ content:''; position:absolute; inset:-18px; border-radius:14px; background: radial-gradient(circle at 20% 40%, rgba(124,58,237,0.08) 0%, rgba(10,132,255,0.06) 32%, rgba(255,255,255,0.00) 55%); filter: blur(24px); z-index:-2; opacity:0; transition: opacity 420ms ease; }
      #maintenanceOverlay.show .box::before{ opacity:1; }
      #maintenanceOverlay .box::after{ content:''; position:absolute; left:0; right:0; height:2px; bottom:-10px; background: linear-gradient(90deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)); border-radius:3px; z-index:-1; filter: blur(6px); }
      #maintenanceOverlay:focus { outline: none; }
      #maintenanceOverlay h2 { font-size: 28px; margin-bottom: 8px; color: #fff; font-weight:800; letter-spacing:0.6px; text-transform:none; text-shadow:0 6px 18px rgba(0,0,0,0.6); }
      /* Magical shimmer effect */
      #maintenanceOverlay h2.shimmer {
        background: linear-gradient(90deg,#ffffff 0%, #ffd9ff 18%, #c2faff 40%, #ffffff 70%);
        background-size: 200% 100%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 2.8s linear infinite;
      }
      @keyframes shimmer { 0% { background-position: 0% 50% } 50% { background-position: 100% 50% } 100% { background-position: 0% 50% } }
      #maintenanceOverlay p { font-size: 16px; color: #e2e2e2; margin-top: 8px; line-height:1.65; max-width:760px; margin-left:auto; margin-right:auto; letter-spacing:0.1px; }
      #maintenanceOverlay .sub { margin-top: 12px; font-size:13px; color:#aeb3bd; letter-spacing:0.2px; }

      /* Animations */
      @keyframes overlayFadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes boxPopIn { from { opacity: 0; transform: translateY(28px) scale(0.96); filter: blur(4px); } to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } }
      @keyframes boxFadeOut { from { opacity: 1; transform: translateY(0) scale(1)} to { opacity: 0; transform: translateY(18px) scale(0.98);} }
      @keyframes textRise { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0);} }

      #maintenanceOverlay.show {
        display: flex;
        opacity: 1;
        pointer-events: all;
      }
      #maintenanceOverlay.hide { opacity: 0; pointer-events: none; }
      #maintenanceOverlay.show .box {
        animation: boxPopIn 420ms cubic-bezier(0.2, 0.9, 0.1, 1) both;
      }
      #maintenanceOverlay.hide .box {
        animation: boxFadeOut 380ms cubic-bezier(0.2, 0.9, 0.1, 1) both;
      }
      #maintenanceOverlay.show h2 { animation: textRise 380ms cubic-bezier(0.2, 0.9, 0.1, 1) both; transform-origin:center; }
      #maintenanceOverlay.show p { animation: textRise 420ms cubic-bezier(0.2, 0.9, 0.1, 1) 60ms both; }
      #maintenanceOverlay.show .sub { animation: textRise 420ms cubic-bezier(0.2, 0.9, 0.1, 1) 120ms both; }

      /* small pulsing dot next to status to feel 'alive' */
      .maintenancePulse { display:inline-block; width:10px; height:10px; border-radius:50%; background:linear-gradient(90deg,#ff6b6b,#ff2d2d); box-shadow:0 2px 12px rgba(255,43,43,0.24); margin-left:10px; vertical-align:middle; transform-origin:center; animation: pulse 1.6s ease-in-out infinite; }
      @keyframes pulse { 0% { transform:scale(1); opacity:1 } 50% { transform:scale(1.14); opacity:0.85 } 100% { transform:scale(1); opacity:1 } }

      /* Accessibility: Respect prefers-reduced-motion */
      @media (prefers-reduced-motion: reduce) {
        #maintenanceOverlay .box, #maintenanceOverlay h2, #maintenanceOverlay p { animation: none !important; transition: none !important; }
      }
      #maintenanceOverlay .sub { margin-top: 8px; font-size:13px; color:#bbb }
    </style>
    <style>
      #adminPanel {
        box-shadow: 0 2px 12px rgba(151, 86, 86, 0.067);
      }
      body {
        font-family: "Segoe UI", sans-serif;
        direction: rtl;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 700px;
        margin: auto;
        padding: 20px;
        background: white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
      }
      h2 {
        text-align: center;
        color: #333;
      }
      input,
      button,
      select {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:active {
        background-color: #1976d2;
      }
      #mainContent,
      #adminPanel {
        display: none;
      }
      #attendanceTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      #attendanceTable th {
        border: 1px solid #000000;
        padding: 10px 8px;
        text-align: center;
        background: #000000;
        color: #fff;
        font-weight: 700;
        font-size: 18px;
        letter-spacing: 0.5px;
        border-bottom: 2.5px solid #000000;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        transition: background 0.2s;
        box-shadow: 0 2px 8px #e3eafc;
      }
      @media (max-width: 767px) {
        #attendanceTable th {
          font-size: 15px;
          padding: 7px 4px;
          border-top-left-radius: 4px;
          border-top-right-radius: 4px;
        }
      }
      #attendanceTable td {
        border: 1px solid #ccc;
        padding: 5px;
        text-align: center;
      }
      .editor-tag {
        font-size: 12px;
        color: #555;
      }
      .error {
        color: red;
        text-align: center;
        margin: 10px 0;
      }
      .loading {
        text-align: center;
        color: #666;
        margin: 10px 0;
      }
      #adminPanel {
        margin-top: 20px;
        border-top: 1px solid #ccc;
        padding-top: 10px;
      }
      #adminPanel h3 {
        margin-top: 0;
        text-align: center;
      }
      /* Employees table: keep legacy appearance */
      table#employeesTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      table#employeesTable th,
      table#employeesTable td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
      }

      /* Users table: modern, airy style */
      #usersPanel { margin-top:12px; }
      table#usersTable { 
        width:100%;
        border-collapse:separate; 
        border-spacing:0;
        margin-top:12px; 
        border-radius:10px; 
        overflow:hidden; 
        box-shadow:0 10px 30px rgba(9,30,66,0.04);
      }
      table#usersTable thead th{
        background: linear-gradient(90deg, rgba(11,116,201,0.06), rgba(3,169,244,0.03));
        color:#07345a; font-weight:700; padding:12px 14px; text-align:right; font-size:14px;
        border-bottom: none;
      }
      table#usersTable tbody td{
        background:#fff; padding:12px 14px; border-bottom:1px solid #f1f6fc; color:#122;
        text-align:right; font-size:14px; vertical-align:middle;
      }
      table#usersTable tbody tr:hover td{ background:#f8fbff; }
      /* style action buttons inside users table to look modern */
      #usersTable .small-button{ padding:6px 10px; border-radius:8px; font-size:13px; }
      #usersTable .btn-toggle{ background:#0b74c9; color:#fff; border:none; }
      #usersTable .btn-delete{ background:#e94b4b; color:#fff; border:none; }
      #usersTable .btn-delete[style*="ff9800"]{ background:#ff9800; color:#082233; }
      /* compact inputs and add-user button */
      #usersPanel .input-compact{ padding:9px 10px; border-radius:10px; border:1px solid #eef6ff; box-sizing:border-box; }
      #usersPanel .btn{ padding:9px 12px; border-radius:10px; }
      @media (max-width:720px){
        #usersPanel .panel-row{ flex-direction:column; gap:10px; }
        table#usersTable thead th, table#usersTable tbody td{ text-align:right; }
      }
      .small-button {
        padding: 5px 10px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 3px;
      }
      .btn-edit {
        background-color: #28a745;
        color: white;
        border: none;
      }
      .btn-delete {
        background-color: #dc3545;
        color: white;
        border: none;
      }
      .btn-toggle {
        background-color: #ffc107;
        color: black;
        border: none;
      }
      @media (max-width: 767px) {
        .container {
          padding: 10px;
        }
        input,
        button,
        select {
          font-size: 14px;
          padding: 8px;
        }
        #attendanceTable th,
        #attendanceTable td {
          font-size: 18px;
          padding: 3px;
        }
      }
      .tooltip-wrapper {
        position: relative;
        display: inline-block;
        cursor: help;
      }
      .tooltip-wrapper .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: #361fa7;
        color: #fff;
        text-align: right;
        padding: 8px;
        border-radius: 6px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        right: 50%;
        transform: translateX(50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
        line-height: 1.4;
      }
      .tooltip-wrapper.show .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
      .checkbox-label {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-top: 5px;
      }
      .checkbox-label input[type="checkbox"] {
        transform: none;
        vertical-align: middle;
        margin: 0;
      }
      #sidebarMenu {
        position: fixed;
        top: 0;
        right: 0;
        width: 0;
        height: 100vh;
        background: #fff;
        box-shadow: -2px 0 12px #0002;
        overflow-x: hidden;
        transition: width 0.13s cubic-bezier(0.4, 1.4, 0.6, 1),
          padding-top 0.13s cubic-bezier(0.4, 1.4, 0.6, 1);
        z-index: 5000;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding-top: 0;
      }
      #sidebarMenu.open {
        width: 210px;
        padding-top: 30px;
      }
      #sidebarMenu .sidebar-header {
        width: 100%;
        padding: 14px 18px 8px 18px;
        background: #007bff;
        color: #fff;
        font-size: 16px;
        font-weight: bold;
        text-align: right;
        border-bottom: 1px solid #eee;
        letter-spacing: 0.5px;
      }
      #sidebarMenu button {
        width: 88%;
        margin: 8px 6%;
        padding: 8px;
        font-size: 15px;
        border-radius: 6px;
        border: none;
        background: #f4f4f4;
        color: #333;
        cursor: pointer;
        text-align: right;
        transition: background 0.08s;
      }
      #sidebarMenu button:hover {
        background: #e0e0e0;
        transition: background 0.08s;
      }
      #sidebarToggleBtn,
      #sidebarCloseBtn {
        position: fixed;
        top: 14px;
        right: 14px;
        width: 34px;
        height: 34px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
  z-index: 12001;
        box-shadow: 0 2px 8px #0002;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }
      #sidebarCloseBtn {
        background: rgba(0, 0, 0, 0.08);
        color: #333;
        font-size: 18px;
        border: none;
        box-shadow: none;
        width: 30px;
        height: 30px;
        right: 18px;
        top: 18px;
        opacity: 0.7;
      }
      #sidebarCloseBtn:hover {
        background: #f4f4f4;
        opacity: 1;
      }
      @media (max-width: 600px) {
        #sidebarMenu.open {
          width: 75vw;
          max-width: 340px;
          min-width: 180px;
          border-top-left-radius: 18px;
          border-bottom-left-radius: 18px;
          transition: width 0.13s cubic-bezier(0.4, 1.4, 0.6, 1);
        }
        #sidebarMenu {
          transition: width 0.13s cubic-bezier(0.4, 1.4, 0.6, 1),
            padding-top 0.13s cubic-bezier(0.4, 1.4, 0.6, 1);
          border-top-left-radius: 18px;
          border-bottom-left-radius: 18px;
        }
        #sidebarToggleBtn,
        #sidebarCloseBtn {
          right: 8px;
          top: 8px;
        }
      }
      /* ===== Advances (Ø³Ù„Ù) styles ===== */
      /* Theme tokens */
      :root{ --bg:#fff; --muted:#6b7280; --accent:#0b74c9; --accent-600:#075fa8; --success:#28a745; --danger:#dc3545; --card-shadow: 0 10px 30px rgba(9,30,66,0.06); }
      .adv-card {
        background: linear-gradient(180deg,var(--bg) #fbfdff);
        border: 1px solid rgba(11,116,201,0.06);
        padding: 14px;
        border-radius: 14px;
        box-shadow: var(--card-shadow);
        transition: transform .14s ease, box-shadow .14s ease;
      }
      .adv-card:hover{ transform: translateY(-4px); box-shadow: 0 18px 40px rgba(9,30,66,0.08); }
      .adv-card-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
      .adv-title { margin:0; font-size:16px; color:#07345a; font-weight:700; }
      .adv-card-desc { font-size:13px; color:var(--muted); margin-top:8px; }

      /* Panels & inputs */
      .panel-grid { display:flex; gap:16px; align-items:flex-start; }
      .panel-col { flex:1; min-width:200px; }
      .panel-actions { display:flex; gap:10px; justify-content:flex-end; }
      .input-compact { padding:10px;border-radius:10px;border:1px solid #eef6ff;width:100%;box-sizing:border-box;font-size:14px; background:#fff; transition:box-shadow .12s ease, border-color .12s ease; }
      .input-compact:focus{ outline:none; border-color:var(--accent); box-shadow:0 6px 18px rgba(11,116,201,0.08); }
      .panel-note { font-size:13px;color:var(--muted);margin-top:8px; }
      @media (max-width:720px){ .panel-grid{flex-direction:column;} .panel-actions{justify-content:flex-start;} }

      /* Buttons */
      .btn{ padding:9px 12px;border-radius:10px;border:1px solid transparent;font-size:14px;cursor:pointer; transition: transform .08s ease, box-shadow .08s ease; }
      .btn:active{ transform: translateY(1px); }
      .btn-primary{ background:var(--accent); color:#fff; }
      .btn-primary:hover{ background:var(--accent-600); }
      .btn-ghost{ background:transparent; color:var(--accent); border:1px solid rgba(11,116,201,0.08); }
      .btn-success{ background:var(--success);color:#fff; }

      /* Toggle switch */
      .switch{ position:relative; display:inline-block; width:46px; height:26px; }
      .switch input{ display:none; }
      .switch .slider{ position:absolute; inset:0; background:#eef4fb; border-radius:999px; transition:background .12s ease; }
      .switch .slider:after{ content:''; position:absolute; width:20px; height:20px; left:3px; top:3px; background:#fff; border-radius:50%; box-shadow:0 4px 10px rgba(2,6,23,0.08); transition:transform .14s cubic-bezier(.2,.9,.2,1); }
      .switch input:checked + .slider{ background:linear-gradient(90deg,var(--accent),var(--accent-600)); }
      .switch input:checked + .slider:after{ transform: translateX(20px); }

      /* Next backup small styles */
      .next-backup{ font-size:13px; color:var(--muted); }
      .next-backup-rel{ font-size:12px; color:#98a3b2; }

      /* Toast */
      .toast-wrap{ position:fixed; right:18px; bottom:18px; z-index:16000; display:flex; flex-direction:column; gap:10px; }
      .toast{ min-width:200px; padding:10px 14px; border-radius:10px; color:#fff; box-shadow:0 8px 28px rgba(2,6,23,0.12); opacity:0; transform:translateY(8px); transition:opacity .18s ease, transform .18s ease; }
      .toast-show{ opacity:1; transform:translateY(0); }
      .toast.info{ background:#0b74c9; }
      .toast.success{ background:var(--success); }
      .toast.error{ background:var(--danger); }

      /* small helpers */
      .muted { color:var(--muted); }
      
      /* Responsive helper panels for Telegram & Salary */
      .panel-grid { display:flex; gap:14px; align-items:flex-start; }
      .panel-col { flex:1; min-width:220px; }
      .panel-actions { display:flex; gap:8px; justify-content:flex-end; }
      .input-compact { padding:8px;border-radius:8px;border:1px solid #e6eefc;width:100%;box-sizing:border-box;font-size:14px; }
      .panel-note { font-size:13px;color:#6b7280;margin-top:6px; }
      @media (max-width:720px){ .panel-grid{flex-direction:column;} .panel-actions{justify-content:flex-start;} }
      .adv-add { background:#0069d9; color:#fff; border:none; padding:8px 10px; border-radius:8px; }
      .adv-add:hover { background:#005bb5; }
      .adv-table-wrap { margin-top:10px; overflow-x:auto; }
      .advances-table { width:100%; border-collapse:collapse; min-width:620px; }
      .advances-table th, .advances-table td { padding:10px 8px; border-bottom:1px solid #eef2ff; text-align:center; font-size:14px; }
      .advances-table thead th { background:#f1f5f9; color:#082233; font-weight:700; }
      .advances-table tbody tr:hover { background: #fbfdff; }
      .advances-table .btn-delete { background:#e63946; color:#fff; padding:6px 8px; border-radius:6px; border:none; }
      /* Modal overrides for advance modal (id used in JS) */
      #advanceModal { position:fixed; inset:0; background:rgba(2,6,23,0.45); z-index:12000; display:flex; align-items:center; justify-content:center; }
      #advanceModal > div { background:#fff; border-radius:12px; padding:18px; max-width:420px; width:94vw; box-shadow:0 12px 36px rgba(2,6,23,0.18); direction:rtl; text-align:right; }
      #advanceModal h3 { margin:0 0 8px 0; color:#0b3b66; }
      #advanceModal label { display:block; font-size:13px; color:#374151; margin-top:8px; }
      #advanceModal input[type="text"], #advanceModal input[type="number"], #advanceModal input[type="date"], #advanceModal select { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #e6eefc; box-sizing:border-box; }
      #advanceModal .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
      #advanceModal .small-button { padding:8px 12px; border-radius:8px; }
      @media (max-width: 520px) {
        .advances-table { min-width:460px; }
        .adv-card { padding:10px; }
        .adv-title { font-size:15px; }
        #advanceModal > div { padding:14px; }
        .advances-table th, .advances-table td { padding:8px 6px; font-size:13px; }
      }
    </style>
  </head>
  <body>
    <!-- Maintenance overlay (global) -->
    <div id="maintenanceOverlay" role="alert" aria-live="assertive" tabindex="0">
      <div class="overlay-bg">
        <div class="sparkles" aria-hidden="true">
          <span></span><span></span><span></span><span></span><span></span><span></span>
        </div>
      </div>
      <div class="box">
        <h2 class="shimmer">â—  System Error   <span class="maintenancePulse" aria-hidden="true"></span></h2>
        <p id="maintenanceMessageText"> Ù†Ø¹ØªØ°Ø±ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠÙˆØ§Ø¬Ù‡ Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ© Ù…ÙØ§Ø¬Ø¦Ø© ØªÙ…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. ØªØ¬Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.  </p> 
        <div class="sub">Error Reference: #500-xc9 | Request ID: 1f4a-7b22</div>
      </div>
    </div>
    <!-- PDF progress overlay -->
    <div id="pdfProgressOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:2147483650;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:12px;padding:18px 20px;max-width:420px;width:90%;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,0.4);">
        <div id="pdfProgressIcon" style="font-size:32px;margin-bottom:8px;">ğŸ”„</div>
        <div id="pdfProgressText" style="font-weight:700;color:#0b66c3;margin-bottom:8px">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡...</div>
        <div style="height:10px;background:#eef3fb;border-radius:8px;overflow:hidden;margin-bottom:12px;">
          <div id="pdfProgressBar" style="width:0%;height:100%;background:#1976d2;transition:width 300ms ease;"></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:center;">
          <button id="pdfProgressCloseBtn" style="display:none;background:#1976d2;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
    <div class="container">
      <!-- Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… -->
      <div
        id="dayDetailsModal"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0, 0, 0, 0.18);
          z-index: 10000;
          align-items: center;
          justify-content: center;
        "
      >
        <div
          style="
            background: #fff;
            max-width: 420px;
            width: 97vw;
            max-height: 90vh;
            overflow: auto;
            border-radius: 16px;
            box-shadow: 0 8px 32px #0002;
            padding: 28px 18px 18px 18px;
            position: relative;
            display: flex;
            flex-direction: column;
          "
        >
          <button
            id="closeDayDetailsModal"
            style="
              position: absolute;
              top: 10px;
              left: 10px;
              background: #dc3545;
              color: white;
              border: none;
              border-radius: 50%;
              width: 32px;
              height: 32px;
              font-size: 18px;
              cursor: pointer;
            "
          >
            âœ–
          </button>
          <div
            id="dayDetailsTitle"
            style="
              font-size: 20px;
              color: #1976d2;
              font-weight: 600;
              text-align: center;
              margin-bottom: 12px;
            "
          ></div>
          <div id="dayDetailsTable"></div>
          <div id="dayDetailsStatus" style="margin-top: 10px; font-size: 14px; text-align: center"></div>

          <!-- App version (single-source) - inserts ribbon below the attendance table when present; falls back to fixed bottom ribbon -->
          <style>
            /* Inline ribbon style (default when injected below the table) */
            .app-version-ribbon{
              position:relative; /* becomes static/flow element when inserted after table */
              display:inline-flex;
              gap:10px;
              align-items:center;
              background:linear-gradient(90deg, rgba(11,102,195,0.08), rgba(3,169,244,0.03));
              color:#07345a;
              padding:8px 14px;
              border-radius:18px;
              font-size:13px;
              box-shadow:0 8px 26px rgba(6,35,58,0.10);
              border:1px solid rgba(11,102,195,0.08);
              cursor:pointer;
              min-width:220px;
              justify-content:center;
            }
            /* Fixed variant used as fallback if table not found */
            .app-version-ribbon.fixed{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:2147483000;backdrop-filter: blur(6px) saturate(120%)}
            .app-version-ribbon strong{color:#0b66c3}
            .app-version-ribbon .info-dot{width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#fff;color:#0b66c3;font-weight:700;border:1px solid rgba(11,102,195,0.06);box-shadow:0 2px 8px rgba(6,35,58,0.06);display:none}
            @media (max-width:640px){
              .app-version-ribbon{font-size:12px;padding:7px 12px;min-width:160px}
            }

            /* Container to center under table */
            .app-version-container{display:flex;justify-content:center;margin-top:12px;width:100%}

            /* Modal/popover for details */
            .app-version-modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:2147483050}
            .app-version-modal{background:#fff;max-width:560px;width:92%;padding:18px;border-radius:12px;box-shadow:0 18px 40px rgba(6,35,58,0.18);color:#123;}
            .app-version-modal h3{margin:0 0 8px 0;font-size:16px;color:#0b66c3}
            .app-version-modal p{margin:6px 0 0 0;font-size:14px;line-height:1.4}
            .app-version-modal .close-btn{display:inline-block;margin-top:12px;padding:8px 12px;border-radius:8px;background:#0b66c3;color:#fff;cursor:pointer}
          </style>

          <script>

            function renderAppVersion(){
              try{
                var label = document.getElementById('appVersionLabel');
                if(label){
                  label.innerHTML = 'Ø§Ù„Ø¥ØµØ¯Ø§Ø±: <strong>'+window.APP_VERSION.version+'</strong>' + ' â€” Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: '+window.APP_VERSION.updated;
                }
                // modal fields
                var mv = document.getElementById('modalVersion'); if(mv) mv.textContent = window.APP_VERSION.version;
                var mu = document.getElementById('modalUpdated'); if(mu) mu.textContent = window.APP_VERSION.updated;
                var mn = document.getElementById('modalNotes'); if(mn) mn.textContent = window.APP_VERSION.notes || '';
              }catch(e){ console && console.warn && console.warn('renderAppVersion error', e); }
            }

            // Public helpers to update/read the version at runtime.
            window.setAppVersion = function(version, updated, notes){
              if(typeof version === 'object'){
                window.APP_VERSION = Object.assign({}, window.APP_VERSION, version);
              } else {
                if(version) window.APP_VERSION.version = version;
                if(updated) window.APP_VERSION.updated = updated;
                if(notes) window.APP_VERSION.notes = notes;
              }
              renderAppVersion();
            };
            window.getAppVersion = function(){ return Object.assign({}, window.APP_VERSION); };

            // modal removed: provide a no-op placeholder so other scripts calling it won't crash
            function showAppVersionModal(show){
              // no-op: modal intentionally removed to keep ribbon minimal
              console && console.debug && console.debug('showAppVersionModal called but modal removed');
            }

            function insertAfter(refNode, newNode){
              if(refNode && refNode.parentNode){
                if(refNode.nextSibling) refNode.parentNode.insertBefore(newNode, refNode.nextSibling);
                else refNode.parentNode.appendChild(newNode);
              }
            }

            // Initialize interactivity and move ribbon under the attendance table if present
            function initVersionUI(){
              var ribbon = document.getElementById('appVersionRibbon');
              var backdrop = null;
              var close = null;

              // Prefer to place the ribbon under the employee-stats table if it exists
              try{
                var placed = false;
                // 1) If there's a specific stats container rendered by the page, insert after it
                var statsContainer = document.getElementById('empStatsBelowTable');
                if(statsContainer && ribbon){
                  var container = document.createElement('div');
                  container.className = 'app-version-container';
                  ribbon.classList.remove('fixed');
                  container.appendChild(ribbon);
                  insertAfter(statsContainer, container);
                  placed = true;
                }

                // 2) If the page builds a table with class 'emp-stats-table-official', insert after that table
                if(!placed){
                  var tbl = document.querySelector('table.emp-stats-table-official');
                  if(tbl && ribbon){
                    var container2 = document.createElement('div');
                    container2.className = 'app-version-container';
                    ribbon.classList.remove('fixed');
                    container2.appendChild(ribbon);
                    insertAfter(tbl, container2);
                    placed = true;
                  }
                }

                // 3) fallback to attendanceTable (previous behavior)
                if(!placed){
                  var table = document.getElementById('attendanceTable');
                  if(table && ribbon){
                    var container3 = document.createElement('div');
                    container3.className = 'app-version-container';
                    ribbon.classList.remove('fixed');
                    container3.appendChild(ribbon);
                    insertAfter(table, container3);
                    placed = true;
                  }
                }

                // if nothing matched, leave ribbon fixed (fallback)
              }catch(e){ /* ignore placement errors and keep ribbon fixed */ }

              // Keep ribbon non-interactive (plain display). Still allow keyboard focus if needed.
              if(ribbon){
                ribbon.setAttribute('role','status');
                ribbon.setAttribute('tabindex','0');
                ribbon.addEventListener('keydown', function(e){ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); /* no modal */ } });
              }
              // modal removed; nothing to bind
              renderAppVersion();
            }

            if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initVersionUI);
            else initVersionUI();
          </script>
        </div>
      </div>
      <!-- Ø¹Ù†ØµØ± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ -->
      <div
        id="loaderSpinner"
        style="
          display: none;
          justify-content: center;
          align-items: center;
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(255, 255, 255, 0.55);
          z-index: 99999;
        "
      >
        <div style="display: flex; flex-direction: column; align-items: center">
          <div
            style="
              background: linear-gradient(135deg, #e3f0ff 60%, #cbe6ff 100%);
              padding: 10px;
              border-radius: 50%;
              box-shadow: 0 6px 32px #1976d244;
              display: flex;
              justify-content: center;
              align-items: center;
              margin-bottom: 12px;
            "
          >
            <img
              id="loaderUserImg"
              src="sticker.webp"
              alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
              style="
                width: 140px;
                height: 140px;
                border-radius: 50%;
                object-fit: cover;
                object-position: top center;
                box-shadow: 0 2px 18px #1976d244;
              "
            />
          </div>
          <div
            style="
              color: #1976d2;
              font-size: 20px;
              font-weight: 600;
              letter-spacing: 0.5px;
            "
          >
            Ø§ØµØ¨Ø± Ø§Ù„Ù†Øª Ø¶Ø¹ÙŠÙ ÙˆØ§Ù„Ù„Ù‡...
          </div>
          <div style="color: #555; font-size: 15px; margin-top: 7px">
            ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
          </div>
        </div>
        <style>
          .loader-user-img {
            animation: rotateUserImg 1.1s linear infinite;
          }
          @keyframes rotateUserImg {
            0% {
              transform: rotate(0deg);
            }
            100% {
              transform: rotate(360deg);
            }
          }
        </style>
      </div>

      <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
      <div id="loginBox">
        <div
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 22px;
          "
        >
          <div class="login-user-img-wrapper">
            <img
              src="sticker.webp"
              alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
              class="login-user-img"
            />
          </div>
        </div>
        <style>
          .login-user-img-wrapper {
            background: linear-gradient(
              135deg,
              #90caf9 0%,
              #e3f0ff 60%,
              #cbe6ff 100%
            );
            padding: 13px;
            border-radius: 50%;
            box-shadow: 0 8px 32px #1976d244, 0 2px 18px #1976d244;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: box-shadow 0.2s, transform 0.2s;
          }
          .login-user-img-wrapper:hover {
            box-shadow: 0 16px 48px #1976d288, 0 4px 24px #1976d244;
            transform: scale(1.04);
          }
          .login-user-img {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            object-fit: cover;
            object-position: top center;
            box-shadow: 0 2px 18px #1976d244, 0 0px 0px #fff;
            border: 4px solid #fff;
            transition: box-shadow 0.2s, border 0.2s;
          }
          .login-user-img-wrapper:hover .login-user-img {
            box-shadow: 0 8px 32px #1976d288, 0 2px 18px #1976d244;
            border: 4px solid #90caf9;
          }
        </style>
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input
          type="text"
          id="username"
          placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
          autocomplete="off"
        />
        <input
          type="password"
          id="password"
          placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
          autocomplete="off"
        />
        <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        <div id="loginMessage"></div>
        <div
          style="
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #555;
            font-style: italic;
            line-height: 1.3;
          "
        >
          Ø¨ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø³Ø¬Ø§Ø¯ Ø±Ø´ÙŠØ¯<br />
          insta: e ._ mg
        </div>
      </div>

      <script>
        // ===== Maintenance mode feature =====
        // Shows a full-screen black overlay for non-admin users when maintenance is enabled in DB.
        (function(){
          async function setMaintenanceState(enabled, reason, message){
            if(typeof db === 'undefined' || !db || typeof db.ref !== 'function'){
              alert('Ø®Ø·Ø£: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
              return;
            }
            try{
              const payload = { enabled: !!enabled, setBy: currentUser || 'unknown', at: formatDateTimeNoSeconds(new Date()), reason: reason || '', message: message || null };
              await db.ref('system/maintenance').set(payload);
              // write a small signal to force immediate propagation and to support some listeners
              try{ await db.ref('system/maintenance/signal').set(Date.now()); }catch(e){}
              // Apply the state locally immediately (include message if provided)
              try{ applyMaintenanceState(payload); }catch(e){}
              // broadcast to other tabs in same browser for instant feedback
              try{ localStorage.setItem('maintenanceSignal', JSON.stringify({ts:Date.now(), enabled: !!enabled})); }catch(e){}
              logActivity(enabled ? 'ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©' : 'Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©', `ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© ${enabled ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'} Ù…Ù† Ù‚Ø¨Ù„: ${currentUser || 'unknown'}`);
              try{ applyMaintenanceState(payload); }catch(e){}
            }catch(e){ console.error('setMaintenanceState error', e); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¶Ø¨Ø· ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©'); }
          }

          function applyMaintenanceState(state){
            try{
              const overlay = document.getElementById('maintenanceOverlay');
              const statusText = document.getElementById('maintenanceStatusText');
              const infoEl = document.getElementById('maintenanceInfo');
              const toggleBtn = document.getElementById('toggleMaintenanceBtn');
              const isAdmin = (typeof currentUserRole !== 'undefined' && currentUserRole === 'admin');
              const enabled = state && state.enabled;
              if(statusText) statusText.textContent = enabled ? 'Ù…ÙØ¹Ù„' : 'ØºÙŠØ± Ù…ÙØ¹Ù„';
              if(infoEl) infoEl.textContent = enabled ? `ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© ${state.setBy || 'â€”'} ÙÙŠ ${state.at || 'â€”'}${state.reason ? (' â€” ' + state.reason) : ''}` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª';
              // set the message text in overlay and update textarea
              try{
                const overlayMsg = document.getElementById('maintenanceMessageText');
                const txtArea = document.getElementById('maintenanceCustomMessage');
                const message = (state && state.message) ? state.message : 'Ù†Ø¹ØªØ°Ø±ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠÙˆØ§Ø¬Ù‡ Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ© Ù…ÙØ§Ø¬Ø¦Ø© ØªÙ…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. ØªØ¬Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.';
                if(overlayMsg) overlayMsg.textContent = message;ØªØ­
                if(txtArea && document.activeElement !== txtArea) txtArea.value = message;
              }catch(e){}
              if(toggleBtn) {
                toggleBtn.textContent = enabled ? 'Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©' : 'ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©';
                toggleBtn.style.background = enabled ? '#4caf50' : '#ff9800';
              }
              // Show overlay for everyone except admins
              if(overlay){
                if(enabled && !isAdmin){
                  // show with animation-friendly approach
                  overlay.style.display = 'flex';
                  overlay.classList.remove('hide');
                  requestAnimationFrame(() => { overlay.classList.add('show'); try{ overlay.focus(); }catch(e){} });
                  try{ document.documentElement.style.overflow = 'hidden'; }catch(e){}
                } else {
                  // hide with class removal then hide after animation
                  overlay.classList.remove('show');
                  overlay.classList.add('hide');
                  try{ overlay.blur(); }catch(e){}
                  // after animation settle, hide the element
                  setTimeout(() => { try{ if(!overlay.classList.contains('show')) overlay.style.display = 'none'; overlay.classList.remove('hide'); }catch(e){} }, 420);
                  try{ document.documentElement.style.overflow = ''; }catch(e){}
                }
              }
              try{ if(typeof updateSidebarVisibility === 'function') updateSidebarVisibility(); }catch(e){}
            }catch(e){ console.error('applyMaintenanceState error', e); }
          }

          // Ask for confirmation and optionally a reason before toggling maintenance
          window.toggleMaintenanceRequest = function(){
            if(!currentUserRole || currentUserRole !== 'admin') { alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­: Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·'); return; }
            if(typeof db === 'undefined' || !db || typeof db.ref !== 'function'){ alert('Ø®Ø·Ø£: Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©'); return; }
            db.ref('system/maintenance').once('value').then((snap)=>{
              const state = snap.val() || { enabled: false };
              if(!state.enabled){
                // enabling
                const reason = prompt('Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):', '');
                // Use the custom message from textarea if present
                const msgEl = document.getElementById('maintenanceCustomMessage');
                const customMsg = (msgEl && msgEl.value) ? msgEl.value.trim() : null;
                showConfirmModal('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©ØŸ', async () => { await setMaintenanceState(true, reason, customMsg); }, null);
              } else {
                // disabling
                showConfirmModal('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø¢Ù†ØŸ', async () => { await setMaintenanceState(false, ''); }, null);
              }
            });
          };

          // Attach DB listener to reflect real-time changes in UI
          var _maintenanceListenersAttached = false;
          function attachMaintenanceListeners(){
            try{
              if(_maintenanceListenersAttached) return;
              if(typeof db === 'undefined' || !db || typeof db.ref !== 'function'){
                // retry later when db is loaded
                setTimeout(attachMaintenanceListeners, 550);
                return;
              }
              _maintenanceListenersAttached = true;
              db.ref('system/maintenance').on('value', (snap) => {
                applyMaintenanceState(snap.val());
              });
              // Listen for the signal node as well (wakes some clients quicker)
              db.ref('system/maintenance/signal').on('value', async (snap) => {
                try{
                  const s = await db.ref('system/maintenance').once('value');
                  applyMaintenanceState(s.val());
                }catch(e){ console.warn('signal listener error', e); }
              });
            }catch(e){ console.warn('attachMaintenanceListeners error', e); }
          }
          attachMaintenanceListeners();

          // Make sure overlay is applied if maintenance is already enabled on load
          document.addEventListener('DOMContentLoaded', function(){
            if(typeof db !== 'undefined' && db && typeof db.ref === 'function'){
              db.ref('system/maintenance').once('value').then((snap) => {
                applyMaintenanceState(snap.val());
              }).catch(()=>{});
            }
            // Wire button now we are sure the DOM is ready
            try{ const btn = document.getElementById('toggleMaintenanceBtn'); if(btn) btn.addEventListener('click', toggleMaintenanceRequest); }catch(e){}
            try{ const saveBtn = document.getElementById('saveMaintenanceMsgBtn'); if(saveBtn) saveBtn.addEventListener('click', async function(){
              if(!currentUserRole || currentUserRole !== 'admin') return alert('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­: Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§ØµÙŠØ© Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·');
              const txtArea = document.getElementById('maintenanceCustomMessage'); if(!txtArea) return;
              const val = txtArea.value.trim();
              if(typeof db === 'undefined' || !db || typeof db.ref !== 'function'){
                try{ localStorage.setItem('maintenanceMessage', val); alert('âœ… ØªÙ… Ø­ÙØ¸ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹'); }catch(e){ alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
                return;
              }
              try{
                await db.ref('system/maintenance').update({ message: val, messageUpdatedBy: currentUser || 'unknown', messageUpdatedAt: formatDateTimeNoSeconds(new Date()) });
                // fetch updated state
                const snap = await db.ref('system/maintenance').once('value');
                const state = snap.val() || {};
                try{ await db.ref('system/maintenance/signal').set(Date.now()); }catch(e){}
                try{ localStorage.setItem('maintenanceSignal', JSON.stringify({ts:Date.now(), enabled: !!state.enabled})); }catch(e){}
                applyMaintenanceState(state);
                alert('âœ… ØªÙ… Ø­ÙØ¸ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©');
                logActivity('ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©', `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¥Ù„Ù‰: ${val}`);
              }catch(err){ console.error(err); alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©'); }
            }); }catch(e){}
            // Listen for localStorage broadcasts for cross-tab instant updates
            try{ window.addEventListener('storage', function(e){ if(e.key === 'maintenanceSignal'){ try{ db.ref('system/maintenance').once('value').then((snap) => applyMaintenanceState(snap.val())).catch(()=>{}); }catch(err){} } }); }catch(e){}
          });
        })();
        // Ensure login box is visible immediately if there's no saved session.
        (function(){
          try{
            var saved = localStorage.getItem('loggedUser');
            var lb = document.getElementById('loginBox');
            var main = document.getElementById('mainContent');
            var admin = document.getElementById('adminPanel');
            var loader = document.getElementById('loaderSpinner');
            if (!saved) {
              if (lb) lb.style.display = 'block';
              if (main) main.style.display = 'none';
              if (admin) admin.style.display = 'none';
              if (loader) loader.style.display = 'none';
            } else {
              // if session exists, keep loader visible until main UI initializes
              if (loader) loader.style.display = 'flex';
              if (lb) lb.style.display = 'none';
            }
          }catch(e){console && console.warn && console.warn('init loginBox script error', e)}
        })();
      </script>

      <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
      <div id="mainContent">
        <h2>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
        <!-- PDF download removed as requested -->
        <table id="attendanceTable">
          <thead>
            <tr>
              <th
                id="dateHeaderTh"
                style="
                  background: linear-gradient(90deg, #e3f0ff 0%, #cbe6ff 100%);
                  color: #1976d2;
                  font-weight: bold;
                  font-size: 18px;
                  border-bottom: 2.5px solid #90caf9;
                  letter-spacing: 0.5px;
                  display: none;
                "
              >
                Ø§Ù„ØªØ§Ø±ÙŠØ®
              </th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <style>
          .day-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
          }
          .day-details-table th,
          .day-details-table td {
            border: 1px solid #e0e0e0;
            padding: 7px 4px;
            text-align: center;
          }
          .day-details-table th {
            background: #e3f0ff;
            color: #1976d2;
            font-size: 16px;
          }
          .day-details-select {
            width: 100%;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 15px;
          }
          .day-details-user {
            font-size: 13px;
            color: #888;
          }
          .day-details-time {
            font-size: 12px;
            color: #aaa;
          }
          @media (max-width: 600px) {
            .day-details-table th,
            .day-details-table td {
              font-size: 13px;
              padding: 5px 2px;
            }
          }
        </style>
        <button onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button
          onclick="logout()"
          style="background-color: #dc3545; margin-top: 10px"
        >
          ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
        </button>
        <h3 style="margin-top: 20px">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <div id="statsBox">â€”</div>
        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
        <!-- Ø²Ø± Ø§Ø­ØµØ§Ø¦ÙŠÙ‡ Ø§Ù„ÙƒØ¹Ø¯Ù‡ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆÙ‚Ø¨Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙƒÙ„ÙŠ -->
        <div style="display: flex; justify-content: flex-start; margin-top: 30px; margin-bottom: -10px;">
          <a href="#" class="myButton" id="showKadahStatsBtn">Ø§Ø­ØµØ§Ø¦ÙŠÙ‡ Ø§Ù„ÙƒØ¹Ø¯Ù‡</a>
          <a href="#" class="myButton closeKadahBtn" id="closeKadahStatsBtn" style="display:none; margin-right:10px;">Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„</a>
        </div>
        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ¹Ø¯Ù‡ Ù…Ø®ÙÙŠ -->
  <div id="kadahStatsTableWrapper" style="display:none; max-width:520px; margin:22px auto 0 auto;">
          <div style="overflow-x:auto;">
            <table id="kadahStatsTable" class="kadah-stats-table">
              <thead>
                <tr>
                  <th class="kadah-head">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th class="kadah-head">600</th>
                  <th class="kadah-head">22</th>
                  <th class="kadah-head">Ù…Ø´ØªØ±ÙƒØ©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div id="empStatsBelowTable" style="margin: 30px 0 0 0"></div>
      </div>
      <style>
      #kadahStatsTableWrapper {
        transition: max-height 0.4s, opacity 0.4s;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
      }
      #kadahStatsTableWrapper.show {
        display: block !important;
        max-height: 600px;
        opacity: 1;
        overflow: auto;
      }
      .kadah-stats-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 10px;
  background: #fff;
  border: 1.5px solid #ccc;
  border-radius: 7px;
  box-shadow: none;
  font-family: 'Segoe UI', Arial, sans-serif;
  overflow: hidden;
  transition: border 0.2s;
      }
      .kadah-stats-table th, .kadah-head {
  padding: 10px 7px;
  text-align: center;
  font-weight: bold;
  font-size: 16px;
  letter-spacing: 0.3px;
  border-bottom: 1.5px solid #ccc;
  border-right: 1px solid #ccc;
  border-left: 1px solid #ccc;
  border-top-left-radius: 7px;
  border-top-right-radius: 7px;
  background: linear-gradient(90deg, #283e51 0%, #6a82fb 100%);
  color: #fff;
  box-shadow: 0 2px 12px #6a82fb44;
      }
      .kadah-stats-table th:first-child {
  background: #c8e6c9;
  color: #388e3c;
  border-top-left-radius: 10px;
      }
      .kadah-stats-table th:nth-child(2) {
  background: #ffe0b2;
  color: #f57c00;
      }
      .kadah-stats-table th:nth-child(3) {
  background: #bbdefb;
  color: #1976d2;
      }
      .kadah-stats-table th:last-child {
  background: #e1bee7;
  color: #8e24aa;
  border-top-right-radius: 10px;
      }
      .kadah-stats-table td {
  padding: 8px 5px;
  text-align: center;
  font-size: 13px;
  background: #fff;
  color: #444;
  border-bottom: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-left: 1px solid #ccc;
  transition: background 0.2s, color 0.2s;
  font-weight: 500;
      }
      .kadah-stats-table tr {
        transition: box-shadow 0.2s;
      }
      .kadah-stats-table tr:nth-child(even) td {
  background: #f7f7fa;
      }
      .kadah-stats-table tr:hover td {
  background: #e3eafc;
  color: #222;
      }
      .kadah-stats-table td:first-child {
  font-weight: 600;
  color: #009688;
  font-size: 16px;
  background: #e3f7ee;
  border-radius: 12px;
  border-right: 1px solid #e0eafc;
      }
      .kadah-stats-table td.kadah-600 {
  background: #fffbe3;
  color: #ff9800;
  border-radius: 12px;
  font-weight: 500;
  border-right: 1px solid #e0eafc;
      }
      .kadah-stats-table td.kadah-22 {
  background: #e3eafc;
  color: #1976d2;
  border-radius: 12px;
  font-weight: 500;
  border-right: 1px solid #e0eafc;
      }
      .kadah-stats-table td.kadah-msh {
  background: #f3e3ff;
  color: #673ab7;
  border-radius: 12px;
  font-weight: 500;
  border-right: 1px solid #e0eafc;
      }
      @media (max-width: 767px) {
        .kadah-stats-table th {
          font-size: 13px;
          padding: 6px 2px;
          border-top-left-radius: 8px;
          border-top-right-radius: 8px;
        }
        .kadah-stats-table td {
          font-size: 11px;
          padding: 5px 2px;
        }
        .kadah-stats-table td:first-child {
          font-size: 11px;
        }
      }
      .myButton {
        box-shadow: 0px 0px 6px 2px #54a3f7;
        background:linear-gradient(to bottom, #007dc1 5%, #2885c7 100%);
        background-color:#007dc1;
      border-radius:16px;
      border:1px solid #0a4e7d;
        display:inline-block;
        cursor:pointer;
        color:#ffffff;
        font-family:Arial;
        font-size:16px;
      padding:5px 21px;
        text-decoration:none;
      }
      .myButton:hover {
        background:linear-gradient(to bottom, #2885c7 5%, #007dc1 100%);
        background-color:#2885c7;
      }
      .myButton:active {
        position:relative;
        top:1px;
      }
      /* Ø²Ø± Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
      .closeKadahBtn {
  box-shadow: 0px 0px 8px 2px #e57373;
  background: linear-gradient(90deg, #ffe3e3 0%, #ffd6d6 100%);
  background-color: #ffe3e3;
  border-radius: 22px;
  border: 1.5px solid #d91842;
  color: #c62828;
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 13px;
  font-weight: bold;
  font-style: normal;
  padding: 7px 18px;
  letter-spacing: 0.5px;
  transition: background 0.2s, color 0.2s;
      }
      .closeKadahBtn:hover {
  background: linear-gradient(90deg, #ffd6d6 0%, #ffe3e3 100%);
  background-color: #fff0f0;
  color: #b71c1c;
      }
      .closeKadahBtn:active {
  position: relative;
  top: 1px;
  background: #ffcdd2;
  color: #d32f2f;
      }
      </style>

      <!-- Ù…ÙƒØ§Ù† Ø¸Ù‡ÙˆØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø£Ø³ÙÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
      <div id="empStatsBelowTable" style="margin: 30px 0 0 0"></div>
      <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù€ Admin -->
      <div id="adminPanel" style="display: none; position:relative;">
        <!-- small inline edit button (top-left) to match requested placement; icon-only circular control -->
        <button id="aboutPanelEditInline" title="ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ù†Ø­Ù†" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ù†Ø­Ù†" style="position:absolute;left:10px;top:10px;width:36px;height:36px;background:#ffc107;border:none;border-radius:50%;display:none;cursor:pointer;padding:0;align-items:center;justify-content:center;display:flex;box-shadow:0 6px 14px rgba(0,0,0,0.12);">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="#082233"/>
            <path d="M20.71 7.04a1.003 1.003 0 000-1.42l-2.34-2.34a1.003 1.003 0 00-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="#082233"/>
          </svg>
        </button>
        <h3 style="text-align:center;margin:8px 0">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
        <!-- Ø²Ø± Ø³Ø±ÙŠØ¹ Ù„ØªØ­Ø±ÙŠØ± ÙÙ‚Ø±Ø© Ù…Ù† Ù†Ø­Ù† Ø¯Ø§Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ±) - compact icon button so it won't be wide -->
        <button id="aboutPanelEditBtn" title="ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ù†Ø­Ù†" style="display:none;width:36px;height:36px;background:#ffc107;border:none;border-radius:50%;padding:0;cursor:pointer;align-items:center;justify-content:center;display:flex;box-shadow:0 6px 14px rgba(0,0,0,0.08);">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z" fill="#082233"/>
            <path d="M20.71 7.04a1.003 1.003 0 000-1.42l-2.34-2.34a1.003 1.003 0 00-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="#082233"/>
          </svg>
        </button>
        <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
        <input
          type="text"
          id="newEmployeeName"
          placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯"
        />
        <button onclick="addEmployee()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
        <table id="employeesTable">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="employeesBody"></tbody>
        </table>
        <!-- ====== Ù‚Ø³Ù… Ø§Ù„Ø³Ù„Ù (Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·) ====== -->
        <div id="advancesAdminSection" class="adv-card" style="margin-top:18px;">
          <div class="adv-card-header">
            <h4 class="adv-title">Ø³Ø¬Ù„ Ø§Ù„Ø³Ù„Ù</h4>
            <button id="openAddAdvanceBtn" class="small-button adv-add">â• Ø¥Ø¶Ø§ÙØ© Ø³Ù„ÙØ©</button>
          </div>
          <div class="adv-card-desc">ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø¯ÙŠØ± ØªØ³Ø¬ÙŠÙ„ Ø³Ù„Ù Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù‡Ù†Ø§ ÙˆØ³ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙƒÙ„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
          <div class="adv-table-wrap">
            <table id="advancesTable" class="advances-table">
              <thead>
                <tr>
                  <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                  <th>Ø­Ø°Ù</th>
                </tr>
              </thead>
              <tbody id="advancesBody"></tbody>
            </table>
          </div>
        </div>
        <hr />
        <div id="usersPanel" class="adv-card">
          <div class="adv-card-header">
            <h4 class="adv-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
            <div style="text-align:right; font-size:13px; color:#6b7280">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</div>
          </div>
          <div class="adv-card-desc">Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>

          <div class="panel-row" style="display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap;">
            <input type="text" id="newUserName" class="input-compact" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" />
            <input type="password" id="newUserPass" class="input-compact" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
            <label class="checkbox-label" style="display:flex;align-items:center;gap:8px;">
              <input type="checkbox" id="newUserCanEdit" checked />
              <span class="muted">ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„</span>
            </label>
            <button class="btn btn-primary" onclick="addUser()">â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…</button>
          </div>

          <div style="margin-top:12px;overflow:auto;">
            <table id="usersTable">
              <thead>
                <tr>
                  <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                  <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                  <th>ØªØºÙŠÙŠØ±</th>
                  <th>Ø­Ø°Ù</th>
                  <th>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</th>
                </tr>
              </thead>
              <tbody id="usersBody"></tbody>
            </table>
          </div>
        </div>
        <!-- Maintenance control (Admin only) -->
        <div id="maintenanceControl" style="margin-top:14px;padding:12px;border-radius:10px;background:#fff;box-shadow:0 1px 6px #0002;border:1px solid #e6eefc;display:flex;flex-direction:column;gap:8px;align-items:flex-start;">
          <h4 style="margin:0 0 6px 0">ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</h4>
          <div style="display:flex;align-items:center;gap:10px;width:100%;justify-content:space-between;">
            <div style="display:flex;flex-direction:column;align-items:flex-start;">
              <div id="maintenanceStatus"><strong id="maintenanceStatusText">ØºÙŠØ± Ù…ÙØ¹Ù„</strong></div>
              <div id="maintenanceInfo" style="font-size:12px;color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;align-items:center;">
              <button id="toggleMaintenanceBtn" class="small-button" style="background:#bd2121;">ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
            </div>
          </div>
          <div style="width:100%;display:flex;flex-direction:column;gap:6px;margin-top:8px;">
            <label style="font-size:13px;color:#334;">Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</label>
            <textarea id="maintenanceCustomMessage" placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ù‡Ù†Ø§" style="width:100%;min-height:52px;padding:8px;border-radius:8px;border:1px solid #e0e6f8;box-sizing:border-box;"> </textarea>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button id="saveMaintenanceMsgBtn" class="small-button" style="background:#1976d2;color:#fff;">Ø­ÙØ¸ Ø§Ù„Ù†Øµ</button>
            </div>
          </div>
        </div>
        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (Admin only) -->
        <div id="telegramSettings" class="adv-card" style="margin-top:14px;">
          <div class="adv-card-header">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#e9f6ff,#f3fbff);display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ“¡</div>
              <div>
                <h4 class="adv-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</h4>
                <div class="adv-card-desc">ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª Ø¨Ø³Ù‡ÙˆÙ„Ø©.</div>
              </div>
            </div>
            <div style="text-align:right;">
              <div id="telegramNextBackup" class="next-backup">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©: -</div>
              <div id="telegramNextBackupRelative" class="next-backup-rel"></div>
            </div>
          </div>

          <div style="margin-top:12px;" class="panel-grid">
            <div class="panel-col">
              <label class="muted">Bot Token</label>
              <input type="text" id="telegramBotToken" class="input-compact" placeholder="Ø£Ø¯Ø®Ù„ Bot Token Ù…Ù† @BotFather" autocomplete="off" />

              <label class="muted" style="margin-top:10px;">Chat ID</label>
              <input type="text" id="telegramChatId" class="input-compact" placeholder="Ù…Ø«Ø§Ù„: 123456789" autocomplete="off" />

              <div style="display:flex;gap:12px;align-items:center;margin-top:10px;">
                <label class="switch"><input type="checkbox" id="telegramAutoBackupToggle" /><span class="slider"></span></label>
                <div style="flex:1;">
                  <div style="font-weight:600;color:#07345a;">Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</div>
                  <div style="display:flex;gap:8px;align-items:center;margin-top:6px;">
                    <input type="number" id="telegramAutoBackupHours" class="input-compact" min="1" value="48" style="width:140px;" />
                    <div class="muted" style="font-size:12px;">(Ø³Ø§Ø¹Ø§Øª)</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="panel-col" style="max-width:320px;">
              <div class="panel-note">Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø³ÙŠÙØ¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</div>
              <div class="panel-actions" style="margin-top:12px;">
                <button id="testTelegramBtn" class="btn btn-ghost">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±</button>
                <button id="saveTelegramSettingsBtn" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸</button>
              </div>
              <div id="telegramStatus" style="margin-top:12px;font-size:13px;color:#374151;"></div>
            </div>
          </div>
        </div>
        <button
          id="toggleEmpStatsBtn"
          style="
            background: #17a2b8;
            color: white;
            font-size: 13px;
            padding: 7px 12px;
            margin-bottom: 10px;
            cursor: pointer;
          "
        >
          ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        </button>
        <!-- Salary management (Admin only) -->
        <div id="salaryAdminSection" class="adv-card" style="margin-top:18px;display:none;">
          <div class="adv-card-header">
            <div>
              <h4 class="adv-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ÙˆØ§ØªØ¨</h4>
              <div class="adv-card-desc" style="margin-top:6px;">ØªØ¹ÙŠÙŠÙ† Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´ÙØª ÙˆØ§Ù„Ù†ØµÙ ÙˆØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø©.</div>
            </div>
            <div style="font-size:13px;color:#6b7280">Ø¶Ø¨Ø· Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</div>
          </div>

          <div class="panel-grid" style="margin-top:12px;">
            <div class="panel-col">
              <label class="muted">Ø³Ø¹Ø± Ø§Ù„Ø´ÙØª (Ø¯ÙŠÙ†Ø§Ø±)</label>
              <input type="text" id="salaryShiftRate" class="input-compact" placeholder="22,000" />

              <label class="muted" style="margin-top:10px;">Ø³Ø¹Ø± Ø§Ù„Ù†ØµÙ (Ø¯ÙŠÙ†Ø§Ø±)</label>
              <input type="text" id="salaryHalfRate" class="input-compact" placeholder="11,000" />
            </div>
            <div class="panel-col" style="max-width:320px;">
              <div style="display:flex;flex-direction:column;gap:10px;">
                <label style="display:flex;align-items:center;gap:10px;"><input type="checkbox" id="applyCurrentMonthSalary" /> ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</label>
                <label style="display:flex;align-items:center;gap:10px;"><input type="checkbox" id="applyFutureMonthsSalary" /> ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label>
                <div class="panel-actions" style="margin-top:8px;">
                  <button id="saveDefaultSalaryBtn" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div
          id="empStatsTab"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.45);
            z-index: 2000;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              max-width: 500px;
              width: 95vw;
              max-height: 90vh;
              overflow: auto;
              border-radius: 12px;
              box-shadow: 0 8px 32px #0002;
              padding: 25px 20px 20px 20px;
              position: relative;
            "
          >
            <button
              id="closeEmpStatsTab"
              style="
                position: absolute;
                top: 10px;
                left: 10px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 50%;
                width: 32px;
                height: 32px;
                font-size: 18px;
                cursor: pointer;
              "
            >
              âœ–
            </button>
            <h3 style="text-align: center; margin-bottom: 18px">
              ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            </h3>
            <div id="empStatsTabContent"></div>
          </div>
        </div>
        <button
          id="btnDeleteData"
          style="
            background-color: #dc3545;
            color: white;
            font-size: 12px;
            padding: 5px 10px;
            margin-top: 15px;
            cursor: pointer;
          "
        >
          ğŸ—‘ï¸ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
        </button>
        <!-- Ø£Ø¶Ù Ø²Ø± Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø¹Ø¯ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
        <button
          id="btnFeaturesTab"
          style="
            background: #673ab7;
            color: white;
            font-size: 13px;
            padding: 7px 12px;
            margin-bottom: 10px;
            cursor: pointer;
          "
        >
          â­ï¸Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
        </button>
        <div
          id="featuresTab"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.45);
            z-index: 3000;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              max-width: 520px;
              width: 97vw;
              max-height: 92vh;
              overflow: auto;
              border-radius: 14px;
              box-shadow: 0 8px 32px #0002;
              padding: 25px 18px 18px 18px;
              position: relative;
            "
          >
            <button
              id="closeFeaturesTab"
              style="
                position: absolute;
                top: 10px;
                left: 10px;
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 50%;
                width: 32px;
                height: 32px;
                font-size: 18px;
                cursor: pointer;
              "
            >
              âœ–
            </button>
            <h3 style="text-align: center; margin-bottom: 18px; color: #673ab7">
              â­ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
            </h3>
            <div id="featuresTabContent"></div>
          </div>
        </div>
        <style>
          @media (max-width: 600px) {
            #featuresTab > div {
              max-width: 99vw !important;
              padding: 10px 2vw 10px 2vw !important;
            }
            #featuresTab h3 {
              font-size: 18px !important;
            }
          }
          .feature-section {
            background: #f6f8fa;
            border-radius: 10px;
            margin-bottom: 18px;
            padding: 13px 12px;
            box-shadow: 0 1px 6px #0001;
          }
          .feature-section h4 {
            margin: 0 0 7px 0;
            color: #3f51b5;
            font-size: 16px;
          }
          .activity-log-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 7px;
            font-size: 14px;
          }
          .activity-log-table th,
          .activity-log-table td {
            border: 1px solid #ccc;
            padding: 5px 4px;
            text-align: center;
          }
          .activity-log-table th {
            background: #ede7f6;
            color: #673ab7;
          }
        </style>
      </div>
    </div>

    <!-- ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù„Ù„Ù€ sidebarMenu Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø± -->
  <button id="sidebarToggleBtn" style="display: none; z-index:12001; position:fixed; top:14px; right:14px">â˜°</button>
  <button id="sidebarCloseBtn" style="display: none; z-index:12001; position:fixed; top:14px; right:14px">âœ–</button>
    <div id="sidebarMenu">
      <div class="sidebar-header" id="sidebarUserName"></div>
      <button onclick="saveData()" style="background: #0dc149; color: white">
        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
      </button>
      <button onclick="logout()" style="background: #dc3545; color: white">
        ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
      </button>
      <button
        id="sidebarAdminBtn"
        style="background: #000000; color: white; display: none"
      >
        âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      </button>
      <button
        id="sidebarMonthsManagerBtn"
        style="
          background: #1976d2;
          color: white;
          display: none;
          margin-top: 2px;
        "
      >
        ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø±
      </button>
      <button
        id="sidebarEmpStatsBtn"
        style="background: #17a2b8; color: white; display: none"
      >
        ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      </button>
      <button
        id="sidebarNotificationsBtn"
        style="background: #ff4081; color: white; display: none"
      >
        ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      </button>
      <!-- Admin-only Announcements button -->
      <button
        id="sidebarAnnouncementsBtn"
        style="background: #ff6f00; color: white; display: none; margin-top:6px;"
        title="Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±"
      >
        ğŸ“¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
      </button>
      <button
        id="sidebarDeleteDataBtn"
        style="background: #dc3545; color: white; display: none"
      >
        ğŸ—‘ï¸ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
      </button>
      
       <button
        id="sidebarPrintTelegramBtn"
        style="background: #0088cc; color: white; display: none; margin-top: 6px;"
        title="Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± PDF Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…"
      >
        ğŸ“„ Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ PDF
      </button>
      
      
      <button
        id="sidebarFeaturesTabBtn"
        style="background: #673ab7; color: white; display: none"
      >
        â­ï¸Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
      </button>
      <button
        id="sidebarChangePassBtn"
        style="background: #2196f3; color: white"
      >
        ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
      </button>
      <!-- Ø£Ø¶Ù Ø²Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
      <button
        id="sidebarUserControlBtn"
        style="background: #009688; color: white; display: none"
      >
        ğŸ‘¥ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
      </button>
      <!-- Ø²Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
      <button
        id="sidebarNotesBtn"
        style="background: #ffb300; color: #333; display: none"
      >
        ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
      </button>
      <!-- Ø²Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· -->
      <button
        id="sidebarNotesSettingsBtn"
        style="background: #ff9800; color: #222; display: none"
      >
        âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
      </button>
      <!-- Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ PDF Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… -->
    
      <!-- Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    </div>
    <script>
      // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ¹Ø¯Ù‡ Ù…Ø¹ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ­Ø±ÙƒØ© scroll
      document.addEventListener("DOMContentLoaded", function () {
        var kadahBtn = document.getElementById("showKadahStatsBtn");
        var closeBtn = document.getElementById("closeKadahStatsBtn");
        var wrapper = document.getElementById("kadahStatsTableWrapper");
        if (kadahBtn && closeBtn && wrapper) {
          kadahBtn.onclick = function (e) {
            e.preventDefault();
            renderKadahStatsTable();
            wrapper.style.display = "block";
            setTimeout(function(){
              wrapper.classList.add("show");
              wrapper.scrollIntoView({ behavior: "smooth" });
              kadahBtn.style.display = "none";
              closeBtn.style.display = "inline-block";
            }, 50);
          };
          closeBtn.onclick = function (e) {
            e.preventDefault();
            wrapper.classList.remove("show");
            setTimeout(function(){
              wrapper.style.display = "none";
              kadahBtn.style.display = "inline-block";
              closeBtn.style.display = "none";
              kadahBtn.scrollIntoView({ behavior: "smooth" });
            }, 400);
          };
        }
      });

      // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØ¹Ø¯Ù‡ Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
      function renderKadahStatsTable() {
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ù…ØªØºÙŠØ± month Ùˆ year Ùˆ employees Ù…Ø¹Ø±ÙÙŠÙ† Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
        const monthKey = `${year}_${(month + 1).toString().padStart(2, "0")}`;
        db.ref(`dayDetails/${monthKey}`)
          .once("value")
          .then((snap) => {
            const days = snap.val() || {};
            const stats = {};
            employees.forEach((emp) => {
              stats[emp] = { "600": 0, "22": 0, "Ù…Ø´ØªØ±ÙƒØ©": 0 };
            });

            function countValueInStats(val, empStats) {
              // val can be string, array, or object. Each non-empty field counts as 0.5
              if (Array.isArray(val)) {
                val.forEach((v) => {
                  if (!v) return;
                  if (v === "600") empStats["600"] += 0.5;
                  if (v === "22") empStats["22"] += 0.5;
                  if (v === "Ù…Ø´ØªØ±ÙƒØ©") empStats["Ù…Ø´ØªØ±ÙƒØ©"] += 0.5;
                });
              } else if (typeof val === 'object' && val !== null) {
                // support { value: [..] } or { value1:.., value2:.. }
                if (Array.isArray(val.value)) {
                  countValueInStats(val.value, empStats);
                } else {
                  const v1 = val.value1 || val.v1 || "";
                  const v2 = val.value2 || val.v2 || "";
                  [v1, v2].forEach((v) => {
                    if (!v) return;
                    if (v === "600") empStats["600"] += 0.5;
                    if (v === "22") empStats["22"] += 0.5;
                    if (v === "Ù…Ø´ØªØ±ÙƒØ©") empStats["Ù…Ø´ØªØ±ÙƒØ©"] += 0.5;
                  });
                }
              } else if (typeof val === 'string' && val) {
                // single string â€” count as 0.5 (one field)
                if (val === "600") empStats["600"] += 0.5;
                if (val === "22") empStats["22"] += 0.5;
                if (val === "Ù…Ø´ØªØ±ÙƒØ©") empStats["Ù…Ø´ØªØ±ÙƒØ©"] += 0.5;
              }
            }

            Object.values(days).forEach((day) => {
              employees.forEach((emp) => {
                const stored = day[emp];
                const val = stored ? stored.value : undefined;
                countValueInStats(val, stats[emp]);
              });
            });
            // Ø¨Ù†Ø§Ø¡ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const tbody = document.querySelector("#kadahStatsTable tbody");
            tbody.innerHTML = "";
            employees.forEach((emp) => {
                const row = document.createElement("tr");
                // Always apply the class for each column, even if the value is zero
                row.innerHTML = `
                  <td>${emp}</td>
                  <td class='kadah-600'>${typeof stats[emp]["600"] === "number" ? stats[emp]["600"] : 0}</td>
                  <td class='kadah-22'>${typeof stats[emp]["22"] === "number" ? stats[emp]["22"] : 0}</td>
                  <td class='kadah-msh'>${typeof stats[emp]["Ù…Ø´ØªØ±ÙƒØ©"] === "number" ? stats[emp]["Ù…Ø´ØªØ±ÙƒØ©"] : 0}</td>
                `;
                tbody.appendChild(row);
            });
          });
      }
      // Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…
      function showDayDetailsModal(dayKey, dayLabel) {
        const modal = document.getElementById("dayDetailsModal");
        const titleDiv = document.getElementById("dayDetailsTitle");
        const tableDiv = document.getElementById("dayDetailsTable");
        const statusDiv = document.getElementById("dayDetailsStatus");
        titleDiv.textContent = `ØªÙØ§ØµÙŠÙ„ ÙŠÙˆÙ…: ${dayLabel}`;
        statusDiv.textContent = "";
        const monthKey = `${year}_${(month + 1).toString().padStart(2, "0")}`;
        db.ref(`dayDetails/${monthKey}/${dayKey}`)
          .once("value")
          .then((snap) => {
            const data = snap.val() || {};
            // Ø§Ø³ØªØ®Ø¯Ù… DocumentFragment Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
            const fragment = document.createDocumentFragment();
            // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            const table = document.createElement("table");
            table.className = "day-details-table";
            const thead = document.createElement("thead");
            thead.innerHTML = `<tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</th><th>Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„</th></tr>`;
            table.appendChild(thead);
            const tbody = document.createElement("tbody");
            employees.forEach((emp) => {
              const stored = data[emp] || {};
              const rawVal = stored.value;
              // normalize to two fields: val1, val2
              let val1 = "", val2 = "";
              if (Array.isArray(rawVal)) {
                val1 = rawVal[0] || "";
                val2 = rawVal[1] || "";
              } else if (typeof rawVal === 'object' && rawVal !== null) {
                val1 = rawVal.value1 || rawVal.v1 || "";
                val2 = rawVal.value2 || rawVal.v2 || "";
              } else if (typeof rawVal === 'string') {
                // legacy single value goes to first field
                val1 = rawVal;
                val2 = "";
              }
              const user = data[emp]?.user || "â€”";
              const time = data[emp]?.time || "â€”";
              const tr = document.createElement("tr");
              // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù
              const tdEmp = document.createElement("td");
              tdEmp.textContent = emp;
              tr.appendChild(tdEmp);
              // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± - Ø§Ù„Ø¢Ù† Ø­Ù‚Ù„Ø§Ù† Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
              const tdSelect = document.createElement("td");
              const wrapper = document.createElement('div');
              wrapper.style.display = 'flex';
              wrapper.style.gap = '8px';
              wrapper.style.justifyContent = 'center';
              // create two selects
              for (let idx = 0; idx < 2; idx++) {
                const select = document.createElement("select");
                select.className = "day-details-select";
                select.setAttribute("data-emp", emp);
                select.setAttribute("data-index", String(idx));
                ["â€”", "600", "22", "Ù…Ø´ØªØ±ÙƒØ©", "âŒ"].forEach((optionVal) => {
                  const option = document.createElement("option");
                  option.value = optionVal === "â€”" ? "" : optionVal;
                  option.textContent = optionVal;
                  select.appendChild(option);
                });
                // set selected based on val1/val2
                if (idx === 0 && val1) select.value = val1;
                if (idx === 1 && val2) select.value = val2;
                wrapper.appendChild(select);
              }
              tdSelect.appendChild(wrapper);
              tr.appendChild(tdSelect);
              // Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„
              const tdEdit = document.createElement("td");
              let userColor =
                user === "admin"
                  ? "#1fa745"
                  : user === "â€”"
                  ? "#555"
                  : "#dc3545";
              function toEnglishDate(str) {
                if (!str || str === "â€”") return "â€”";
                return str
                  .replace(/[Ù -Ù©]/g, (d) => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d))
                  .replace(/ØŒ/g, ",");
              }
              tdEdit.innerHTML = `<span class='day-details-user' style='color:${userColor};font-weight:bold;'>${user}</span><br><span class='day-details-time' style='color:#000;'>${toEnglishDate(
                time
              )}</span>`;
              tr.appendChild(tdEdit);
              tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            fragment.appendChild(table);
            // Ø²Ø± Ø§Ù„Ø­ÙØ¸
            const saveBtn = document.createElement("button");
            saveBtn.id = "saveDayDetailsBtn";
            saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
            saveBtn.style =
              "background:#1976d2;color:white;padding:8px 18px;border:none;border-radius:7px;font-size:16px;margin-top:8px;cursor:pointer;";
            fragment.appendChild(saveBtn);
            tableDiv.innerHTML = "";
            tableDiv.appendChild(fragment);
            modal.style.display = "flex";
            document.getElementById("closeDayDetailsModal").onclick =
              function () {
                modal.style.display = "none";
              };
            saveBtn.onclick = function () {
              const selects = tableDiv.querySelectorAll(".day-details-select");
              const updates = {};
              let changed = false;
              employees.forEach((emp) => {
                const empSelects = Array.from(selects).filter((s) => s.getAttribute("data-emp") === emp).sort((a,b)=> a.getAttribute('data-index') - b.getAttribute('data-index'));
                const newV1 = empSelects[0] ? empSelects[0].value : "";
                const newV2 = empSelects[1] ? empSelects[1].value : "";
                const newVal = [newV1, newV2];
                const oldRaw = data[emp]?.value;
                let oldValArr = [];
                if (Array.isArray(oldRaw)) oldValArr = [oldRaw[0] || "", oldRaw[1] || ""];
                else if (typeof oldRaw === 'object' && oldRaw !== null) oldValArr = [oldRaw.value1 || oldRaw.v1 || "", oldRaw.value2 || oldRaw.v2 || ""];
                else if (typeof oldRaw === 'string') oldValArr = [oldRaw, ""];
                else oldValArr = ["",""];
                const changedForEmp = !(oldValArr[0] === newVal[0] && oldValArr[1] === newVal[1]);
                if (changedForEmp) {
                  updates[emp] = {
                    value: newVal,
                    user: currentUser,
                    time: formatDateTimeNoSeconds(new Date()),
                  };
                  changed = true;
                } else if (data[emp]) {
                  updates[emp] = data[emp];
                }
              });
              if (!changed) {
                statusDiv.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù„Ø­ÙØ¸Ù‡.";
                return;
              }
              db.ref(`dayDetails/${monthKey}/${dayKey}`)
                .set(updates)
                .then(() => {
                  statusDiv.textContent = "âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
                  setTimeout(() => {
                    modal.style.display = "none";
                  }, 900);
                })
                .catch((err) => {
                  console && console.error && console.error('save dayDetails error', err);
                  if (statusDiv) statusDiv.textContent = 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (err && err.message ? err.message : err);
                });
            };
          });
      }
      // Ø¯Ø§Ù„Ø© ØªØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù‡Ùˆ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
      function isCurrentMonthSelected() {
        const now = new Date();
        return month === now.getMonth() && year === now.getFullYear();
      }

      // Ø¯Ø§Ù„Ø© Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      function preventEditIfNotCurrentMonth() {
        if (!isCurrentMonthSelected()) {
          alert(
            "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø­Ø°Ù Ø£Ùˆ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©."
          );
          return false;
        }
        return true;
      }
      // Ø²Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
      document.getElementById("sidebarNotesSettingsBtn").onclick = function () {
        document.getElementById("sidebarMenu").classList.remove("open");
        setTimeout(showNotesSettingsTab, 100);
      };

      // Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
      function showNotesSettingsTab() {
        let modal = document.getElementById("notesSettingsModal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "notesSettingsModal";
          modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:8000;display:flex;align-items:center;justify-content:center;`;
          modal.innerHTML = `
        <div style=\"background:#fff;max-width:440px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:30px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;border:2px solid #ff9800;\">
          <button id=\"closeNotesSettingsBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">âœ–</button>
          <div style=\"font-size:20px;color:#ff9800;margin-bottom:18px;font-weight:600;text-align:center;\">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
          <div id=\"notesSettingsContent\" style=\"overflow-y:auto;max-height:60vh;\">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <style>
          @media (max-width: 600px) {
            #notesSettingsModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
            #notesSettingsModal div { font-size:16px !important; }
          }
          #closeNotesSettingsBtn:hover { background:#b71c1c !important; }
        </style>
      `;
          document.body.appendChild(modal);
          document.getElementById("closeNotesSettingsBtn").onclick =
            function () {
              modal.remove();
            };
        } else {
          modal.style.display = "flex";
        }
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù…
        db.ref("users")
          .once("value")
          .then((snapshot) => {
            const users = snapshot.val() || {};
            let html = `<table style='width:100%;border-collapse:collapse;margin-bottom:10px;'>
        <tr><th style='background:#f6f6f6;'>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th style='background:#f6f6f6;'>ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr>`;
            Object.entries(users).forEach(([username, data]) => {
              if (username === "admin") return;
              const perm = data.notesPermission || "edit";
              html += `<tr>
          <td style='padding:7px 4px;'>${username}</td>
          <td style='padding:7px 4px;'>
            <select data-user='${username}' class='notePermSelect' style='font-size:15px;'>
              <option value='edit' ${
                perm === "edit" ? "selected" : ""
              }>ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</option>
              <option value='read' ${
                perm === "read" ? "selected" : ""
              }>Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</option>
              <option value='none' ${
                perm === "none" ? "selected" : ""
              }>Ù…Ø®ÙÙŠ ØªÙ…Ø§Ù…Ù‹Ø§</option>
            </select>
          </td>
        </tr>`;
            });
            html += `</table><div style='font-size:13px;color:#555;'>Ø­Ø¯Ø¯ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±ÙŠ.</div>`;
            document.getElementById("notesSettingsContent").innerHTML = html;
            Array.from(
              document.getElementsByClassName("notePermSelect")
            ).forEach((sel) => {
              sel.onchange = function () {
                const user = sel.getAttribute("data-user");
                const val = sel.value;
                db.ref("users/" + user + "/notesPermission")
                  .set(val)
                  .then(() => {
                    logActivity(
                      "ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
                      "ØªÙ… ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: " +
                        user +
                        " Ø¥Ù„Ù‰: " +
                        (val === "edit"
                          ? "ØªØ¹Ø¯ÙŠÙ„"
                          : val === "read"
                          ? "Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·"
                          : "Ù…Ø®ÙÙŠ")
                    );
                    updateSidebarVisibility();
                  });
              };
            });
          });
      }
      // Ø²Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
      document.getElementById("sidebarNotesBtn").onclick = function () {
        document.getElementById("sidebarMenu").classList.remove("open");
        setTimeout(showNotesTab, 100);
      };

      // ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
      function showNotesTab() {
        let notesTab = document.getElementById("notesTab");
        if (!notesTab) {
          notesTab = document.createElement("div");
          notesTab.id = "notesTab";
          notesTab.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:7000;display:flex;align-items:center;justify-content:center;`;
          notesTab.innerHTML = `
        <div style=\"background:#fff;max-width:430px;width:97vw;border-radius:16px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;\">
          <button id=\"closeNotesTabBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">âœ–</button>
          <div style=\"font-size:20px;color:#333;margin-bottom:18px;font-weight:600;text-align:center;\">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
          <div id=\"notesTabContent\" style=\"overflow-y:auto;max-height:60vh;\"></div>
        </div>
        <style>
          @media (max-width: 600px) {
            #notesTab > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
            #notesTab div { font-size:16px !important; }
          }
          #closeNotesTabBtn:hover { background:#b71c1c !important; }
        </style>
      `;
          document.body.appendChild(notesTab);
          document.getElementById("closeNotesTabBtn").onclick = function () {
            notesTab.remove();
          };
        } else {
          notesTab.style.display = "flex";
        }
        renderNotesTabContent();
      }

      // Ø¹Ø±Ø¶ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
      function renderNotesTabContent() {
        // Ø¥Ø°Ø§ ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©ØŒ Ø£Ø¸Ù‡Ø±Ù‡Ø§ Ù‡Ù†Ø§ÙƒØŒ ÙˆØ¥Ù„Ø§ Ø£Ø¸Ù‡Ø±Ù‡Ø§ Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        let notesDiv = document.getElementById("notesTabContent");
        let notesSection = document.getElementById("notesSection");
        if (notesSection && notesSection.style.display !== "none") {
          notesDiv = notesSection.querySelector("#notesTabContent");
        }
        notesDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ Ø§Ù„Ø­Ø¶ÙˆØ±ØŒ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
        Promise.all([
          db.ref("notes").once("value"),
          db.ref("attendance").once("value"),
          db.ref("salaries").once("value"),
          db.ref("users/" + currentUser).once("value"),
        ]).then(([notesSnap, attSnap, salSnap, userSnap]) => {
          const notes = notesSnap.val() || {};
          const attendance = attSnap.val() || {};
          const salaries = salSnap.val() || {};
          const userData = userSnap.val() || {};
          const perm = userData.notesPermission || "edit";
          // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
          const stats = {};
          employees.forEach((emp) => {
            stats[emp] = { shift: 0, half: 0, vac: 0 };
          });
          Object.entries(attendance).forEach(([dateStr, day]) => {
            // ÙÙ‚Ø· Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            let parts = dateStr.split("-");
            if (parts.length === 3) {
              let dYear = parseInt(parts[0]);
              let dMonth = parseInt(parts[1]) - 1;
              if (dYear === year && dMonth === month) {
                employees.forEach((emp) => {
                  const val = day[emp];
                  if (val === "Ø´ÙØª") stats[emp].shift++;
                  if (val === "Ù†Øµ") stats[emp].half++;
                  if (val === "âŒ") stats[emp].vac++;
                });
              }
            }
          });
          let html = "";
          employees.forEach((emp) => {
            let noteVal = notes[emp] ? notes[emp] : "";
            let isEmpty = noteVal.trim() === "";
            html += `<div class="note-box" style="border:1.5px solid #e3eafc; margin:18px 0 22px 0; border-radius:13px; background:linear-gradient(135deg,#f8fafc 70%,#e3eafc 100%); box-shadow:0 2px 12px #3f51b511; transition:box-shadow 0.2s;">`;
            // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù
            html += `<div style=\"font-weight:700; color:#3f51b5; font-size:18px; padding:13px 16px 0 16px; letter-spacing:0.2px;\">ğŸ‘¤ ${emp}</div>`;
            // Ø®Ø§Ù†Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙˆØ²Ø± Ø§Ù„Ø­ÙØ¸
            if (perm === "edit") {
              html += `<textarea id='noteInput_${emp}' style='width:94%;min-height:60px;margin:13px 3%;border-radius:8px;border:1.2px solid #bfc7e3;padding:9px;font-size:15.5px;resize:vertical;background:#fff;transition:border 0.2s;'>${noteVal}</textarea>`;
              html += `<div style='display:flex;align-items:center;justify-content:space-between;margin:0 3% 13px 3%;'>`;
              html += isEmpty
                ? `<span style='color:#b0b0b0;font-size:13px;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>ğŸ›ˆ</span>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø¹Ø¯</span>`
                : `<span style='color:#607d8b;font-size:13px;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>ğŸ“</span>ØªÙ…Øª Ø¢Ø®Ø± Ù…Ø±Ø§Ø¬Ø¹Ø©</span>`;
              html += `<button class='saveNoteBtn' data-emp='${emp}' style='background:linear-gradient(90deg,#3f51b5 60%,#5c6bc0 100%);color:white;padding:7px 22px;border:none;border-radius:7px;font-size:15.5px;cursor:pointer;box-shadow:0 2px 8px #3f51b522;font-weight:600;transition:background 0.2s;'>ğŸ’¾ Ø­ÙØ¸</button>`;
              html += `</div>`;
            } else if (perm === "read") {
              html += `<textarea id='noteInput_${emp}' style='width:94%;min-height:60px;margin:13px 3%;border-radius:8px;border:1.2px solid #bfc7e3;padding:9px;font-size:15.5px;background:#f5f7fa;resize:vertical;' readonly>${noteVal}</textarea>`;
              html += isEmpty
                ? `<div style='color:#b0b0b0;font-size:13px;padding:0 3% 13px 3%;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>ğŸ›ˆ</span>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ø¹Ø¯</div>`
                : `<div style='color:#607d8b;font-size:13px;padding:0 3% 13px 3%;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>ğŸ“</span>ØªÙ…Øª Ø¢Ø®Ø± Ù…Ø±Ø§Ø¬Ø¹Ø©</div>`;
            } else {
              html += `<div style='color:#888;font-size:14px;padding:13px;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>`;
            }
            html += `</div>`;
          });
          notesDiv.innerHTML = html;
          // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø§Ù„Ù‚Ø³Ù… Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø£Ø¸Ù‡Ø± Ø§Ù„Ù‚Ø³Ù…
          if (notesSection) notesSection.style.display = "block";
          if (perm === "edit") {
            Array.from(document.getElementsByClassName("saveNoteBtn")).forEach(
              (btn) => {
                btn.onclick = function () {
                  const emp = btn.getAttribute("data-emp");
                  const noteVal = document.getElementById(
                    `noteInput_${emp}`
                  ).value;
                  db.ref("notes/" + emp)
                    .set(noteVal)
                    .then(() => {
                      btn.textContent = "âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸";
                      setTimeout(() => {
                        btn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©";
                      }, 1200);
                      logActivity(
                        "ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…ÙˆØ¸Ù",
                        `<span style='color:#007bff;font-weight:bold;'>${emp}</span> | <span style='color:#ffb300;'>${noteVal
                          .replace(/</g, "&lt;")
                          .replace(/>/g, "&gt;")}</span>`,
                        { type: "note", emp: emp }
                      );
                    });
                };
              }
            );
          }
        });
      }
      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ©
      document.addEventListener("DOMContentLoaded", function () {
        // Ù‡Ø¬Ø±Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
        if (typeof migrateAllPlaintextUsers === "function") {
          migrateAllPlaintextUsers();
        }
        db.ref("users/" + currentUser)
          .once("value")
          .then((snap) => {
            const data = snap.val() || {};
            const perm = data.notesPermission || "edit";
            if (perm === "edit" || perm === "read") {
              let notesSection = document.getElementById("notesSection");
              if (notesSection) {
                notesSection.style.display = "block";
                renderNotesTabContent();
              }
            }
          });
      });
      // ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± ÙˆØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      function updateSidebarVisibility() {
        const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
        const sidebarMenu = document.getElementById("sidebarMenu");
        const sidebarCloseBtn = document.getElementById("sidebarCloseBtn");
        const isAdmin = currentUserRole === "admin";
        try{ const maintenanceSection = document.getElementById('maintenanceControl'); if(maintenanceSection) maintenanceSection.style.display = isAdmin ? 'block' : 'none'; }catch(e){}
        try{ const salarySection = document.getElementById('salaryAdminSection'); if(salarySection) salarySection.style.display = isAdmin ? 'block' : 'none'; }catch(e){}
        // Show/hide advances admin section and bind add-button safely
        try {
          const advancesSection = document.getElementById('advancesAdminSection');
          const addBtn = document.getElementById('openAddAdvanceBtn');
          if (advancesSection) advancesSection.style.display = isAdmin ? 'block' : 'none';
          if (addBtn) {
            addBtn.style.display = isAdmin ? 'inline-block' : 'none';
            addBtn.onclick = function () {
              if (typeof openAddAdvanceForm === 'function') return openAddAdvanceForm();
              // if function not defined yet (load order), try shortly after
              setTimeout(() => { if (typeof openAddAdvanceForm === 'function') openAddAdvanceForm(); }, 200);
            };
          }
        } catch (e) {
          console.warn('Advances visibility update failed', e);
        }
        // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·
        [
          "sidebarAdminBtn",
          "sidebarMonthsManagerBtn",
          "sidebarEmpStatsBtn",
          "sidebarDeleteDataBtn",
          "sidebarFeaturesTabBtn",
          "sidebarChangePassBtn",
          "sidebarUserControlBtn",
          "sidebarNotesSettingsBtn",
          "sidebarNotificationsBtn",
          "sidebarPrintTelegramBtn",
        ].forEach((id) => {
          try {
            const el = document.getElementById(id);
            if (el) el.style.display = isAdmin ? "block" : "none";
          } catch (e) {}
        });
        // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
        try {
          const telegramSection = document.getElementById('telegramSettings');
          if (telegramSection) telegramSection.style.display = isAdmin ? 'block' : 'none';
        } catch (e) {}
        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        try {
          // Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
          const notificationsBtn = document.getElementById("sidebarNotificationsBtn");
          if (notificationsBtn) {
            notificationsBtn.onclick = function () {
              document.getElementById("sidebarMenu").classList.remove("open");
              setTimeout(showNotificationsManager, 100);
            };
          }
        } catch (e) {}

        function showNotificationsManager() {
            let modal = document.getElementById("notificationsManagerModal");
            if (modal) {
              modal.style.display = "flex";
              return;
            }
            modal = document.createElement("div");
            modal.id = "notificationsManagerModal";
            modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9100;display:flex;align-items:center;justify-content:center;`;
            modal.innerHTML = `
    <div style="background:#fff;max-width:420px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;">
      <button id="closeNotificationsManagerBtn" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
      <div style="font-size:21px;color:#ff4081;margin-bottom:10px;font-weight:700;text-align:center;letter-spacing:0.2px;">ğŸ”” Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</div>
      <div style="margin-bottom:10px;">
        <label style="font-size:15px;font-weight:500;">Ø§Ù„Ù…Ø³ØªÙ„Ù…:
          <select id="notificationTarget" multiple style="width:100%;padding:7px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;margin-top:5px;min-height:38px;max-height:120px;overflow:auto;"></select>
          <div style="font-size:12px;color:#888;margin-top:3px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…ÙˆØ¸Ù Ø¨Ø§Ù„Ø¶ØºØ· Ù…Ø¹ Ctrl Ø£Ùˆ Shift</div>
        </label>
      </div>
      <textarea id="notificationMsg" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§..." style="width:100%;min-height:60px;border-radius:7px;border:1px solid #ccc;padding:7px;font-size:15px;margin-bottom:10px;"></textarea>
      <button id="sendNotificationBtn" style="background:#ff4081;color:white;padding:9px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;font-weight:600;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
    </div>
    <style>
      @media (max-width: 600px) {
        #notificationsManagerModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #notificationsManagerModal div { font-size:16px !important; }
      }
      #closeNotificationsManagerBtn:hover { background:#b71c1c !important; }
      #sendNotificationBtn:hover { background:#c51162 !important; }
    </style>
  `;
            document.body.appendChild(modal);
            document.getElementById("closeNotificationsManagerBtn").onclick =
              function () {
                modal.style.display = "none";
              };
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            db.ref("users")
              .once("value")
              .then((snap) => {
                const users = snap.val() || {};
                let sel = document.getElementById("notificationTarget");
                sel.innerHTML = `<option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</option>`;
                Object.keys(users).forEach((u) => {
                  if (u !== "admin")
                    sel.innerHTML += `<option value="${u}">${u}</option>`;
                });
              });
            document.getElementById("sendNotificationBtn").onclick =
              function () {
                const sel = document.getElementById("notificationTarget");
                const selected = Array.from(sel.selectedOptions).map(
                  (opt) => opt.value
                );
                const msg = document
                  .getElementById("notificationMsg")
                  .value.trim();
                if (!msg) return alert("âŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");
                const notif = { msg, time: Date.now(), from: currentUser };
                if (selected.includes("all")) {
                  db.ref("notifications/all")
                    .set(notif)
                    .then(() => {
                      alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹");
                      modal.style.display = "none";
                    });
                } else if (selected.length > 0) {
                  let promises = selected.map((u) =>
                    db.ref("notifications/" + u).set(notif)
                  );
                  Promise.all(promises).then(() => {
                    alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†");
                    modal.style.display = "none";
                  });
                } else {
                  alert("âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
                }
              };
          }
          // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
          window.listenForNotifications = function listenForNotifications() {
            if (!currentUser) return;
            // ØªØ¬Ø§Ù‡Ù„ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
            if (currentUser === "admin") return;
            // Ø¥Ø´Ø¹Ø§Ø± Ù…Ø®ØµØµ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            db.ref("notifications/" + currentUser).on("value", (snap) => {
              const notif = snap.val();
              if (notif)
                showNotificationPopup(notif, () => {
                  db.ref("notifications/" + currentUser).remove();
                });
            });
            // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù… Ù„Ù„Ø¬Ù…ÙŠØ¹
            db.ref("notifications/all").on("value", (snap) => {
              const notif = snap.val();
              if (notif)
                showNotificationPopup(notif, () => {
                  db.ref("notifications/all").remove();
                });
            });
          };

          // Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±
          function showNotificationPopup(notif, onOk) {
            let old = document.getElementById("notificationPopup");
            if (old) old.remove();
            const modal = document.createElement("div");
            modal.id = "notificationPopup";
            modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:12000;display:flex;align-items:center;justify-content:center;`;
            let sender = notif.from === "admin" ? "Ø§Ù„Ù…Ø¯ÙŠØ±" : notif.from || "";
            modal.innerHTML = `
    <div style="background:linear-gradient(135deg,#e8eaf6 60%,#c5cae9 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #3f51b522;position:relative;text-align:center;animation:fadeIn 0.3s;">
      <button id="closeNotifPopupBtn" style="position:absolute;top:10px;left:10px;background:#3f51b5;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
      <div style="font-size:21px;color:#3f51b5;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;">ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ù…Ù† ${sender}</div>
      <div style="font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#e3eafc;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #3f51b511;">${notif.msg
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")}</div>
      <button id="notifOkBtn" style="background:linear-gradient(90deg,#3f51b5 60%,#5c6bc0 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #3f51b522;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;">Ø­Ø³Ù†Ù‹Ø§</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #notificationPopup > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #notificationPopup div { font-size:16px !important; }
      }
      #closeNotifPopupBtn:hover { background:#283593 !important; }
      #notifOkBtn:hover { background:#283593 !important; }
    </style>
  `;
            document.body.appendChild(modal);
            document.getElementById("notifOkBtn").onclick = () => {
              modal.remove();
              if (onOk) onOk();
            };
            document.getElementById("closeNotifPopupBtn").onclick = () => {
              modal.remove();
              if (onOk) onOk();
            };
          }
        // Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
        try {
          const monthsManagerBtn = document.getElementById("sidebarMonthsManagerBtn");
          if (monthsManagerBtn) {
            monthsManagerBtn.onclick = function () {
              document.getElementById("sidebarMenu").classList.remove("open");
              setTimeout(showMonthsManagerModal, 100);
            };
          }
        } catch (e) {
          console.warn('Ø®Ø·Ø£ ÙÙŠ Ø±Ø¨Ø· Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø±:', e);
        }

        function showMonthsManagerModal() {
          let modal = document.getElementById("monthsManagerModal");
          if (modal) {
            modal.style.display = "flex";
            return;
          }
          modal = document.createElement("div");
          modal.id = "monthsManagerModal";
          modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9000;display:flex;align-items:center;justify-content:center;`;
          modal.innerHTML = `
    <div id="monthsManagerModalInner" style="background:#fff;max-width:480px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:24px 10px 14px 10px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;">
      <button id="closeMonthsManagerBtn" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
      <div style="font-size:21px;color:#1976d2;margin-bottom:10px;font-weight:700;text-align:center;letter-spacing:0.2px;">ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø±</div>
      <div id="monthsManagerContent" style="overflow-x:auto;max-height:60vh;padding-bottom:4px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div style="margin-top:12px;text-align:center;display:flex;flex-wrap:wrap;gap:7px;justify-content:center;">
        <button id="addNewMonthBtn" style="background:#1976d2;color:white;padding:10px 16px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">â• Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø±</button>
        <button id="toggleAutoMonthBtn" style="background:#ffb300;color:#333;padding:10px 16px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">â€”</button>
      </div>
      <div style="font-size:13px;color:#888;margin-top:10px;text-align:center;">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø±ØŒ Ø¥ØºÙ„Ø§Ù‚Ù‡Ø§ØŒ Ø¥Ø®ÙØ§Ø¦Ù‡Ø§ØŒ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§ØªØŒ Ù†Ø³Ø® Ø£Ùˆ Ø­Ø°Ù Ø´Ù‡Ø±ØŒ ÙˆØ§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ù‡Ù†Ø§.</div>
    </div>
    <style>
      #monthsManagerModalInner table {
        width: 100%;
        border-collapse: collapse;
        font-size: 15px;
        margin-bottom: 8px;
        background: #fafbfc;
      }
      #monthsManagerModalInner th, #monthsManagerModalInner td {
        border: 1px solid #e0e0e0;
        padding: 7px 4px;
        text-align: center;
      }
      #monthsManagerModalInner th {
        background: #e3f0ff;
        color: #1976d2;
        font-size: 15px;
      }
      #monthsManagerModalInner td {
        font-size: 15px;
      }
      #monthsManagerModalInner button.advMonthBtn {
        padding: 4px 10px;
        font-size: 14px;
        border-radius: 6px;
        margin: 0 2px;
      }
      @media (max-width: 600px) {
        #monthsManagerModalInner {
          max-width: 99vw !important;
          padding: 10px 2vw 10px 2vw !important;
        }
        #monthsManagerModalInner table, #monthsManagerModalInner th, #monthsManagerModalInner td {
          font-size: 13px !important;
          padding: 5px 2px !important;
        }
        #monthsManagerModalInner button, #monthsManagerModalInner .advMonthBtn {
          font-size: 13px !important;
          padding: 7px 8px !important;
        }
      }
      #closeMonthsManagerBtn:hover { background:#b71c1c !important; }
      #addNewMonthBtn:hover { background:#1565c0 !important; color:#fff; }
      #toggleAutoMonthBtn:hover { background:#ff9800 !important; }
    </style>
  `;
          document.body.appendChild(modal);
          document.getElementById("closeMonthsManagerBtn").onclick =
            function () {
              modal.style.display = "none";
            };
          loadMonthsManagerContent();
        }

        function loadMonthsManagerContent() {
          const contentDiv = document.getElementById("monthsManagerContent");
          contentDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
          Promise.all([
            db.ref("monthsSettings").once("value"),
            db.ref("attendance").once("value"),
            db.ref("employees").once("value"),
            db.ref("months").once("value"),
            db.ref("monthsNotes").once("value"),
            db.ref("activityLog").once("value"),
          ]).then(([
            settingsSnap,
            attSnap,
            empSnap,
            monthsSnap,
            notesSnap,
            logSnap,
          ]) => {
            const settings = settingsSnap.val() || {
              auto: true,
              closed: {},
              hidden: {},
            };
            const data = attSnap.val() || {};
            const legacyEmployees = empSnap.val() || {};
            const monthsTree = monthsSnap.val() || {};
            // Merge employees from legacy `employees` root and new `months` structured nodes
            const allEmployees = Object.assign({}, legacyEmployees);
            Object.entries(monthsTree).forEach(([y, monthsObj]) => {
              Object.entries(monthsObj || {}).forEach(([mm, monthObj]) => {
                if (monthObj && monthObj.employees) {
                  Object.entries(monthObj.employees).forEach(([id, val]) => {
                    // if structured as object {name:..}, extract name, else take value
                    const name = typeof val === "string" ? val : val.name || "";
                    if (name) allEmployees[id] = name;
                  });
                }
              });
            });
            const monthsNotes = notesSnap.val() || {};
            const activityLog = logSnap.val() || {};
            const monthsSet = new Set();
            Object.keys(data).forEach((key) => {
              const parts = key.split("-");
              if (parts.length === 3) {
                const m = parseInt(parts[1]) - 1;
                const y = parseInt(parts[0]);
                monthsSet.add(`${y}-${m}`);
              }
            });
            if (settings.manual && Array.isArray(settings.manual)) {
              settings.manual.forEach((m) => monthsSet.add(m));
            }
            const monthsArr = Array.from(monthsSet).sort((a, b) => {
              const [ya, ma] = a.split("-").map(Number),
                [yb, mb] = b.split("-").map(Number);
              return ya !== yb ? ya - yb : ma - mb;
            });
            let html = `<table style='width:100%;border-collapse:collapse;margin-bottom:10px;'>
      <tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥ØºÙ„Ø§Ù‚</th><th>Ø¥Ø®ÙØ§Ø¡</th><th>Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</th></tr>`;
            monthsArr.forEach((m) => {
              const [y, mo] = m.split("-");
              const label = `${arMonths[parseInt(mo)]} ${y}`;
              const isClosed = settings.closed && settings.closed[m];
              const isHidden = settings.hidden && settings.hidden[m];
              const isDefault = settings.defaultMonth === m;
              // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
              let empKey = `employees_${y}_${(parseInt(mo) + 1)
                .toString()
                .padStart(2, "0")}`;
              let empArr = allEmployees[empKey]
                ? Object.values(allEmployees[empKey])
                : [];
              let empCount = empArr.length;
              let daysCount = Object.keys(data).filter((k) =>
                k.startsWith(`${y}-${parseInt(mo) + 1}`)
              ).length;
              html += `<tr>
        <td><span style="font-weight:bold;">${label}</span><br><span style="font-size:12px;color:#888;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${empCount} | Ø£ÙŠØ§Ù…: ${daysCount}</span></td>
        <td>${
          isClosed
            ? '<span style="color:#d32f2f;font-weight:bold;">Ù…ØºÙ„Ù‚</span>'
            : '<span style="color:#388e3c;font-weight:bold;">Ù…ÙØªÙˆØ­</span>'
        }${
                isDefault
                  ? '<br><span style="color:#1976d2;font-size:12px;">Ø§ÙØªØ±Ø§Ø¶ÙŠ</span>'
                  : ""
              }</td>
        <td><input type='checkbox' data-month='${m}' class='closeMonthChk' ${
                isClosed ? "checked" : ""
              }></td>
        <td><input type='checkbox' data-month='${m}' class='hideMonthChk' ${
                isHidden ? "checked" : ""
              }></td>
        <td>
          <button class='advMonthBtn' data-month='${m}' style='background:#eee;color:#333;font-size:13px;padding:3px 8px;border-radius:5px;border:none;cursor:pointer;'>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø©</button>
        </td>
      </tr>`;
            });
            html += `</table>`;
            contentDiv.innerHTML = html;
            // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            Array.from(
              document.getElementsByClassName("closeMonthChk")
            ).forEach((chk) => {
              chk.onchange = function () {
                const m = chk.getAttribute("data-month");
                db.ref("monthsSettings/closed/" + m).set(chk.checked);
              };
            });
            Array.from(document.getElementsByClassName("hideMonthChk")).forEach(
              (chk) => {
                chk.onchange = function () {
                  const m = chk.getAttribute("data-month");
                  db.ref("monthsSettings/hidden/" + m).set(chk.checked);
                };
              }
            );
            // Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„ÙƒÙ„ Ø´Ù‡Ø±
            Array.from(document.getElementsByClassName("advMonthBtn")).forEach(
              (btn) => {
                btn.onclick = function () {
                  const m = btn.getAttribute("data-month");
                  showMonthAdvancedOptions(
                    m,
                    monthsArr,
                    settings,
                    data,
                    allEmployees,
                    monthsNotes,
                    activityLog
                  );
                };
              }
            );
          });
          // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯
          document.getElementById("addNewMonthBtn").onclick = function () {
            let now = new Date();
            let y = now.getFullYear(),
              m = now.getMonth();
            let nextM = m + 1,
              nextY = y;
            if (nextM > 11) {
              nextM = 0;
              nextY++;
            }
            const key = `${nextY}-${nextM}`;
            db.ref("monthsSettings/manual")
              .once("value")
              .then((snap) => {
                let arr = snap.val() || [];
                if (!arr.includes(key)) arr.push(key);
                db.ref("monthsSettings/manual")
                  .set(arr)
                  .then(loadMonthsManagerContent);
              });
          };
          // Ø²Ø± ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
          db.ref("monthsSettings/auto")
            .once("value")
            .then((snap) => {
              const auto = snap.val() !== false;
              const btn = document.getElementById("toggleAutoMonthBtn");
              btn.textContent = auto
                ? "ğŸ”„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ù…ÙØ¹Ù„"
                : "â¸ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ù…Ø¹Ø·Ù„";
              btn.style.background = auto ? "#ffb300" : "#bdbdbd";
              btn.onclick = function () {
                db.ref("monthsSettings/auto")
                  .set(!auto)
                  .then(loadMonthsManagerContent);
              };
            });
        }

        // Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„ÙƒÙ„ Ø´Ù‡Ø±
        function showMonthAdvancedOptions(
          m,
          monthsArr,
          settings,
          data,
          allEmployees,
          monthsNotes,
          activityLog
        ) {
          let advModal = document.getElementById("monthAdvModal");
          if (advModal) advModal.remove();
          advModal = document.createElement("div");
          advModal.id = "monthAdvModal";
          advModal.style =
            "position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9500;display:flex;align-items:center;justify-content:center;";
          const [y, mo] = m.split("-");
          const label = `${arMonths[parseInt(mo)]} ${y}`;
          let empKey = `employees_${y}_${(parseInt(mo) + 1)
            .toString()
            .padStart(2, "0")}`;
          let empCount = allEmployees[empKey]
            ? Object.values(allEmployees[empKey]).length
            : 0;
          let daysCount = Object.keys(data).filter((k) =>
            k.startsWith(`${y}-${parseInt(mo) + 1}`)
          ).length;
          let note = monthsNotes[m] || "";
          let isClosed = settings.closed && settings.closed[m];
          let isHidden = settings.hidden && settings.hidden[m];
          let isDefault = settings.defaultMonth === m;
          let closeMsg =
            settings.closeMsg && settings.closeMsg[m]
              ? settings.closeMsg[m]
              : "";
          // Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø·
          let monthLog = Object.values(activityLog).filter(
            (l) => l.month === m || (l.details && l.details.includes(m))
          );
          advModal.innerHTML = `
    <div style="background:#fff;max-width:440px;width:97vw;border-radius:16px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;">
      <button id="closeMonthAdvModalBtn" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
      <div style="font-size:20px;color:#1976d2;margin-bottom:10px;font-weight:600;text-align:center;">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø´Ù‡Ø±: ${label}</div>
      <div style="font-size:13px;color:#888;margin-bottom:8px;">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: ${empCount} | Ø£ÙŠØ§Ù…: ${daysCount}</div>
      <label style="font-size:15px;font-weight:500;">Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø±:
        <input id="renameMonthInput" type="text" value="${label}" style="width:70%;margin:0 0 8px 0;padding:5px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;">
        <button id="renameMonthBtn" style="background:#1976d2;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">ØªØºÙŠÙŠØ±</button>
      </label>
      <label style="font-size:15px;font-weight:500;">Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©:
        <textarea id="monthNoteInput" style="width:95%;min-height:40px;margin:0 0 8px 0;border-radius:6px;border:1px solid #ccc;font-size:15px;">${note}</textarea>
        <button id="saveMonthNoteBtn" style="background:#ffb300;color:#333;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">Ø­ÙØ¸</button>
      </label>
      <label style="font-size:15px;font-weight:500;">Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ù‚ÙÙ„ Ø§Ù„Ø´Ù‡Ø±:
        <input id="closeMsgInput" type="text" value="${closeMsg}" style="width:80%;margin:0 0 8px 0;padding:5px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;">
        <button id="saveCloseMsgBtn" style="background:#d32f2f;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">Ø­ÙØ¸</button>
      </label>
      <div style="margin:8px 0 0 0;display:flex;gap:7px;flex-wrap:wrap;">
        <button id="setDefaultMonthBtn" style="background:${
          isDefault ? "#1976d2" : "#eee"
        };color:${
            isDefault ? "#fff" : "#333"
          };padding:4px 10px;border:none;border-radius:6px;font-size:14px;">${
            isDefault ? "Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø­Ø§Ù„ÙŠØ§Ù‹" : "ØªØ¹ÙŠÙŠÙ† ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ"
          }</button>
        <button id="copyMonthBtn" style="background:#2196f3;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø´Ù‡Ø± Ø¢Ø®Ø±</button>
        <button id="deleteMonthBtn" style="background:#dc3545;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±</button>
        <button id="restoreMonthBtn" style="background:#388e3c;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;display:${
          isHidden ? "inline-block" : "none"
        };">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ù‡Ø±</button>
      </div>
      <div style="margin:12px 0 0 0;">
        <b>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±:</b>
        <div style="max-height:90px;overflow:auto;border:1px solid #eee;border-radius:7px;padding:5px 7px;background:#fafafa;font-size:13px;">
          ${
            monthLog.length
              ? monthLog
                  .map(
                    (l) =>
                      `<div style='border-bottom:1px solid #eee;margin-bottom:3px;'>${
                        l.time || ""
                      } - ${l.user || ""}: ${l.action || ""}</div>`
                  )
                  .join("")
              : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª."
          }
        </div>
      </div>
    </div>
  `;
          document.body.appendChild(advModal);
          document.getElementById("closeMonthAdvModalBtn").onclick =
            function () {
              advModal.remove();
            };
          // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ© (ÙÙ‚Ø· ÙˆØ§Ø¬Ù‡Ø©ØŒ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…)
          document.getElementById("renameMonthBtn").onclick = function () {
            const newName = document
              .getElementById("renameMonthInput")
              .value.trim();
            if (!newName) return alert("âŒ Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹");
            db.ref("monthsSettings/renames/" + m)
              .set(newName)
              .then(() => {
                alert("âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙ‚Ø·");
                advModal.remove();
                loadMonthsManagerContent();
              });
          };
          // Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©
          document.getElementById("saveMonthNoteBtn").onclick = function () {
            const noteVal = document.getElementById("monthNoteInput").value;
            db.ref("monthsNotes/" + m)
              .set(noteVal)
              .then(() => {
                alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©");
              });
          };
          // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„
          document.getElementById("saveCloseMsgBtn").onclick = function () {
            const msg = document.getElementById("closeMsgInput").value;
            db.ref("monthsSettings/closeMsg/" + m)
              .set(msg)
              .then(() => {
                alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
              });
          };
          // ØªØ¹ÙŠÙŠÙ† ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
          document.getElementById("setDefaultMonthBtn").onclick = function () {
            db.ref("monthsSettings/defaultMonth")
              .set(m)
              .then(() => {
                alert("âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ù‡Ø± ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ");
                advModal.remove();
                loadMonthsManagerContent();
              });
          };
          // Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ù‡Ø±
          document.getElementById("copyMonthBtn").onclick = function () {
            let target = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‡Ø¯Ù (Ù…Ø«Ø§Ù„: 2025-8)");
            if (!target || !/^\d{4}-\d{1,2}$/.test(target))
              return alert("âŒ ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
            // Ù†Ø³Ø® Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            let srcEmpKey = empKey;
            let tgtEmpKey = `employees_${target.split("-")[0]}_${(
              parseInt(target.split("-")[1]) + 1
            )
              .toString()
              .padStart(2, "0")}`;
            db.ref(srcEmpKey)
              .once("value")
              .then((snap) => {
                db.ref(tgtEmpKey).set(snap.val() || []);
              });
            // Ù†Ø³Ø® Ø§Ù„Ø­Ø¶ÙˆØ±
            Object.keys(data)
              .filter((k) => k.startsWith(`${y}-${parseInt(mo) + 1}`))
              .forEach((dayKey) => {
                let tgtDayKey = target + "-" + dayKey.split("-")[2];
                db.ref("attendance/" + tgtDayKey).set(data[dayKey]);
              });
            alert("âœ… ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±");
          };
          // Ø­Ø°Ù Ø´Ù‡Ø±
          document.getElementById("deleteMonthBtn").onclick = function () {
            if (
              !confirm(
                "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±."
              )
            )
              return;
            // Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            db.ref(empKey).remove();
            // Ø­Ø°Ù Ø§Ù„Ø­Ø¶ÙˆØ±
            Object.keys(data)
              .filter((k) => k.startsWith(`${y}-${parseInt(mo) + 1}`))
              .forEach((dayKey) => {
                db.ref("attendance/" + dayKey).remove();
              });
            // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
            db.ref("monthsNotes/" + m).remove();
            // Ø­Ø°Ù Ù…Ù† monthsSettings.manual Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¯ÙˆÙŠ
            db.ref("monthsSettings/manual")
              .once("value")
              .then((snap) => {
                let arr = snap.val() || [];
                arr = arr.filter((x) => x !== m);
                db.ref("monthsSettings/manual").set(arr);
              });
            alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±");
            advModal.remove();
            loadMonthsManagerContent();
          };
          // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø´Ù‡Ø± Ù…Ø®ÙÙŠ
          document.getElementById("restoreMonthBtn").onclick = function () {
            db.ref("monthsSettings/hidden/" + m)
              .set(false)
              .then(() => {
                alert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ù‡Ø±");
                advModal.remove();
                loadMonthsManagerContent();
              });
          };
        }

        // Ø²Ø± Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ© (edit Ø£Ùˆ read)
        db.ref("users/" + currentUser)
          .once("value")
          .then((snap) => {
            const data = snap.val() || {};
            const perm = data.notesPermission || "edit";
            const notesBtn = document.getElementById("sidebarNotesBtn");
            if (notesBtn) {
              if (perm === "edit" || perm === "read") {
                notesBtn.style.display = "block";
              } else {
                notesBtn.style.display = "none";
              }
            }
          });

        // Ø²Ø± Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ©
        db.ref("users/" + currentUser)
          .once("value")
          .then((snapshot) => {
            const data = snapshot.val() || {};
            let logBtn = document.getElementById("sidebarUserLogBtn");
            if (data.canViewLog) {
              if (!logBtn) {
                logBtn = document.createElement("button");
                logBtn.id = "sidebarUserLogBtn";
                logBtn.style = "background:#673ab7;color:white;";
                logBtn.textContent = "ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª";
                logBtn.onclick = function () {
                  document
                    .getElementById("sidebarMenu")
                    .classList.remove("open");
                  // Ù†Ø§ÙØ°Ø© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                  let modal = document.getElementById("userLogModal");
                  if (!modal) {
                    modal = document.createElement("div");
                    modal.id = "userLogModal";
                    modal.style.position = "fixed";
                    modal.style.top = "0";
                    modal.style.left = "0";
                    modal.style.width = "100vw";
                    modal.style.height = "100vh";
                    modal.style.background = "rgba(0,0,0,0.35)";
                    modal.style.zIndex = "7000";
                    modal.style.display = "flex";
                    modal.style.alignItems = "center";
                    modal.style.justifyContent = "center";
                    modal.innerHTML = `
                <div style="background:#fff;max-width:400px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;">
                  <button id="closeUserLogModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">âœ–</button>
                  <h3 style="text-align:center;margin-bottom:18px;color:#673ab7;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
                  <div id="userLogContent">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
              `;
                    document.body.appendChild(modal);
                    document.getElementById("closeUserLogModal").onclick =
                      function () {
                        modal.style.display = "none";
                      };
                  } else {
                    modal.style.display = "flex";
                  }
                  // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·
                  db.ref("activityLog")
                    .orderByChild("user")
                    .equalTo(currentUser)
                    .limitToLast(30)
                    .once("value")
                    .then((snapshot) => {
                      const log = snapshot.val() || {};
                      let html = `<table class="activity-log-table">
                <tr>
                  <th>Ø§Ù„ÙˆÙ‚Øª</th>
                  <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                </tr>`;
                      Object.values(log)
                        .reverse()
                        .forEach((item) => {
                          html += `<tr>
                  <td>${toEnglishNumbers(item.time || "")}</td>
                  <td>${item.action || ""}</td>
                  <td>${item.details || ""}</td>
                </tr>`;
                        });
                      html += `</table>`;
                      document.getElementById("userLogContent").innerHTML =
                        html;
                    });
                };
                sidebarMenu.appendChild(logBtn);
              } else {
                logBtn.style.display = "block";
              }
            } else {
              if (logBtn) logBtn.style.display = "none";
            }
          });

        if (localStorage.getItem("loggedUser")) {
          sidebarToggleBtn.style.display = sidebarMenu.classList.contains(
            "open"
          )
            ? "none"
            : "flex";
          sidebarCloseBtn.style.display = sidebarMenu.classList.contains("open")
            ? "flex"
            : "none";
        } else {
          sidebarToggleBtn.style.display = "none";
          sidebarCloseBtn.style.display = "none";
          sidebarMenu.classList.remove("open");
        }
      }
      // Ø²Ø± ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
      document.getElementById("sidebarToggleBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.add("open");
        document.getElementById("sidebarToggleBtn").style.display = "none";
        document.getElementById("sidebarCloseBtn").style.display = "flex";
        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const sidebarUserName = document.getElementById("sidebarUserName");
        sidebarUserName.textContent = currentUser
          ? "ğŸ‘¤ " + currentUser
          : "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
        updateSidebarVisibility();
      };
      // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
      document.getElementById("sidebarCloseBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        document.getElementById("sidebarCloseBtn").style.display = "none";
        document.getElementById("sidebarToggleBtn").style.display = "flex";
        updateSidebarVisibility();
      };
      // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¨Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠØ©
      document.getElementById("sidebarAdminBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        setTimeout(() => toggleAdminPanel(), 100);
      };
      document.getElementById("sidebarEmpStatsBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        setTimeout(
          () => document.getElementById("toggleEmpStatsBtn").click(),
          100
        );
      };
      document.getElementById("sidebarDeleteDataBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        setTimeout(() => document.getElementById("btnDeleteData").click(), 100);
      };
      document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        setTimeout(() => {
          document.getElementById("btnFeaturesTab").click();
          document.getElementById("featuresTab").style.display = "flex";
          const featuresTabContent =
            document.getElementById("featuresTabContent");
          featuresTabContent.innerHTML = `
        <div class="feature-section">
          <h4>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h4>
          <div id="activityLogBox">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <div class="feature-section" style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <h4 style="margin:0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
            <div id="featuresShowMorePlaceholder"></div>
          </div>
          <ul style="margin:0;padding:0 0 0 15px;">
            <li>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${employees.length}</b></li>
            <li>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${currentUser}</b></li>
            <li>Ø§Ù„Ø¯ÙˆØ±: <b>${currentUserRole}</b></li>
          </ul>
        </div>
      `;
          db.ref("activityLog")
            .limitToLast(30)
            .once("value")
            .then((snapshot) => {
              const log = snapshot.val() || {};
              // use shared renderer
              if (typeof renderActivityLog === 'function') {
                renderActivityLog(30, 'activityLogBox');
              } else {
                // fallback: basic rendering
                let html = `<table class="activity-log-table">
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
            <th>Ø§Ù„ÙˆØµÙ</th>
          </tr>`;
                Object.values(log)
                  .reverse()
                  .forEach((item) => {
                    html += `<tr>
            <td>${toEnglishNumbers(item.time || "")}</td>
            <td>${item.user || ""}</td>
            <td>${item.action || ""}</td>
            <td>${item.details || ""}</td>
          </tr>`;
                  });
                html += `</table>`;
                document.getElementById("activityLogBox").innerHTML = html;
              }
              // ensure a single well-styled 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯' button exists and is attached
              ensureFeaturesShowMoreButton('activityLogBox');
            });
          // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
          const closeBtn = document.getElementById("closeFeaturesTab");
          if (closeBtn) {
            closeBtn.onclick = () => {
              document.getElementById("featuresTab").style.display = "none";
            };
          }
        }, 100);
      };
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
      document.addEventListener("DOMContentLoaded", () => {
        [
          "toggleEmpStatsBtn",
          "btnDeleteData",
          "btnFeaturesTab",
        ].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.style.display = "none";
        });
        updateSidebarVisibility();
      });
      window.addEventListener("storage", updateSidebarVisibility);
      window.addEventListener("focus", updateSidebarVisibility);
      setInterval(updateSidebarVisibility, 1000);
    </script>
    <!-- Announcement modal -->
    <div
      id="announceModal"
      style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:7000;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:420px;width:94vw;border-radius:12px;padding:18px;box-shadow:0 8px 32px #0002;position:relative;">
        <button id="closeAnnounceModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:#fff;border:none;border-radius:50%;width:30px;height:30px;">âœ–</button>
        <h3 style="text-align:center;color:#ff6f00;margin-bottom:10px;">ğŸ“¢ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ù„Ø§Ù†</h3>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <textarea id="announceText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬Ø²Ø© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†" style="width:100%;min-height:80px;padding:8px;border:1px solid #ccc;border-radius:8px;font-size:15px;resize:vertical;"></textarea>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="font-size:14px;margin:0;">Ø­Ø¬Ù… Ø§Ù„Ø®Ø·:</label>
            <select id="announceFontSize" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ccc;">
              <option value="16">ØµØºÙŠØ± (16px)</option>
              <option value="18" selected>Ø§ÙØªØ±Ø§Ø¶ÙŠ (18px)</option>
              <option value="20">Ù…ØªÙˆØ³Ø· (20px)</option>
              <option value="24">ÙƒØ¨ÙŠØ± (24px)</option>
            </select>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <label style="font-size:14px;margin:0;">Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ù…Ø¤Ù‚Øª:</label>
            <input id="announceBgColor" type="color" value="#ff8a00" style="width:56px;height:36px;border-radius:6px;border:1px solid #ccc;padding:2px;" />
            <span style="font-size:12px;color:#fff;background:#0000;padding:0 6px;">&nbsp;</span>
          </div>
          <label style="font-size:14px;">Ø§Ù„Ù…Ø¯Ø©:</label>
          <select id="announceDuration" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;">
            <option value="5">5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="15">15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            <option value="30">30 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            <option value="60">1 Ø³Ø§Ø¹Ø©</option>
            <option value="180">3 Ø³Ø§Ø¹Ø§Øª</option>
            <option value="720">12 Ø³Ø§Ø¹Ø©</option>
            <option value="1440">24 Ø³Ø§Ø¹Ø©</option>
            <option value="custom">Ø£Ø®Ø±Ù‰ (Ø¯Ù‚Ø§Ø¦Ù‚)</option>
          </select>
          <div style="display:flex;gap:8px;">
            <button id="publishAnnounceBtn" style="flex:1;background:#ff6f00;color:white;border:none;padding:10px;border-radius:8px;">Ù†Ø´Ø±</button>
            <button id="previewAnnounceBtn" style="flex:1;background:#1976d2;color:white;border:none;padding:10px;border-radius:8px;">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
          </div>
          <div style="display:flex;gap:8px;margin-top:6px;">
            <button id="deleteCurrentAnnounceBtn" style="flex:1;background:#e53935;color:white;border:none;padding:8px;border-radius:8px;display:none;">Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Announcement bar (fixed at top) -->
    <div id="announcementBar" style="display:none;position:fixed;top:0;left:0;right:0;height:auto;background:linear-gradient(90deg,#ff8a00,#ff6f00);color:#fff;z-index:2000;align-items:center;overflow:visible;padding:8px 14px;">
      <div id="announcementInner" style="white-space:normal;display:block;padding:0 12px;font-weight:700;font-size:18px;line-height:1.2;font-family:'Segoe UI', Tahoma, Arial, sans-serif;letter-spacing:0.2px;text-align:center;">&nbsp;</div>
      <button id="closeAnnouncementBar" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" title="Ø¥ØºÙ„Ø§Ù‚" style="position:absolute;right:10px;top:8px;width:36px;height:36px;background:rgba(255,255,255,0.08);border:none;color:#fff;border-radius:8px;font-size:18px;display:none;align-items:center;justify-content:center;cursor:pointer;">âœ–</button>
    </div>
    <!-- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª - ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <script>
      // Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
      function logActivity(action, details, extra = {}) {
        const now = new Date();
        // format without seconds
        const time = formatDateTimeNoSeconds(now);
        let style = "";
        if (extra && extra.type === "note") {
          style = "background:#fffde7;border-left:5px solid #ffb300;";
        }
        db.ref("activityLog").push({
          time,
          action,
          details,
          user: currentUser,
          ...extra,
          style,
        });
      }

      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
      function toEnglishNumbers(str) {
        return str.replace(/[Ù -Ù©]/g, (d) => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
      }

      // Format a Date to 'DD/MM/YYYY HH:MM' (Arabic locale) without seconds
      function formatDateTimeNoSeconds(d) {
        try {
          const datePart = toEnglishNumbers(d.toLocaleDateString("ar-EG"));
          const timePart = toEnglishNumbers(
            d.toLocaleTimeString("ar-EG", { hour: "2-digit", minute: "2-digit" })
          );
          return datePart + " " + timePart;
        } catch (e) {
          // fallback
          return toEnglishNumbers(d.toLocaleDateString("ar-EG")) + " " + toEnglishNumbers(d.toLocaleTimeString("ar-EG"));
        }
      }

      // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ± ÙØ¹Ù„ÙŠ
      async function saveData() {
        if (!currentUserCanEdit) {
          alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");
          return;
        }
        const days = getDays();
        // Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø· Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
        let monthEmployees = employees.slice();
        try {
          const attendanceSnapshot = await db.ref("attendance").once("value");
          const savedData = attendanceSnapshot.val() || {};
          const updatedData = { ...savedData };
          let changes = [];
          let anyChange = false;
          days.forEach((day, dayIndex) => {
            if (!updatedData[day.key]) updatedData[day.key] = {};
            let dayChanged = false;
            monthEmployees.forEach((employee, empIndex) => {
              const selectElement = document.getElementById(
                `d${dayIndex}e${empIndex}`
              );
              if (selectElement) {
                const newValue = selectElement.value;
                const oldValue = savedData[day.key]
                  ? savedData[day.key][employee]
                  : "";
                if (newValue !== oldValue) {
                  updatedData[day.key][employee] = newValue;
                  dayChanged = true;
                  anyChange = true;
                  changes.push({
                    user: currentUser,
                    day: day.key,
                    employee,
                    old: oldValue,
                    new: newValue,
                    time: formatDateTimeNoSeconds(new Date()),
                  });
                }
              }
            });
            if (dayChanged) {
              updatedData[day.key].__editor = currentUser;
              const now = new Date();
              updatedData[day.key].__editedAt = formatDateTimeNoSeconds(now);
            }
          });
          if (!anyChange) {
            alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù„Ø­ÙØ¸Ù‡.");
            return;
          }
          await db.ref("attendance").set(updatedData);
          alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
          generateTable();
          changes.forEach((change) => {
            logActivity(
              "ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±",
              `
          <span style="color:#007bff;font-weight:bold;">${change.user}</span>
          Ù‚Ø§Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸Ù
          <span style="color:#673ab7;font-weight:bold;">${
            change.employee
          }</span>
          ÙÙŠ Ø§Ù„ÙŠÙˆÙ…
          <span style="color:#009688;font-weight:bold;">${change.day}</span>
          Ù…Ù†
          <span style="background:#d4edda;padding:2px 6px;border-radius:5px;">${
            change.old || "Ø¨Ø¯ÙˆÙ†"
          }</span>
          Ø¥Ù„Ù‰
          <span style="background:#fff9db;padding:2px 6px;border-radius:5px;">${
            change.new || "Ø¨Ø¯ÙˆÙ†"
          }</span>
        `,
              { time: change.time, user: change.user }
            );
          });
        } catch (error) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
          alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
      }

      // Ø²Ø± Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø© + Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
      document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        document.getElementById("btnFeaturesTab").click();
        document.getElementById("featuresTab").style.display = "flex";
        const featuresTabContent =
          document.getElementById("featuresTabContent");
        featuresTabContent.innerHTML = `
    <div class="feature-section">
      <h4>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h4>
      <div id="activityLogBox">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
        <div class="feature-section" style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <h4 style="margin:0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
            <div id="featuresShowMorePlaceholder"></div>
          </div>
          <ul style="margin:0;padding:0 0 0 15px;">
        <li>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${employees.length}</b></li>
        <li>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${currentUser}</b></li>
        <li>Ø§Ù„Ø¯ÙˆØ±: <b>${currentUserRole}</b></li>
      </ul>
    </div>
  `;
        db.ref("activityLog")
          .limitToLast(30)
          .once("value")
          .then((snapshot) => {
            const log = snapshot.val() || {};
            let html = `<table class="activity-log-table" style="width:100%;border-collapse:collapse;">
        <tr>
          <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„ÙˆÙ‚Øª</th>
          <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„Ù†Ø´Ø§Ø·</th>
          <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„ÙˆØµÙ</th>
        </tr>`;
            Object.values(log)
              .reverse()
              .forEach((item) => {
                html += `<tr style='${item.style || ""}'>
          <td>${toEnglishNumbers(item.time || "")}</td>
          <td>${item.user || ""}</td>
          <td>${item.action || ""}</td>
          <td>${item.details || ""}</td>
        </tr>`;
              });
            html += `</table>`;
            document.getElementById("activityLogBox").innerHTML = html;
            ensureFeaturesShowMoreButton('activityLogBox');
          });
        // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
        const closeBtn = document.getElementById("closeFeaturesTab");
        if (closeBtn) {
          closeBtn.onclick = () => {
            document.getElementById("featuresTab").style.display = "none";
          };
        }
      };

      // Helper: render activity log into a container with a 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯' button
      function renderActivityLog(limit, containerId) {
        limit = limit || 30;
        const container = document.getElementById(containerId || 'activityLogBox');
        if (!container) return;
        container.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        db.ref('activityLog')
          .limitToLast(limit)
          .once('value')
          .then((snapshot) => {
            const log = snapshot.val() || {};
            let html = `<table class="activity-log-table" style="width:100%;border-collapse:collapse;">
              <tr>
                <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„ÙˆÙ‚Øª</th>
                <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„Ù†Ø´Ø§Ø·</th>
                <th style='background:#f0f0f0;padding:7px;'>Ø§Ù„ÙˆØµÙ</th>
              </tr>`;
            Object.values(log).reverse().forEach((item) => {
              html += `<tr style='${item.style || ""}'>
                <td>${toEnglishNumbers(item.time || "")}</td>
                <td>${item.user || ""}</td>
                <td>${item.action || ""}</td>
                <td>${item.details || ""}</td>
              </tr>`;
            });
            html += `</table>`;
            // add 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯' button only when limit < 80
            if (limit < 80) {
              html += `<div style="display:flex;justify-content:center;margin-top:12px;">
                <button id="showMoreActivityBtn" style="background:linear-gradient(90deg,#6a82fb,#283e51);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;box-shadow:0 4px 12px #6a82fb33;font-weight:700;">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</button>
              </div>`;
            }
            container.innerHTML = html;
            // attach click handler
            const moreBtn = document.getElementById('showMoreActivityBtn');
            if (moreBtn) {
              moreBtn.onclick = function () {
                // load last 80 edits
                renderActivityLog(80, containerId);
                // smooth scroll to the log container
                setTimeout(() => {
                  container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 120);
              };
            }
          })
          .catch((err) => {
            container.innerHTML = '<div style="color:#d32f2f;text-align:center;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</div>';
            console.error('Error loading activity log:', err);
          });
      }

      // Ensure a single, well-styled 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯' button is present in the features tab
      function ensureFeaturesShowMoreButton(containerId) {
        try {
          const placeholder = document.getElementById('featuresShowMorePlaceholder');
          if (!placeholder) return;
          // Remove any existing global buttons with the same id to avoid duplicates
          const existing = Array.from(document.querySelectorAll('#featuresShowMoreBtn'));
          existing.forEach((el) => {
            // if it's already inside the current placeholder, keep it
            if (el.parentElement !== placeholder) el.remove();
          });
          // If button already exists inside placeholder, reuse it
          let btn = placeholder.querySelector('#featuresShowMoreBtn');
          if (!btn) {
            btn = document.createElement('button');
            btn.id = 'featuresShowMoreBtn';
            btn.className = 'features-show-more-btn';
            btn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯';
            placeholder.appendChild(btn);
          }
          // attach handler (idempotent)
          btn.onclick = function () {
            // visually disable while loading
            btn.disabled = true;
            const oldText = btn.textContent;
            btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            renderActivityLog(80, containerId || 'activityLogBox');
            setTimeout(() => {
              btn.textContent = oldText;
              btn.disabled = false;
              // hide the button after loading 80 entries
              try { btn.style.display = 'none'; } catch(e){}
            }, 800);
          };
        } catch (e) {
          console.error('ensureFeaturesShowMoreButton error', e);
        }
      }

      // Responsive styling for the features-show-more button
      if (!document.getElementById('featuresShowMoreStyles')) {
        const fs = document.createElement('style');
        fs.id = 'featuresShowMoreStyles';
        fs.innerHTML = `
          .features-show-more-btn{ background:linear-gradient(90deg,#5b6bff,#2b3b71); color:#fff; border:none; padding:7px 10px; border-radius:6px; cursor:pointer; box-shadow:0 6px 18px rgba(43,59,113,0.14); font-weight:700; font-size:13px; }
          @media (max-width:600px){ .features-show-more-btn{ padding:6px 8px; font-size:12px; border-radius:6px; box-shadow:none; } }
        `;
        document.head.appendChild(fs);
      }

      // Ù†Ø§ÙØ°Ø© ØªØ­ÙƒÙ… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
      document.getElementById("sidebarUserControlBtn").onclick = function () {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©
        let modal = document.getElementById("userLogControlModal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "userLogControlModal";
          modal.style.position = "fixed";
          modal.style.top = "0";
          modal.style.left = "0";
          modal.style.width = "100vw";
          modal.style.height = "100vh";
          modal.style.background = "rgba(0,0,0,0.35)";
          modal.style.zIndex = "8000";
          modal.style.display = "flex";
          modal.style.alignItems = "center";
          modal.style.justifyContent = "center";
          modal.innerHTML = `
      <div style="background:#fff;max-width:420px;width:95vw;border-radius:14px;box-shadow:0 8px 32px #0002;padding:28px 20px 20px 20px;position:relative;">
        <button id="closeUserLogControlModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#009688;">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
        <div id="userLogControlContent" style="min-height:70px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    `;
          document.body.appendChild(modal);
          document.getElementById("closeUserLogControlModal").onclick =
            function () {
              modal.style.display = "none";
            };
        } else {
          modal.style.display = "flex";
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù…
        db.ref("users")
          .once("value")
          .then((snapshot) => {
            const users = snapshot.val() || {};
            let html = `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <th style="background:#f6f6f6;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th style="background:#f6f6f6;">Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</th>
      </tr>`;
            Object.entries(users).forEach(([username, data]) => {
              if (username === "admin") return; // Ù„Ø§ ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ± Ù†ÙØ³Ù‡
              html += `<tr>
        <td style="padding:7px 4px;">${username}</td>
        <td style="padding:7px 4px;">
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" ${
              data.canViewLog ? "checked" : ""
            } onchange="window.setUserLogAccess('${username}', this.checked)">
            <span style="font-size:13px;color:${
              data.canViewLog ? "#28a745" : "#dc3545"
            };">${data.canViewLog ? "Ù…ÙØ¹Ù„" : "Ù…Ø¹Ø·Ù„"}</span>
          </label>
        </td>
      </tr>`;
            });
            html += `</table>
      <div style="margin-top:10px;font-size:13px;color:#555;">
        Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙŠØ¸Ù‡Ø± Ø²Ø± Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.<br>
        Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø·ÙŠÙ„ ÙŠØ®ØªÙÙŠ Ø§Ù„Ø²Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
      </div>`;
            document.getElementById("userLogControlContent").innerHTML = html;
            window.setUserLogAccess = function (username, enabled) {
              db.ref("users/" + username + "/canViewLog")
                .set(enabled)
                .then(() => {
                  logActivity(
                    "ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª",
                    `ØªÙ… ${
                      enabled ? "ØªÙØ¹ÙŠÙ„" : "ØªØ¹Ø·ÙŠÙ„"
                    } Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username}`
                  );
                  updateSidebarVisibility();
                });
            };
          });
      };
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script>
      // ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ==========
      const firebaseConfig = {
        apiKey: "AIzaSyDh8KquT-8Slr6B5SAGoyGj2zOEusyiEg4",
        authDomain: "sjad-b3946.firebaseapp.com",
        databaseURL: "https://sjad-b3946-default-rtdb.firebaseio.com",
        projectId: "sjad-b3946",
        storageBucket: "sjad-b3946.appspot.com",
        messagingSenderId: "1001672753514",
        appId: "1:1001672753514:web:eac813b6e25621f5d16513",
        measurementId: "G-EV0NVW2036",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      function clearDatabase() {
        // Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±
        let passModal = document.getElementById("adminPassModal");
        if (passModal) passModal.remove();
        passModal = document.createElement("div");
        passModal.id = "adminPassModal";
        passModal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
        passModal.innerHTML = `
    <div style=\"background:#fff;max-width:350px;width:90vw;padding:22px 18px 18px 18px;border-radius:14px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;\">
      <button id=\"closeAdminPassModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">âœ–</button>
      <div style=\"font-size:17px;color:#333;margin-bottom:18px;\">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯:</div>
      <input id=\"adminPassInput\" type=\"password\" style=\"width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;\" />
      <button id=\"adminPassConfirmBtn\" style=\"background:#007bff;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;\">ØªØ£ÙƒÙŠØ¯</button>
    </div>
  `;
        document.body.appendChild(passModal);
        document.getElementById("adminPassConfirmBtn").onclick = function () {
          const adminPass = document.getElementById("adminPassInput").value;
          passModal.remove();
          db.ref("users/admin/password")
            .once("value")
            .then(async (snapshot) => {
              const realAdminPass = snapshot.val();
              const ok = await verifyPassword(realAdminPass, adminPass);
              if (!ok) {
                alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
                return;
              }
              if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
                db.ref("/")
                  .remove()
                  .then(async () => {
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø­ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø´ÙØ±Ø©
                    const hashObj = await hashPassword("admin");
                    await db.ref("users/admin").set({
                      password: hashObj,
                      role: "admin",
                      canEdit: true,
                    });
                    alert(
                      "ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ."
                    );
                  })
                  .catch((err) => alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­: " + err.message));
              }
            });
        };
        document.getElementById("closeAdminPassModalBtn").onclick =
          function () {
            passModal.remove();
          };
      }

      let employees = [];
      let employeeIds = [];
      // ========== Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ========== (Ù…Ø¹ Ù…Ø±Ø§Ù‚Ø¨Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
      document.addEventListener("DOMContentLoaded", function () {
        // Ù…ÙŠØ²Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ ØªÙ… Ø­Ø°ÙÙ‡
        db.ref("users/admin")
          .once("value")
          .then(async (snap) => {
            if (!snap.exists()) {
                let hashObj = null;
                if (typeof hashPassword === "function") {
                  hashObj = await hashPassword("admin");
                } else {
                  hashObj = "admin";
                }
                await db.ref("users/admin").set({
                  password: hashObj,
                  role: "admin",
                  canEdit: true,
                });
                // Debug message removed: account auto-creation is silent in production
              }
          });

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
        var loader = document.getElementById("loaderSpinner");
        if (localStorage.getItem("loggedUser")) {
          loader.style.display = "flex";
          const userObj = JSON.parse(localStorage.getItem("loggedUser"));
          currentUser = userObj.user;
          currentUserRole = userObj.role;
          currentUserCanEdit = userObj.canEdit;
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("mainContent").style.display = "block";
          if (currentUserRole === "admin") {
            document.getElementById("adminPanel").style.display = "block";
            loadUsers();
            loadEmployeesTable();
          } else {
            document.getElementById("adminPanel").style.display = "none";
          }
          // Ø¬Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª allowedStatsEmps Ùˆ canViewSalary ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙÙŠ window.currentUserData
          db.ref("users/" + currentUser)
            .once("value")
            .then((snap) => {
              window.currentUserData = snap.val() || {};
              // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø¥Ø®ÙÙ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
              const empKey = `employees_${year}_${(month + 1)
                .toString()
                .padStart(2, "0")}`;
              loadEmployees(empKey).then(() => {
                generateTable();
                if (typeof tryShowUserEmpStats === "function")
                  tryShowUserEmpStats();
              });
            });
          if (typeof checkForcedLogoutOnLogin === "function")
            checkForcedLogoutOnLogin(currentUser);
          if (typeof updateSidebarVisibility === "function")
            updateSidebarVisibility();
          // ensure announcements button visibility is updated after session restore
          if (typeof updateAnnouncementsVisibility === "function")
            updateAnnouncementsVisibility();
          if (typeof loadAvailableMonths === "function") loadAvailableMonths();
          if (typeof listenForNotifications === "function") {
            listenForNotifications();
          } else {
            // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¯Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯
            setTimeout(() => {
              if (typeof listenForNotifications === "function") {
                listenForNotifications();
              }
            }, 500);
          }

          // Ù…Ø±Ø§Ù‚Ø¨Ø© ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙˆØ±Ø§Ù‹
          if (currentUser !== "admin") {
            db.ref("users/" + currentUser + "/canEdit").on(
              "value",
              function (snap) {
                const newCanEdit = !!snap.val();
                if (currentUserCanEdit !== newCanEdit) {
                  currentUserCanEdit = newCanEdit;
                  if (!window.currentUserData) window.currentUserData = {};
                  window.currentUserData.canEdit = newCanEdit;
                  updateEditabilityUI(newCanEdit);
                  generateTable();
                  if (!currentUserCanEdit) {
                    showPermissionRevokedModal();
                  }
                }
              }
            );
          }

          function updateEditabilityUI(canEdit) {
            document
              .querySelectorAll("select[data-attendance-select]")
              .forEach((sel) => {
                sel.disabled = !canEdit;
              });
            document
              .querySelectorAll(".btn-edit, .btn-save, .btn-delete, .btn-add")
              .forEach((btn) => {
                btn.disabled = !canEdit;
                if (!canEdit) btn.classList.add("disabled");
                else btn.classList.remove("disabled");
              });
          }
          ["allowedStatsEmps", "canViewSalary"].forEach((key) => {
            db.ref("users/" + currentUser + "/" + key).on(
              "value",
              function (snap) {
                if (!window.currentUserData) window.currentUserData = {};
                window.currentUserData[key] = snap.val();
                db.ref("attendance")
                  .once("value")
                  .then((snap2) => {
                    calculateStats(snap2.val() || {});
                    if (typeof renderUserEmpStats === "function")
                      renderUserEmpStats();
                  });
              }
            );
          });
        }
      });
      const statuses = ["", "Ø´ÙØª", "Ù†Øµ", "âŒ"];
      let month = new Date().getMonth();
      const year = new Date().getFullYear();
      const arMonths = [
        "ÙŠÙ†Ø§ÙŠØ±",
        "ÙØ¨Ø±Ø§ÙŠØ±",
        "Ù…Ø§Ø±Ø³",
        "Ø¥Ø¨Ø±ÙŠÙ„",
        "Ù…Ø§ÙŠÙˆ",
        "ÙŠÙˆÙ†ÙŠÙˆ",
        "ÙŠÙˆÙ„ÙŠÙˆ",
        "Ø£ØºØ³Ø·Ø³",
        "Ø³Ø¨ØªÙ…Ø¨Ø±",
        "Ø£ÙƒØªÙˆØ¨Ø±",
        "Ù†ÙˆÙÙ…Ø¨Ø±",
        "Ø¯ÙŠØ³Ù…Ø¨Ø±",
      ];
      let currentUser = "";
      let currentUserRole = "";
      let currentUserCanEdit = false;

      // ========== Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª ==========
      /* duplicate logActivity removed here â€” using the single shared
         implementation defined earlier which preserves formatting and
         optional styling for note-type entries. */

      // ========== Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
      function setSession(userObj) {
        currentUser = userObj.user;
        currentUserRole = userObj.role;
        currentUserCanEdit = userObj.canEdit;
        localStorage.setItem("loggedUser", JSON.stringify(userObj));
        // Ensure UI elements that depend on role (like announcements) update immediately
        try {
          if (typeof updateAnnouncementsVisibility === "function")
            updateAnnouncementsVisibility();
          if (typeof updateSidebarVisibility === "function")
            updateSidebarVisibility();
        } catch (e) {
          console.warn("Failed to update UI after setSession:", e);
        }
      }
      function clearSession() {
        currentUser = "";
        currentUserRole = "";
        currentUserCanEdit = false;
        localStorage.removeItem("loggedUser");
      }

      // ========== Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
      function showMessage(message, isError = false) {
        const messageDiv = document.getElementById("loginMessage");
        if (!message) {
          messageDiv.innerHTML = "";
          messageDiv.className = "";
          return;
        }
        if (isError) {
          messageDiv.innerHTML = `
      <div style='animation:fadeIn 0.4s; background:linear-gradient(135deg,#fff6f6 60%,#ffe3e3 100%); border-radius:16px; box-shadow:0 6px 24px #d32f2f33; padding:22px 28px; display:flex; align-items:center; gap:18px; border:2.5px solid #d32f2f; margin:16px 0; position:relative;'>
        <span style='display:inline-block; animation:shake 0.5s;'>
          <svg width="38" height="38" viewBox="0 0 38 38" style="display:block;">
            <circle cx="19" cy="19" r="17" fill="#fff" stroke="#d32f2f" stroke-width="2.5"/>
            <line x1="12" y1="12" x2="26" y2="26" stroke="#d32f2f" stroke-width="3.5" stroke-linecap="round">
              <animate attributeName="stroke" values="#d32f2f;#ff1744;#d32f2f" dur="1.2s" repeatCount="indefinite"/>
            </line>
            <line x1="26" y1="12" x2="12" y2="26" stroke="#d32f2f" stroke-width="3.5" stroke-linecap="round">
              <animate attributeName="stroke" values="#d32f2f;#ff1744;#d32f2f" dur="1.2s" repeatCount="indefinite"/>
            </line>
          </svg>
        </span>
        <span style='color:#d32f2f; font-weight:bold; font-size:19px; letter-spacing:0.5px; text-shadow:0 2px 8px #d32f2f22;'>${message}</span>
      </div>
      <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
        @keyframes shake { 0% { transform:translateX(0);} 25% { transform:translateX(-4px);} 50% { transform:translateX(4px);} 75% { transform:translateX(-2px);} 100% { transform:translateX(0);} }
      </style>
    `;
          messageDiv.className = "error";
        } else if (message.includes("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")) {
          messageDiv.innerHTML = `
      <div style='animation:fadeIn 0.4s; background:#f6f8fa; border-radius:12px; box-shadow:0 2px 12px #1976d222; padding:13px 18px; display:flex; align-items:center; gap:10px; border:1.5px solid #1976d2; margin:8px 0;'>
        <span class='login-spinner' style='width:24px;height:24px;display:inline-block;'>
          <svg width='24' height='24' viewBox='0 0 50 50' style='animation:spin 0.8s linear infinite;'>
            <circle cx='25' cy='25' r='20' fill='none' stroke='#e3eafc' stroke-width='6'/>
            <circle cx='25' cy='25' r='20' fill='none' stroke='#1976d2' stroke-width='6' stroke-linecap='round' stroke-dasharray='60 90' stroke-dashoffset='0'/>
          </svg>
        </span>
        <span style='color:#1976d2; font-weight:bold; font-size:16px;'>${message}</span>
      </div>
      <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
        @keyframes spin { 100% { transform:rotate(360deg);} }
      </style>
    `;
          messageDiv.className = "loading";
        } else {
          messageDiv.innerHTML = `
      <div style='animation:fadeIn 0.4s; background:#e3f0ff; border-radius:12px; box-shadow:0 2px 12px #1976d222; padding:13px 18px; display:flex; align-items:center; gap:10px; border:1.5px solid #1976d2; margin:8px 0;'>
        <span style='color:#1976d2; font-weight:bold; font-size:16px;'>${message}</span>
      </div>
      <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
      </style>
    `;
          messageDiv.className = "loading";
        }
      }

      // ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ==========
      function login() {
        const username = document
          .getElementById("username")
          .value.trim()
          .toLowerCase();
        const password = document.getElementById("password").value.trim();
        if (!username || !password)
          return showMessage(" ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", true);
        showMessage(" Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
        db.ref("users/" + username)
          .once("value")
          .then(async (snapshot) => {
            if (!snapshot.exists()) throw new Error("User not found");
            const userData = snapshot.val();
            const storedPass = userData.password;
            // debug logs removed
            const ok = await verifyPassword(storedPass, password);
            if (!ok) throw new Error("Wrong password");
              // If maintenance is enabled in DB, block non-admin users from logging in
              try{
                const mSnap = await db.ref('system/maintenance').once('value');
                const mState = mSnap.val() || { enabled: false };
                if(mState.enabled && (!userData || (userData.role !== 'admin')) ){
                  throw new Error('MaintenanceMode');
                }
              }catch(e){ if(e.message === 'MaintenanceMode') throw e; }
            // Ø¥Ø°Ø§ legacyØŒ Ø­Ø¯Ø« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙˆØ±Ø§Ù‹ Ø¥Ù„Ù‰ ØµÙŠØºØ© hash
            if (typeof storedPass === "string") {
              const hashObj = await hashPassword(password);
              await db.ref("users/" + username + "/password").set(hashObj);
            }
            setSession({
              user: username,
              role: userData.role || "user",
              canEdit: userData.canEdit !== undefined ? userData.canEdit : true,
            });
            showMessage("");
            document.getElementById("loginBox").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            const empKey = `employees_${year}_${(month + 1)
              .toString()
              .padStart(2, "0")}`;
            loadEmployees(empKey).then(generateTable);
            if (currentUserRole === "admin") {
              document.getElementById("adminPanel").style.display = "block";
              loadUsers();
              loadEmployeesTable();
              // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
              setTimeout(() => {
                if (typeof loadTelegramSettings === 'function') {
                  loadTelegramSettings();
                }
              }, 500);
            } else {
              document.getElementById("adminPanel").style.display = "none";
            }
            // update announcements visibility immediately after login UI changes
            if (typeof updateAnnouncementsVisibility === "function")
              updateAnnouncementsVisibility();
            checkForcedLogoutOnLogin(username);
          })
          .catch((error) => {
            showMessage(
              error.message === "User not found"
                ? " Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
                : (
                  error.message === 'MaintenanceMode' ? ' Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§ ÙÙŠ ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚' : ' ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'
                ),
              true
            );
            console.error("[LOGIN ERROR]", error);
          });
      }

      function logout() {
        clearSession();
        document.getElementById("loginBox").style.display = "block";
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("adminPanel").style.display = "none";
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        showMessage("");
      }

      // ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ==========
      function loadEmployees() {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById("loaderSpinner").style.display = "flex";
        // new structured path: months/<year>/<MM>/employees
        const mm = (month + 1).toString().padStart(2, "0");
        const empKey = `employees_${year}_${mm}`;
        const newPath = `months/${year}/${mm}/employees`;

        // Helper to migrate a single month from old path to new path (non-destructive)
        function migrateEmployeesForMonthIfNeeded(yearArg, monthArg, oldEmpKey, newPathArg) {
          // Copy data from old path to new path only if new path is empty
          return db
            .ref(newPathArg)
            .once("value")
            .then((newSnap) => {
              if (newSnap.exists()) return Promise.resolve(false); // already migrated
              return db.ref("employees/" + oldEmpKey).once("value").then((oldSnap) => {
                if (!oldSnap.exists()) return false;
                const oldObj = oldSnap.val() || {};
                const toWrite = {};
                Object.entries(oldObj).forEach(([id, name]) => {
                  // store as object for future extensibility but keep name exact
                  toWrite[id] = { name: name, migratedFrom: `employees/${oldEmpKey}` };
                });
                // write copy to new structured path (non-destructive to old data)
                return db
                  .ref(newPathArg)
                  .set(toWrite)
                  .then(() => true)
                  .catch((e) => {
                    console.error("Migration write failed:", e);
                    return false;
                  });
              });
            });
        }

        // Try new structured path first, fallback to legacy path if missing.
        return db
          .ref(newPath)
          .once("value")
          .then((snapshot) => {
            if (snapshot.exists()) {
              const empObj = snapshot.val() || {};
              // empObj may have values either as objects {name:..} or plain strings
              employees = Object.values(empObj).map((v) => (typeof v === "string" ? v : v.name));
              employeeIds = Object.keys(empObj);
              // continue with UI updates below
              return { migrated: false };
            }
            // new path empty -> fallback to old legacy path
            return db
              .ref("employees/" + empKey)
              .once("value")
              .then((oldSnap) => {
                const empObj = oldSnap.exists() ? oldSnap.val() : {};
                employees = Object.values(empObj);
                employeeIds = Object.keys(empObj);
                // attempt to copy to new structured path in background (non-destructive)
                migrateEmployeesForMonthIfNeeded(year, month, empKey, newPath).then((ok) => {
                  // migration performed silently; no debug logging
                });
                return { migrated: true };
              });
          })
          .then(() => {
            const theadRow = document.querySelector("#attendanceTable thead tr");
            while (theadRow.children.length > 1) theadRow.removeChild(theadRow.lastChild);
            if (theadRow.children.length > 0) {
              const firstTh = theadRow.children[0];
              firstTh.style.background = "#e3f0ff";
              firstTh.style.color = "#222";
              firstTh.style.fontWeight = "bold";
              firstTh.style.fontSize = "17px";
              firstTh.style.border = "1px solid #b0bec5";
              firstTh.style.boxShadow = "none";
              firstTh.style.letterSpacing = "0.5px";
              firstTh.style.borderRadius = "0";
              firstTh.style.transition = "background 0.2s";
            }
            employees.forEach((emp) => {
              const th = document.createElement("th");
              th.textContent = emp;
              th.style.background = "#e3f0ff";
              th.style.color = "#222";
              th.style.fontWeight = "bold";
              th.style.fontSize = "17px";
              th.style.border = "1px solid #b0bec5";
              th.style.boxShadow = "none";
              th.style.letterSpacing = "0.5px";
              th.style.borderRadius = "0";
              th.style.transition = "background 0.2s";
              theadRow.appendChild(th);
            });
            loadEmployeesTable();
            // expose employees globally for compatibility with admin UI
            try { window.employees = employees; window.employeeIds = employeeIds; } catch (e) {}
            setTimeout(function () {
              document.getElementById("loaderSpinner").style.display = "none";
            }, 350);
          });
      }

      // ========== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ==========
      // Ù†Ø³Ø® Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù…Ø¹ Ø§Ø­ØªØ±Ø§Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø±
      function ensureMonthEmployees() {
        const empKey = `employees_${year}_${(month + 1)
          .toString()
          .padStart(2, "0")}`;
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø±
        // Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ù†Ø§Ùƒ Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
        return Promise.resolve();
      }

      // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø£Ùˆ Ø§Ù„Ø³Ù†Ø©
      window.addEventListener("DOMContentLoaded", ensureMonthEmployees);
      function getDays() {
        const days = [];
        let date = new Date(year, month, 1);
        while (date.getMonth() === month) {
          const dayKey = `${year}-${month + 1}-${date.getDate()}`;
          const dayLabel = `${date.getDate()} ${
            arMonths[month]
          } (${date.toLocaleDateString("ar-EG", { weekday: "long" })})`;
          days.push({ key: dayKey, label: dayLabel });
          date.setDate(date.getDate() + 1);
        }
        return days;
      }

      function generateTable() {
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById("loaderSpinner").style.display = "flex";
        const days = getDays();
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø³Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        document.querySelector(
          "#mainContent h2"
        ).textContent = `ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± - ${arMonths[month]}`;
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        // Ø¥Ø®ÙØ§Ø¡ Ø±Ø£Ø³ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        var dateHeader = document.getElementById("dateHeaderTh");
        if (dateHeader) dateHeader.style.display = "none";
        db.ref("attendance")
          .once("value")
          .then((snapshot) => {
            const savedData = snapshot.val() || {};
            // Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø· Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
            let monthEmployees = employees.slice();
            days.forEach((day, dayIndex) => {
              const row = document.createElement("tr");
              const dateCell = document.createElement("td");
              let dateContent = toEnglishNumbers(day.label);
              if (savedData[day.key] && savedData[day.key].__editor) {
                const ts = savedData[day.key].__editedAt || "";
                const editor = savedData[day.key].__editor;
                const color = editor === "admin" ? "#1fa745" : "#dc3545";
                dateContent += `<div class='editor-tag' style="color:${color};font-weight:bold;">
          ğŸ“ ${editor}${ts ? " - " + toEnglishNumbers(ts) : ""}
        </div>`;
              }
              // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…ØŒ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
              // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… ØªÙ…Ø§Ù…Ø§Ù‹ Ù†Ø¹ÙŠØ¯ innerHTML ÙƒÙ…Ø§ ÙƒØ§Ù†ØŒ Ø«Ù… Ù†Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø« Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
              dateCell.innerHTML = `<span style='cursor:pointer;'>${dateContent}</span>`;
              const spanEl = dateCell.querySelector('span');
              if (spanEl) {
                spanEl.addEventListener('click', function () {
                  try {
                    showDayDetailsModal(day.key, day.label);
                  } catch (e) {
                    console && console.error && console.error('showDayDetailsModal error', e);
                  }
                });
              }
              row.appendChild(dateCell);
              monthEmployees.forEach((employee, empIndex) => {
                const cell = document.createElement("td");
                const select = document.createElement("select");
                select.id = `d${dayIndex}e${empIndex}`;
                statuses.forEach((status) => {
                  const option = document.createElement("option");
                  option.value = status;
                  option.textContent = status;
                  select.appendChild(option);
                });
                if (
                  savedData[day.key] &&
                  savedData[day.key][employee] !== undefined
                ) {
                  select.value = savedData[day.key][employee];
                }
                if (select.value === "Ø´ÙØª") {
                  cell.style.background = "#d4edda";
                } else if (select.value === "Ù†Øµ") {
                  cell.style.background = "#fff9db";
                } else if (select.value === "âŒ") {
                  cell.style.background = "#ffe3e3";
                  cell.style.color = "#d32f2f";
                  select.style.color = "#d32f2f";
                } else {
                  cell.style.color = "";
                  select.style.color = "";
                }
                if (!currentUserCanEdit || !isCurrentMonthSelected()) {
                  select.setAttribute("disabled", "disabled");
                  select.addEventListener("change", (e) => {
                    e.target.value = savedData[day.key]
                      ? savedData[day.key][employee]
                      : "";
                  });
                }
                select.addEventListener("change", function () {
                  if (this.value === "Ø´ÙØª") {
                    cell.style.background = "#d4edda";
                    cell.style.color = "";
                    select.style.color = "";
                  } else if (this.value === "Ù†Øµ") {
                    cell.style.background = "#fff9db";
                    cell.style.color = "";
                    select.style.color = "";
                  } else if (this.value === "âŒ") {
                    cell.style.background = "#ffe3e3";
                    cell.style.color = "#d32f2f";
                    select.style.color = "#d32f2f";
                  } else {
                    cell.style.background = "";
                    cell.style.color = "";
                    select.style.color = "";
                  }
                });
                cell.appendChild(select);
                row.appendChild(cell);
              });
              tbody.appendChild(row);
            });
            // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ©
            const saveBtn = document.querySelector(
              'button[onclick="saveData()"]'
            );
            if (saveBtn)
              saveBtn.disabled =
                !currentUserCanEdit || !isCurrentMonthSelected();
            calculateStats(savedData);
            if (typeof renderUserEmpStats === "function") renderUserEmpStats();
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø£Ø³ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            if (dateHeader) dateHeader.style.display = "";
            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            setTimeout(function () {
              document.getElementById("loaderSpinner").style.display = "none";
            }, 350);
          });
        // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ select Ùˆinput Ùˆtextarea ÙˆØ£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ Ø¥Ø°Ø§ ÙÙ‚Ø¯Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
        setTimeout(() => {
          if (!currentUserCanEdit || !isCurrentMonthSelected()) {
            document
              .querySelectorAll(
                "#mainContent select, #mainContent input, #mainContent textarea"
              )
              .forEach((el) => {
                el.setAttribute("disabled", "disabled");
              });
            const saveBtn = document.querySelector(
              'button[onclick="saveData()"]'
            );
            if (saveBtn) saveBtn.disabled = true;
          } else {
            document
              .querySelectorAll(
                "#mainContent select, #mainContent input, #mainContent textarea"
              )
              .forEach((el) => {
                el.removeAttribute("disabled");
              });
            const saveBtn = document.querySelector(
              'button[onclick="saveData()"]'
            );
            if (saveBtn) saveBtn.disabled = false;
          }
        }, 100);
      }

      // ========== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========

      // Unified permission check for editing current month
      function canEditCurrentMonth() {
        if (!isCurrentMonthSelected()) {
          alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø´Ù‡Ø± Ø³Ø§Ø¨Ù‚.");
          return false;
        }
        if (!currentUserCanEdit) {
          alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");
          return false;
        }
        return true;
      }

      // Unified save function for attendance (days/employees)
      async function saveAttendanceData() {
        if (!canEditCurrentMonth()) return;
        const days = getDays();
        try {
          const attendanceSnapshot = await db.ref("attendance").once("value");
          const savedData = attendanceSnapshot.val() || {};
          const updatedData = { ...savedData };
          let changes = [];
          let anyChange = false;
          days.forEach((day, dayIndex) => {
            if (!updatedData[day.key]) updatedData[day.key] = {};
            let dayChanged = false;
            employees.forEach((employee, empIndex) => {
              const selectElement = document.getElementById(
                `d${dayIndex}e${empIndex}`
              );
              if (selectElement) {
                const newValue = selectElement.value;
                const oldValue = savedData[day.key]
                  ? savedData[day.key][employee]
                  : "";
                if (newValue !== oldValue) {
                  updatedData[day.key][employee] = newValue;
                  dayChanged = true;
                  anyChange = true;
                  changes.push({
                    user: currentUser,
                    day: day.key,
                    employee,
                    old: oldValue,
                    new: newValue,
                    time: formatDateTimeNoSeconds(new Date()),
                  });
                }
              }
            });
            if (dayChanged) {
              updatedData[day.key].__editor = currentUser;
              const now = new Date();
              updatedData[day.key].__editedAt = formatDateTimeNoSeconds(now);
            }
          });
          if (!anyChange) {
            alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ù„Ø­ÙØ¸Ù‡.");
            return;
          }
          await db.ref("attendance").set(updatedData);
          alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
          generateTable();
          changes.forEach((change) => {
            logActivity(
              "ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±",
              `
          <span style=\"color:#007bff;font-weight:bold;\">${change.user}</span>
          Ù‚Ø§Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ÙˆØ¸Ù
          <span style=\"color:#673ab7;font-weight:bold;\">${
            change.employee
          }</span>
          ÙÙŠ Ø§Ù„ÙŠÙˆÙ…
          <span style=\"color:#009688;font-weight:bold;\">${change.day}</span>
          Ù…Ù†
          <span style=\"background:#d4edda;padding:2px 6px;border-radius:5px;\">${
            change.old || "Ø¨Ø¯ÙˆÙ†"
          }</span>
          Ø¥Ù„Ù‰
          <span style=\"background:#fff9db;padding:2px 6px;border-radius:5px;\">${
            change.new || "Ø¨Ø¯ÙˆÙ†"
          }</span>
        `,
              { time: change.time, user: change.user }
            );
          });
        } catch (error) {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
          alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
      }

      // Unified save function for employees (add/update/delete)
      async function saveEmployees(newEmployees) {
        if (!canEditCurrentMonth()) return;
        const mm = (month + 1).toString().padStart(2, "0");
        const empKey = `employees_${year}_${mm}`;
        const newPath = `months/${year}/${mm}/employees`;
        try {
          // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±ÙØ§Øª ÙØ±ÙŠØ¯Ø© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
          let empObj = {};
          newEmployees.forEach((name, idx) => {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ø¹Ø±ÙØŒ Ø§Ø­ØªÙØ¸ Ø¨Ù‡
            let id =
              employeeIds[idx] ||
              "id" + Date.now() + "_" + Math.floor(Math.random() * 10000);
            // store as object for new structured format
            empObj[id] = { name: name };
          });
          // write primary copy to new structured path
          await db.ref(newPath).set(empObj);
          // ALSO keep a legacy-compatible plain string copy under employees/<empKey>
          const legacyObj = {};
          Object.entries(empObj).forEach(([id, obj]) => {
            legacyObj[id] = obj.name;
          });
          await db.ref("employees/" + empKey).set(legacyObj).catch((e) => {
            // non-fatal: log but continue
            console.warn("Failed to write legacy copy for employees:", e);
          });
          // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆÙ„ÙŠØ³ Ø£Ø¨Ø¬Ø¯ÙŠ
          employees = Object.values(empObj).map((v) => v.name);
          employeeIds = Object.keys(empObj);
          window.monthEmployees = employees.slice();
          loadEmployeesTable();
          generateTable();
          alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø·");
          logActivity(
            "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
            `ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±: ${employees.join(", ")}`
          );
        } catch (err) {
          console.error(err);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†");
        }
      }

      // Replace old saveData with unified function
      function saveData() {
        saveAttendanceData();
      }

      // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ==========
      // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ==========
      // Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ø­ØªØ±Ø§ÙÙŠØ©
      function showConfirmModal(message, onConfirm, onCancel) {
        let oldModal = document.getElementById("customConfirmModal");
        if (oldModal) oldModal.remove();
        const modal = document.createElement("div");
        modal.id = "customConfirmModal";
        modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
        modal.innerHTML = `
    <div style=\"background:#fff;max-width:370px;width:92vw;padding:26px 18px 20px 18px;border-radius:16px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeConfirmModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;\">âœ–</button>
      <div style=\"font-size:18px;color:#333;margin-bottom:20px;font-weight:500;\">${message}</div>
      <div style=\"display:flex;gap:12px;justify-content:center;\">
        <button id=\"confirmModalYes\" style=\"background:#007bff;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #007bff22;transition:background 0.2s;\">ØªØ£ÙƒÙŠØ¯</button>
        <button id=\"confirmModalNo\" style=\"background:#6c757d;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #6c757d22;transition:background 0.2s;\">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #customConfirmModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #customConfirmModal div { font-size:16px !important; }
      }
      #closeConfirmModalBtn:hover { background:#b71c1c !important; }
      #confirmModalYes:hover { background:#0056b3 !important; }
      #confirmModalNo:hover { background:#343a40 !important; }
    </style>
  `;
        document.body.appendChild(modal);
        document.getElementById("confirmModalYes").onclick = () => {
          modal.remove();
          if (onConfirm) onConfirm();
        };
        document.getElementById("confirmModalNo").onclick = () => {
          modal.remove();
          if (onCancel) onCancel();
        };
        document.getElementById("closeConfirmModalBtn").onclick = () => {
          modal.remove();
          if (onCancel) onCancel();
        };
      }
      // ØªØ­Ù…ÙŠÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      async function loadUsers() {
        const snapshot = await db.ref("users").once("value");
        const users = snapshot.val() || {};
        const tbody = document.getElementById("usersBody");
        tbody.innerHTML = "";
        Object.entries(users).forEach(([username, data]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${username}</td>
      <td>${data.canEdit ? "Ù†Ø¹Ù…" : "Ù„Ø§"}</td>
      <td>
        <button class="small-button btn-toggle" onclick="toggleUserEdit('${username}', ${
            data.canEdit
          })">
          ${data.canEdit ? "Ù‚ÙÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"}
        </button>
      </td>
      <td>
        ${
          username === currentUser
            ? "â€”"
            : `<button class="small-button btn-delete" onclick="deleteUser('${username}')">Ø­Ø°Ù</button>`
        }
      </td>
      <td>
        ${
          username === currentUser
            ? "â€”"
            : `<button class="small-button btn-delete" style="background:#ff9800;" onclick="forceLogoutUser('${username}')">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>`
        }
      </td>
    `;
          tbody.appendChild(tr);
        });
      }

      // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù„Ù…Ø³ØªØ®Ø¯Ù…
      async function forceLogoutUser(username) {
        if (username === currentUser) {
          alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ù†ÙØ³Ùƒ Ø¥Ø¬Ø¨Ø§Ø±ÙŠÙ‹Ø§.");
          return;
        }
        showConfirmModal(
          `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username} Ø¥Ø¬Ø¨Ø§Ø±ÙŠÙ‹Ø§ØŸ`,
          async () => {
            try {
              await db.ref("forcedLogout/" + username).set(true);
              alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ.");
              logActivity("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ", username);
            } catch (err) {
              alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ");
              console.error(err);
            }
          }
        );
      }

      // ØªØ¨Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
      async function toggleUserEdit(username, currentCanEdit) {
        if (username === currentUser) {
          alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØªÙƒ Ø§Ù„Ø®Ø§ØµØ©.");
          return;
        }
        await db.ref("users/" + username + "/canEdit").set(!currentCanEdit);
        loadUsers();
      }

      // Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø£Ù†ÙŠÙ‚Ø© ÙˆØ¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙˆØ±Ø§Ù‹
      async function deleteUser(username) {
        if (username === currentUser) {
          showPermissionRevokedModal("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù†ÙØ³Ùƒ.");
          return;
        }
        showDeleteUserModal(username);
      }

      // Ø¯Ø§Ù„Ø© Ù„Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø¯Ø§Ø¦Ù…Ø§Ù‹
      async function ensureAdminAccount() {
        const snap = await db.ref("users").once("value");
        const users = snap.val() || {};
        if (!users.admin) {
          const hashObj = await hashPassword("admin");
          await db.ref("users/admin").set({
            password: hashObj,
            role: "admin",
            canEdit: true,
          });
        }
      }

      function showDeleteUserModal(username) {
        let oldModal = document.getElementById("deleteUserModal");
        if (oldModal) oldModal.remove();
        const modal = document.createElement("div");
        modal.id = "deleteUserModal";
        modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
        modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#fff7f7 60%,#fce4ec 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #e5737333;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeDeleteUserModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#e57373;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;box-shadow:0 2px 8px #e5737322;\">âœ–</button>
      <div style=\"font-size:21px;color:#d32f2f;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#fff3f3;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #e5737311;\">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <b style='color:#d32f2f;'>${username}</b>ØŸ<br>Ø³ÙŠØªÙ… Ø¥Ø®Ø±Ø§Ø¬Ù‡ ÙÙˆØ±Ø§Ù‹ ÙˆÙ„Ù† ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø£Ù†Ø´Ø£ØªÙ‡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.</div>
      <button id=\"deleteUserConfirmBtn\" style=\"background:linear-gradient(90deg,#d32f2f 60%,#e57373 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #d32f2f22;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;\">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #deleteUserModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #deleteUserModal div { font-size:16px !important; }
      }
      #closeDeleteUserModalBtn:hover { background:#b71c1c !important; }
      #deleteUserConfirmBtn:hover { background:#b71c1c !important; }
    </style>
  `;
        document.body.appendChild(modal);
        document.getElementById("deleteUserConfirmBtn").onclick = async () => {
          await db.ref("users/" + username).remove();
          await ensureAdminAccount();
          await db.ref("forcedLogout/" + username).set(true);
          if (username === currentUser) {
            localStorage.setItem("accountDeleted", "true");
            clearSession && clearSession();
            location.reload();
            return;
          }
          loadUsers();
          logActivity("Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…", username);
          modal.remove();
        };
        // Ø±Ø³Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener("DOMContentLoaded", function () {
          if (localStorage.getItem("accountDeleted")) {
            localStorage.removeItem("accountDeleted");
            showAccountDeletedModal();
          }
        });

        // Ù†Ø§ÙØ°Ø© Ø±Ø³Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨
        function showAccountDeletedModal() {
          const modal = document.createElement("div");
          modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
          modal.innerHTML = `
    <div style="background:#fff3f3;padding:24px 18px;border-radius:12px;box-shadow:0 4px 20px #0002;text-align:center;">
      <div style="font-size:20px;color:#d32f2f;margin-bottom:12px;">âŒ ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ</div>
      <div style="font-size:15px;color:#444;">ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.</div>
      <button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:8px;cursor:pointer;">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  `;
          document.body.appendChild(modal);
        }
        // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¥Ø°Ø§ accountDeleted=true ÙÙŠ localStorageØŒ Ø£Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙ‚Ø·
        document.addEventListener("DOMContentLoaded", function () {
          if (localStorage.getItem("accountDeleted")) {
            localStorage.removeItem("accountDeleted");
            showAccountDeletedModal();
          }
        });
        document.getElementById("closeDeleteUserModalBtn").onclick = () => {
          modal.remove();
        };
      }

      // ØªØ­Ø¯ÙŠØ« showPermissionRevokedModal Ù„Ù‚Ø¨ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      const _oldShowPermissionRevokedModal = window.showPermissionRevokedModal;
      window.showPermissionRevokedModal = function (msg) {
        if (!msg) return _oldShowPermissionRevokedModal();
        let oldModal = document.getElementById("permRevokedModal");
        if (oldModal) oldModal.remove();
        const modal = document.createElement("div");
        modal.id = "permRevokedModal";
        modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
        modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#f7faff 60%,#e3eafc 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #1976d233;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closePermRevokedModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#e57373;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;box-shadow:0 2px 8px #e5737322;\">âœ–</button>
      <div style=\"font-size:19px;color:#d32f2f;margin-bottom:16px;font-weight:600;\">${msg}</div>
      <button id=\"permRevokedOkBtn\" style=\"background:linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #1976d222;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;\">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #permRevokedModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #permRevokedModal div { font-size:16px !important; }
      }
      #closePermRevokedModalBtn:hover { background:#b71c1c !important; }
      #permRevokedOkBtn:hover { background:#1565c0 !important; }
    </style>
  `;
        document.body.appendChild(modal);
        document.getElementById("permRevokedOkBtn").onclick = () => {
          modal.remove();
        };
        document.getElementById("closePermRevokedModalBtn").onclick = () => {
          modal.remove();
        };
      };

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
      async function addUser() {
        if (!preventEditIfNotCurrentMonth()) return;
        const username = document
          .getElementById("newUserName")
          .value.trim()
          .toLowerCase();
        const password = document.getElementById("newUserPass").value.trim();
        const canEdit = document.getElementById("newUserCanEdit").checked;
        if (!username || !password) {
          alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
          return;
        }
        const snapshot = await db.ref("users/" + username).once("value");
        if (snapshot.exists()) {
          alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹");
          return;
        }
        try {
          const hashObj = await hashPassword(password);
          await db
            .ref("users/" + username)
            .set({ password: hashObj, role: "user", canEdit });
          alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
          document.getElementById("newUserName").value = "";
          document.getElementById("newUserPass").value = "";
          document.getElementById("newUserCanEdit").checked = true;
          loadUsers();
        } catch (err) {
          console.error(err);
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        }
      }

      // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ==========
      function addEmployee() {
        if (!canEditCurrentMonth()) return;
        const name = document.getElementById("newEmployeeName").value.trim();
        if (!name) {
          alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù");
          return;
        }
        if (employees.includes(name)) {
          alert("âŒ Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹");
          return;
        }
        // Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙŠØ¸Ù‡Ø± ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¨Ø¯ÙˆÙ† ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ)
        const newEmployees = [...employees, name];
        saveEmployees(newEmployees);
        document.getElementById("newEmployeeName").value = "";
      }
      function loadEmployeesTable() {
        const tbody = document.getElementById("employeesBody");
        tbody.innerHTML = "";
        employees.forEach((emp, idx) => {
          const tr = document.createElement("tr");
          const nameTd = document.createElement("td");
          nameTd.textContent = emp;
          nameTd.id = `employeeName_${idx}`;
          const actionsTd = document.createElement("td");
          const editBtn = document.createElement("button");
          editBtn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
          editBtn.className = "small-button btn-edit";
          editBtn.onclick = () => enableEmployeeEdit(idx);
          actionsTd.appendChild(editBtn);
          // Ø²Ø± Ø§Ù„Ø­Ø°Ù ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
          if (typeof isCurrentMonthSelected === "function" && isCurrentMonthSelected()) {
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Ø­Ø°Ù";
            deleteBtn.className = "small-button btn-delete";
            deleteBtn.onclick = () => deleteEmployee(idx);
            actionsTd.appendChild(deleteBtn);
          }
          tr.appendChild(nameTd);
          tr.appendChild(actionsTd);
          tbody.appendChild(tr);
        });
      }
      // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ù (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù„Ù Ù„Ù„Ù…Ø¯ÙŠØ±) ==========
      function getAdvPath() {
        const mm = (month + 1).toString().padStart(2, '0');
        return `advances/${year}/${mm}`;
      }

      function loadAdvancesFromStorage() {
        // Try Firebase first, fallback to localStorage
        const path = getAdvPath();
        if (typeof db !== 'undefined' && db && db.ref) {
          return db.ref(path).once('value').then((snap) => {
            const obj = snap.val() || {};
            // Firebase may store as { id: {employee,amount,...}, ... }
            const arr = Object.keys(obj).length ? Object.entries(obj).map(([id, v]) => ({ id, ...(v || {}) })) : [];
            window._advancesRaw = arr;
            const map = {};
            arr.forEach((a) => { if (!map[a.employee]) map[a.employee] = []; map[a.employee].push(a); });
            window._advancesMap = map;
            // keep a local copy as fallback
            try { localStorage.setItem('advances', JSON.stringify(arr)); } catch (e) {}
            return arr;
          }).catch((e) => {
            console.warn('Firebase advances load failed, falling back to localStorage', e);
            try {
              const raw = localStorage.getItem('advances');
              const arr = raw ? JSON.parse(raw) : [];
              const map = {};
              arr.forEach((a) => { if (!map[a.employee]) map[a.employee] = []; map[a.employee].push(a); });
              window._advancesRaw = arr; window._advancesMap = map; return arr;
            } catch (err) { window._advancesRaw = []; window._advancesMap = {}; return []; }
          });
        }
        // no db available: localStorage only
        try {
          const raw = localStorage.getItem("advances");
          const arr = raw ? JSON.parse(raw) : [];
          const map = {};
          arr.forEach((a) => { if (!map[a.employee]) map[a.employee] = []; map[a.employee].push(a); });
          window._advancesRaw = arr; window._advancesMap = map; return Promise.resolve(arr);
        } catch (e) {
          console.error("Failed to load advances:", e);
          window._advancesRaw = [];
          window._advancesMap = {};
          return Promise.resolve([]);
        }
      }

      function saveAdvancesToStorage(arr) {
        window._advancesRaw = arr;
        const map = {};
        arr.forEach((a) => { if (!map[a.employee]) map[a.employee] = []; map[a.employee].push(a); });
        window._advancesMap = map;
        try { localStorage.setItem('advances', JSON.stringify(arr)); } catch (e) {}
        // also persist to Firebase if available
        if (typeof db !== 'undefined' && db && db.ref) {
          const path = getAdvPath();
          // convert to object keyed by id
          const obj = {};
          arr.forEach((a) => { const copy = Object.assign({}, a); const id = copy.id || ('adv_' + Date.now()); copy.id = id; delete copy.id; obj[a.id || ('adv_' + Date.now())] = copy; });
          // write full set (simpler sync)
          try { db.ref(path).set(obj).catch(()=>{}); } catch(e) { console.warn('adv save to firebase failed', e); }
        }
      }

      function renderAdvancesTable() {
        const tbody = document.getElementById("advancesBody");
        if (!tbody) return;
        const arr = window._advancesRaw || [];
        tbody.innerHTML = "";
        if (arr.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" style="padding:12px;text-align:center;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù„Ù Ù…Ø³Ø¬Ù„Ø©</td></tr>`;
          return;
        }
        arr.slice().reverse().forEach((a) => {
          const tr = document.createElement("tr");
          const tdEmp = document.createElement('td'); tdEmp.textContent = a.employee;
          const tdAmount = document.createElement('td'); tdAmount.textContent = (a.amount||0).toLocaleString() + ' Ø¯.Ø¹';
          const tdDate = document.createElement('td'); tdDate.textContent = a.date || '';
          const tdNote = document.createElement('td'); tdNote.textContent = a.note || '';
          const tdActions = document.createElement('td');
          const wrap = document.createElement('div'); wrap.style.display = 'flex'; wrap.style.gap = '6px'; wrap.style.justifyContent = 'center';
          const editBtn = document.createElement('button'); editBtn.className = 'small-button btn-edit'; editBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
          editBtn.onclick = () => { try { openAddAdvanceForm(encodeURIComponent(JSON.stringify(a))); } catch(e){ console.error(e); } };
          const delBtn = document.createElement('button'); delBtn.className = 'small-button btn-delete'; delBtn.textContent = 'Ø­Ø°Ù';
          delBtn.onclick = () => deleteAdvance(a.id);
          wrap.appendChild(editBtn); wrap.appendChild(delBtn);
          tdActions.appendChild(wrap);
          tr.appendChild(tdEmp); tr.appendChild(tdAmount); tr.appendChild(tdDate); tr.appendChild(tdNote); tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });
      }

      function openAddAdvanceForm(existingAdvEncoded) {
        // Build modal
        const modal = document.createElement('div');
        modal.id = 'advanceModal';
        modal.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:12000;';
        const box = document.createElement('div');
        box.style = 'background:#fff;border-radius:12px;padding:18px;max-width:420px;width:95vw;box-shadow:0 8px 32px rgba(0,0,0,0.12);direction:rtl;text-align:right;';
        box.innerHTML = `
          <h3>â• ØªØ³Ø¬ÙŠÙ„ Ø³Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
          <label for="advanceEmployee">Ø§Ù„Ù…ÙˆØ¸Ù</label>
          <select id="advanceEmployee"></select>
          <label for="advanceAmount">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¨Ø¯ÙˆÙ† ÙÙˆØ§ØµÙ„)</label>
          <input id="advanceAmount" type="number" min="0" step="1" />
          <label for="advanceDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="advanceDate" type="date" />
          <label for="advanceNote">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="advanceNote" type="text" />
          <div class="modal-actions">
            <button id="cancelAdvance" class="small-button" style="background:#ddd;color:#111">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="saveAdvanceBtn" class="small-button" style="background:#007bff;color:#fff">Ø­ÙØ¸ Ø§Ù„Ø³Ù„ÙØ©</button>
          </div>
        `;
        modal.appendChild(box);
        document.body.appendChild(modal);

        // populate employees (use the local `employees` array; if empty, try to reload)
        const sel = document.getElementById('advanceEmployee');
        sel.innerHTML = '';
        function fillEmployeesIntoSelect() {
          const list = (typeof employees !== 'undefined' && Array.isArray(employees) && employees.length) ? employees : [];
          if (list.length === 0) {
            sel.innerHTML = `<option value="">-- Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† --</option>`;
            document.getElementById('saveAdvanceBtn').disabled = true;
            return;
          }
          sel.innerHTML = '';
          list.forEach((e) => {
            const opt = document.createElement('option');
            opt.value = e;
            opt.textContent = e;
            sel.appendChild(opt);
          });
          document.getElementById('saveAdvanceBtn').disabled = false;
        }
        fillEmployeesIntoSelect();
        // if empty, try to load from DB (in case loadEmployees hasn't finished yet)
        if ((typeof employees === 'undefined' || employees.length === 0) && typeof loadEmployees === 'function') {
          const mm = (month + 1).toString().padStart(2, '0');
          const empKey = `employees_${year}_${mm}`;
          loadEmployees(empKey).then(() => {
            // expose for compatibility
            try { window.employees = employees; window.employeeIds = employeeIds; } catch(e){}
            fillEmployeesIntoSelect();
          }).catch(()=>{});
        }
        // set default date to today
        const dateInput = document.getElementById('advanceDate');
        const today = new Date().toISOString().slice(0,10);
        dateInput.value = today;

        // if existingAdvEncoded provided, parse and prefill for edit
        let editingId = null;
        if (existingAdvEncoded) {
          try {
            const decoded = decodeURIComponent(existingAdvEncoded);
            const advObj = JSON.parse(decoded);
            editingId = advObj.id;
            document.getElementById('advanceEmployee').value = advObj.employee || '';
            document.getElementById('advanceAmount').value = advObj.amount || '';
            document.getElementById('advanceDate').value = advObj.date || today;
            document.getElementById('advanceNote').value = advObj.note || '';
            document.getElementById('saveAdvanceBtn').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
          } catch (e) { console.warn('Failed to parse existing adv', e); }
        }

        document.getElementById('cancelAdvance').onclick = () => { modal.remove(); };
        document.getElementById('saveAdvanceBtn').onclick = () => {
          const emp = document.getElementById('advanceEmployee').value;
          const amount = Number(document.getElementById('advanceAmount').value || 0);
          const date = document.getElementById('advanceDate').value;
          const note = document.getElementById('advanceNote').value.trim();
          if (!emp) { alert('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù'); return; }
          if (!amount || amount <= 0) { alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­'); return; }
          const arr = window._advancesRaw ? window._advancesRaw.slice() : [];
          if (editingId) {
            const idx = arr.findIndex(a => a.id === editingId);
            if (idx !== -1) {
              arr[idx] = Object.assign({}, arr[idx], { employee: emp, amount: amount, date: date, note: note });
            }
          } else {
            const id = 'adv_' + Date.now();
            const newAdv = { id: id, employee: emp, amount: amount, date: date, note: note };
            arr.push(newAdv);
          }
          saveAdvancesToStorage(arr);
          renderAdvancesTable();
          modal.remove();
          // update employee stats live (no reload)
          if (typeof db !== 'undefined' && db && db.ref) {
            db.ref('attendance').once('value').then((snap) => calculateStats(snap.val() || {})).catch(()=>{});
          } else {
            // try calling calculateStats with last known attendance if available
            if (window._lastAttendanceSnapshot) calculateStats(window._lastAttendanceSnapshot);
          }
        };
      }

      function deleteAdvance(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù„ÙØ©ØŸ')) return;
        const arr = (window._advancesRaw || []).filter(a => a.id !== id);
        saveAdvancesToStorage(arr);
        renderAdvancesTable();
        // remove from firebase if available
        try {
          if (typeof db !== 'undefined' && db && db.ref) {
            const path = getAdvPath();
            db.ref(path + '/' + id).remove().catch(()=>{});
          }
        } catch(e){}
        // update stats live
        if (typeof db !== 'undefined' && db && db.ref) {
          db.ref('attendance').once('value').then((snap) => calculateStats(snap.val() || {})).catch(()=>{});
        } else if (window._lastAttendanceSnapshot) {
          calculateStats(window._lastAttendanceSnapshot);
        }
      }

      // initialize advances UI (only show to admin)
      (function initAdvancesUI(){
        const section = document.getElementById('advancesAdminSection');
        const openBtn = document.getElementById('openAddAdvanceBtn');
        const isAdmin = (typeof currentUserRole !== 'undefined' && currentUserRole === 'admin') || (typeof currentUser !== 'undefined' && currentUser === 'admin');
        // load then render
        Promise.resolve(loadAdvancesFromStorage()).then(() => {
          renderAdvancesTable();
          if (!isAdmin) {
            if (section) section.style.display = 'none';
          } else {
            if (section) section.style.display = 'block';
            if (openBtn) openBtn.onclick = () => openAddAdvanceForm();
          }
        }).catch((e) => { console.warn('initAdvancesUI load failed', e); renderAdvancesTable(); });
      })();
      function enableEmployeeEdit(index) {
        if (!canEditCurrentMonth()) return;
        const nameTd = document.getElementById(`employeeName_${index}`);
        const oldName = nameTd.textContent;
        nameTd.innerHTML = "";
        const input = document.createElement("input");
        input.type = "text";
        input.value = oldName;
        input.style.width = "80%";
        nameTd.appendChild(input);
        const saveBtn = document.createElement("button");
        saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸";
        saveBtn.className = "small-button btn-edit";
        saveBtn.style.marginLeft = "5px";
        saveBtn.onclick = async () => {
          if (!canEditCurrentMonth()) return;
          const newName = input.value.trim();
          if (!newName) {
            alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹");
            return;
          }
          if (employees.includes(newName)) {
            alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹");
            return;
          }
          // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙ‚Ø· Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
          const days = getDays();
          const attendanceSnapshot = await db.ref("attendance").once("value");
          const attendance = attendanceSnapshot.val() || {};
          days.forEach((day) => {
            const dayKey = day.key;
            if (
              attendance[dayKey] &&
              Object.prototype.hasOwnProperty.call(attendance[dayKey], oldName)
            ) {
              attendance[dayKey][newName] = attendance[dayKey][oldName];
              delete attendance[dayKey][oldName];
            }
          });
          await db.ref("attendance").set(attendance);
          // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ allowedStatsEmps Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
          const usersSnap = await db.ref("users").once("value");
          const users = usersSnap.val() || {};
          await Promise.all(Object.entries(users).map(async ([username, data]) => {
            if (username === "admin") return;
            const allowed = Array.isArray(data.allowedStatsEmps) ? data.allowedStatsEmps : [];
            if (allowed.includes(oldName)) {
              const updated = allowed.map(e => e === oldName ? newName : e);
              await db.ref("users/" + username + "/allowedStatsEmps").set(updated);
            }
          }));
          const newEmployees = employees.slice();
          newEmployees[index] = newName;
          saveEmployees(newEmployees);
        };
        nameTd.appendChild(saveBtn);
      }

      // ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ==========
      // ======= Salary helpers / admin =======
      window.salariesData = window.salariesData || {};
      db.ref('salaries').on('value', function(snap){ try{ window.salariesData = snap.val() || {}; }catch(e){ window.salariesData = {}; } try{ if(typeof refreshSalariesList === 'function') refreshSalariesList(); if(typeof calculateStats === 'function') calculateStats(window._lastAttendanceSnapshot); }catch(e){} });

      function formatNumberWithCommas(n){
        if(n === null || n === undefined || n === '') return '';
        const num = typeof n === 'number' ? n : Number(String(n).replace(/[^0-9.-]/g, '')) || 0;
        return num.toLocaleString('en-US');
      }
      function parseFormattedNumber(s){
        if(s === null || s === undefined) return null;
        const cleaned = String(s).replace(/[^0-9.-]/g, '');
        if(cleaned.trim() === '') return null;
        return Number(cleaned) || 0;
      }

      function getRatesForEmployee(emp, y, m){
        const salaries = window.salariesData || {};
        const monthKey = `${y}_${String(m+1).padStart(2,'0')}`;
        // month overrides
        if(salaries.months && salaries.months[monthKey]){
          const monthNode = salaries.months[monthKey];
          if(monthNode.overrides && monthNode.overrides[emp]) return { shift: Number(monthNode.overrides[emp].shift||0), half: Number(monthNode.overrides[emp].half||0) };
          if(monthNode.default) return { shift: Number(monthNode.default.shift||0), half: Number(monthNode.default.half||0) };
        }
        // per-employee override
        if(salaries.overrides && salaries.overrides[emp]) return { shift: Number(salaries.overrides[emp].shift||0), half: Number(salaries.overrides[emp].half||0) };
        // default
        if(salaries.default) return { shift: Number(salaries.default.shift||22000), half: Number(salaries.default.half||11000) };
        // fallback
        return { shift:22000, half:11000 };
      }

      async function refreshSalariesList(){
        const container = document.getElementById('salariesListContainer');
        if(!container) return;
        container.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        const sal = window.salariesData || {};
        const monthKey = `${year}_${String(month+1).padStart(2,'0')}`;
        let items = employees.slice(); items.sort((a,b)=> a.localeCompare(b));
        let html = '';
        items.forEach(emp=>{
          const globalOv = (sal.overrides && sal.overrides[emp]) ? sal.overrides[emp] : null;
          const monthOv = (sal.months && sal.months[monthKey] && sal.months[monthKey].overrides && sal.months[monthKey].overrides[emp]) ? sal.months[monthKey].overrides[emp] : null;
          const ov = monthOv || globalOv || {};
          const shiftVal = ov.shift !== undefined ? formatNumberWithCommas(ov.shift) : '';
          const halfVal = ov.half !== undefined ? formatNumberWithCommas(ov.half) : '';
          html += `<div style="display:flex;gap:8px;align-items:center;padding:6px;border-bottom:1px dashed #eef6fb;">
            <div style="flex:1;min-width:120px;">${emp}</div>
            <div style="width:120px;"><input placeholder="Ø´ÙØª" data-emp="${emp}" class="empShiftOverride" value="${shiftVal}" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e9eef8;" /></div>
            <div style="width:120px;"><input placeholder="Ù†Øµ" data-emp="${emp}" class="empHalfOverride" value="${halfVal}" style="width:100%;padding:6px;border-radius:6px;border:1px solid #e9eef8;" /></div>
            <div style="display:flex;gap:6px;">
              <button class="small-button btn-save-emp-override" data-emp="${emp}" style="background:#28a745;color:#fff">ğŸ’¾</button>
              <button class="small-button btn-clear-emp-override" data-emp="${emp}" style="background:#e53935;color:#fff">ğŸ—‘ï¸</button>
            </div>
          </div>`;
        });
        container.innerHTML = html;
        Array.from(document.getElementsByClassName('empShiftOverride')).forEach(el=>{ el.oninput = (e)=>{ el.value = formatNumberWithCommas(parseFormattedNumber(el.value)); }; });
        Array.from(document.getElementsByClassName('empHalfOverride')).forEach(el=>{ el.oninput = (e)=>{ el.value = formatNumberWithCommas(parseFormattedNumber(el.value)); }; });
        Array.from(document.getElementsByClassName('btn-save-emp-override')).forEach(btn=>{ btn.onclick = async function(){ const emp = this.dataset.emp; const shiftEl = container.querySelector('.empShiftOverride[data-emp="'+emp+'"]'); const halfEl = container.querySelector('.empHalfOverride[data-emp="'+emp+'"]'); const shift = parseFormattedNumber(shiftEl.value); const half = parseFormattedNumber(halfEl.value); if(!shift && !half){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; } const applyCurrent = document.getElementById('applyCurrentMonthSalary').checked; const applyFuture = document.getElementById('applyFutureMonthsSalary').checked; // save override
          await db.ref('salaries/overrides/' + emp).set({ shift: shift === null ? null : shift, half: half === null ? null : half });
          if(applyCurrent){ await db.ref('salaries/months/'+monthKey+'/overrides/'+emp).set({ shift: shift === null ? null : shift, half: half === null ? null : half }); }
          // For future months - we keep it as global override (overrides apply to all months) so if applyFuture explicitly false nothing else to do
          await db.ref('salaries/signal').set({ time: Date.now() }); localStorage.setItem('salariesSignal', Date.now()); refreshSalariesList(); calculateStats(window._lastAttendanceSnapshot);
        }; });
        Array.from(document.getElementsByClassName('btn-clear-emp-override')).forEach(btn=>{ btn.onclick = async function(){ if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) return; const emp = this.dataset.emp; const monthKey = `${year}_${String(month+1).padStart(2,'0')}`; await db.ref('salaries/overrides/'+emp).remove(); await db.ref('salaries/months/'+monthKey+'/overrides/'+emp).remove(); await db.ref('salaries/signal').set({ time: Date.now() }); localStorage.setItem('salariesSignal', Date.now()); refreshSalariesList(); calculateStats(window._lastAttendanceSnapshot); }; });
      }

      async function initSalaryAdmin(){
        // bind save default button
        const shiftEl = document.getElementById('salaryShiftRate');
        const halfEl = document.getElementById('salaryHalfRate');
        const saveBtn = document.getElementById('saveDefaultSalaryBtn');
        const refreshBtn = document.getElementById('refreshSalariesListBtn');
        // format on input
        [shiftEl, halfEl].forEach(el=>{ if(!el) return; el.oninput = (e)=>{ el.value = formatNumberWithCommas(parseFormattedNumber(el.value)); }; el.onblur = (e)=>{ el.value = formatNumberWithCommas(parseFormattedNumber(el.value)); }; });
        if(refreshBtn) refreshBtn.onclick = refreshSalariesList;
        if(saveBtn) saveBtn.onclick = async function(){ const s = parseFormattedNumber(shiftEl.value); const h = parseFormattedNumber(halfEl.value); if(!s && !h){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; } const applyCurrent = document.getElementById('applyCurrentMonthSalary').checked; const applyFuture = document.getElementById('applyFutureMonthsSalary').checked; const nowKey = `${year}_${String(month+1).padStart(2,'0')}`; // update default
          await db.ref('salaries/default').set({ shift: s === null ? null : s, half: h === null ? null : h });
          if(applyCurrent){ await db.ref('salaries/months/'+nowKey+'/default').set({ shift: s === null ? null : s, half: h === null ? null : h }); }
          // applyFuture: updating salaries/default is enough to affect future months
          await db.ref('salaries/signal').set({ time: Date.now() }); localStorage.setItem('salariesSignal', Date.now()); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
          refreshSalariesList(); calculateStats(window._lastAttendanceSnapshot);
        };
        // when local salaries updates, refresh
        window.addEventListener('storage', (e)=>{ if(e.key === 'salariesSignal') refreshSalariesList(); });
        refreshSalariesList();
      }

      // ØªÙ‡ÙŠØ¦Ø© Ø­Ù‚Ù„ Ø§Ù„Ø±Ø§ØªØ¨ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      try{ document.getElementById('sidebarUserControlBtn').onclick = function(){ setTimeout(()=>{ try{ const section = document.getElementById('salaryAdminSection'); if(section){ section.style.display = (window.currentUserRole === 'admin') ? 'block' : 'none'; } }catch(e){} }, 60); }; }catch(e){}
      // call initSalaryAdmin in the normal init path; if function exists the load will call it
      try{ initSalaryAdmin(); }catch(e){}

      function calculateStats(savedData) {
        // cache last attendance snapshot so UI updates can reuse it without re-fetch
        try { window._lastAttendanceSnapshot = savedData || {}; } catch(e){}
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† savedData Ù‡Ùˆ object ØµØ§Ù„Ø­
        if (!savedData || typeof savedData !== 'object' || Array.isArray(savedData)) {
          savedData = {};
        }
        // Ø¬Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        db.ref("users/" + currentUser)
          .once("value")
          .then((userSnap) => {
            const userData = userSnap.val() || {};
            const isAdmin = userData.role === "admin";
            const allowedEmps = isAdmin
              ? employees.slice()
              : userData.allowedStatsEmps || [];
            const canViewSalary = isAdmin ? true : !!userData.canViewSalary;
            // Ø¨Ù†Ø§Ø¡ counts ÙÙ‚Ø· Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ÙŠÙ†
            const counts = {};
            allowedEmps.forEach((e) => {
              counts[e] = { Ø´ÙØª: 0, Ù†Øµ: 0, "âŒ": 0 };
            });
            // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
            Object.entries(savedData).forEach(([dateStr, day]) => {
              let parts = dateStr.split("-");
              if (parts.length === 3) {
                let dYear = parseInt(parts[0]);
                let dMonth = parseInt(parts[1]) - 1;
                if (dYear === year && dMonth === month) {
                  allowedEmps.forEach((e) => {
                    const val = day[e];
                    if (val && counts[e][val] !== undefined)
                      counts[e][val] += 1;
                  });
                }
              }
            });
            const bestShift = Object.entries(counts).sort(
              (a, b) => b[1]["Ø´ÙØª"] - a[1]["Ø´ÙØª"]
            )[0];
            const bestHalf = Object.entries(counts).sort(
              (a, b) => b[1]["Ù†Øµ"] - a[1]["Ù†Øµ"]
            )[0];
            const mostX = Object.entries(counts).sort(
              (a, b) => b[1]["âŒ"] - a[1]["âŒ"]
            )[0];
            const statsDiv = document.getElementById("statsBox");
            statsDiv.innerHTML = `
      <p>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù Ø´ÙØª: <b>${
        bestShift ? bestShift[0] + ` (${bestShift[1]["Ø´ÙØª"]})` : "â€”"
      }</b></p>
      <p>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù Ù†Øµ: <b>${
        bestHalf ? bestHalf[0] + ` (${bestHalf[1]["Ù†Øµ"]})` : "â€”"
      }</b></p>
      <p>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù âŒ: <b>${
        mostX ? mostX[0] + ` (${mostX[1]["âŒ"]})` : "â€”"
      }</b></p>`;

            // Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙƒÙ„ Ù…ÙˆØ¸Ù Ø£Ø³ÙÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨ØªØµÙ…ÙŠÙ… Ø­Ø¯ÙŠØ« Ù…Ø¹ Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØ®ØµÙ… Ø§Ù„Ø³Ù„Ù
            const empStatsDiv = document.getElementById("empStatsBelowTable");
            if (empStatsDiv) {
              let html = `<div class="emp-stats-bar-official">
        <table class="emp-stats-table-official">
          <thead>
            <tr>
              <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
              <th>Ø´ÙØª</th>
              <th>Ù†Øµ</th>
              <th>Ø¥Ø¬Ø§Ø²Ø©</th>
              ${canViewSalary ? "<th>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙƒÙ„ÙŠ</th><th>Ø§Ù„Ø³Ù„Ù Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø©</th><th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</th>" : ""}
            </tr>
          </thead>
          <tbody>`;
              allowedEmps.forEach((emp) => {
                const shift = counts[emp]["Ø´ÙØª"] || 0;
                const half = counts[emp]["Ù†Øµ"] || 0;
                const vac = counts[emp]["âŒ"] || 0;
                const rates = getRatesForEmployee(emp, year, month);
                const salary = shift * (rates.shift || 22000) + half * (rates.half || 11000);
                // Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ù„Ù Ø§Ù„Ù…Ø³Ø­ÙˆØ¨Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù (Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ)
                const advs = (window._advancesMap && window._advancesMap[emp]) ? window._advancesMap[emp] : [];
                const totalAdv = advs.reduce((s, a) => s + Number(a.amount || 0), 0);
                const netSalary = Math.max(0, salary - totalAdv);
                html += `<tr>
          <td class="emp-name-official">${emp}</td>
          <td class="emp-stat-official shift">${shift}</td>
          <td class="emp-stat-official half">${half}</td>
          <td class="emp-stat-official vac">${vac}</td>
          ${
            canViewSalary
              ? `<td class="emp-salary-official">${salary.toLocaleString()} Ø¯.Ø¹</td><td class="emp-salary-official">${totalAdv.toLocaleString()} Ø¯.Ø¹</td><td class="emp-salary-official" style="font-weight:700;color:#0b6">${netSalary.toLocaleString()} Ø¯.Ø¹</td>`
              : ""
          }
        </tr>`;
              });
              html += `</tbody></table></div>`;
              empStatsDiv.innerHTML = html;
            }
          });
        // CSS Ø§Ø­ØªØ±Ø§ÙÙŠ ÙˆÙ…ØªØ¬Ø§ÙˆØ¨
        if (!document.getElementById("empStatsProStyle")) {
          const style = document.createElement("style");
          style.id = "empStatsProStyle";
          style.innerHTML = `
        .emp-stats-bar-official {
          width: 100%;
          margin: 0 auto 18px auto;
          background: #f8f9fa;
          border-radius: 12px;
          box-shadow: 0 1px 8px #e3eafc33;
          padding: 0 0 8px 0;
          overflow-x: auto;
        }
        .emp-stats-table-official {
          width: 100%;
          border-collapse: collapse;
          font-size: 16px;
          background: none;
        }
        .emp-stats-table-official th, .emp-stats-table-official td {
          border: 1px solid #e0e0e0;
          padding: 8px 10px;
          text-align: center;
        }
        .emp-stats-table-official th {
          background: #e3f0ff;
          color: #1976d2;
          font-weight: bold;
          font-size: 17px;
        }
        .emp-name-official {
          color: #1976d2;
          font-weight: 600;
        }
        .emp-stat-official.shift { color: #28a745; font-weight: 500; }
        .emp-stat-official.half { color: #ff9800; font-weight: 500; }
        .emp-stat-official.vac { color: #d32f2f; font-weight: 500; }
        .emp-salary-official {
          color: #388e3c;
          font-weight: bold;
          background: #e8fbe8;
          border-radius: 6px;
        }
        @media (max-width: 900px) {
          .emp-stats-table-official th, .emp-stats-table-official td { font-size: 14px; padding: 6px 4px; }
        }
        @media (max-width: 600px) {
          .emp-stats-bar-official { border-radius: 7px; }
          .emp-stats-table-official th, .emp-stats-table-official td { font-size: 13px; padding: 5px 2px; }
        }
      `;
          document.head.appendChild(style);
        }
        // ØªØ£Ø«ÙŠØ± ripple Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø·ÙˆØ±
        if (!window.rippleEffect) {
          window.rippleEffect = function (e, el) {
            // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø©
            if (el.classList.contains("ripple-active")) return;
            el.classList.add("ripple-active");
            let rect = el.getBoundingClientRect();
            let ripple = document.createElement("span");
            ripple.className = "ripple";
            let size = Math.max(rect.width, rect.height) * 1.1;
            ripple.style.width = ripple.style.height = size + "px";
            let x =
              (e.touches ? e.touches[0].clientX : e.clientX) -
              rect.left -
              size / 2;
            let y =
              (e.touches ? e.touches[0].clientY : e.clientY) -
              rect.top -
              size / 2;
            ripple.style.left = x + "px";
            ripple.style.top = y + "px";
            el.appendChild(ripple);
            setTimeout(() => {
              ripple.remove();
              el.classList.remove("ripple-active");
            }, 700);
          };
        }
        // ...existing code...
      }

      // Ø²Ø± Ù„ØªØ±Ø­ÙŠÙ„ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      // ========== Tabs Ù„Ù„Ø£Ø´Ù‡Ø± ==========

      // Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ù„Ø£Ø´Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ø±ÙŠ Ø­Ø¯ÙŠØ«
      const monthsFab = document.createElement("div");
      monthsFab.id = "monthsFab";
      monthsFab.innerHTML = `<button id="fabMainMonth" class="fab-month"></button><div id="fabMonthsList" style="display:none;"></div>`;
      monthsFab.style.position = "fixed";
      monthsFab.style.bottom = "22px";
      monthsFab.style.left = "22px";
      monthsFab.style.zIndex = "9999";
      document.body.appendChild(monthsFab);

      function loadAvailableMonths() {
        Promise.all([
          db.ref("attendance").once("value"),
          db.ref("monthsSettings/manual").once("value"),
          db.ref("monthsSettings/hidden").once("value"),
          db.ref("users/" + (currentUser || "")).once("value"),
        ]).then(([attSnap, manualSnap, hiddenSnap, userSnap]) => {
          const data = attSnap.val() || {};
          const manual = manualSnap.val() || [];
          const hidden = hiddenSnap.val() || {};
          const user = userSnap.val() || {};
          const isAdmin = user.role === "admin";
          const monthsSet = new Set();
          Object.keys(data).forEach((key) => {
            const parts = key.split("-");
            if (parts.length === 3) {
              const m = parseInt(parts[1]) - 1;
              const y = parseInt(parts[0]);
              monthsSet.add(`${y}-${m}`);
            }
          });
          manual.forEach((m) => monthsSet.add(m));
          // Ø£Ø¶Ù Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹
          const now = new Date();
          const currentMonthKey = `${now.getFullYear()}-${now.getMonth()}`;
          monthsSet.add(currentMonthKey);
          let monthsArr = Array.from(monthsSet).sort((a, b) => {
            const [ya, ma] = a.split("-").map(Number),
              [yb, mb] = b.split("-").map(Number);
            return ya !== yb ? ya - yb : ma - mb;
          });
          // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø®ÙÙŠØ© Ø¹Ù† ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙŠØ±
          if (!isAdmin) {
            monthsArr = monthsArr.filter((m) => !hidden[m]);
          }
          renderMonthFab(monthsArr);
        });
      }

      function renderMonthFab(months) {
        const fabBtn = document.getElementById("fabMainMonth");
        const fabList = document.getElementById("fabMonthsList");
        // Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙ‚Ø·
        fabBtn.textContent = "ğŸ“…";
        fabBtn.title = `ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø±`;
        fabBtn.style.background = "#007bff";
        fabBtn.style.color = "white";
        fabBtn.style.fontWeight = "bold";
        fabBtn.style.fontSize = "20px";
        fabBtn.style.boxShadow = "0 2px 8px #007bff44";
        fabBtn.style.transition = "box-shadow 0.2s";
        fabBtn.onmouseenter = () =>
          (fabBtn.style.boxShadow = "0 4px 16px #007bff77");
        fabBtn.onmouseleave = () =>
          (fabBtn.style.boxShadow = "0 2px 8px #007bff44");
        fabBtn.onclick = function () {
          fabList.style.display =
            fabList.style.display === "none" ? "flex" : "none";
        };
        fabList.innerHTML = "";
        fabList.style.position = "absolute";
        fabList.style.bottom = "60px";
        fabList.style.left = "0";
        fabList.style.flexDirection = "column";
        fabList.style.gap = "8px";
        fabList.style.alignItems = "flex-start";
        fabList.style.transition = "all 0.2s";
        // ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
        fabList.style.background = "#fff";
        fabList.style.borderRadius = "12px";
        fabList.style.boxShadow = "0 4px 16px #007bff22";
        fabList.style.padding = "8px 6px";
        fabList.style.minWidth = "48px";
        fabList.style.maxHeight = "60vh";
        fabList.style.overflowY = "auto";
        months
          .slice()
          .reverse()
          .forEach((m) => {
            const [y, mo] = m.split("-");
            const btn = document.createElement("button");
            btn.textContent = `${parseInt(mo) + 1}-${y}`; // Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©
            btn.className = "fab-month fab-month-mini";
            btn.style.background =
              parseInt(y) === year && parseInt(mo) === month
                ? "#007bff"
                : "#f4f4f4";
            btn.style.color =
              parseInt(y) === year && parseInt(mo) === month ? "white" : "#333";
            btn.title = `${arMonths[parseInt(mo)]} ${y}`;
            btn.style.margin = "2px 0";
            btn.onclick = function () {
              month = parseInt(mo);
              window.year = parseInt(y);
              const empKey = `employees_${year}_${(month + 1)
                .toString()
                .padStart(2, "0")}`;
              loadEmployees(empKey).then(() => {
                generateTable();
                renderMonthFab(months);
                fabList.style.display = "none";
              });
            };
            fabList.appendChild(btn);
          });
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§ (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
        document.addEventListener("click", function fabListClose(e) {
          if (!fabList.contains(e.target) && e.target !== fabBtn) {
            fabList.style.display = "none";
            document.removeEventListener("click", fabListClose);
          }
        });
      }

      // CSS Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
      const fabStyle = document.createElement("style");
      fabStyle.innerHTML = `
  .fab-month {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    outline: none;
    box-shadow: 0 2px 8px #007bff44;
    background: #007bff;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0;
    transition: box-shadow 0.2s, background 0.2s, color 0.2s;
  }
  .fab-month-mini {
    width: 36px;
    height: 36px;
    font-size: 16px;
    margin-bottom: 2px;
    background: #f4f4f4;
    color: #333;
    border: 2px solid #007bff22;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s, border 0.2s;
  }
  .fab-month-mini:hover {
    background: #007bff;
    color: white;
    border: 2px solid #007bff;
  }
  @media (max-width: 600px) {
    #monthsFab {
      left: 8px !important;
      bottom: 8px !important;
    }
    .fab-month, .fab-month-mini {
      width: 34px !important;
      height: 34px !important;
      font-size: 15px !important;
    }
    #fabMonthsList {
      min-width: 38px !important;
      padding: 5px 2px !important;
      border-radius: 10px !important;
      box-shadow: 0 2px 8px #007bff22 !important;
      gap: 4px !important;
    }
  }
`;
      document.head.appendChild(fabStyle);
      if (localStorage.getItem("loggedUser")) {
        loadAvailableMonths();
      }

      // Admin panel toggling: replaced the separate toggle button with a function
      const adminPanel = document.getElementById("adminPanel");
      if (adminPanel) {
        adminPanel.style.maxHeight = adminPanel.style.maxHeight || "0px";
        adminPanel.style.overflow = adminPanel.style.overflow || "hidden";
        adminPanel.style.transition = adminPanel.style.transition || "max-height 0.4s ease";
      }
      function toggleAdminPanel() {
        const adminPanel = document.getElementById("adminPanel");
        if (!adminPanel) return;
        const current = adminPanel.style.maxHeight || "0px";
        const isOpen = current !== "" && current !== "0px";
        if (!isOpen) {
          adminPanel.style.maxHeight = adminPanel.scrollHeight + "px";
          try{
            const inlineBtn = document.getElementById('aboutPanelEditInline');
            const panelBtn = document.getElementById('aboutPanelEditBtn');
            const isAdmin = (typeof currentUserRole !== 'undefined' && currentUserRole === 'admin');
            if(inlineBtn) inlineBtn.style.display = isAdmin ? 'flex' : 'none';
            if(panelBtn) panelBtn.style.display = 'none';
            if(inlineBtn){ inlineBtn.onclick = function(){ const pb = document.getElementById('aboutPanelEditBtn'); if(pb) pb.click(); }; }
          }catch(e){}
          setTimeout(() => {
            adminPanel.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 200);
        } else {
          adminPanel.style.maxHeight = "0px";
        }
      }

      // ========== Ø­Ø°Ù Ù…ØªÙ‚Ø¯Ù… ==========
      function advancedDelete() {
        // Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ø¶Ø­Ø©
        let modal = document.getElementById("deleteChoiceModal");
        if (modal) modal.remove();
        modal = document.createElement("div");
        modal.id = "deleteChoiceModal";
        modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
        modal.innerHTML = `
    <div style=\"background:#fff;max-width:370px;width:92vw;padding:26px 18px 20px 18px;border-radius:16px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeDeleteChoiceModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;\">âœ–</button>
      <div style=\"font-size:18px;color:#333;margin-bottom:20px;font-weight:500;\">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªÙ†ÙÙŠØ°Ù‡Ø§:</div>
      <div style=\"display:flex;flex-direction:column;gap:10px;align-items:center;\">
        <button class=\"deleteOpBtn\" data-op=\"1\" style=\"background:#e91e63;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">1 - Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙ‚Ø·</button>
        <button class=\"deleteOpBtn\" data-op=\"2\" style=\"background:#9c27b0;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">2 - Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        <button class=\"deleteOpBtn\" data-op=\"3\" style=\"background:#ff9800;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">3 - Ø­Ø°Ù Ø§Ù„ØªØ§Ø´ÙŠØ±Ø§Øª (Ø´ÙØªØŒ Ù†ØµØŒ âŒ)</button>
        <button class=\"deleteOpBtn\" data-op=\"4\" style=\"background:#009688;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">4 - Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</button>
        <button class=\"deleteOpBtn\" data-op=\"5\" style=\"background:#607d8b;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">5 - Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button onclick=\"clearDatabase()\" style=\"background:#e53935;color:white;margin-top:10px;width:100%;font-size:15px;padding:8px 0;border-radius:7px;\">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      </div>
    </div>
  `;
        document.body.appendChild(modal);
        document.getElementById("closeDeleteChoiceModalBtn").onclick =
          function () {
            modal.remove();
          };
        Array.from(document.getElementsByClassName("deleteOpBtn")).forEach(
          (btn) => {
            btn.onclick = function () {
              const choice = btn.getAttribute("data-op");
              modal.remove();
              // Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±
              let passModal = document.getElementById("adminPassModal");
              if (passModal) passModal.remove();
              passModal = document.createElement("div");
              passModal.id = "adminPassModal";
              passModal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
              passModal.innerHTML = `
        <div style=\"background:#fff;max-width:350px;width:90vw;padding:22px 18px 18px 18px;border-radius:14px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;\">
          <button id=\"closeAdminPassModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">âœ–</button>
          <div style=\"font-size:17px;color:#333;margin-bottom:18px;\">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯:</div>
          <input id=\"adminPassInput\" type=\"password\" style=\"width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;\" />
          <button id=\"adminPassConfirmBtn\" style=\"background:#007bff;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;\">ØªØ£ÙƒÙŠØ¯</button>
        </div>
      `;
              document.body.appendChild(passModal);
              document.getElementById("adminPassConfirmBtn").onclick =
                async function () {
                  const adminPass =
                    document.getElementById("adminPassInput").value;
                  passModal.remove();
                  const snapshot = await db
                    .ref("users/admin/password")
                    .once("value");
                  const realAdminPass = snapshot.val();
                  const ok = await verifyPassword(realAdminPass, adminPass);
                  if (!ok) {
                    alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
                    return;
                  }
                  // Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ
                  showConfirmModal(
                    "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!",
                    () => {
                      switch (choice) {
                        case "1": {
                          // Ø­Ø°Ù Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
                          const empKey = `employees_${year}_${(month + 1)
                            .toString()
                            .padStart(2, "0")}`;
                          db.ref("employees/" + empKey)
                            .remove()
                            .then(() =>
                              alert("âœ… ØªÙ… Ø­Ø°Ù Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·.")
                            )
                            .catch((e) =>
                              alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: " + e.message)
                            );
                          break;
                        }
                        case "2":
                          db.ref("users")
                            .remove()
                            .then(() => alert("âœ… ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†."))
                            .catch((e) =>
                              alert(
                                "âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: " + e.message
                              )
                            );
                          break;
                        case "3": {
                          // Ø­Ø°Ù Ø§Ù„ØªØ§Ø´ÙŠØ±Ø§Øª (Ø§Ù„Ø­Ø¶ÙˆØ±) Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
                          const days = getDays();
                          const updates = {};
                          days.forEach((day) => {
                            updates[day.key] = null;
                          });
                          db.ref("attendance")
                            .update(updates)
                            .then(() =>
                              alert("âœ… ØªÙ… Ø­Ø°Ù ØªØ§Ø´ÙŠØ±Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·.")
                            )
                            .catch((e) =>
                              alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ§Ø´ÙŠØ±Ø§Øª: " + e.message)
                            );
                          break;
                        }
                        case "4":
                          db.ref("activityLog")
                            .remove()
                            .then(() => alert("âœ… ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª."))
                            .catch((e) =>
                              alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª: " + e.message)
                            );
                          break;
                        case "5":
                          Promise.all([
                            db.ref("employees").remove(),
                            db.ref("attendance").remove(),
                            db.ref("activityLog").remove(),
                            db
                              .ref("users")
                              .once("value")
                              .then((snapshot) => {
                                const users = snapshot.val() || {};
                                const updates = {};
                                Object.keys(users).forEach((username) => {
                                  if (username !== currentUser)
                                    updates[username] = null;
                                });
                                return db.ref("users").update(updates);
                              }),
                          ])
                            .then(() => {
                              alert(
                                "âœ… ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø§ Ø¹Ø¯Ø§ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ."
                              );
                            })
                            .catch((e) => {
                              alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
                            });
                          break;
                      }
                    }
                  );
                };
              document.getElementById("closeAdminPassModalBtn").onclick =
                function () {
                  passModal.remove();
                };
            };
          }
        );
      }
      document.addEventListener("DOMContentLoaded", () => {
        const btnDeleteData = document.getElementById("btnDeleteData");
        if (btnDeleteData)
          btnDeleteData.addEventListener("click", advancedDelete);
      });

      // ========== Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
      function checkForcedLogoutOnLogin(userKey) {
        // Modified: automatically clear a forcedLogout flag instead of
        // immediately removing the session and reloading the page.
        // This preserves the logged-in session while removing the server-side
        // forced-logout marker (matches the manual console action you tested).
        return db
          .ref("forcedLogout/" + userKey)
          .once("value")
          .then((snapshot) => {
            if (snapshot.exists()) {
              // If a forced logout marker exists at login time, enforce it: remove marker then logout the session
              return db
                .ref("forcedLogout/" + userKey)
                .remove()
                .then(() => {
                  try { logActivity("Forced logout executed at login", userKey); } catch (e) {}
                  try { showForcedLogoutModal(); } catch (e) {}
                  // perform logout UI update
                  try { logout(); } catch (e) {}
                  return true;
                })
                .catch((err) => {
                  console.error("Failed to remove forcedLogout:", err);
                  return false;
                });
            }
            return false;
          });
      }

      // Ù†Ø§ÙØ°Ø© Ø£Ù†ÙŠÙ‚Ø© Ø¹Ù†Ø¯ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±
      function showAccountDeletedModal() {
        let oldModal = document.getElementById("accountDeletedModal");
        if (oldModal) oldModal.remove();
        const modal = document.createElement("div");
        modal.id = "accountDeletedModal";
        modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
        modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#fff7f7 60%,#fce4ec 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #e5737333;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <div style=\"font-size:21px;color:#d32f2f;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">ğŸš« ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#fff3f3;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #e5737311;\">ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.<br>Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ø§ Ø¥Ø°Ø§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.</div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #accountDeletedModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #accountDeletedModal div { font-size:16px !important; }
      }
    </style>
  `;
        document.body.appendChild(modal);
      }

      // Ù†Ø§ÙØ°Ø© Ø£Ù†ÙŠÙ‚Ø© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¬Ø¨Ø§Ø±ÙŠÙ‹Ø§ (Ø§Ø­ØªÙŠØ§Ø·)
      function showForcedLogoutModal() {
        let oldModal = document.getElementById("forcedLogoutModal");
        if (oldModal) oldModal.remove();
        const modal = document.createElement("div");
        modal.id = "forcedLogoutModal";
        modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
        modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#f7faff 60%,#e3eafc 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #1976d233;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <div style=\"font-size:21px;color:#1976d2;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">ğŸšª ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#f3f7ff;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #1976d211;\">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.<br>Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø­ØªÙ‰ ØªØ¹ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.</div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #forcedLogoutModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #forcedLogoutModal div { font-size:16px !important; }
      }
    </style>
  `;
        document.body.appendChild(modal);
      }
      if (localStorage.getItem("loggedUser")) {
        const savedUser = JSON.parse(localStorage.getItem("loggedUser"));
        checkForcedLogoutOnLogin(savedUser.user);
      }
      setInterval(() => {
        // Periodic check: if there's a forcedLogout marker, perform forced logout
        if (currentUser) {
          db.ref("forcedLogout/" + currentUser)
            .once("value")
            .then((snapshot) => {
              if (snapshot.exists()) {
                // remove the server-side flag and then log the user out locally
                db.ref("forcedLogout/" + currentUser)
                  .remove()
                  .then(() => {
                    try { logActivity("Forced logout executed", currentUser); } catch (e) {}
                    try {
                      // show a modal explaining the forced logout and clear session
                      showForcedLogoutModal();
                      logout();
                    } catch (e) { console.error('Error during forced logout handling', e); }
                  })
                  .catch((err) => console.error("Failed to remove forcedLogout:", err));
              }
            });
        }
      }, 3000);

      // ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ==========
      function setEmpStatsEnabled(enabled) {
        db.ref("settings/showEmpStats").set(enabled ? true : false);
      }
      function getEmpStatsEnabled() {
        return db
          .ref("settings/showEmpStats")
          .once("value")
          .then((snap) => !!snap.val());
      }
      function setEmpStatsMode(mode, value) {
        db.ref("settings/empStatsMode").set({ mode, value: value || "" });
      }
      function getEmpStatsMode() {
        return db
          .ref("settings/empStatsMode")
          .once("value")
          .then((snap) => snap.val() || { mode: "all", value: "" });
      }
      // Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ù…Ø¯ÙŠØ±
      document.getElementById("toggleEmpStatsBtn").onclick = function () {
        let tab = document.getElementById("empStatsTab");
        tab.style.display = "flex";
        document.getElementById("closeEmpStatsTab").onclick = function () {
          tab.style.display = "none";
        };
        renderEmpStatsTabContent();
      };

      // Ø¹Ø±Ø¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
      function renderEmpStatsTabContent() {
        const contentDiv = document.getElementById("empStatsTabContent");
        contentDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        // Ensure we always fetch the up-to-date employee list for the currently
        // selected month/year from the same path that loadEmployees() uses
        // (employees/<empKey>). Previously this used a wrong/refactored path
        // which could return stale/incomplete data.
        const empKey = `employees_${year}_${(month + 1).toString().padStart(2, "0")}`;
        Promise.all([
          db.ref("users").once("value"),
          db.ref("employees/" + empKey).once("value"),
        ]).then(([usersSnap, empsSnap]) => {
          const users = usersSnap.val() || {};
          // Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø´Ù‡Ø±ÙŠ
          const employeesList = empsSnap.exists() ? Object.values(empsSnap.val()) : [];
          let html = `<div style='font-size:15px;color:#333;margin-bottom:10px;text-align:center;'>ØªØ­ÙƒÙ… Ø¨Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>`;
          html += `<table style='width:100%;border-collapse:collapse;'>
      <tr style='background:#f6f6f6;'>
        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¹Ø±Ø¶Ù‡Ù…</th>
        <th>Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§ØªØ¨</th>
      </tr>`;
          Object.entries(users).forEach(([username, data]) => {
            if (username === "admin") return;
            const allowedEmps = data.allowedStatsEmps || [];
            const canViewSalary = !!data.canViewSalary;
            html += `<tr>
        <td style='padding:7px 4px;'>${username}</td>
        <td style='padding:7px 4px;'>
          <select multiple data-user='${username}' class='allowedEmpsSelect' style='width:140px;min-height:38px;font-size:15px;'>
            ${employeesList
              .map(
                (emp) =>
                  `<option value='${emp}' ${
                    allowedEmps.includes(emp) ? "selected" : ""
                  }>${emp}</option>`
              )
              .join("")}
          </select>
        </td>
        <td style='padding:7px 4px;text-align:center;'>
  <label style='display:inline-flex;align-items:center;gap:7px;'>
    <span style='font-size:15px;color:#1976d2;'>Ø§Ù„Ø±ÙˆØ§ØªØ¨</span>
    <input type='checkbox' data-user='${username}' class='canViewSalaryCheckbox' ${
              canViewSalary ? "checked" : ""
            } />
  </label>
</td>
      </tr>`;
          });
          html += `</table><div style='font-size:13px;color:#555;margin-top:8px;'>Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¹Ø±Ø¶Ù‡Ù… Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙˆØ®ÙŠØ§Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§ØªØ¨. Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±ÙŠ.</div>`;
          contentDiv.innerHTML = html;

          // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¹Ø±Ø¶Ù‡Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
          Array.from(
            document.getElementsByClassName("allowedEmpsSelect")
          ).forEach((sel) => {
            sel.onchange = function () {
              const user = sel.getAttribute("data-user");
              const selected = Array.from(sel.selectedOptions).map(
                (opt) => opt.value
              );
              // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              db.ref("users/" + user + "/allowedStatsEmps")
                .set(selected)
                .then(() => {
                  logActivity(
                    "ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
                    "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¹Ø±Ø¶Ù‡Ù… Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: " +
                      user +
                      " Ø¥Ù„Ù‰: " +
                      selected.join(", ")
                  );
                });
              // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…ØªØ£Ø«Ø±ØŒ Ø­Ø¯Ø« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
              if (user === currentUser) {
                // ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                if (window.currentUserData)
                  window.currentUserData.allowedStatsEmps = selected;
                // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹
                db.ref("attendance")
                  .once("value")
                  .then((snap) => {
                    calculateStats(snap.val() || {});
                  });
              }
            };
          });
          // Ø­ÙØ¸ Ø®ÙŠØ§Ø± Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
          Array.from(
            document.getElementsByClassName("canViewSalaryCheckbox")
          ).forEach((chk) => {
            chk.onchange = function () {
              const user = chk.getAttribute("data-user");
              const val = chk.checked;
              // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              db.ref("users/" + user + "/canViewSalary")
                .set(val)
                .then(() => {
                  logActivity(
                    "ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±ÙˆØ§ØªØ¨",
                    "ØªÙ… ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: " +
                      user +
                      " Ø¥Ù„Ù‰: " +
                      (val ? "Ù†Ø¹Ù…" : "Ù„Ø§")
                  );
                });
              // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…ØªØ£Ø«Ø±ØŒ Ø­Ø¯Ø« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
              if (user === currentUser) {
                if (window.currentUserData)
                  window.currentUserData.canViewSalary = val;
                db.ref("attendance")
                  .once("value")
                  .then((snap) => {
                    calculateStats(snap.val() || {});
                  });
              }
            };
          });
          // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ (Realtime)
          if (typeof window._statsPermsListenerSet === "undefined") {
            window._statsPermsListenerSet = true;
            ["allowedStatsEmps", "canViewSalary"].forEach((key) => {
              db.ref("users/" + currentUser + "/" + key).on(
                "value",
                function () {
                  db.ref("attendance")
                    .once("value")
                    .then((snap) => {
                      calculateStats(snap.val() || {});
                    });
                }
              );
            });
          }
        });
      }

      // ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ==========
      const userEmpStatsDiv = document.createElement("div");
      userEmpStatsDiv.id = "userEmpStatsDiv";
      userEmpStatsDiv.style.margin = "20px 0";
      userEmpStatsDiv.style.padding = "10px";
      userEmpStatsDiv.style.background = "#f8f9fa";
      userEmpStatsDiv.style.border = "1px solid #ddd";
      userEmpStatsDiv.style.borderRadius = "7px";
      userEmpStatsDiv.style.display = "none";
      document.getElementById("mainContent").appendChild(userEmpStatsDiv);

      function renderUserEmpStats() {
        Promise.all([getEmpStatsEnabled(), getEmpStatsMode()]).then(
          ([enabled, modeObj]) => {
            if (!enabled) {
              userEmpStatsDiv.style.display = "none";
              return;
            }
            let allow = false,
              onlyEmp = null;
            if (modeObj.mode === "all") allow = true;
            else if (modeObj.mode === "user" && currentUser === modeObj.value)
              allow = true;
            else if (modeObj.mode === "employee") {
              allow = true;
              onlyEmp = modeObj.value;
            }
            if (!allow) {
              userEmpStatsDiv.style.display = "none";
              return;
            }
            let html = `
      <b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</b>
      <div id='userEmpStatsGrid' style='margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:13px;'></div>
      <style>
        @media (max-width:600px){
          #userEmpStatsGrid{grid-template-columns:1fr;gap:8px;}
        }
        .emp-card{background:#f8f9fa;border-radius:10px;box-shadow:0 1px 6px #0001;padding:15px 10px;display:flex;flex-direction:column;align-items:center;transition:box-shadow 0.2s;}
        .emp-card .emp-name{font-weight:bold;font-size:16px;color:#007bff;margin-bottom:7px;}
        .emp-card .emp-stats{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
        .emp-card .stat{display:flex;align-items:center;gap:4px;font-size:14px;background:#fff;border-radius:6px;padding:4px 9px;margin:2px 0;box-shadow:0 1px 3px #0001;}
        .emp-card .stat.shift{color:#28a745;}
        .emp-card .stat.half{color:#ffc107;}
        .emp-card .stat.absent{color:#dc3545;}
      </style>
    `;
            userEmpStatsDiv.innerHTML = html;
            const gridDiv = document.getElementById("userEmpStatsGrid");
            gridDiv.innerHTML =
              "<div style='text-align:center;width:100%;color:#888;'>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>";
            db.ref("attendance")
              .once("value")
              .then((snapshot) => {
                const data = snapshot.val() || {};
                // Ø§Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„Ù…ØªØ£Ø«Ø±
                let allowedEmps, canViewSalary;
                if (typeof window.currentUserData !== "undefined") {
                  allowedEmps = window.currentUserData.allowedStatsEmps || [];
                  canViewSalary = !!window.currentUserData.canViewSalary;
                } else {
                  allowedEmps = [];
                  canViewSalary = false;
                }
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ ÙŠØ±Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹
                let showEmps =
                  currentUserRole === "admin"
                    ? window.monthEmployees
                    : allowedEmps;
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ ÙŠØ±Ù‰ Ø§Ù„Ø¬Ù…ÙŠØ¹
                if (!Array.isArray(showEmps) || showEmps.length === 0)
                  showEmps = window.monthEmployees;
                // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ¸ÙÙŠÙ†
                if (!Array.isArray(showEmps) || showEmps.length === 0) {
                  gridDiv.innerHTML =
                    "<div style='text-align:center;width:100%;color:#888;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>";
                  userEmpStatsDiv.style.display = "block";
                  return;
                }
                // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ± Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                let hasAttendance = false;
                Object.entries(data).forEach(([dateStr, day]) => {
                  let parts = dateStr.split("-");
                  if (parts.length === 3) {
                    let dYear = parseInt(parts[0]);
                    let dMonth = parseInt(parts[1]) - 1;
                    if (dYear === year && dMonth === month)
                      hasAttendance = true;
                  }
                });
                if (!hasAttendance) {
                  gridDiv.innerHTML =
                    "<div style='text-align:center;width:100%;color:#888;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>";
                  userEmpStatsDiv.style.display = "block";
                  return;
                }
                gridDiv.innerHTML = "";
                showEmps.forEach((emp) => {
                  if (onlyEmp && emp !== onlyEmp) return;
                  let shift = 0,
                    half = 0,
                    x = 0;
                  Object.entries(data).forEach(([dateStr, day]) => {
                    let parts = dateStr.split("-");
                    if (parts.length === 3) {
                      let dYear = parseInt(parts[0]);
                      let dMonth = parseInt(parts[1]) - 1;
                      if (dYear === year && dMonth === month) {
                        if (day[emp] === "Ø´ÙØª") shift++;
                        if (day[emp] === "Ù†Øµ") half++;
                        if (day[emp] === "âŒ") x++;
                      }
                    }
                  });
                  const rates = getRatesForEmployee(emp, year, month);
                  const salary = shift * (rates.shift || 20000) + half * (rates.half || 10000);
                  const card = document.createElement("div");
                  card.className = "emp-card";
                  card.innerHTML = `
          <div class='emp-name'>${emp}</div>
          <div class='emp-stats'>
            <div class='stat shift'>âœ… Ø´ÙØª: <b>${shift}</b></div>
            <div class='stat half'>ğŸŒ“ Ù†Øµ: <b>${half}</b></div>
            <div class='stat absent'>ğŸ–ï¸ Ø§Ø¬Ø§Ø²Ø©: <b>${x}</b></div>
          </div>
          ${
            canViewSalary || currentUserRole === "admin"
              ? `<div class='emp-salary' style='margin-top:8px;font-size:15px;color:#222;background:#e3f7e3;padding:6px 0;border-radius:7px;width:100%;text-align:center;'>ğŸ’° Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙƒÙ„ÙŠ: <b>${salary.toLocaleString()} Ø¯.Ø¹</b></div>`
              : ""
          }
        `;
                  gridDiv.appendChild(card);
                });
                userEmpStatsDiv.style.display = "block";
              });
          }
        );
      }
      function tryShowUserEmpStats() {
        if (
          typeof window.monthEmployees !== "undefined" &&
          window.monthEmployees.length > 0
        )
          renderUserEmpStats();
      }
      const origLoadEmployees = loadEmployees;
      loadEmployees = function () {
        return origLoadEmployees.apply(this, arguments).then(() => {
          if (
            typeof window.monthEmployees !== "undefined" &&
            window.monthEmployees.length > 0
          ) {
            renderUserEmpStats();
          }
        });
      };
      if (localStorage.getItem("loggedUser")) tryShowUserEmpStats();
      db.ref("settings/empStatsMode").on("value", () => renderUserEmpStats());

      // ========== ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± ==========
      // ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
      function changeAdminPassword() {
        const oldPass = document.getElementById("adminOldPass").value;
        const newPass = document.getElementById("adminNewPass").value;
        const statusDiv = document.getElementById("adminPassStatus");
        if (currentUserRole !== "admin") {
          statusDiv.textContent = "âŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ…ÙƒÙ†Ù‡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
          return;
        }
        if (!oldPass || !newPass) {
          statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.";
          return;
        }
        db.ref("users/admin/password")
          .once("value")
          .then(async (snapshot) => {
            try {
              const stored = snapshot.val();
              // use verifyPassword to support hashed and legacy formats
              const ok = await verifyPassword(stored, oldPass);
              if (!ok) {
                statusDiv.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                return;
              }
              const hashObj = await hashPassword(newPass);
              await db.ref("users/admin/password").set(hashObj);
              statusDiv.textContent = "âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
              document.getElementById("adminOldPass").value = "";
              document.getElementById("adminNewPass").value = "";
              logActivity(
                "ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±",
                `ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† Ù‚Ø¨Ù„: ${currentUser}`
              );
            } catch (err) {
              console.error("Error changing admin password:", err);
              statusDiv.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
            }
          })
          .catch((err) => {
            console.error("Error reading admin password:", err);
            statusDiv.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
          });
      }

      // ========== Ø­Ø°Ù Ù…ÙˆØ¸Ù ==========
      // ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù
      function deleteEmployee(index) {
        if (!canEditCurrentMonth()) return;
        if (currentUserRole !== "admin") {
          alert("âŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ…ÙƒÙ†Ù‡ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.");
          return;
        }
        const empName = employees[index];
        if (!empName) {
          alert("âŒ Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
          return;
        }
        showConfirmModal(
          `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù \"${empName}\"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±Ù‡ Ø£ÙŠØ¶Ø§.`,
          async () => {
            if (!canEditCurrentMonth()) return;
            const newEmployees = employees.slice();
            newEmployees.splice(index, 1);
            // Remove employee attendance
            const attendanceSnapshot = await db.ref("attendance").once("value");
            const attendance = attendanceSnapshot.val() || {};
            Object.keys(attendance).forEach((dayKey) => {
              if (attendance[dayKey][empName] !== undefined) {
                delete attendance[dayKey][empName];
              }
            });
            await db.ref("attendance").set(attendance);
            // Remove employee from allowedStatsEmps for all users
            const usersSnap = await db.ref("users").once("value");
            const users = usersSnap.val() || {};
            await Promise.all(Object.entries(users).map(async ([username, data]) => {
              if (username === "admin") return;
              const allowed = Array.isArray(data.allowedStatsEmps) ? data.allowedStatsEmps : [];
              if (allowed.includes(empName)) {
                const updated = allowed.filter(e => e !== empName);
                await db.ref("users/" + username + "/allowedStatsEmps").set(updated);
              }
            }));
            saveEmployees(newEmployees);
            logActivity(
              "Ø­Ø°Ù Ù…ÙˆØ¸Ù",
              `ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù: ${empName} ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±Ù‡ ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª Ø¸Ù‡ÙˆØ±Ù‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†`
            );
          }
        );
      }

      
    </script>

    <!-- Ø¥Ø¶Ø§ÙØ©: Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
    <div
      id="changePassModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.35);
        z-index: 6000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        style="
          background: #fff;
          max-width: 340px;
          width: 95vw;
          border-radius: 12px;
          box-shadow: 0 8px 32px #0002;
          padding: 22px 18px 18px 18px;
          position: relative;
        "
      >
        <button
          id="closeChangePassModal"
          style="
            position: absolute;
            top: 10px;
            left: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 16px;
            cursor: pointer;
          "
        >
          âœ–
        </button>
        <h3 style="text-align: center; margin-bottom: 18px; color: #2196f3">
          ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        </h3>
        <div id="changePassForm"></div>
        <div
          id="changePassStatus"
          style="margin-top: 10px; font-size: 14px; text-align: center"
        ></div>
      </div>
    </div>
    <script>
      // ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
      document.getElementById("sidebarChangePassBtn").onclick = function () {
        document.getElementById("sidebarMenu").classList.remove("open");
        showChangePassForm();
      };

      function showChangePassForm() {
        const modal = document.getElementById("changePassModal");
        const formDiv = document.getElementById("changePassForm");
        const statusDiv = document.getElementById("changePassStatus");
        statusDiv.textContent = "";
        // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ù†ÙØ³Ù‡
        if (currentUserRole === "admin") {
          db.ref("users")
            .once("value")
            .then((snapshot) => {
              const users = snapshot.val() || {};
              let html = `<div style='margin-bottom:10px;font-size:15px;color:#1976d2;font-weight:bold;'>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±</div>
        <label style='font-size:14px;'>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
        <select id="changePassUser" style="width:100%;margin-bottom:10px;">`;
              Object.keys(users).forEach((u) => {
                html += `<option value="${u}" ${
                  u === currentUser ? "selected" : ""
                }>${u}${u === "admin" ? " (Ù…Ø¯ÙŠØ±)" : ""}</option>`;
              });
              html += `</select>
        <label style='font-size:14px;'>Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:</label>
        <input type="text" id="changeUserName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-bottom:8px;" />
        <label style='font-size:14px;'>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©:</label>
        <input type="password" id="changePassNew" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-bottom:8px;" />
        <button id="changeUserSubmit" style="background:#2196f3;color:white;width:100%;margin-top:8px;font-size:16px;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        <button id="resetPassBtn" style="background:#ff9800;color:white;width:100%;margin-top:8px;font-size:16px;">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)</button>
        <div style='margin-top:10px;font-size:13px;color:#555;'>ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø³Ù‡ÙˆÙ„Ø©.<br>Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ Ù†Ø³ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.</div>`;
              formDiv.innerHTML = html;
              modal.style.display = "flex";
              // ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
              document.getElementById("changeUserSubmit").onclick =
                async function () {
                  const user = document.getElementById("changePassUser").value;
                  const newPass =
                    document.getElementById("changePassNew").value;
                  const newUserName = document
                    .getElementById("changeUserName")
                    .value.trim();
                  let changed = false;
                  // ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ù… ÙŠÙƒÙ† Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§
                  if (newUserName && !users[newUserName]) {
                    const userDataSnap = await db
                      .ref("users/" + user)
                      .once("value");
                    const userData = userDataSnap.val();
                    await db.ref("users/" + newUserName).set(userData);
                    await db.ref("users/" + user).remove();
                    statusDiv.textContent = `âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰: ${newUserName}`;
                    logActivity(
                      "ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…",
                      `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ${user} Ø¥Ù„Ù‰ ${newUserName} Ø¨ÙˆØ§Ø³Ø·Ø©: ${currentUser}`
                    );
                    changed = true;
                  } else if (newUserName && users[newUserName]) {
                    statusDiv.textContent =
                      "âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.";
                    return;
                  }
                  // ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©
                  if (newPass) {
                    const hashObj = await hashPassword(newPass);
                    const targetUser =
                      newUserName && !users[newUserName] ? newUserName : user;
                    await db
                      .ref("users/" + targetUser + "/password")
                      .set(hashObj);
                    statusDiv.textContent +=
                      (changed ? "<br>" : "") +
                      "âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
                    logActivity(
                      "ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±",
                      `ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${targetUser} Ø¨ÙˆØ§Ø³Ø·Ø©: ${currentUser}`
                    );
                    changed = true;
                  }
                  if (!changed) {
                    statusDiv.textContent =
                      "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.";
                  }
                  document.getElementById("changePassNew").value = "";
                  document.getElementById("changeUserName").value = "";
                };
              // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
              document.getElementById("resetPassBtn").onclick =
                async function () {
                  const user = document.getElementById("changePassUser").value;
                  let newPass = "";
                  // Ù†Ø§ÙØ°Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                  let passModal = document.createElement("div");
                  passModal.style =
                    "position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:center;justify-content:center;";
                  passModal.innerHTML = `<div style='background:#fff;max-width:340px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;text-align:center;'>
          <h3 style='color:#ff9800;margin-bottom:12px;'>Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
          <div style='margin-bottom:10px;font-size:15px;'>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… <b style='color:#1976d2;'>${user}</b>:</div>
          <input type='password' id='newPassInput' style='width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;' placeholder='ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©' />
          <button id='confirmNewPassBtn' style='background:#2196f3;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;'>ØªØ£ÙƒÙŠØ¯</button>
          <button id='cancelNewPassBtn' style='background:#dc3545;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;margin-left:8px;'>Ø¥Ù„ØºØ§Ø¡</button>
        </div>`;
                  document.body.appendChild(passModal);
                  document.getElementById("confirmNewPassBtn").onclick =
                    async function () {
                      newPass = document.getElementById("newPassInput").value;
                      if (!newPass) {
                        statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.";
                        passModal.remove();
                        return;
                      }
                      const hashObj = await hashPassword(newPass);
                      await db.ref("users/" + user + "/password").set(hashObj);
                      statusDiv.textContent =
                        "âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
                      logActivity(
                        "Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±",
                        `ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user} Ø¨ÙˆØ§Ø³Ø·Ø©: ${currentUser}`
                      );
                      passModal.remove();
                    };
                  document.getElementById("cancelNewPassBtn").onclick =
                    function () {
                      passModal.remove();
                    };
                };
            });
        } else {
          let html = `
      <input type="text" id="changeUserName" placeholder="Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-bottom:8px;" />
      <input type="password" id="changePassOld" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" style="margin-bottom:8px;" />
      <input type="password" id="changePassNew" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" style="margin-bottom:8px;" />
      <button id="changePassSubmit" style="background:#2196f3;color:white;width:100%;margin-top:8px;">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
      <button id="resetPassBtn" style="background:#ff9800;color:white;width:100%;margin-top:8px;">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¥Ø°Ø§ Ù†Ø³ÙŠØª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)</button>`;
          formDiv.innerHTML = html;
          modal.style.display = "flex";
          document.getElementById("changePassSubmit").onclick =
            async function () {
              const oldPass = document.getElementById("changePassOld").value;
              const newPass = document.getElementById("changePassNew").value;
              const newUserName = document
                .getElementById("changeUserName")
                .value.trim();
              if (!oldPass || !newPass)
                return (statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
              const passSnap = await db
                .ref("users/" + currentUser + "/password")
                .once("value");
              const stored = passSnap.val();
              const ok = await verifyPassword(stored, oldPass);
              if (!ok)
                return (statusDiv.textContent =
                  "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
              const hashObj = await hashPassword(newPass);
              await db.ref("users/" + currentUser + "/password").set(hashObj);
              // ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ ÙˆÙ„Ù… ÙŠÙƒÙ† Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§
              const usersSnap = await db.ref("users").once("value");
              const users = usersSnap.val() || {};
              if (newUserName && !users[newUserName]) {
                const userDataSnap = await db
                  .ref("users/" + currentUser)
                  .once("value");
                const userData = userDataSnap.val();
                await db.ref("users/" + newUserName).set(userData);
                await db.ref("users/" + currentUser).remove();
                statusDiv.textContent = `âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰: ${newUserName}`;
                logActivity(
                  "ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…",
                  `ØªÙ… ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ${currentUser} Ø¥Ù„Ù‰ ${newUserName}`
                );
              } else {
                statusDiv.textContent = "âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
              }
              logActivity(
                "ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±",
                `ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser}`
              );
              document.getElementById("changePassOld").value = "";
              document.getElementById("changePassNew").value = "";
              document.getElementById("changeUserName").value = "";
            };
          // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ø°Ø§ Ù†Ø³ÙŠØª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
          document.getElementById("resetPassBtn").onclick = async function () {
            const newPass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
            if (!newPass)
              return (statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.");
            const hashObj = await hashPassword(newPass);
            await db.ref("users/" + currentUser + "/password").set(hashObj);
            statusDiv.textContent = "âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
            logActivity(
              "Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±",
              `ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser}`
            );
          };
        }
      }
      document.getElementById("closeChangePassModal").onclick = function () {
        document.getElementById("changePassModal").style.display = "none";
      };

      // ========== ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± ==========
      // ØªÙ… Ø¯Ù…Ø¬ Ø¯Ø§Ù„Ø© updateSidebarVisibility ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…Ø¹ Ù…Ù†Ø·Ù‚ Ù…ÙˆØ­Ø¯ ÙˆØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±

      // ========== ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ==========
      document.getElementById("sidebarToggleBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.add("open");
        document.getElementById("sidebarToggleBtn").style.display = "none";
        document.getElementById("sidebarCloseBtn").style.display = "flex";
        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const sidebarUserName = document.getElementById("sidebarUserName");
        sidebarUserName.innerHTML = currentUser
          ? `<span style="display:inline-flex;align-items:center;gap:7px;">
          <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User" style="width:22px;height:22px;border-radius:50%;background:#e3f0ff;margin-left:2px;">
          <span style="font-weight:600;color:#fffff;">${currentUser}</span>
             </span>`
          : "ØºÙŠØ± Ù…Ø³Ø¬Ù„";
        updateSidebarVisibility();
      };
      document.getElementById("sidebarCloseBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        document.getElementById("sidebarCloseBtn").style.display = "none";
        document.getElementById("sidebarToggleBtn").style.display = "flex";
        updateSidebarVisibility();
      };

    // Announcements feature (admin-only)
    function updateAnnouncementsVisibility() {
      const btn = document.getElementById("sidebarAnnouncementsBtn");
      if (!btn) return;
      btn.style.display = currentUserRole === "admin" ? "block" : "none";
      // Only show the local close button for admin users. Regular users cannot close the announcement.
      const closeBtn = document.getElementById('closeAnnouncementBar');
      if (closeBtn) {
        if (currentUserRole === 'admin') {
          closeBtn.style.display = 'flex';
          // delegate precise positioning to a dedicated helper so it can
          // be re-used on resize and other layout changes.
          try {
            if (typeof positionAnnouncementCloseButton === 'function')
              positionAnnouncementCloseButton();
          } catch (e) {
            // fallback: ensure it's visible in the top-right
            closeBtn.style.position = 'absolute';
            closeBtn.style.right = '10px';
            closeBtn.style.top = '8px';
          }
        } else {
          closeBtn.style.display = 'none';
        }
      }
    }
    // call on load and when user role changes
    try {
      updateAnnouncementsVisibility();
    } catch (e) {}

    // Helper: position the admin-only announcement close button next to the
    // sidebar toggle. This is called from updateAnnouncementsVisibility and
    // on window resize to keep it aligned.
    function positionAnnouncementCloseButton() {
      const closeBtn = document.getElementById('closeAnnouncementBar');
      const toggle = document.getElementById('sidebarToggleBtn');
      if (!closeBtn) return;
      // Default placement (top-right) in case toggle isn't visible
      closeBtn.style.position = 'absolute';
      closeBtn.style.right = '10px';
      closeBtn.style.top = '8px';
      try {
        if (toggle && toggle.getBoundingClientRect) {
          const rect = toggle.getBoundingClientRect();
          // prefer fixed positioning so it follows viewport
          closeBtn.style.position = 'fixed';
          // align vertically with the toggle button
          closeBtn.style.top = rect.top + 'px';
          // place it to the left of the toggle by a small margin
          const leftPos = rect.left - (closeBtn.offsetWidth + 8);
          // if left would go off-screen, keep in top-right
          if (leftPos > 8) {
            closeBtn.style.left = leftPos + 'px';
            closeBtn.style.right = 'auto';
          } else {
            closeBtn.style.left = 'auto';
            closeBtn.style.right = '10px';
          }
        }
      } catch (err) {
        // ignore and keep default
      }
    }

    // Keep the close button positioned on resize and when the DOM is ready
    window.addEventListener('resize', function () {
      try {
        positionAnnouncementCloseButton();
      } catch (e) {}
    });
    document.addEventListener('DOMContentLoaded', function () {
      try {
        positionAnnouncementCloseButton();
      } catch (e) {}
    });

    // Non-invasive debug helper: shows current session info in console when
    // developer toggles `window.showSessionDebug()` in the console.
    // Non-logging helper that returns session info (call .getAnnouncement() to fetch persisted announcement)
    window.showSessionDebug = function () {
      return {
        currentUser: currentUser,
        currentUserRole: currentUserRole,
        currentUserCanEdit: currentUserCanEdit,
        getAnnouncement: function(){
          if (typeof db === 'undefined' || !db) return Promise.resolve(null);
          return db.ref('announcements/current').once('value').then(snap => snap.val()).catch(() => null);
        }
      };
    };

    document.getElementById("sidebarAnnouncementsBtn").onclick = function () {
      document.getElementById("sidebarMenu").classList.remove("open");
      document.getElementById("announceModal").style.display = "flex";
      document.getElementById("announceText").focus();
      // show delete button only to admin
      try {
        const delBtn = document.getElementById('deleteCurrentAnnounceBtn');
        if (delBtn) delBtn.style.display = currentUserRole === 'admin' ? 'block' : 'none';
      } catch (e) {}
    };
    document.getElementById("closeAnnounceModal").onclick = function () {
      document.getElementById("announceModal").style.display = "none";
    };

    // custom duration input handling
    (function() {
      const durSel = document.getElementById('announceDuration');
      const modalInner = document.getElementById('announceModal').querySelector('div');
      let customInput = null;
      durSel.addEventListener('change', function() {
        if (this.value === 'custom') {
          if (!customInput) {
            customInput = document.createElement('input');
            customInput.type = 'number';
            customInput.min = '1';
            customInput.placeholder = 'Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ (Ù…Ø«Ø§Ù„: 90)';
            customInput.style = 'padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;margin-top:6px;';
            durSel.parentNode.insertBefore(customInput, durSel.nextSibling);
          }
        } else {
          if (customInput) {
            customInput.remove();
            customInput = null;
          }
        }
      });
    })();

    // Announcement publish logic with DB persistence and listener
    let announcementTimer = null;
    let announceAnimation = null; // kept for backward compatibility but unused for static mode
    function showAnnouncementLocal(text, minutes, opts) {
      if (!text || !text.trim()) return;
      const bar = document.getElementById("announcementBar");
      const inner = document.getElementById("announcementInner");
      // set static text and allow wrapping
      inner.textContent = text.trim();
      // apply formatting options when provided
      if (opts && opts.fontSize) inner.style.fontSize = opts.fontSize + 'px';
      else inner.style.fontSize = '18px';
      if (opts && opts.bgColor) bar.style.background = opts.bgColor;
      else bar.style.background = 'linear-gradient(90deg,#ff8a00,#ff6f00)';
      // make bar visible and allow it to size to content
      bar.style.display = "flex";
      bar.style.alignItems = "center";
      bar.style.justifyContent = "center";
      inner.style.transform = "none";
      // clear any previous timers/animations
      if (announceAnimation) {
        cancelAnimationFrame(announceAnimation);
        announceAnimation = null;
      }
      if (announcementTimer) clearTimeout(announcementTimer);
      const hideMs = minutes > 0 ? minutes * 60 * 1000 : 30 * 1000;
      // ensure the bar height can expand to the text content
      inner.style.display = 'block';
  inner.style.maxWidth = 'calc(100% - 100px)';
      inner.style.overflow = 'visible';
      // schedule hide
      announcementTimer = setTimeout(() => {
        bar.style.display = "none";
        // restore default background when hiding
        bar.style.background = 'linear-gradient(90deg,#ff8a00,#ff6f00)';
        inner.style.fontSize = '18px';
      }, hideMs);
    }

    // Persist announcement to DB under announcements/current
    function publishAnnouncement(text, minutes, persist = true, opts) {
      if (!text || !text.trim()) return;
      const payload = {
        text: text.trim(),
        minutes: minutes,
        from: currentUser || "admin",
        ts: Date.now(),
        opts: opts || {},
      };
      // write to DB so it survives refresh across clients
      if (persist) {
        db.ref('announcements/current').set(payload).catch((e) => console.warn('Failed to persist announcement', e));
      }
  // show immediately locally (apply formatting if provided)
  showAnnouncementLocal(payload.text, payload.minutes, payload.opts);
      // schedule removal from DB when expired (only if persisted)
      if (persist && minutes > 0) {
        setTimeout(() => {
          // only remove if unchanged
          db.ref('announcements/current').once('value').then(snap => {
            const cur = snap.val();
            if (!cur) return;
            if (cur.ts === payload.ts && cur.text === payload.text) {
              db.ref('announcements/current').remove().catch(() => {});
            }
          });
        }, minutes * 60 * 1000 + 2000);
      }
    }

    // close button handler
    document.getElementById('closeAnnouncementBar').onclick = function() {
      const bar = document.getElementById('announcementBar');
      bar.style.display = 'none';
      if (announceAnimation) cancelAnimationFrame(announceAnimation);
      announceAnimation = null;
      if (announcementTimer) clearTimeout(announcementTimer);
      // If admin closed the bar, remove the persisted announcement so it
      // disappears for everyone.
      try {
        if (currentUserRole === 'admin') {
          db.ref('announcements/current').remove().catch(() => {});
        }
      } catch (e) {}
    };

    // Listen for announcement changes so they persist across refresh
    db.ref('announcements/current').on('value', function(snap) {
      const val = snap.val();
      if (!val) {
        // clear UI
        const bar = document.getElementById('announcementBar');
        if (bar) bar.style.display = 'none';
        if (announceAnimation) cancelAnimationFrame(announceAnimation);
        announceAnimation = null;
        if (announcementTimer) clearTimeout(announcementTimer);
        return;
      }
      // calculate remaining time based on ts and minutes
      const elapsed = (Date.now() - (val.ts || 0)) / 60000; // minutes
      const remaining = (val.minutes || 0) - elapsed;
      // If already expired, remove from DB
      if (val.minutes > 0 && remaining <= 0) {
        db.ref('announcements/current').remove().catch(() => {});
        return;
      }
      // pass stored opts (bgColor, fontSize, etc.) so formatting persists across reloads
      showAnnouncementLocal(val.text, remaining > 0 ? remaining : 0.5, val.opts || {});
    });

    document.getElementById("publishAnnounceBtn").onclick = function () {
      const text = document.getElementById("announceText").value;
      const durEl = document.getElementById("announceDuration");
      let minutes = durEl.value === 'custom' && durEl.nextSibling && durEl.nextSibling.value ? parseInt(durEl.nextSibling.value, 10) : parseInt(durEl.value || "60", 10);
      if (!minutes || minutes <= 0) minutes = 60;
      const fontSize = parseInt(document.getElementById('announceFontSize').value, 10) || 18;
      const bgColor = document.getElementById('announceBgColor').value || '';
      const opts = { fontSize, bgColor };
      publishAnnouncement(text, minutes, true, opts);
      document.getElementById("announceModal").style.display = "none";
    };
    document.getElementById("previewAnnounceBtn").onclick = function () {
      const text = document.getElementById("announceText").value;
      const fontSize = parseInt(document.getElementById('announceFontSize').value, 10) || 18;
      const bgColor = document.getElementById('announceBgColor').value || '';
      const opts = { fontSize, bgColor };
      // preview should not persist â€” 12 seconds
      publishAnnouncement(text, 0.2, false, opts); // short preview (~12s)
    };

    // Delete current announcement button handler (in modal)
    document.getElementById('deleteCurrentAnnounceBtn').onclick = function() {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØŸ')) return;
      db.ref('announcements/current').remove()
        .then(() => {
          alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ');
          document.getElementById('announceModal').style.display = 'none';
        })
        .catch((e) => {
          console.error(e);
          alert('âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');
        });
    };

      // ========== Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¨Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠØ© ==========
      // sidebarAdminBtn handler removed (duplicate) - handled earlier when sidebar is initialized
      // document.getElementById("sidebarAdminBtn").onclick = () => {
      //   document.getElementById("sidebarMenu").classList.remove("open");
      // removed: document.getElementById("toggleAdminBtn").click(); â€” use toggleAdminPanel() instead
      // };
      document.getElementById("sidebarEmpStatsBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        document.getElementById("toggleEmpStatsBtn").click();
      };
      document.getElementById("sidebarDeleteDataBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        document.getElementById("btnDeleteData").click();
      };
      document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
        document.getElementById("sidebarMenu").classList.remove("open");
        document.getElementById("btnFeaturesTab").click();
        document.getElementById("featuresTab").style.display = "flex";
        const featuresTabContent =
          document.getElementById("featuresTabContent");
        featuresTabContent.innerHTML = `
    <div class="feature-section">
      <h4>Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h4>
      <div id="activityLogBox">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    <div class="feature-section" style="display:flex;flex-direction:column;gap:8px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <h4 style="margin:0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
        <div id="featuresShowMorePlaceholder"></div>
      </div>
      <ul style="margin:0;padding:0 0 0 15px;">
        <li>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${employees.length}</b></li>
        <li>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${currentUser}</b></li>
        <li>Ø§Ù„Ø¯ÙˆØ±: <b>${currentUserRole}</b></li>
      </ul>
    </div>
  `;
        db.ref("activityLog")
          .limitToLast(30)
          .once("value")
          .then((snapshot) => {
            const log = snapshot.val() || {};
            // render via helper if available
            if (typeof renderActivityLog === 'function') {
              renderActivityLog(30, 'activityLogBox');
            } else {
              let html = `<table class="activity-log-table">
      <tr>
        <th>Ø§Ù„ÙˆÙ‚Øª</th>
        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
        <th>Ø§Ù„ÙˆØµÙ</th>
      </tr>`;
              Object.values(log)
                .reverse()
                .forEach((item) => {
                  html += `<tr>
        <td>${toEnglishNumbers(item.time || "")}</td>
        <td>${item.user || ""}</td>
        <td>${item.action || ""}</td>
        <td>${item.details || ""}</td>
      </tr>`;
                });
              html += `</table>`;
              document.getElementById("activityLogBox").innerHTML = html;
            }
            // ensure single button instance and attach handler
            ensureFeaturesShowMoreButton('activityLogBox');
          });
        // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø©
        const closeBtn = document.getElementById("closeFeaturesTab");
        if (closeBtn) {
          closeBtn.onclick = () => {
            document.getElementById("featuresTab").style.display = "none";
          };
        }
      };

      // Ù†Ø§ÙØ°Ø© ØªØ­ÙƒÙ… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
      document.getElementById("sidebarUserControlBtn").onclick = function () {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©
        let modal = document.getElementById("userLogControlModal");
        if (!modal) {
          modal = document.createElement("div");
          modal.id = "userLogControlModal";
          modal.style.position = "fixed";
          modal.style.top = "0";
          modal.style.left = "0";
          modal.style.width = "100vw";
          modal.style.height = "100vh";
          modal.style.background = "rgba(0,0,0,0.35)";
          modal.style.zIndex = "8000";
          modal.style.display = "flex";
          modal.style.alignItems = "center";
          modal.style.justifyContent = "center";
          modal.innerHTML = `
      <div style="background:#fff;max-width:420px;width:95vw;border-radius:14px;box-shadow:0 8px 32px #0002;padding:28px 20px 20px 20px;position:relative;">
        <button id="closeUserLogControlModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#009688;">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
        <div id="userLogControlContent" style="min-height:70px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    `;
          document.body.appendChild(modal);
          document.getElementById("closeUserLogControlModal").onclick =
            function () {
              modal.style.display = "none";
            };
        } else {
          modal.style.display = "flex";
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù…
        db.ref("users")
          .once("value")
          .then((snapshot) => {
            const users = snapshot.val() || {};
            let html = `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <th style="background:#f6f6f6;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th style="background:#f6f6f6;">Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</th>
        <th style="background:#f6f6f6;">Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
      </tr>`;
            Object.entries(users).forEach(([username, data]) => {
              if (username === "admin") return; // Ù„Ø§ ØªØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ± Ù†ÙØ³Ù‡
              html += `<tr>
        <td style="padding:7px 4px;">${username}</td>
        <td style="padding:7px 4px;">
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" ${
              data.canViewLog ? "checked" : ""
            } onchange="window.setUserLogAccess('${username}', this.checked)">
            <span style="font-size:13px;color:${
              data.canViewLog ? "#28a745" : "#dc3545"
            };">${data.canViewLog ? "Ù…ÙØ¹Ù„" : "Ù…Ø¹Ø·Ù„"}</span>
          </label>
        </td>
        <td style="padding:7px 4px;">
          <select onchange="window.setUserLogType('${username}', this.value)" style="font-size:13px;">
            <option value="all" ${
              !data.logViewType || data.logViewType === "all" ? "selected" : ""
            }>ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„</option>
            <option value="self" ${
              data.logViewType === "self" ? "selected" : ""
            }>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·</option>
          </select>
        </td>
      </tr>`;
            });
            html += `</table>
      <div style="margin-top:10px;font-size:13px;color:#555;">
        Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙŠØ¸Ù‡Ø± Ø²Ø± Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©.<br>
        Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:<br>
        <b>ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„:</b> ÙŠØ±Ù‰ ÙƒÙ„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.<br>
        <b>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·:</b> ÙŠØ±Ù‰ ÙÙ‚Ø· Ù†Ø´Ø§Ø·Ø§ØªÙ‡ Ù‡Ùˆ.<br>
        Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø·ÙŠÙ„ ÙŠØ®ØªÙÙŠ Ø§Ù„Ø²Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
      </div>`;
            document.getElementById("userLogControlContent").innerHTML = html;
            window.setUserLogAccess = function (username, enabled) {
              db.ref("users/" + username + "/canViewLog")
                .set(enabled)
                .then(() => {
                  logActivity(
                    "ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª",
                    `ØªÙ… ${
                      enabled ? "ØªÙØ¹ÙŠÙ„" : "ØªØ¹Ø·ÙŠÙ„"
                    } Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username}`
                  );
                  updateSidebarVisibility();
                });
            };
            window.setUserLogType = function (username, type) {
              db.ref("users/" + username + "/logViewType")
                .set(type)
                .then(() => {
                  logActivity(
                    "ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ ØµÙ„Ø§Ø­ÙŠØ© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª",
                    `ØªÙ… ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${username} Ø¥Ù„Ù‰: ${
                      type === "all" ? "ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„" : "Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·"
                    }`
                  );
                  updateSidebarVisibility();
                });
            };
          });
      };
    </script>
    <!-- Fixed top sticky header: clones #attendanceTable thead and fixes it to top with smooth animation -->
    <style>
      /* Match screenshot: compact pill-like blue header cells with clear separators */
      .sticky-clone-wrap{ position:fixed; top:6px; z-index:11000; transform:translateY(-120%); opacity:0; transition:transform 260ms cubic-bezier(.22,.9,.28,1), opacity 200ms; pointer-events:auto; left:0 }
      .sticky-clone-wrap.visible{ transform:translateY(0); opacity:1 }
      .sticky-clone-table{ border-collapse:collapse; background:transparent; width:100% }
      /* container is transparent â€” each cell is a small rounded pill */
      .sticky-clone-table-container{ border-radius:6px; overflow:visible; background:transparent; padding:0 6px }
      .sticky-clone-row{ position:relative; }
  .sticky-clone-cell{ position:absolute; top:0; box-sizing:border-box; display:flex; align-items:center; justify-content:center; text-align:center; white-space:normal; /* allow wrapping onto multiple lines */ word-break:break-word; padding:6px 10px; font-size:14px; color:#0d47a1; font-weight:700; background:linear-gradient(180deg,#eaf4ff,#e3f0ff); border:1px solid rgba(13,71,161,0.08); }
      /* vertical separator: slim gap between pills achieved with left border on subsequent cells */
      .sticky-clone-cell + .sticky-clone-cell{ border-left:1px solid rgba(13,71,161,0.06) }
      /* rounded corners for first and last visible pill */
      .sticky-clone-row .sticky-clone-cell:first-child{ border-top-right-radius:8px; border-bottom-right-radius:8px }
      .sticky-clone-row .sticky-clone-cell:last-child{ border-top-left-radius:8px; border-bottom-left-radius:8px }
      /* compact mode: reduce padding and font-size for minimal footprint */
      .sticky-clone-wrap.compact .sticky-clone-cell{ padding:4px 8px; font-size:13px }
      /* subtle hover highlight without shifting layout */
      .sticky-clone-cell:hover{ background:linear-gradient(180deg,#fff,#eef6ff); box-shadow:0 6px 12px rgba(13,71,161,0.06) }
      /* column highlight in main table when hovering header */
      #attendanceTable td.col-highlight, #attendanceTable th.col-highlight{ background: rgba(13,71,161,0.05) !important; transition: background 160ms }
      @media (max-width:600px){ .sticky-clone-cell{ font-size:12px; padding:5px 8px } }
    </style>

    <script>
      (function(){
        const table = document.getElementById('attendanceTable');
        if(!table) return;

        const thead = table.querySelector('thead');
        if(!thead) return;

        // Create wrapper and container
        let wrap = document.createElement('div');
        wrap.className = 'sticky-clone-wrap';
        let container = document.createElement('div');
        container.className = 'sticky-clone-table-container';
        let cloneTable = document.createElement('table');
        cloneTable.className = 'sticky-clone-table';
        container.appendChild(cloneTable);
        wrap.appendChild(container);
        document.body.appendChild(wrap);

        let isVisible = false;

        function buildClone(){
          // We'll build an absolutely-positioned header row that mirrors the visible header cells
          container.innerHTML = '';
          const row = document.createElement('div');
          row.className = 'sticky-clone-row';
          container.appendChild(row);
          // create placeholder cells; skip the date column (id='dateHeaderTh') so it won't appear in the fixed header
          const origAllThs = Array.from(thead.querySelectorAll('th'));
          const origThs = origAllThs.filter(th => th.id !== 'dateHeaderTh');
          origThs.forEach((th)=>{
            const cell = document.createElement('div');
            cell.className = 'sticky-clone-cell';
            // copy the inner HTML so any icons or multi-line content is preserved
            cell.innerHTML = th.innerHTML;
            // If header is plain text (no child elements), insert a line break after the first word
            // so names like "Ù…Ø­Ù…Ø¯ Ø¹Ù„Ø§Ø¡" render as two lines on small screens.
            try{
              if(th.children.length === 0){
                const txt = th.textContent.trim();
                if(txt.indexOf(' ') !== -1){
                  const parts = txt.split(/\s+/);
                  // keep first word on first line, the rest on second line
                  const first = parts.shift();
                  const rest = parts.join(' ');
                  cell.innerHTML = first + '<br>' + rest;
                }
              }
            }catch(e){ /* fail silently if any node is unexpected */ }
            if(th.getAttribute('dir')) cell.setAttribute('dir', th.getAttribute('dir'));
            row.appendChild(cell);
          });
          syncSizes();
        }

        function syncSizes(){
          const rect = table.getBoundingClientRect();
          // position wrap and set width to match table
          wrap.style.left = rect.left + 'px';
          wrap.style.width = rect.width + 'px';
          container.style.width = '100%';

          const row = container.querySelector('.sticky-clone-row');
          if(!row) return;
          // set row height same as original thead
          const theadRect = thead.getBoundingClientRect();
          row.style.height = theadRect.height + 'px';

          const origAllThs = Array.from(thead.querySelectorAll('th'));
          const origThs = origAllThs.filter(th => th.id !== 'dateHeaderTh');
          const cloneCells = row.querySelectorAll('.sticky-clone-cell');
          origThs.forEach((th, i) => {
            const thRect = th.getBoundingClientRect();
            const left = thRect.left - rect.left;
            const w = thRect.width;
            if(cloneCells[i]){
              const cs = cloneCells[i];
              cs.style.left = left + 'px';
              cs.style.width = w + 'px';
              // make header slightly smaller than original for compact look
              const isCompact = wrap.classList.contains('compact');
              const headerH = isCompact ? Math.max(30, theadRect.height - 12) : Math.max(36, theadRect.height - 6);
              cs.style.height = headerH + 'px';
              // copy computed styles for visual parity
              const s = window.getComputedStyle(th);
              cs.style.background = s.backgroundColor || th.style.background || '';
              cs.style.color = s.color || th.style.color || '';
              cs.style.fontWeight = s.fontWeight || th.style.fontWeight || '';
              cs.style.fontSize = s.fontSize || th.style.fontSize || '';
              cs.style.paddingLeft = s.paddingLeft;
              cs.style.paddingRight = s.paddingRight;
            }
          });
        }

        function updateVisibility(){
          const rect = table.getBoundingClientRect();
          const show = rect.top < 0 && rect.bottom > 40; // show when table scrolled past top
          if(show && !isVisible){ wrap.classList.add('visible'); isVisible = true; }
          else if(!show && isVisible){ wrap.classList.remove('visible'); wrap.classList.remove('compact'); isVisible = false; }
          // compact mode when scrolled further down for less visual footprint
          const compactThreshold = 260; // px scrolled past table top
          if(rect.top < -compactThreshold){ wrap.classList.add('compact'); } else { wrap.classList.remove('compact'); }
        }

        // Build initially in case header already present
        buildClone(); updateVisibility();

        // Observe changes to thead (employees list may be added dynamically)
        const mo = new MutationObserver(()=>{ buildClone(); updateVisibility(); });
        mo.observe(thead, { childList:true, subtree:true, characterData:true });

        // Keep in sync on resize / scroll / table changes
        let rt;
        window.addEventListener('resize', ()=>{ clearTimeout(rt); rt = setTimeout(()=>{ syncSizes(); updateVisibility(); }, 120); });
        window.addEventListener('scroll', ()=>{ syncSizes(); updateVisibility(); }, { passive:true });

        if(window.ResizeObserver){
          const ro = new ResizeObserver(()=>{ syncSizes(); updateVisibility(); });
          ro.observe(table);
        }

        // close on print
        if(window.matchMedia){
          try{ window.matchMedia('print').addListener(()=> wrap.classList.remove('visible')); }catch(e){}
        }

        // expose for debugging if needed
        window._stickyHeaderClone = { rebuild: buildClone, sync: syncSizes };
      })();
    </script>

    <!-- Ù…Ù† Ù†Ø­Ù† - ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ ÙˆÙ…ÙÙ…ÙŠØ² (Ù…ÙØ­Ø¯Ù‘ÙØ« Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù†) -->
    <style>
      /* About Us - richer color palette for better contrast and visual appeal */
      #aboutUs.pro{
        max-width:1100px;
        margin:36px auto 80px auto;
        background:linear-gradient(180deg,#052233 0%, #083a52 55%, #0b6b8f 100%);
        padding:28px;
        border-radius:14px;
        box-shadow:0 18px 60px rgba(4,30,55,0.45);
        color:#e9f7ff;
        direction:rtl;
        font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      }

      #aboutUs.pro .inner{ display:grid; grid-template-columns: 320px 1fr; gap:24px; align-items:start; }

      /* Founder card becomes a semi-transparent panel to stand out on the darker background */
      #aboutUs.pro .founder-card{
        background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
        border-radius:12px;
        padding:18px;
        box-shadow:0 10px 30px rgba(3,34,63,0.12);
        text-align:right;
        border:1px solid rgba(255,255,255,0.04);
        color: #e6f7ff;
      }

      /* Vibrant avatar for a stronger brand mark.
         Size controlled via CSS variable --founder-avatar-size (px). */
      #aboutUs.pro { --founder-avatar-size:88px; }
      #aboutUs.pro .avatar{
        width:var(--founder-avatar-size); height:var(--founder-avatar-size); border-radius:50%;
        background:linear-gradient(135deg,#ff7a59 0%, #ffca58 100%);
        color:#082233; display:inline-flex; align-items:center; justify-content:center;
        font-weight:800; font-size: calc(var(--founder-avatar-size) / 3.2); margin-left:12px;
        box-shadow:0 10px 30px rgba(255,122,89,0.12) inset, 0 8px 20px rgba(11,102,195,0.08);
      }

      #aboutUs.pro .founder-meta{ display:flex; align-items:center; justify-content:flex-end; gap:12px }

      #aboutUs.pro h3{ margin:0 0 6px 0; color:#ffdede; font-size:20px }
      #aboutUs.pro p.lead{ margin:0 0 12px 0; color:#e6f7ff; line-height:1.7; font-size:15px }

      /* Feature chips get subtle translucent backgrounds that pop on the dark panel */
      #aboutUs.pro .features{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
      #aboutUs.pro .feature{ background:rgba(255,255,255,0.04); padding:8px 12px; border-radius:8px; color:#bfeeff; font-weight:700; font-size:13px }

      #aboutUs.pro .meta{ margin-top:12px; color:#cfeeff; font-size:14px }

      #aboutUs.pro .contact { margin-top:14px; display:flex; gap:10px; align-items:center; justify-content:flex-end }

      /* Instagram CTA: keep brand gradient but slightly larger and with shadow */
      #aboutUs.pro .ig-btn{ display:inline-flex; gap:8px; align-items:center; padding:12px 16px; background:linear-gradient(90deg,#e1306c,#c72d7b); color:#fff; border-radius:12px; text-decoration:none; font-weight:800; box-shadow:0 8px 30px rgba(199,45,123,0.18); }

      /* Social icons container on dark background */
      #aboutUs.pro .socials{ display:flex; gap:8px; margin-top:12px; justify-content:flex-end }
      #aboutUs.pro .socials a{ width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; background:rgba(255,255,255,0.03); color:#ffdede; text-decoration:none }

      #aboutUs.pro .right-col{ padding-left:8px }
      /* Make version more prominent: badge-style for quick attention */
  #aboutUs.pro .version{ margin-top:18px; color:#bfeeff; font-size:14px; display:flex; gap:12px; align-items:center; }
  #aboutUs.pro .version .ver-label{ color:#e9fbff; font-weight:700; font-size:14px }
  /* larger, more prominent version badge */
  /* Softer version badge: smaller, subtler shadow and gentler animation */
  #footerVersion{
    display:inline-block;
    background:linear-gradient(90deg,#ffd54a,#ffb74d); /* softer orange */
    color:#082233; font-weight:800; padding:6px 12px; border-radius:999px;
    box-shadow:0 6px 18px rgba(255,167,79,0.08); font-size:14px; letter-spacing:0.4px;
  }
  #footerUpdated{ color:rgba(255,255,255,0.85); font-size:13px }
  /* subtle attention animation (stop on reduced-motion) */
  @media (prefers-reduced-motion: no-preference){
    @keyframes pulseBadge{ 0%{ transform:translateY(0) scale(1); }50%{ transform:translateY(-0.5px) scale(1.01); }100%{ transform:translateY(0) scale(1); } }
    #footerVersion{ animation: pulseBadge 4.2s ease-in-out infinite; }
  }

      /* Responsive adjustments */
      @media (max-width:880px){
        /* Stack content but show right-col (Ù…Ù† Ù†Ø­Ù†) first on small screens */
        #aboutUs.pro .inner{ grid-template-columns:1fr; display:flex; flex-direction:column-reverse; gap:14px }
        /* Stack founder card vertically and center on small screens */
        #aboutUs.pro .founder-card{ display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; gap:10px }
        /* Make founder meta stack avatar above name for clearer layout */
        #aboutUs.pro .founder-meta{ flex-direction:column-reverse; align-items:center; justify-content:center }
        #aboutUs.pro .avatar{ margin-left:0; margin-bottom:6px }
        /* Full-width CTA on mobile for easier tapping */
        #aboutUs.pro .contact .ig-btn{ width:100%; justify-content:center }
        /* Hide secondary social icons to reduce clutter */
        #aboutUs.pro .socials{ display:none }
        /* Center the right column content */
        #aboutUs.pro .right-col{ padding-left:0; text-align:center }
        #aboutUs.pro .features{ justify-content:center }
        #aboutUs.pro .version{ text-align:center }
        /* Slightly reduce padding on small screens */
        #aboutUs.pro { padding:16px }
        /* Make small footer meta readable */
        #aboutUs.pro small, #aboutUs.pro > div[style] { color: rgba(223,239,251,0.75) }
        /* Adjust font sizes for tight screens */
        #aboutUs.pro .avatar{ width:72px; height:72px; font-size:24px }
        #aboutUs.pro .feature{ font-size:12px; padding:7px 10px }
      }
    </style>

  <footer id="aboutUs" class="pro" aria-labelledby="aboutTitle" style="display:none;">
      <div class="inner">
        <div class="founder-card" role="region" aria-label="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³">
          <div class="founder-meta">
            <div style="text-align:right;">
              <div style="font-weight:800;font-size:16px;color:#ffdede;" id="founderName">Ø³Ø¬Ø§Ø¯ Ø±Ø´ÙŠØ¯</div>
              <div style="font-size:13px;color:#dfeffb;">Ù…Ø¤Ø³Ø³ ÙˆÙ…Ø·ÙˆØ± Ø§Ù„Ù†Ø¸Ø§Ù…</div>
            </div>
            <div class="avatar" id="founderAvatar">Ø³Ø¬</div>
          </div>
          <div class="meta" id="founderBio">Ù…Ø·ÙˆØ± ÙˆÙ…ØµÙ…Ù… Ù†Ø¸Ù… Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶ÙˆØ±ØŒ ÙŠØ±ÙƒØ² Ø¹Ù„Ù‰ Ø­Ù„ÙˆÙ„ Ø®ÙÙŠÙØ© ÙˆØ³Ù‡Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ÙˆØ§Ù„Ù…ØªÙˆØ³Ø·Ø©.</div>
          <div class="contact" aria-label="ÙˆØ³Ø§Ø¦Ù„ ØªÙˆØ§ØµÙ„">
            <!-- Instagram only per request -->
            <a class="ig-btn" id="founderInstagram" href="https://instagram.com/example" target="_blank" rel="noopener noreferrer">ğŸ“¸ ØªØ§Ø¨Ø¹ Ø¹Ù„Ù‰ Ø¥Ù†Ø³ØªØºØ±Ø§Ù…</a>
          </div>
          <div class="socials" aria-hidden="false">
          </div>
        </div>

        <div class="right-col">
          <h3 id="aboutTitle">Ù…Ù† Ù†Ø­Ù†</h3>
          <p class="lead">Ù†Ù‚Ø¯Ù… Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø®ÙÙŠÙ ÙˆØ³Ø±ÙŠØ¹ Ø§Ù„Ù†Ø´Ø± Ù„Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ÙˆØ§Ù„Ù…ØªÙˆØ³Ø·Ø©. ÙŠÙˆÙÙ‘Ø± ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ù…Ù„Ø©ØŒ Ø¥Ù…ÙƒØ§Ù†ÙŠØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±ØŒ  .</p>
          <div class="features" aria-hidden="false">
            <div class="feature">ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ù…Ù„Ø©</div>
            <div class="feature">Ø£Ø¯Ø§Ø¡ Ø³Ø±ÙŠØ¹ ÙˆØ®ÙÙŠÙ</div>
            <div class="feature">ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</div>
            <div class="feature">ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
            <div class="feature">ØªÙ‚Ø§Ø±ÙŠØ± Ø­Ø¶ÙˆØ± Ù…ÙØµÙ‘Ù„Ø©</div>
            <div class="feature">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¢Ù…Ù†Ø©</div>
            <div class="feature">ØªØ®ØµÙŠØµ Ø³Ø±ÙŠØ¹ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø§Øª</div>
          </div>

          <div class="version" aria-live="polite"><span class="ver-label">Ø§Ù„Ø¥ØµØ¯Ø§Ø±</span>: <span id="footerVersion">v?</span> <span style="opacity:0.9;margin-left:8px;color:#dff8ff;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span> <span id="footerUpdated">â€”</span></div>
          <div style="margin-top:12px;color:#dfeffb;font-size:13px;">Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ø³ØªØ®Ø¯Ù… ØµÙØ­Ø© Ø§Ù„Ø¥Ù†Ø³ØªØºØ±Ø§Ù… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¤Ø³Ø³.</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px;gap:12px;flex-wrap:wrap;">
        <small style="color:rgba(223,239,251,0.7);">Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</small>
        <div id="footerCredit" style="color:rgba(223,239,251,0.7);font-size:13px;">ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ±: Ø³Ø¬Ø§Ø¯ Ø±Ø´ÙŠØ¯</div>
      </div>

      <script>
        // Fill footer version info from global APP_VERSION and wire Instagram handle
        try{
          const app = (window.getAppVersion && window.getAppVersion()) || window.APP_VERSION || {};
          const v = app.version || 'â€”';
          const u = app.updated || 'â€”';
          const fv = document.getElementById('footerVersion'); if(fv) fv.textContent = v;
          const fu = document.getElementById('footerUpdated'); if(fu) fu.textContent = u;
          // set avatar initials from founder name
          const fnEl = document.getElementById('founderName');
          const fn = fnEl ? fnEl.textContent.trim() : 'Ø³Ø¬Ø§Ø¯ Ø±Ø´ÙŠØ¯';
          const initials = fn.split(/\s+/).map(s=>s[0]||'').slice(0,2).join('');
          const avatar = document.getElementById('founderAvatar'); if(avatar) avatar.textContent = initials;
          // Instagram: read handle from a data attribute if present, fallback to example
          const igBtn = document.getElementById('founderInstagram');
          const igHandle = (document.getElementById('founderContact') && document.getElementById('founderContact').textContent.trim()) || 'e._mg';
          if(igBtn){
            igBtn.href = 'https://instagram.com/' + igHandle.replace(/^@/, '');
            igBtn.setAttribute('aria-label', 'ØªØ§Ø¨Ø¹ ' + fn + ' Ø¹Ù„Ù‰ Ø¥Ù†Ø³ØªØºØ±Ø§Ù…');
          }
        }catch(e){ console && console.warn && console.warn('footer init error', e); }

        // Load persisted founder/app/footer info from DB or localStorage so edits survive page reload
        try{
          const applyFounder = (v) => {
            try{
              const fnEl = document.getElementById('founderName'); if(fnEl && v.name) fnEl.textContent = v.name;
              const bioEl = document.getElementById('founderBio'); if(bioEl && v.bio) bioEl.textContent = v.bio;
              let contactEl = document.getElementById('founderContact');
              if(!contactEl){ contactEl = document.createElement('div'); contactEl.id = 'founderContact'; contactEl.style.display='none'; document.body.appendChild(contactEl); }
              contactEl.textContent = v.instagram || '';
              const igBtn = document.getElementById('founderInstagram'); if(igBtn && v.instagram) igBtn.href = 'https://instagram.com/' + (v.instagram||'').replace(/^@/,'');
              const avatarEl = document.getElementById('founderAvatar');
              if(avatarEl){
                // prefer storing avatar as background so we can control positioning
                if(v.avatar){
                  avatarEl.innerHTML = '';
                  avatarEl.style.backgroundImage = 'url("' + v.avatar + '")';
                  avatarEl.style.backgroundSize = 'cover';
                  const ox = v.avatarOffset && typeof v.avatarOffset.x !== 'undefined' ? v.avatarOffset.x : 50;
                  const oy = v.avatarOffset && typeof v.avatarOffset.y !== 'undefined' ? v.avatarOffset.y : 50;
                  avatarEl.style.backgroundPosition = ox + '% ' + oy + '%';
                } else if(v.name){
                  avatarEl.style.backgroundImage = '';
                  avatarEl.textContent = v.name.split(/\s+/).map(s=>s[0]||'').slice(0,2).join('');
                }
              }
            }catch(e){}
          };

          const applyApp = (a) => {
            try{
              const fv = document.getElementById('footerVersion');
              const fu = document.getElementById('footerUpdated');
              // if a provides values, apply them; otherwise set sensible defaults (requested)
              if(fv){
                if(a && a.version) fv.textContent = ('v' + String(a.version).replace(/^v/i, ''));
                else if(!fv.textContent || fv.textContent === 'v?') fv.textContent = 'v2.8';
              }
              if(fu){
                if(a && a.updated) fu.textContent = a.updated;
                else if(!fu.textContent || fu.textContent === 'â€”') fu.textContent = '2025-10-31';
              }
              // apply avatar size if provided
              try{
                if(a && a.avatarSize){
                  const aboutEl = document.querySelector('#aboutUs.pro');
                  if(aboutEl && aboutEl.style) aboutEl.style.setProperty('--founder-avatar-size', String(a.avatarSize) + 'px');
                  const av = document.getElementById('founderAvatar');
                  if(av){ av.style.width = String(a.avatarSize) + 'px'; av.style.height = String(a.avatarSize) + 'px'; av.style.fontSize = (a.avatarSize/3.2) + 'px'; }
                }
              }catch(e){}
              // render features if provided
              if(a && Array.isArray(a.features)){
                const featuresContainer = document.querySelector('#aboutUs .features');
                if(featuresContainer){
                  featuresContainer.innerHTML = '';
                  a.features.forEach(f => { const d = document.createElement('div'); d.className = 'feature'; d.textContent = f; featuresContainer.appendChild(d); });
                }
              }
            }catch(e){}
          };

          const applyFooter = (f) => { try{ const fc = document.getElementById('footerCredit'); if(fc && f.credit) fc.textContent = f.credit; }catch(e){} };

          if(typeof db !== 'undefined' && db && typeof db.ref === 'function'){
            db.ref('settings/founder').once('value').then(snap=>{ const v = snap.val(); if(v) applyFounder(v); }).catch(()=>{});
            db.ref('settings/app').once('value').then(snap=>{ const a = snap.val(); if(a) applyApp(a); }).catch(()=>{});
            db.ref('settings/footer').once('value').then(snap=>{ const f = snap.val(); if(f) applyFooter(f); }).catch(()=>{});
          }

          // fallback to localStorage if present
          try{
            const lf = localStorage.getItem('settings_founder'); if(lf){ const v = JSON.parse(lf); applyFounder(v); }
            const la = localStorage.getItem('settings_app'); if(la){ const a = JSON.parse(la); applyApp(a); }
            const lfc = localStorage.getItem('settings_footer'); if(lfc){ const f = JSON.parse(lfc); applyFooter(f); }
          }catch(e){}
        }catch(e){}
      </script>
    </footer>

    <!-- Modal: ØªØ­Ø±ÙŠØ± Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ù†Ø­Ù† (Ù…Ø³ØªØ¯Ø¹Ù‰ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…) -->
    <style>
      /* Responsive tweaks for About edit modal to keep layout tidy */
      .about-edit-inner { display:grid; grid-template-columns:1fr 260px; gap:12px; align-items:start; }
      .about-edit-inner .avatar-column{ text-align:center; }
      .about-edit-inner .left-column{ min-width:0; }
      #aboutPanelEditModal .modal-box{ background:#fff; max-width:760px; width:96vw; border-radius:12px; padding:18px; box-shadow:0 14px 40px rgba(0,0,0,0.25); max-height:calc(100vh - 80px); overflow:auto; }
      @media (max-width:720px){
        .about-edit-inner{ grid-template-columns:1fr; display:flex; flex-direction:column-reverse; gap:12px; }
        .about-edit-inner .avatar-column{ order:0; }
        .about-edit-inner .left-column{ order:1; }
        #aboutPanelEditModal .modal-box{ padding:14px; }
        #aboutPanelEditModal .modal-box input[type=text], #aboutPanelEditModal .modal-box textarea{ font-size:14px; }
      }
    </style>
  <div id="aboutPanelEditModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:15000;align-items:center;justify-content:center;">
      <div class="modal-box">
        <h3 style="margin:0 0 8px 0;">ØªØ¹Ø¯ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ "Ù…Ù† Ù†Ø­Ù†"</h3>
        <div class="about-edit-inner">
          <div class="left-column">
            <label style="display:block;font-size:13px;margin-top:8px;">Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³</label>
            <input id="aboutEditName" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;" />
            <label style="display:block;font-size:13px;margin-top:8px;">Ø§Ù„ÙˆØµÙ / Ø§Ù„Ø³ÙŠØ±Ø©</label>
            <textarea id="aboutEditBio" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;min-height:90px;"></textarea>
            <label style="display:block;font-size:13px;margin-top:8px;">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù†Ø³ØªØºØ±Ø§Ù… (Ù…Ø¹ Ø£Ùˆ Ø¨Ø¯ÙˆÙ† @)</label>
            <input id="aboutEditIg" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;" />

            <div style="display:flex;gap:8px;margin-top:12px;align-items:center;">
              <label style="font-size:13px;">Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label>
              <!-- make version input larger for more typing room -->
              <input id="aboutEditVersion" type="text" placeholder="Ù…Ø«Ø§Ù„: 2.8" style="width:180px;padding:8px;border-radius:8px;border:1px solid #ddd;font-weight:800;font-size:15px;" />
              <label style="font-size:13px;margin-left:8px;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</label>
              <input id="aboutEditUpdated" type="date" style="padding:6px;border-radius:6px;border:1px solid #ddd;" />
            </div>

            <label style="display:block;font-size:13px;margin-top:8px;">Ù†Øµ Ø§Ù„ØªØ°ÙŠÙŠÙ„ (ÙŠÙ…ÙŠÙ†)</label>
            <input id="aboutEditFooterCredit" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;" />

            <label style="display:block;font-size:13px;margin-top:10px;">Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ù…ÙŠØ²Ø§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ù…ÙŠØ²Ø©)</label>
            <textarea id="aboutEditFeatures" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„ Ù…ÙŠØ²Ø© ÙÙŠ Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ØŒ Ù…Ø«Ø§Ù„:\nÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ù…Ù„Ø©\nØ£Ø¯Ø§Ø¡ Ø³Ø±ÙŠØ¹ ÙˆØ®ÙÙŠÙ" style="width:100%;min-height:90px;padding:8px;border-radius:8px;border:1px solid #ddd;font-size:13px;"></textarea>
          </div>

          <div class="avatar-column" style="text-align:center;">
            <div style="font-size:13px;margin-bottom:6px;color:#333;font-weight:700;">ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¤Ø³Ø³</div>
              <div id="avatarPreview" style="width:120px;height:120px;border-radius:50%;background:#f0f0f0;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:8px;border:1px solid #ddd;">
              <!-- will be filled with <img> or initials -->
            </div>
            <input id="aboutEditAvatarFile" type="file" accept="image/*" style="display:block;margin:6px auto 8px auto;" />
            <input id="aboutEditAvatarUrl" type="text" placeholder="Ø£Ùˆ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" style="width:100%;padding:6px;border-radius:6px;border:1px solid #ddd;" />
            <div style="font-size:12px;color:#666;margin-top:8px;">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±. ØªØ­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ÙƒÙ€ data URL Ø¥Ø°Ø§ Ù„Ù… ØªØªÙˆÙØ± Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª.</div>

            <!-- Avatar size control -->
            <label style="display:block;font-size:13px;margin-top:10px;text-align:center;">Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©: <span id="aboutEditAvatarSizeVal" style="font-weight:800;margin-left:8px;">88px</span></label>
            <div style="display:flex;align-items:center;gap:10px;justify-content:center;margin-top:6px;">
              <input id="aboutEditAvatarSize" type="range" min="60" max="160" value="88" style="width:160px;" />
            </div>
          </div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
          <button id="aboutEditCancel" style="background:#ff0000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="aboutEditSave" style="background:#1976d2;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
      </div>
    </div>

    <script>
      // Wire the admin-panel About Us editor
      (function(){
        const panelBtn = document.getElementById('aboutPanelEditBtn');
        const modal = document.getElementById('aboutPanelEditModal');
        const nameIn = document.getElementById('aboutEditName');
        const bioIn = document.getElementById('aboutEditBio');
        const igIn = document.getElementById('aboutEditIg');
  const saveBtn = document.getElementById('aboutEditSave');
  const cancelBtn = document.getElementById('aboutEditCancel');
  const versionIn = document.getElementById('aboutEditVersion');
  const updatedIn = document.getElementById('aboutEditUpdated');
  const footerCreditIn = document.getElementById('aboutEditFooterCredit');
  const avatarUrlIn = document.getElementById('aboutEditAvatarUrl');
  const avatarFileIn = document.getElementById('aboutEditAvatarFile');
  const avatarPreview = document.getElementById('avatarPreview');
  const avatarSizeIn = document.getElementById('aboutEditAvatarSize');
  const avatarSizeVal = document.getElementById('aboutEditAvatarSizeVal');
  // hold a selected avatar dataURL (from file) so saveChanges can persist it
  let _avatarDataURL = null;
  // avatar offset in percent (0..100) for background-position
  let _avatarOffset = { x: 50, y: 50 };

        function openEditor(){
          // populate from current DOM
          const fn = document.getElementById('founderName');
          const fb = document.getElementById('founderBio');
          const igBtn = document.getElementById('founderInstagram');
          nameIn.value = fn ? fn.textContent.trim() : '';
          bioIn.value = fb ? fb.textContent.trim() : '';
          let handle = '';
          const contactEl = document.getElementById('founderContact');
          if(contactEl) handle = contactEl.textContent.trim();
          else if(igBtn && igBtn.href) try{ handle = igBtn.href.split('instagram.com/')[1].replace(/\/+$/,'') }catch(e){}
          igIn.value = handle || '';
          // app version / updated
          try{
            const fv = document.getElementById('footerVersion');
            const fu = document.getElementById('footerUpdated');
            versionIn.value = (fv && fv.textContent && fv.textContent !== 'v?') ? fv.textContent.replace(/^v/i,'') : ((window.APP_VERSION && window.APP_VERSION.version) || '');
            // try to interpret footerUpdated if present
            if(fu && fu.textContent && fu.textContent !== 'â€”'){
              // if it's in YYYY-MM-DD (from input) keep it; otherwise leave blank
              const d = fu.textContent.trim();
              // naive check for ISO-like
              if(/\d{4}-\d{2}-\d{2}/.test(d)) updatedIn.value = d;
              else updatedIn.value = '';
            } else {
              updatedIn.value = (window.APP_VERSION && window.APP_VERSION.updated) ? window.APP_VERSION.updated.split('T')[0] : '';
            }
          }catch(e){}
          // footer credit
          try{ const fc = document.getElementById('footerCredit'); footerCreditIn.value = fc ? fc.textContent.trim() : ''; }catch(e){}
          // avatar: show existing image if any
          try{
            _avatarDataURL = null;
            const avatarEl = document.getElementById('founderAvatar');
            // if avatar contains an <img>, use its src
            const img = avatarEl && avatarEl.querySelector && avatarEl.querySelector('img');
            if(img && img.src){ renderAvatarPreview(img.src); }
            else {
              // else show initials
              const initials = avatarEl ? avatarEl.textContent.trim() : '';
              renderAvatarPreview(null, initials);
            }
            avatarUrlIn.value = '';
            avatarFileIn.value = null;
            // populate avatar size input and preview
            try{
              let size = 88;
              if(window.APP_VERSION && window.APP_VERSION.avatarSize) size = parseInt(window.APP_VERSION.avatarSize,10) || size;
              // fallback to existing avatar element size
              const avEl = document.getElementById('founderAvatar');
              if(avEl && avEl.getBoundingClientRect){ size = Math.round(avEl.getBoundingClientRect().width) || size; }
              if(avatarSizeIn) avatarSizeIn.value = size;
              if(avatarSizeVal) avatarSizeVal.textContent = size + 'px';
              if(avatarPreview){ avatarPreview.style.width = size + 'px'; avatarPreview.style.height = size + 'px'; }
            }catch(e){}
            // populate features textarea from existing chips
            try{
              const featuresContainer = document.querySelector('#aboutUs .features');
              const featTa = document.getElementById('aboutEditFeatures');
              if(featuresContainer && featTa){
                const items = Array.from(featuresContainer.querySelectorAll('.feature')).map(el=>el.textContent.trim()).filter(Boolean);
                featTa.value = items.join('\n');
              }
            }catch(e){}
          }catch(e){}
          modal.style.display = 'flex';
        }

        function _applyBackgroundToElement(el, src, offset){
          if(!el) return;
          if(src){
            el.innerHTML = '';
            el.style.backgroundImage = 'url("' + src + '")';
            el.style.backgroundSize = 'cover';
            const ox = offset && typeof offset.x !== 'undefined' ? offset.x : 50;
            const oy = offset && typeof offset.y !== 'undefined' ? offset.y : 50;
            el.style.backgroundPosition = ox + '% ' + oy + '%';
          } else {
            // remove background and show initials
            el.style.backgroundImage = '';
            el.innerHTML = '';
          }
        }

        function renderAvatarPreview(src, initials){
          // Render using background-image so we can control background-position (drag)
          if(src){
            _applyBackgroundToElement(avatarPreview, src, _avatarOffset);
            avatarPreview.style.cursor = 'grab';
          } else {
            avatarPreview.style.backgroundImage = '';
            avatarPreview.innerHTML = '';
            const span = document.createElement('div');
            span.style.fontWeight = '800';
            // make initials font-size proportional to avatar size if available
            try{
              const sz = (avatarSizeIn && avatarSizeIn.value) ? parseInt(avatarSizeIn.value,10) : 88;
              span.style.fontSize = (sz/3.2) + 'px';
            }catch(e){ span.style.fontSize = '28px'; }
            span.style.color = '#082233';
            span.textContent = initials || '';
            avatarPreview.appendChild(span);
            avatarPreview.style.cursor = 'default';
          }
          // Also update the real footer avatar preview if present
          try{ const fv = document.getElementById('founderAvatar'); if(fv){ if(src) _applyBackgroundToElement(fv, src, _avatarOffset); else fv.textContent = initials || ''; } }catch(e){}
        }

        // file input preview handling
        if(avatarFileIn){
          avatarFileIn.addEventListener('change', function(){
            const f = this.files && this.files[0];
            if(!f) return;
            const fr = new FileReader();
            fr.onload = function(ev){ _avatarDataURL = ev.target.result; renderAvatarPreview(_avatarDataURL); };
            fr.readAsDataURL(f);
          });
        }
        // allow pasting a URL and preview
        if(avatarUrlIn){
          avatarUrlIn.addEventListener('change', function(){ _avatarDataURL = null; renderAvatarPreview(this.value || null); });
        }

        // avatar size slider handling
        if(avatarSizeIn){
          avatarSizeIn.addEventListener('input', function(){
            const v = parseInt(this.value,10) || 88;
            if(avatarSizeVal) avatarSizeVal.textContent = v + 'px';
            if(avatarPreview){ avatarPreview.style.width = v + 'px'; avatarPreview.style.height = v + 'px'; }
            const av = document.getElementById('founderAvatar'); if(av){ av.style.width = v + 'px'; av.style.height = v + 'px'; av.style.fontSize = (v/3.2) + 'px'; }
          });
        }

        // Drag-to-position for avatarPreview (mouse + touch)
        (function(){
          let dragging = false, startX=0, startY=0, startOffset = {x:50,y:50};
          function toPercentDelta(dx, dy, el){
            const w = el.clientWidth || 1; const h = el.clientHeight || 1;
            return { dx: (dx / w) * 100, dy: (dy / h) * 100 };
          }
          function clamp(v){ return Math.max(0, Math.min(100, v)); }

          avatarPreview.addEventListener('mousedown', function(e){
            if(!avatarPreview.style.backgroundImage) return;
            dragging = true; avatarPreview.style.cursor='grabbing';
            startX = e.clientX; startY = e.clientY; startOffset = { x: _avatarOffset.x, y: _avatarOffset.y };
            e.preventDefault();
          });
          document.addEventListener('mousemove', function(e){
            if(!dragging) return;
            const delta = toPercentDelta(e.clientX - startX, e.clientY - startY, avatarPreview);
            _avatarOffset.x = clamp(startOffset.x + delta.dx);
            _avatarOffset.y = clamp(startOffset.y + delta.dy);
            // apply to preview and footer
            try{ _applyBackgroundToElement(avatarPreview, (_avatarDataURL || (avatarUrlIn && avatarUrlIn.value)) || (document.getElementById('founderAvatar') && (document.getElementById('founderAvatar').style.backgroundImage ? document.getElementById('founderAvatar').style.backgroundImage.replace(/^url\(["']?|["']?\)$/g,'') : null)), _avatarOffset); }catch(e){}
            try{ const fv = document.getElementById('founderAvatar'); if(fv) fv.style.backgroundPosition = _avatarOffset.x + '% ' + _avatarOffset.y + '%'; }catch(e){}
          });
          document.addEventListener('mouseup', function(){ if(dragging){ dragging=false; avatarPreview.style.cursor='grab'; } });

          // touch support
          avatarPreview.addEventListener('touchstart', function(e){
            const t = e.touches && e.touches[0]; if(!t) return;
            if(!avatarPreview.style.backgroundImage) return;
            dragging = true; startX = t.clientX; startY = t.clientY; startOffset = { x: _avatarOffset.x, y: _avatarOffset.y };
          });
          avatarPreview.addEventListener('touchmove', function(e){ if(!dragging) return; const t = e.touches && e.touches[0]; if(!t) return; const delta = toPercentDelta(t.clientX - startX, t.clientY - startY, avatarPreview); _avatarOffset.x = clamp(startOffset.x + delta.dx); _avatarOffset.y = clamp(startOffset.y + delta.dy); try{ _applyBackgroundToElement(avatarPreview, (_avatarDataURL || (avatarUrlIn && avatarUrlIn.value)) || (document.getElementById('founderAvatar') && (document.getElementById('founderAvatar').style.backgroundImage ? document.getElementById('founderAvatar').style.backgroundImage.replace(/^url\(["']?|["']?\)$/g,'') : null)), _avatarOffset); }catch(e){}; try{ const fv = document.getElementById('founderAvatar'); if(fv) fv.style.backgroundPosition = _avatarOffset.x + '% ' + _avatarOffset.y + '%'; }catch(e){}; e.preventDefault(); });
          avatarPreview.addEventListener('touchend', function(){ dragging=false; });
        })();

        function closeEditor(){ modal.style.display = 'none'; }

        async function saveChanges(){
          const newName = nameIn.value.trim();
          const newBio = bioIn.value.trim();
          const newIg = igIn.value.trim().replace(/^@/,'');
          let _featuresLines = [];
          if(!newName){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³'); return; }
          // update DOM
          const fnEl = document.getElementById('founderName'); if(fnEl) fnEl.textContent = newName;
          const bioEl = document.getElementById('founderBio'); if(bioEl) bioEl.textContent = newBio;
          // avatar: prefer avatarDataURL, else provided URL, else initials
          const avatarEl = document.getElementById('founderAvatar');
          const useUrl = avatarUrlIn && avatarUrlIn.value && avatarUrlIn.value.trim();
          const avatarToUse = _avatarDataURL || (useUrl ? avatarUrlIn.value.trim() : null);
          if(avatarEl){
            avatarEl.innerHTML = '';
            if(avatarToUse){
              const img = document.createElement('img'); img.src = avatarToUse; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; avatarEl.appendChild(img);
            } else {
              const initials = newName.split(/\s+/).map(s=>s[0]||'').slice(0,2).join(''); avatarEl.textContent = initials;
            }
          }
          // ensure hidden contact element exists
          let contactEl = document.getElementById('founderContact');
          if(!contactEl){ contactEl = document.createElement('div'); contactEl.id = 'founderContact'; contactEl.style.display='none'; document.body.appendChild(contactEl); }
          contactEl.textContent = newIg || '';
          const igBtn = document.getElementById('founderInstagram'); if(igBtn) igBtn.href = 'https://instagram.com/' + (newIg||'').replace(/^@/, '');

          // version / updated / footer credit updates
          try{
            // normalize version (strip leading v) and update display with a single 'v' prefix
            const rawVer = (versionIn && versionIn.value) ? versionIn.value.trim() : '';
            const newVer = rawVer.replace(/^v/i,'');
            const newUpd = (updatedIn && updatedIn.value) ? updatedIn.value : '';
            const fv = document.getElementById('footerVersion'); if(fv) fv.textContent = newVer ? ('v' + newVer) : 'â€”';
            const fu = document.getElementById('footerUpdated'); if(fu) fu.textContent = newUpd || 'â€”';
            const fcEl = document.getElementById('footerCredit'); if(fcEl && footerCreditIn) fcEl.textContent = footerCreditIn.value || fcEl.textContent;
            // ensure avatar element uses chosen size
            try{
              const avSize = (avatarSizeIn && avatarSizeIn.value) ? parseInt(avatarSizeIn.value,10) : null;
              const avEl = document.getElementById('founderAvatar');
              if(avEl && avSize){ avEl.style.width = avSize + 'px'; avEl.style.height = avSize + 'px'; avEl.style.fontSize = (avSize/3.2) + 'px'; }
            }catch(e){}
          }catch(e){}

          // features: read textarea lines and update chips (store into _featuresLines to persist later)
          try{
            const featEl = document.getElementById('aboutEditFeatures');
            if(featEl){
              _featuresLines = featEl.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
              const featuresContainer = document.querySelector('#aboutUs .features');
              if(featuresContainer){
                featuresContainer.innerHTML = '';
                _featuresLines.forEach(f => { const d = document.createElement('div'); d.className = 'feature'; d.textContent = f; featuresContainer.appendChild(d); });
              }
            }
          }catch(e){}

          // persist if db available, otherwise fallback to localStorage
          try{
            const founderPayload = { name:newName, bio:newBio, instagram:newIg };
            // determine avatar to persist: prefer newly uploaded dataURL, else provided URL,
            // else preserve existing background-image src if any
            let finalAvatarSrc = null;
            if(_avatarDataURL) finalAvatarSrc = _avatarDataURL;
            else if(avatarUrlIn && avatarUrlIn.value) finalAvatarSrc = avatarUrlIn.value.trim();
            else {
              // try to read existing founderAvatar background-image or img src
              try{
                const avEl = document.getElementById('founderAvatar');
                if(avEl){
                  const bg = avEl.style && avEl.style.backgroundImage;
                  if(bg && bg.indexOf('url(') >= 0){ finalAvatarSrc = bg.replace(/^url\(["']?|["']?\)$/g,'').replace(/^url\(|\)$/g,'').replace(/^["']|["']$/g,''); }
                  else {
                    const im = avEl.querySelector && avEl.querySelector('img');
                    if(im && im.src) finalAvatarSrc = im.src;
                  }
                }
              }catch(e){}
            }
            if(finalAvatarSrc) founderPayload.avatar = finalAvatarSrc;
            // persist avatar offset as percent if available
            try{ if(_avatarOffset && typeof _avatarOffset.x !== 'undefined') founderPayload.avatarOffset = { x: Math.round(_avatarOffset.x), y: Math.round(_avatarOffset.y) }; }catch(e){}
            // store normalized version (without 'v') and avatar size
            const appPayload = { version: (versionIn && versionIn.value) ? versionIn.value.trim().replace(/^v/i,'') : '', updated: (updatedIn && updatedIn.value) ? updatedIn.value : '' };
            try{ if(avatarSizeIn && avatarSizeIn.value) appPayload.avatarSize = parseInt(avatarSizeIn.value,10); }catch(e){}
            // attach features collected earlier (if any)
            try{ if(Array.isArray(_featuresLines) && _featuresLines.length > 0) appPayload.features = _featuresLines; }catch(e){}
            const footerPayload = { credit: (footerCreditIn && footerCreditIn.value) ? footerCreditIn.value : '' };
            if(typeof db !== 'undefined' && db && typeof db.ref === 'function'){
              // write founder and app settings
              await db.ref('settings/founder').set(founderPayload).catch(()=>{});
              await db.ref('settings/app').set(appPayload).catch(()=>{});
              await db.ref('settings/footer').set(footerPayload).catch(()=>{});
            } else {
              try{ localStorage.setItem('settings_founder', JSON.stringify(founderPayload)); }catch(e){}
              try{ localStorage.setItem('settings_app', JSON.stringify(appPayload)); }catch(e){}
              try{ localStorage.setItem('settings_footer', JSON.stringify(footerPayload)); }catch(e){}
            }
          }catch(e){ console && console.warn && console.warn('Persist founder failed', e); }

          closeEditor();
          // feedback
          try{ const t = document.createElement('div'); t.textContent='âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'; t.style.position='fixed'; t.style.bottom='18px'; t.style.right='18px'; t.style.background='#2e7d32'; t.style.color='#fff'; t.style.padding='8px 12px'; t.style.borderRadius='8px'; t.style.zIndex='16000'; document.body.appendChild(t); setTimeout(()=>t.remove(),1600); }catch(e){}
        }

        // show inline button only for admin role; keep panelBtn hidden (it still has the click handler)
        try{
          const inlineBtn = document.getElementById('aboutPanelEditInline');
          const isAdmin = (typeof currentUserRole !== 'undefined' && currentUserRole === 'admin');
          if(inlineBtn) inlineBtn.style.display = isAdmin ? 'flex' : 'none';
          if(panelBtn) panelBtn.style.display = 'none';
          // wire inline button to open the editor directly
          if(inlineBtn) inlineBtn.addEventListener('click', openEditor);
        }catch(e){}

        if(panelBtn) panelBtn.addEventListener('click', openEditor);
        if(cancelBtn) cancelBtn.addEventListener('click', closeEditor);
        if(saveBtn) saveBtn.addEventListener('click', saveChanges);
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape' && modal && modal.style.display === 'flex') closeEditor(); });
      })();
    </script>

    <!-- ============================================ -->
    <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… -->
    <!-- ============================================ -->
    <script>
      (function() {
        'use strict';

        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let telegramSettings = {
          botToken: '',
          chatId: '',
          autoBackupHours: 48
        };
        let autoBackupInterval = null;
        let lastBackupTime = null;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Firebase Ø£Ùˆ localStorage
        async function loadTelegramSettings() {
          try {
            if (typeof db !== 'undefined' && db) {
              const snap = await db.ref('settings/telegram').once('value');
              const saved = snap.val();
              if (saved) {
                telegramSettings = { ...telegramSettings, ...saved };
              }
            } else {
              const saved = localStorage.getItem('telegramSettings');
              if (saved) {
                telegramSettings = { ...telegramSettings, ...JSON.parse(saved) };
              }
            }

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const tokenInput = document.getElementById('telegramBotToken');
            const chatIdInput = document.getElementById('telegramChatId');
            const hoursInput = document.getElementById('telegramAutoBackupHours');
            
            if (tokenInput) tokenInput.value = telegramSettings.botToken || '';
            if (chatIdInput) chatIdInput.value = telegramSettings.chatId || '';
            if (hoursInput) hoursInput.value = telegramSettings.autoBackupHours || 48;

            // restore last backup time if present (DB or localStorage)
            try{
              const savedLast = (telegramSettings && telegramSettings.lastBackup) || localStorage.getItem('telegramLastBackup');
              if (savedLast) {
                lastBackupTime = parseInt(savedLast, 10);
                telegramSettings.lastBackup = lastBackupTime;
              }
            }catch(e){}

            // set toggle state from settings
            try{
              const toggle = document.getElementById('telegramAutoBackupToggle');
              if (toggle) toggle.checked = !!telegramSettings.autoBackupEnabled;
            }catch(e){}

            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (telegramSettings.botToken && telegramSettings.chatId) {
              if (telegramSettings.autoBackupEnabled) startAutoBackup();
              else updateTelegramNextBackupDisplay();
            }
          } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…:', error);
          }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø¹ Ù‚Ø±Ø§Ø¡Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø¥Ø®Ø·Ø§Ø± Ø³Ø±ÙŠØ¹)
        async function saveTelegramSettings() {
          try {
            const tokenInput = document.getElementById('telegramBotToken');
            const chatIdInput = document.getElementById('telegramChatId');
            const hoursInput = document.getElementById('telegramAutoBackupHours');
            const toggleEl = document.getElementById('telegramAutoBackupToggle');

            if (!tokenInput || !chatIdInput || !hoursInput || !toggleEl) return;

            telegramSettings.botToken = tokenInput.value.trim();
            telegramSettings.chatId = chatIdInput.value.trim();
            telegramSettings.autoBackupHours = parseInt(hoursInput.value) || 48;
            telegramSettings.autoBackupEnabled = !!toggleEl.checked;

            if (!telegramSettings.botToken || !telegramSettings.chatId) {
              showToast('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Bot Token Ùˆ Chat ID', 'error');
              return;
            }

            // Ø­ÙØ¸ ÙÙŠ Firebase Ø£Ùˆ localStorage
            if (typeof db !== 'undefined' && db) {
              await db.ref('settings/telegram').set(telegramSettings);
            } else {
              localStorage.setItem('telegramSettings', JSON.stringify(telegramSettings));
            }

            updateTelegramStatus('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            showToast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…', 'success');

            // ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
            if (telegramSettings.autoBackupEnabled) {
              startAutoBackup();
            } else {
              stopAutoBackup();
            }
          } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
            updateTelegramStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
            showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
          }
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
        function updateTelegramStatus(message, type = 'info') {
          const statusEl = document.getElementById('telegramStatus');
          if (statusEl) {
            statusEl.textContent = message;
            statusEl.style.color = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#666';
            setTimeout(() => {
              if (statusEl.textContent === message) {
                statusEl.textContent = '';
              }
            }, 5000);
          }
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬)
        async function testTelegramConnection() {
          try {
            const tokenInput = document.getElementById('telegramBotToken');
            const chatIdInput = document.getElementById('telegramChatId');

            if (!tokenInput || !chatIdInput) return;

            const token = tokenInput.value.trim();
            const chatId = chatIdInput.value.trim();

            if (!token || !chatId) {
              showToast('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Bot Token Ùˆ Chat ID Ø£ÙˆÙ„Ø§Ù‹', 'error');
              return;
            }

            updateTelegramStatus('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...', 'info');

            // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø±
            const testMessage = 'ğŸ§ª Ù‡Ø°Ø§ Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±\nâœ… Ø¥Ø°Ø§ ÙˆØµÙ„Øª Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ ÙØ§Ù„Ø§ØªØµØ§Ù„ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­.';
            
            const success = await sendTelegramMessage(token, chatId, testMessage);
            
            if (success) {
              updateTelegramStatus('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­! ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…', 'success');
              showToast('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } else {
              updateTelegramStatus('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Token Ùˆ Chat ID', 'error');
              showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ­Ù‚Ù‚ Ù…Ù† Token Ùˆ Chat ID', 'error');
            }
          } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„:', error);
            updateTelegramStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, 'error');
            showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
          }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
        async function sendTelegramMessage(token, chatId, message) {
          try {
            const url = `https://api.telegram.org/bot${token}/sendMessage`;
            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                chat_id: chatId,
                text: message,
                parse_mode: 'HTML'
              })
            });

            const data = await response.json();
            return data.ok === true;
          } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
            return false;
          }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù PDF Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
        async function sendPDFToTelegram(pdfBlob, filename) {
          try {
            if (!telegramSettings.botToken || !telegramSettings.chatId) {
              alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');
              return false;
            }

            // ØªØ­ÙˆÙŠÙ„ Blob Ø¥Ù„Ù‰ File
            const file = new File([pdfBlob], filename, { type: 'application/pdf' });
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± FormData
            const formData = new FormData();
            formData.append('document', file);
            formData.append('chat_id', telegramSettings.chatId);
            formData.append('caption', `ğŸ“„ ${filename}\nğŸ“… ${new Date().toLocaleDateString('ar-EG')}\nâ° ${new Date().toLocaleTimeString('ar-EG')}`);

            const url = `https://api.telegram.org/bot${telegramSettings.botToken}/sendDocument`;
            
            const response = await fetch(url, {
              method: 'POST',
              body: formData
            });

            const data = await response.json();
            
            if (data.ok) {
              return true;
            } else {
              console.error('Ø®Ø·Ø£ Ù…Ù† ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…:', data);
              return false;
            }
          } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ PDF:', error);
            return false;
          }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ PDF Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        async function generateAttendancePDF() {
          try {
            if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
              alert('âŒ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©');
              return null;
            }

            const { jsPDF } = window.jspdf;
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
            const attendanceTable = document.getElementById('attendanceTable');
            const mainContent = document.getElementById('mainContent');
            const empStatsDiv = document.getElementById('empStatsBelowTable');
            const statsBox = document.getElementById('statsBox');
            
            if (!attendanceTable || !mainContent) {
              alert('âŒ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„');
              return null;
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ container Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
            const printContainer = document.createElement('div');
            printContainer.style.position = 'absolute';
            printContainer.style.left = '-9999px';
            printContainer.style.top = '0px';
            printContainer.style.width = '210mm';
            printContainer.style.backgroundColor = '#fff';
            printContainer.style.padding = '20px';
            printContainer.style.direction = 'rtl';
            printContainer.style.fontFamily = 'inherit';
            printContainer.style.fontSize = '14px';
            document.body.appendChild(printContainer);
            
            // Ù†Ø³Ø® Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            const title = mainContent.querySelector('h2');
            if (title) {
              const titleClone = title.cloneNode(true);
              titleClone.style.marginTop = '0';
              titleClone.style.marginBottom = '20px';
              printContainer.appendChild(titleClone);
            }
            
            // Ù†Ø³Ø® Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ù…Ø§Ø·
            const tableClone = attendanceTable.cloneNode(true);
            tableClone.style.width = '100%';
            tableClone.style.marginBottom = '30px';
            tableClone.style.borderCollapse = 'collapse';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø£Ø³ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ÙÙŠØ§Ù‹
            const dateHeader = tableClone.querySelector('#dateHeaderTh');
            if (dateHeader) {
              dateHeader.style.display = '';
              dateHeader.style.display = 'table-cell';
            }
            
            // ØªØ­ÙˆÙŠÙ„ Ø¬Ù…ÙŠØ¹ select elements Ø¥Ù„Ù‰ Ù†Øµ Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø³Ø®
            const allSelects = tableClone.querySelectorAll('select');
            allSelects.forEach(select => {
              const selectedValue = select.value || '';
              const parent = select.parentElement;
              if (parent) {
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ù…Ù† Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                const originalCell = attendanceTable.querySelector(`select[id="${select.id}"]`)?.parentElement;
                const bgColor = originalCell ? window.getComputedStyle(originalCell).backgroundColor : '';
                const textColor = originalCell ? window.getComputedStyle(originalCell).color : '';
                
                // Ø¥Ù†Ø´Ø§Ø¡ span Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† select
                const span = document.createElement('span');
                span.textContent = selectedValue;
                span.style.display = 'block';
                span.style.width = '100%';
                span.style.height = '100%';
                span.style.textAlign = 'center';
                span.style.verticalAlign = 'middle';
                span.style.padding = '8px 4px';
                span.style.fontSize = '15px';
                span.style.fontWeight = 'bold';
                span.style.minHeight = '30px';
                span.style.lineHeight = '1.4';
                
                // ØªØ·Ø¨ÙŠÙ‚ Ù†ÙØ³ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø©
                if (selectedValue === 'Ø´ÙØª') {
                  span.style.background = '#d4edda';
                  span.style.color = '#155724';
                } else if (selectedValue === 'Ù†Øµ') {
                  span.style.background = '#fff9db';
                  span.style.color = '#856404';
                } else if (selectedValue === 'âŒ') {
                  span.style.background = '#ffe3e3';
                  span.style.color = '#d32f2f';
                } else {
                  span.style.background = bgColor || '#fff';
                  span.style.color = textColor || '#000';
                }
                
                // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ select Ø¨Ù€ span
                parent.replaceChild(span, select);
              }
            });
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ th elements Ù…Ø±Ø¦ÙŠØ© ÙˆÙ…ØªØ³Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø±Ø¶
            const allThs = tableClone.querySelectorAll('thead th');
            allThs.forEach(th => {
              th.style.display = 'table-cell';
              th.style.visibility = 'visible';
              th.style.opacity = '1';
              th.style.position = 'relative';
              th.style.zIndex = '1';
              // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Øµ Ù…Ø±Ø¦ÙŠ
              th.style.textAlign = 'center';
              th.style.verticalAlign = 'middle';
              th.style.padding = '10px 5px';
              th.style.whiteSpace = 'normal';
              th.style.wordWrap = 'break-word';
              th.style.fontSize = '17px';
              th.style.fontWeight = 'bold';
            });
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ td elements Ù…Ø±Ø¦ÙŠØ©
            const allTds = tableClone.querySelectorAll('tbody td');
            allTds.forEach(td => {
              td.style.display = 'table-cell';
              td.style.visibility = 'visible';
              td.style.opacity = '1';
              td.style.position = 'relative';
              // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ border-radius Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ Ù…Ø´Ø§ÙƒÙ„
              td.style.borderRadius = '0';
              td.style.padding = '5px';
              td.style.textAlign = 'center';
              td.style.verticalAlign = 'middle';
              
              // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ø±Ø¦ÙŠ
              const span = td.querySelector('span');
              if (span) {
                span.style.display = 'block';
                span.style.visibility = 'visible';
                span.style.opacity = '1';
              }
            });
            
            printContainer.appendChild(tableClone);
            
            // Ù†Ø³Ø® Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (statsBox && statsBox.innerHTML && statsBox.innerHTML !== 'â€”') {
              const statsTitle = document.createElement('h3');
              statsTitle.textContent = 'ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª';
              statsTitle.style.marginTop = '20px';
              statsTitle.style.marginBottom = '10px';
              printContainer.appendChild(statsTitle);
              
              const statsClone = statsBox.cloneNode(true);
              printContainer.appendChild(statsClone);
            }
            
            // Ù†Ø³Ø® Ø¬Ø¯ÙˆÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (empStatsDiv && empStatsDiv.innerHTML.trim()) {
              const empStatsClone = empStatsDiv.cloneNode(true);
              empStatsClone.style.marginTop = '20px';
              printContainer.appendChild(empStatsClone);
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            const footer = document.createElement('div');
            footer.style.marginTop = '30px';
            footer.style.paddingTop = '20px';
            footer.style.borderTop = '1px solid #ccc';
            footer.style.textAlign = 'center';
            footer.style.fontSize = '10px';
            footer.style.color = '#666';
            footer.innerHTML = `
              <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø©: ${currentUser || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</p>
              <p>ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleString('ar-EG')}</p>
            `;
            printContainer.appendChild(footer);

            // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙˆØ§Ù„Ø®Ø·ÙˆØ·
            await new Promise(resolve => setTimeout(resolve, 1000));

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
            try{ updatePdfProgress(45, 'ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ ØµÙˆØ±Ø©...'); }catch(e){}

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ ØµÙˆØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… html2canvas
            const canvas = await html2canvas(printContainer, {
              scale: 2.5, // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¯Ù‚Ø©
              useCORS: true,
              logging: false,
              backgroundColor: '#ffffff',
              width: printContainer.scrollWidth,
              height: printContainer.scrollHeight,
              windowWidth: printContainer.scrollWidth,
              windowHeight: printContainer.scrollHeight,
              allowTaint: false,
              removeContainer: false,
              imageTimeout: 15000,
              onclone: function(clonedDoc) {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ø±Ø¦ÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø³Ø®Ø©
                const clonedContainer = clonedDoc.querySelector('div');
                if (clonedContainer) {
                  // Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
                  const allElements = clonedContainer.querySelectorAll('*');
                  allElements.forEach(el => {
                    if (el.style) {
                      el.style.visibility = 'visible';
                      el.style.opacity = '1';
                      if (el.tagName === 'TD' || el.tagName === 'TH') {
                        el.style.display = 'table-cell';
                      } else if (el.tagName === 'TR') {
                        el.style.display = 'table-row';
                      } else if (el.tagName === 'TABLE') {
                        el.style.display = 'table';
                      } else if (el.tagName === 'SPAN') {
                        el.style.display = 'block';
                      }
                    }
                  });
                  
                  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø±Ø¦ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
                  const clonedTable = clonedContainer.querySelector('table');
                  if (clonedTable) {
                    clonedTable.style.display = 'table';
                    clonedTable.style.visibility = 'visible';
                    clonedTable.style.width = '100%';
                    clonedTable.style.borderCollapse = 'collapse';
                  }
                  
                  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµ Ù…Ø±Ø¦ÙŠØ©
                  const allTexts = clonedContainer.querySelectorAll('th, td, span');
                  allTexts.forEach(textEl => {
                    textEl.style.color = window.getComputedStyle(textEl).color || '#000';
                    textEl.style.textShadow = 'none';
                  });
                }
              }
            });
            
            const imgData = canvas.toDataURL('image/png', 0.95);
            
            // Ø¥Ù†Ø´Ø§Ø¡ PDF ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø©
            try{ updatePdfProgress(75, 'ğŸ” ØªØ¬Ù‡ÙŠØ² Ù…Ù„Ù PDF...'); }catch(e){}
            const doc = new jsPDF({ 
              orientation: 'portrait', 
              unit: 'mm', 
              format: 'a4',
              compress: true
            });
            
            const imgWidth = 210; // Ø¹Ø±Ø¶ A4 Ø¨Ø§Ù„Ù…Ù„ÙŠÙ…ØªØ±
            const pageHeight = 297; // Ø§Ø±ØªÙØ§Ø¹ A4 Ø¨Ø§Ù„Ù…Ù„ÙŠÙ…ØªØ±
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            let heightLeft = imgHeight;
            let position = 0;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
            heightLeft -= pageHeight;
            
            // Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            while (heightLeft >= 0) {
              position = heightLeft - imgHeight;
              doc.addPage();
              doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
              heightLeft -= pageHeight;
            }
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¤Ù‚Øª
            document.body.removeChild(printContainer);
            
            return doc.output('blob');
          } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF:', error);
            alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF: ' + error.message);
            return null;
          }
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨
        function getRatesForEmployee(emp, y, m, salaries) {
          const monthKey = `${y}_${String(m + 1).padStart(2, '0')}`;
          if (salaries.months && salaries.months[monthKey]) {
            const mn = salaries.months[monthKey];
            if (mn.overrides && mn.overrides[emp]) {
              return { shift: Number(mn.overrides[emp].shift || 0), half: Number(mn.overrides[emp].half || 0) };
            }
            if (mn.default) {
              return { shift: Number(mn.default.shift || 0), half: Number(mn.default.half || 0) };
            }
          }
          if (salaries.overrides && salaries.overrides[emp]) {
            return { shift: Number(salaries.overrides[emp].shift || 0), half: Number(salaries.overrides[emp].half || 0) };
          }
          if (salaries.default) {
            return { shift: Number(salaries.default.shift || 22000), half: Number(salaries.default.half || 11000) };
          }
          return { shift: 22000, half: 11000 };
        }

        // Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ PDF
        async function printAndSendPDF() {
          try {
            if (!telegramSettings.botToken || !telegramSettings.chatId) {
              alert('âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Admin Panel)');
              return;
            }
            // Show PDF overlay progress
            startPdfProgress();

            // Ø¥Ù†Ø´Ø§Ø¡ PDF
            updatePdfProgress(30, 'ğŸ”„ Ø¥Ù†Ø´Ø§Ø¡ PDF...');
            const pdfBlob = await generateAttendancePDF();
            if (!pdfBlob) {
              completePdfProgress(false, 'âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ PDF');
              return;
            }

            updatePdfProgress(60, 'ğŸ” Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ PDF...');

            // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
            const filename = `ØªÙ‚Ø±ÙŠØ±_Ø­Ø¶ÙˆØ±_${year}_${month + 1}_${new Date().getTime()}.pdf`;
            const sent = await sendPDFToTelegram(pdfBlob, filename);

            if (sent) {
              completePdfProgress(true, 'âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ PDF Ø¨Ù†Ø¬Ø§Ø­');
              showMessage('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ PDF Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…');
              
              // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
              lastBackupTime = Date.now();
              // persist in settings (DB or localStorage)
              if (typeof db !== 'undefined' && db) {
                await db.ref('settings/telegram/lastBackup').set(lastBackupTime);
              } else {
                localStorage.setItem('telegramLastBackup', lastBackupTime.toString());
              }

              // keep in-memory settings and persist full telegramSettings so scheduler can restore
              try{
                telegramSettings.lastBackup = lastBackupTime;
                await persistTelegramSettings();
                try{ updateTelegramNextBackupDisplay(); }catch(e){}
                showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'success');
              }catch(e){ console.warn('Could not persist telegramSettings.lastBackup', e); }



              // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
              if (typeof logActivity === 'function') {
                logActivity('Ø¥Ø±Ø³Ø§Ù„ PDF Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…', `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± PDF Ø¨Ù†Ø¬Ø§Ø­: ${filename}`);
              }
            } else {
              completePdfProgress(false, 'âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ PDF');
              showMessage('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ PDF Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', true);
            }
          } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ PDF:', error);
            completePdfProgress(false, 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (error.message || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
            showMessage('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message, true);
          }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø¬Ø¯ÙˆÙ„Ø© Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ ØªØ³Ø­ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª)
        function startAutoBackup() {
          // clear previous timer
          try{ if (autoBackupInterval) { clearTimeout(autoBackupInterval); autoBackupInterval = null; } }catch(e){}

          // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹Ø·Ù„Ø©ØŒ Ù„Ø§ ØªÙ‚Ù… Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
          if (!telegramSettings.autoBackupEnabled) {
            console.log('ğŸ”• Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹Ø·Ù„');
            try{ updateTelegramNextBackupDisplay(); }catch(e){}
            return;
          }

          if (!telegramSettings.botToken || !telegramSettings.chatId) {
            return;
          }

          const hours = Math.max(1, (parseInt(telegramSettings.autoBackupHours,10) || 48));
          const msWindow = hours * 60 * 60 * 1000;

          // compute next run based on lastBackupTime (persisted) so scheduler survives reloads
          const now = Date.now();
          let nextRunAt = (telegramSettings && telegramSettings.lastBackup) ? (telegramSettings.lastBackup + msWindow) : (lastBackupTime ? (lastBackupTime + msWindow) : (now + msWindow));

          let waitMs = nextRunAt - now;
          if (isNaN(waitMs) || waitMs <= 0) {
            // if overdue or invalid, run soon (1s)
            waitMs = 1000;
          }

          autoBackupInterval = setTimeout(async function autoBackupRunner(){
            try{
              console.log('ğŸ” ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ø¢Ù†');
              await printAndSendPDF();
            }catch(err){ console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', err); }
            try{
              // after running (or attempt), schedule next based on updated lastBackup
              const after = Date.now();
              telegramSettings.lastBackup = after;
              await persistTelegramSettings();
            }catch(e){ console.warn('Could not persist lastBackup after auto run', e); }
            // schedule next
            startAutoBackup();
          }, waitMs);

          console.log(`âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø¹Ø¯ ${Math.round(waitMs/1000)} Ø«Ø§Ù†ÙŠØ© (ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ ${hours} Ø³Ø§Ø¹Ø©)`);
          // update next backup hint
          try{ updateTelegramNextBackupDisplay(); }catch(e){}
        }

        // Ø¹Ø±Ø¶ Ù…Ø³Ø§Ø¹Ø¯: ÙˆÙ‚Øª Ù‚Ø±ÙŠØ¨/Ø¨Ø¹ÙŠØ¯ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø²Ù…Ù†
        function relativeTimeFromNow(ts){
          try{
            const diff = Math.floor((ts - Date.now())/1000);
            if (isNaN(diff)) return '';
            const adiff = Math.abs(diff);
            if (adiff < 60) return diff > 0 ? `Ø¨Ø¹Ø¯ ${adiff} Ø«Ø§Ù†ÙŠØ©` : `Ù…Ù†Ø° ${adiff} Ø«Ø§Ù†ÙŠØ©`;
            const mins = Math.floor(adiff/60); if (mins < 60) return diff > 0 ? `Ø¨Ø¹Ø¯ ${mins} Ø¯Ù‚ÙŠÙ‚Ø©` : `Ù…Ù†Ø° ${mins} Ø¯Ù‚ÙŠÙ‚Ø©`;
            const hrs = Math.floor(mins/60); if (hrs < 24) return diff > 0 ? `Ø¨Ø¹Ø¯ ${hrs} Ø³Ø§Ø¹Ø©` : `Ù…Ù†Ø° ${hrs} Ø³Ø§Ø¹Ø©`;
            const days = Math.floor(hrs/24); return diff > 0 ? `Ø¨Ø¹Ø¯ ${days} ÙŠÙˆÙ…` : `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
          }catch(e){ return ''; }
        }

        // show small toasts
        function showToast(message, type='info', timeout=3800){
          try{
            let wrap = document.querySelector('.toast-wrap');
            if(!wrap){ wrap = document.createElement('div'); wrap.className='toast-wrap'; document.body.appendChild(wrap); }
            const t = document.createElement('div'); t.className = 'toast '+(type||'info'); t.textContent = message; wrap.appendChild(t);
            // trigger show
            setTimeout(()=> t.classList.add('toast-show'), 10);
            setTimeout(()=>{ t.classList.remove('toast-show'); setTimeout(()=> t.remove(), 200); }, timeout);
          }catch(e){ console.warn('toast error', e); }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªØ§Ù„ÙŠ (Ù†Øµ ØªØ§Ø±ÙŠØ¬ ÙˆÙˆÙ‚Øª Ù†Ø³Ø¨ÙŠ)
        function updateTelegramNextBackupDisplay(){
          try{
            const el = document.getElementById('telegramNextBackup'); if(!el) return;
            const rel = document.getElementById('telegramNextBackupRelative');
            const enabled = !!telegramSettings.autoBackupEnabled;
            const hrs = parseInt(telegramSettings.autoBackupHours,10) || 0;
            const last = parseInt(telegramSettings.lastBackup || lastBackupTime || 0,10) || 0;
            if(!enabled || !hrs || !last){ el.textContent = 'Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©: -'; if(rel) rel.textContent=''; return; }
            const next = last + hrs * 3600 * 1000;
            const d = new Date(next);
            el.textContent = 'Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©: ' + d.toLocaleString(); if(rel) rel.textContent = relativeTimeFromNow(next);
          }catch(e){ console.warn('updateTelegramNextBackupDisplay error', e); }
        }

        // refresh next backup display periodically
        setInterval(()=>{ try{ updateTelegramNextBackupDisplay(); }catch(e){} }, 60000);

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function stopAutoBackup() {
          if (autoBackupInterval) {
            clearTimeout(autoBackupInterval);
            autoBackupInterval = null;
            console.log('â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
            updateTelegramNextBackupDisplay();
          }
        }

        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        document.addEventListener('DOMContentLoaded', function() {
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
          setTimeout(() => {
            if (typeof currentUserRole !== 'undefined' && currentUserRole === 'admin') {
              loadTelegramSettings();
            }
          }, 1000);

          // Ø²Ø± Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
          const saveBtn = document.getElementById('saveTelegramSettingsBtn');
          if (saveBtn) {
            saveBtn.addEventListener('click', saveTelegramSettings);
          }

          // Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
          const testBtn = document.getElementById('testTelegramBtn');
          if (testBtn) {
            testBtn.addEventListener('click', testTelegramConnection);
          }

          // Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„
          const printBtn = document.getElementById('sidebarPrintTelegramBtn');
          if (printBtn) {
            printBtn.addEventListener('click', function() {
              document.getElementById('sidebarMenu').classList.remove('open');
              printAndSendPDF();
            });
          }

          // Ø±Ø¨Ø· ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù…Ø¨Ø§Ø´Ø±)
          const autoToggle = document.getElementById('telegramAutoBackupToggle');
          if (autoToggle) {
            autoToggle.addEventListener('change', async function(e){
              try{
                telegramSettings.autoBackupEnabled = !!e.target.checked;
                // persist immediately
                if (typeof db !== 'undefined' && db) await db.ref('settings/telegram').set(telegramSettings);
                else localStorage.setItem('telegramSettings', JSON.stringify(telegramSettings));
                if (telegramSettings.autoBackupEnabled) startAutoBackup(); else stopAutoBackup();
                showToast(telegramSettings.autoBackupEnabled ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ' : 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ', 'info');
              }catch(err){ console.warn('toggle error', err); }
            });
          }
        });

        // ØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        function updatePrintButtonVisibility() {
          const printBtn = document.getElementById('sidebarPrintTelegramBtn');
          if (printBtn) {
            const isAdmin = (typeof currentUserRole !== 'undefined' && currentUserRole === 'admin');
            printBtn.style.display = isAdmin ? 'block' : 'none';
          }
        }

        // Ø¯Ù…Ø¬ Ù…Ø¹ Ø¯Ø§Ù„Ø© updateSidebarVisibility Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        const originalUpdateSidebarVisibility = window.updateSidebarVisibility;
        if (typeof originalUpdateSidebarVisibility === 'function') {
          window.updateSidebarVisibility = function() {
            originalUpdateSidebarVisibility();
            updatePrintButtonVisibility();
          };
        } else {
          // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯Ø© Ø¨Ø³ÙŠØ·Ø©
          window.updateSidebarVisibility = updatePrintButtonVisibility;
        }

        // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
        setTimeout(updatePrintButtonVisibility, 1000);
        setInterval(updatePrintButtonVisibility, 2000);

        // ===== PDF progress helpers =====
        function startPdfProgress(){
          const overlay = document.getElementById('pdfProgressOverlay');
          if(!overlay) return;
          document.getElementById('pdfProgressBar').style.width = '6%';
          document.getElementById('pdfProgressText').textContent = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ PDF ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡...';
          document.getElementById('pdfProgressIcon').textContent = 'ğŸ”„';
          document.getElementById('pdfProgressCloseBtn').style.display = 'none';
          overlay.style.display = 'flex';
          try{ const printBtn = document.getElementById('sidebarPrintTelegramBtn'); if(printBtn){ printBtn.disabled = true; printBtn.style.opacity = '0.6'; } }catch(e){}
        }
        function updatePdfProgress(percent, text){
          const overlay = document.getElementById('pdfProgressOverlay');
          if(!overlay || overlay.style.display === 'none') return;
          document.getElementById('pdfProgressBar').style.width = Math.min(100, Math.max(0, percent)) + '%';
          if(text) document.getElementById('pdfProgressText').textContent = text;
        }
        function completePdfProgress(success, text){
          const overlay = document.getElementById('pdfProgressOverlay');
          if(!overlay) return;
          document.getElementById('pdfProgressBar').style.width = success ? '100%' : '100%';
          document.getElementById('pdfProgressIcon').textContent = success ? 'âœ…' : 'âŒ';
          document.getElementById('pdfProgressText').textContent = text || (success ? 'âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„' : 'âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
          const closeBtn = document.getElementById('pdfProgressCloseBtn');
          closeBtn.style.display = 'inline-block';
          closeBtn.onclick = function(){ overlay.style.display = 'none'; };
          try{ const printBtn = document.getElementById('sidebarPrintTelegramBtn'); if(printBtn){ printBtn.disabled = false; printBtn.style.opacity = ''; } }catch(e){}
          // auto-hide after short delay on success
          if(success){ setTimeout(()=>{ try{ overlay.style.display = 'none'; }catch(e){} }, 2200); }
        }

        // Allow closing overlay with Escape when close button visible
        document.addEventListener('keydown', function(e){ try{ const overlay = document.getElementById('pdfProgressOverlay'); const closeBtn = document.getElementById('pdfProgressCloseBtn'); if(!overlay || overlay.style.display === 'none') return; if(e.key === 'Escape' && closeBtn && closeBtn.style.display !== 'none'){ overlay.style.display = 'none'; } }catch(e){} });


      })();
    </script>

  </body>
</html>

<!-- Hide About Us for guests: show only when a user is logged in -->
<script>
  (function(){
    const el = document.getElementById('aboutUs');
    function isLoggedIn(){
      try{ return !!(window.currentUser || localStorage.getItem('loggedUser')); }catch(e){ return false; }
    }

    // ensure hidden by default (inline style already set) and show only when confirmed
    try{
      if(!el) return;
      el.style.display = isLoggedIn() ? '' : 'none';
    }catch(e){}

    // keep track of previous state and update only on change to avoid flicker
    let last = isLoggedIn();
    function update(){
      try{
        const cur = isLoggedIn();
        if(cur !== last){
          last = cur;
          el.style.display = cur ? '' : 'none';
        }
      }catch(e){}
    }

    // Poll for changes (lightweight) so logout/login reflect immediately
    setInterval(update, 400);

    // Patch localStorage.setItem to react when loggedUser is changed programmatically
    try{
      const origSet = Storage.prototype.setItem;
      Storage.prototype.setItem = function(k,v){
        origSet.apply(this, arguments);
        if(k === 'loggedUser') update();
      };
    }catch(e){}

    // Expose manual toggler and listen for custom events
    window.toggleAboutVisibility = function(){ try{ el.style.display = isLoggedIn() ? '' : 'none'; }catch(e){} };
    window.addEventListener('user:login', update);
    window.addEventListener('user:logout', update);
  })();
</script>
</html>
