<!DOCTYPE html>
<htm lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      background-color: #f4f4f4;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 700px;
      margin: auto;
      padding: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    h2 { text-align: center; color: #333; }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    #mainContent, #adminPanel { display: none; }
    #attendanceTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #attendanceTable th, #attendanceTable td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
    .editor-tag { font-size: 12px; color: #555; }
    .error { color: red; text-align: center; margin: 10px 0; }
    .loading { text-align: center; color: #666; margin: 10px 0; }
    #adminPanel { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
    #adminPanel h3 { margin-top: 0; text-align: center; }
    table#usersTable, table#employeesTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table#usersTable th, table#usersTable td,
    table#employeesTable th, table#employeesTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .small-button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 3px;
    }
    .btn-edit { background-color: #28a745; color: white; border: none; }
    .btn-delete { background-color: #dc3545; color: white; border: none; }
    .btn-toggle { background-color: #ffc107; color: black; border: none; }
    @media (max-width: 767px) {
      .container { padding: 10px; }
      input, button, select { font-size: 14px; padding: 8px; }
      #attendanceTable th, #attendanceTable td { font-size: 18px; padding: 3px; }
    }
    .tooltip-wrapper { position: relative; display: inline-block; cursor: help; }
    .tooltip-wrapper .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #361fa7;
      color: #fff;
      text-align: right;
      padding: 8px;
      border-radius: 6px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      right: 50%;
      transform: translateX(50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      line-height: 1.4;
    }
    .tooltip-wrapper.show .tooltip-text { visibility: visible; opacity: 1; }
    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }
    .checkbox-label input[type="checkbox"] {
      transform: none;
      vertical-align: middle;
      margin: 0;
    }
  </style>
</head>
<body>
<div class="container">

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginBox">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="off" />
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off" />
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    <div id="loginMessage"></div>
    <div style="text-align:center; margin-top:10px; font-size:14px; color:#555; font-style:italic; line-height:1.3;">
      Ø¨ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø³Ø¬Ø§Ø¯ Ø±Ø´ÙŠØ¯<br />
      insta: e ._ mg
    </div>
  </div>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± -->
  <div id="mainContent">
    <h2>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± - ØªÙ…ÙˆØ²</h2>
    <button id="btnDownloadPDF" style="margin-bottom:10px;" onclick="downloadPDF()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ PDF</button>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <button onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <button onclick="logout()" style="background-color: #dc3545; margin-top: 10px;">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    <h3 style="margin-top:20px;">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
    <div id="statsBox">â€”</div>
  </div>

  <!-- Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù€ Admin -->
  <div id="adminPanel" style="display:none">
    <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
    <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
    <input type="text" id="newEmployeeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯" />
    <button onclick="addEmployee()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
    <table id="employeesTable">
      <thead>
        <tr><th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø­Ø°Ù</th></tr>
      </thead>
      <tbody id="employeesBody"></tbody>
    </table>
    <hr />
    <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
    <input type="text" id="newUserName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯" />
    <input type="password" id="newUserPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <label class="checkbox-label">
      <input type="checkbox" id="newUserCanEdit" checked />ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    </label>
    <button onclick="addUser()">â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…</button>
    <table id="usersTable">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (ØªØ¹Ø¯ÙŠÙ„ØŸ)</th>
          <th>ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
          <th>Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
    <button id="toggleEmpStatsBtn" style="background:#17a2b8;color:white;font-size:13px;padding:7px 12px;margin-bottom:10px;cursor:pointer;">
      ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    </button>
    <div id="empStatsTab" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:2000;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:500px;width:95vw;max-height:90vh;overflow:auto;border-radius:12px;box-shadow:0 8px 32px #0002;padding:25px 20px 20px 20px;position:relative;">
        <button id="closeEmpStatsTab" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
        <h3 style="text-align:center;margin-bottom:18px;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
        <div id="empStatsTabContent"></div>
      </div>
    </div>
    <button id="btnDeleteData" style="background-color:#dc3545; color:white; font-size:12px; padding:5px 10px; margin-top:15px; cursor:pointer;">
      ğŸ—‘ï¸ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
    </button>
    <!-- Ø£Ø¶Ù Ø²Ø± Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø¹Ø¯ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <button id="btnFeaturesTab" style="background:#673ab7;color:white;font-size:13px;padding:7px 12px;margin-bottom:10px;cursor:pointer;">
      â­ï¸ Ù…ÙŠØ²Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
    </button>
    <div id="featuresTab" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:3000;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:520px;width:97vw;max-height:92vh;overflow:auto;border-radius:14px;box-shadow:0 8px 32px #0002;padding:25px 18px 18px 18px;position:relative;">
        <button id="closeFeaturesTab" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">âœ–</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#673ab7;">â­ï¸ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
        <div id="featuresTabContent"></div>
      </div>
    </div>
    <style>
      @media (max-width: 600px) {
        #featuresTab > div {
          max-width: 99vw !important;
          padding: 10px 2vw 10px 2vw !important;
        }
        #featuresTab h3 { font-size: 18px !important; }
      }
      .feature-section {
        background: #f6f8fa;
        border-radius: 10px;
        margin-bottom: 18px;
        padding: 13px 12px;
        box-shadow: 0 1px 6px #0001;
      }
      .feature-section h4 {
        margin: 0 0 7px 0;
        color: #3f51b5;
        font-size: 16px;
      }
      .activity-log-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 7px;
        font-size: 14px;
      }
      .activity-log-table th, .activity-log-table td {
        border: 1px solid #ccc;
        padding: 5px 4px;
        text-align: center;
      }
      .activity-log-table th {
        background: #ede7f6;
        color: #673ab7;
      }
    </style>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ==========
const firebaseConfig = {
  apiKey: "AIzaSyDh8KquT-8Slr6B5SAGoyGj2zOEusyiEg4",
  authDomain: "sjad-b3946.firebaseapp.com",
  databaseURL: "https://sjad-b3946-default-rtdb.firebaseio.com",
  projectId: "sjad-b3946",
  storageBucket: "sjad-b3946.appspot.com",
  messagingSenderId: "1001672753514",
  appId: "1:1001672753514:web:eac813b6e25621f5d16513",
  measurementId: "G-EV0NVW2036"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let employees = [];
const statuses = ["", "Ø´ÙØª", "Ù†Øµ", "âŒ"];
let month = new Date().getMonth();
const year = new Date().getFullYear();
let currentUser = "";
let currentUserRole = "";
let currentUserCanEdit = false;

// ========== Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
if (localStorage.getItem('loggedUser')) {
  const savedUser = JSON.parse(localStorage.getItem('loggedUser'));
  currentUser = savedUser.user;
  currentUserRole = savedUser.role;
  currentUserCanEdit = savedUser.canEdit;
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("mainContent").style.display = "block";
  if (currentUserRole === "admin") document.getElementById("adminPanel").style.display = "block";
  loadEmployees().then(()=>{ generateTable(); });
  if (currentUserRole === "admin") { loadUsers(); loadEmployeesTable(); }
}

// ========== Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
function showMessage(message, isError = false) {
  const messageDiv = document.getElementById("loginMessage");
  messageDiv.innerHTML = message;
  messageDiv.className = isError ? "error" : "loading";
}

// ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ==========
function login() {
  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const username = usernameInput.value.trim();
  const password = passwordInput.value.trim();
  if (!username || !password) {
    showMessage("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", true);
    return;
  }
  showMessage("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
  const userKey = username.toLowerCase();
  db.ref("users/" + userKey).once("value")
    .then(snapshot => {
      if (!snapshot.exists()) {
        showMessage("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", true);
        throw new Error("User not found");
      }
      const userData = snapshot.val();
      if (userData.password !== password) {
        showMessage("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©", true);
        throw new Error("Wrong password");
      }
      currentUser = userKey;
      currentUserRole = userData.role || "user";
      currentUserCanEdit = userData.canEdit !== undefined ? userData.canEdit : true;
      localStorage.setItem('loggedUser', JSON.stringify({user:currentUser, role:currentUserRole, canEdit:currentUserCanEdit}));
      showMessage("");
      usernameInput.value = "";
      passwordInput.value = "";
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      loadEmployees().then(() => { generateTable(); });
      if (currentUserRole === "admin") {
        document.getElementById("adminPanel").style.display = "block";
        loadUsers();
        loadEmployeesTable();
      } else {
        document.getElementById("adminPanel").style.display = "none";
      }
      checkForcedLogoutOnLogin(userKey);
    })
    .catch(error => {
      console.error("Login error:", error);
      if (!error.message.startsWith("User not found") && !error.message.startsWith("Wrong password")) {
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message, true);
      }
    });
}

function logout() {
  currentUser = "";
  currentUserRole = "";
  currentUserCanEdit = false;
  localStorage.removeItem('loggedUser');
  document.getElementById("loginBox").style.display = "block";
  document.getElementById("mainContent").style.display = "none";
  document.getElementById("adminPanel").style.display = "none";
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  showMessage("");
}

// ========== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ==========
function loadEmployees() {
  return db.ref("employees").once("value").then(snapshot => {
    employees = snapshot.exists() ? Object.values(snapshot.val()) : [];
    const theadRow = document.querySelector("#attendanceTable thead tr");
    while (theadRow.children.length > 1) theadRow.removeChild(theadRow.lastChild);
    employees.forEach(emp => {
      const th = document.createElement("th");
      th.textContent = emp;
      theadRow.appendChild(th);
    });
    loadEmployeesTable();
  });
}

// ========== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ==========
function getDays() {
  const days = [];
  let date = new Date(year, month, 1);
  while (date.getMonth() === month) {
    const dayKey = `${year}-${month + 1}-${date.getDate()}`;
    const dayLabel = `${date.getDate()} ØªÙ…ÙˆØ² (${date.toLocaleDateString('ar-EG', {weekday: 'long'})})`;
    days.push({key: dayKey, label: dayLabel});
    date.setDate(date.getDate() + 1);
  }
  return days;
}

function generateTable() {
  const days = getDays();
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  db.ref("attendance").once("value").then(snapshot => {
    const savedData = snapshot.val() || {};
    days.forEach((day, dayIndex) => {
      const row = document.createElement("tr");
      const dateCell = document.createElement("td");
      let dateContent = day.label;
      if (savedData[day.key] && savedData[day.key].__editor) {
        const ts = savedData[day.key].__editedAt || "";
        const editor = savedData[day.key].__editor;
        // Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± Ø¥Ø°Ø§ adminØŒ Ø£Ø­Ù…Ø± Ø¥Ø°Ø§ ØºÙŠØ± Ø°Ù„Ùƒ
        const color = (editor === "admin") ? "#1fa745" : "#dc3545";
        dateContent += `<div class='editor-tag' style="color:${color};font-weight:bold;">
          ğŸ–Šï¸ ${editor}${ts ? ' - ' + ts : ''}
        </div>`;
      }
      dateCell.innerHTML = dateContent;
      row.appendChild(dateCell);
      employees.forEach((employee, empIndex) => {
        const cell = document.createElement("td");
        const select = document.createElement("select");
        select.id = `d${dayIndex}e${empIndex}`;
        statuses.forEach(status => {
          const option = document.createElement("option");
          option.value = status;
          option.textContent = status;
          select.appendChild(option);
        });
        if (savedData[day.key] && savedData[day.key][employee] !== undefined) {
          select.value = savedData[day.key][employee];
        }
        // Ø¥Ø¶Ø§ÙØ© ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø©
        if (select.value === "Ø´ÙØª") {
          cell.style.background = "#d4edda"; // Ø£Ø®Ø¶Ø± ÙØ§ØªØ­
        } else if (select.value === "Ù†Øµ") {
          cell.style.background = "#fff9db"; // Ø£ØµÙØ± ÙØ§ØªØ­
        }
        if (!currentUserCanEdit) {
          select.setAttribute('disabled','disabled');
          select.addEventListener('change', (e)=>{ e.target.value = savedData[day.key] ? savedData[day.key][employee] : ""; });
        }
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆÙ† Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø©
        select.addEventListener('change', function() {
          if (this.value === "Ø´ÙØª") {
            cell.style.background = "#d4edda";
          } else if (this.value === "Ù†Øµ") {
            cell.style.background = "#fff9db";
          } else {
            cell.style.background = "";
          }
        });
        cell.appendChild(select);
        row.appendChild(cell);
      });
      tbody.appendChild(row);
    });
    calculateStats(savedData);
  });
}

// ========== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
async function saveData() {
  if (!currentUserCanEdit) {
    alert("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.");
    return;
  }
  const days = getDays();
  try {
    const attendanceSnapshot = await db.ref("attendance").once("value");
    const savedData = attendanceSnapshot.val() || {};
    const updatedData = {...savedData};
    let anyChange = false;
    days.forEach((day, dayIndex) => {
      if (!updatedData[day.key]) updatedData[day.key] = {};
      let dayChanged = false;
      employees.forEach((employee, empIndex) => {
        const selectElement = document.getElementById(`d${dayIndex}e${empIndex}`);
        if (selectElement) {
          const newValue = selectElement.value;
          const oldValue = savedData[day.key] ? savedData[day.key][employee] : undefined;
          if (newValue !== oldValue) {
            updatedData[day.key][employee] = newValue;
            dayChanged = true;
            anyChange = true;
          }
        }
      });
      if (dayChanged) {
        updatedData[day.key].__editor = currentUser;
        const now = new Date();
        const ts = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
        updatedData[day.key].__editedAt = ts;
      }
    });
    if (!anyChange) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ø­ÙØ¸Ù‡Ø§'); return; }
    await db.ref("attendance").set(updatedData);
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
    generateTable();
    logActivity("Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„", "ØªÙ… Ø­ÙØ¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±");
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  }
}

// ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ==========
let forcedLogoutUsers = [];
function loadForcedLogoutUsers() {
  return db.ref("forcedLogout").once("value").then(snapshot => {
    forcedLogoutUsers = snapshot.val() ? Object.keys(snapshot.val()) : [];
  });
}
function loadUsers() {
  loadForcedLogoutUsers().then(() => {
    db.ref("users").once("value").then(snapshot => {
      const users = snapshot.val() || {};
      const tbody = document.getElementById("usersBody");
      tbody.innerHTML = "";
      Object.entries(users).forEach(([username, data]) => {
        const isForced = forcedLogoutUsers.includes(username);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${username}</td>
          <td>${data.canEdit ? "Ù†Ø¹Ù…" : "Ù„Ø§"}</td>
          <td>
            <button class="small-button btn-toggle" onclick="toggleUserEdit('${username}', ${data.canEdit})">
              ${data.canEdit ? "Ù‚ÙÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "ÙØªØ­ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"}
            </button>
          </td>
          <td>
            ${username === currentUser ? "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù†ÙØ³Ùƒ" : `<button class="small-button btn-delete" onclick="deleteUser('${username}')">Ø­Ø°Ù</button>`}
          </td>
          <td>
            ${username === currentUser ? "â€”" : `
              <button class="small-button btn-delete" style="background:#ff9800;" onclick="forceLogoutUser('${username}')" ${isForced ? "disabled" : ""}>
                ${isForced ? "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" : "ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬"}
              </button>
            `}
          </td>
        `;
        tbody.appendChild(tr);
      });
    });
  });
}
function forceLogoutUser(username) {
  if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username} ÙÙˆØ±Ø§Ù‹ØŸ`)) return;
  db.ref("forcedLogout/" + username).set(Date.now()).then(() => {
    alert("âœ… ØªÙ… Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.");
    loadUsers();
    if (currentUser === username) {
      localStorage.removeItem('loggedUser');
      alert("âŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.");
      db.ref("forcedLogout/" + username).remove();
      location.reload();
    }
  }).catch(e => {
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: " + e.message);
  });
}
function toggleUserEdit(username, currentCanEdit) {
  if (username === currentUser) {
    alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØªÙƒ Ø§Ù„Ø®Ø§ØµØ©.");
    return;
  }
  db.ref("users/" + username + "/canEdit").set(!currentCanEdit).then(() => {
    loadUsers();
    alert(`âœ… ØªÙ… ${!currentCanEdit ? "ÙØªØ­" : "Ù‚ÙÙ„"} ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}`);
  });
}
function deleteUser(username) {
  if (username === currentUser) {
    alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù†ÙØ³Ùƒ.");
    return;
  }
  if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}ØŸ`)) {
    db.ref("users/" + username).remove().then(() => {
      loadUsers();
      alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.");
      logActivity("Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…", username); // <-- Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ù‡Ù†Ø§
    });
  }
}
function addUser() {
  const username = document.getElementById("newUserName").value.trim().toLowerCase();
  const password = document.getElementById("newUserPass").value.trim();
  const canEdit = document.getElementById("newUserCanEdit").checked;
  if (!username || !password) {
    alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
    return;
  }
  db.ref("users/" + username).once("value").then(snapshot => {
    if (snapshot.exists()) {
      alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹");
      return;
    }
    const newUserData = { password, role: "user", canEdit };
    return db.ref("users/" + username).set(newUserData);
  }).then(() => {
    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPass").value = "";
    document.getElementById("newUserCanEdit").checked = true;
    loadUsers();
  }).catch(err => {
    console.error(err);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
  });
}
function addEmployee() {
  const name = document.getElementById("newEmployeeName").value.trim();
  if (!name) { alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù"); return; }
  if (employees.includes(name)) { alert("âŒ Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹"); return; }
  employees.push(name);
  db.ref("employees").set(employees).then(() => {
    alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­");
    document.getElementById("newEmployeeName").value = "";
    loadEmployeesTable();
    generateTable();
  }).catch(err => {
    console.error(err);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù");
  });
}
function loadEmployeesTable() {
  const tbody = document.getElementById("employeesBody");
  tbody.innerHTML = "";
  employees.forEach((emp, idx) => {
    const tr = document.createElement("tr");
    const nameTd = document.createElement("td");
    nameTd.textContent = emp;
    nameTd.id = `employeeName_${idx}`;
    const actionsTd = document.createElement("td");
    const editBtn = document.createElement("button");
    editBtn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
    editBtn.className = "small-button btn-edit";
    editBtn.onclick = () => enableEmployeeEdit(idx);
    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Ø­Ø°Ù";
    deleteBtn.className = "small-button btn-delete";
    deleteBtn.onclick = () => deleteEmployee(idx);
    actionsTd.appendChild(editBtn);
    actionsTd.appendChild(deleteBtn);
    tr.appendChild(nameTd);
    tr.appendChild(actionsTd);
    tbody.appendChild(tr);
  });
}
function enableEmployeeEdit(index) {
  const nameTd = document.getElementById(`employeeName_${index}`);
  const oldName = nameTd.textContent;
  nameTd.innerHTML = "";
  const input = document.createElement("input");
  input.type = "text";
  input.value = oldName;
  input.style.width = "80%";
  nameTd.appendChild(input);
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "ğŸ’¾ Ø­ÙØ¸";
  saveBtn.className = "small-button btn-edit";
  saveBtn.style.marginLeft = "5px";
  saveBtn.onclick = () => {
    const newName = input.value.trim();
    if (!newName) { alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºØ§Ù‹"); return; }
    if (employees.includes(newName)) { alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹"); return; }
    employees[index] = newName;
    db.ref("employees").set(employees).then(() => {
      alert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­");
      loadEmployeesTable();
      generateTable();
    }).catch(err => {
      console.error(err);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù");
    });
  };
  nameTd.appendChild(saveBtn);
}

// ========== PDF ==========
async function downloadPDF() {
  const element = document.getElementById('attendanceTable');
  const canvas = await html2canvas(element, {scale:2});
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l', 'pt', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgProps = pdf.getImageProperties(imgData);
  const ratio = Math.min(pageWidth / imgProps.width, pageHeight / imgProps.height);
  const imgWidth = imgProps.width * ratio;
  const imgHeight = imgProps.height * ratio;
  pdf.addImage(imgData, 'PNG', (pageWidth - imgWidth)/2, 20, imgWidth, imgHeight);
  pdf.save('attendance.pdf');
}

// ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ==========
function calculateStats(savedData) {
  const counts = {};
  employees.forEach(e=>{ counts[e]={"Ø´ÙØª":0,"Ù†Øµ":0,"âŒ":0}; });
  Object.values(savedData).forEach(day=>{
    employees.forEach(e=>{
      const val = day[e];
      if (val && counts[e][val] !== undefined) counts[e][val] += 1;
    });
  });
  const bestShift = Object.entries(counts).sort((a,b)=>b[1]["Ø´ÙØª"]-a[1]["Ø´ÙØª"])[0];
  const bestHalf  = Object.entries(counts).sort((a,b)=>b[1]["Ù†Øµ"]-a[1]["Ù†Øµ"])[0];
  const mostX     = Object.entries(counts).sort((a,b)=>b[1]["âŒ"]-a[1]["âŒ"])[0];
  const statsDiv = document.getElementById('statsBox');
  statsDiv.innerHTML = `
    <p>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù Ø´ÙØª: <b>${bestShift ? bestShift[0]+` (${bestShift[1]["Ø´ÙØª"]})` : 'â€”'}</b></p>
    <p>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù Ù†Øµ: <b>${bestHalf ? bestHalf[0]+` (${bestHalf[1]["Ù†Øµ"]})` : 'â€”'}</b></p>
    <p>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù âŒ: <b>${mostX ? mostX[0]+` (${mostX[1]["âŒ"]})` : 'â€”'}</b></p>`;
}

// ========== Tabs Ù„Ù„Ø£Ø´Ù‡Ø± ==========
const monthTabsDiv = document.createElement("div");
monthTabsDiv.id = "monthsTabs";
monthTabsDiv.style.marginTop = "20px";
document.getElementById("mainContent").appendChild(monthTabsDiv);
function loadAvailableMonths() {
  db.ref("attendance").once("value").then(snapshot => {
    const data = snapshot.val() || {};
    const monthsSet = new Set();
    Object.keys(data).forEach(key => {
      const parts = key.split("-");
      if (parts.length === 3) {
        const m = parseInt(parts[1]) - 1;
        monthsSet.add(m);
      }
    });
    const monthsArr = Array.from(monthsSet).sort((a,b)=>a-b);
    renderMonthTabs(monthsArr);
  });
}
function renderMonthTabs(months) {
  const div = document.getElementById("monthsTabs");
  div.innerHTML = "<b>ğŸ“… Ø§Ù„Ø£Ø´Ù‡Ø±:</b> ";
  months.forEach(m => {
    const btn = document.createElement("button");
    btn.textContent = m + 1;
    btn.style.padding = "6px 10px";
    btn.style.margin = "2px";
    btn.style.fontSize = "12px";
    btn.style.border = "1px solid #007bff";
    btn.style.background = "#f0f8ff";
    btn.style.color = "#007bff";
    btn.style.borderRadius = "5px";
    btn.style.cursor = "pointer";
    btn.style.transition = "all 0.2s ease";
    btn.onmouseover = () => { btn.style.background = "#007bff"; btn.style.color = "white"; };
    btn.onmouseout  = () => { btn.style.background = "#f0f8ff"; btn.style.color = "#007bff"; };
    btn.onclick = () => { month = m; generateTable(); };
    div.appendChild(btn);
  });
}
if (localStorage.getItem('loggedUser')) { loadAvailableMonths(); }
const toggleMonthsBtn = document.createElement("button");
toggleMonthsBtn.textContent = "ğŸ“…";
toggleMonthsBtn.style.position = "fixed";
toggleMonthsBtn.style.bottom = "25px";
toggleMonthsBtn.style.left = "25px";
toggleMonthsBtn.style.width = "45px";
toggleMonthsBtn.style.height = "45px";
toggleMonthsBtn.style.borderRadius = "50%";
toggleMonthsBtn.style.background = "#007bff";
toggleMonthsBtn.style.color = "white";
toggleMonthsBtn.style.border = "none";
toggleMonthsBtn.style.boxShadow = "0 2px 8px rgba(0,0,0,0.2)";
toggleMonthsBtn.style.cursor = "pointer";
toggleMonthsBtn.style.fontSize = "18px";
toggleMonthsBtn.style.transition = "transform 0.2s ease, background 0.2s ease";
toggleMonthsBtn.onmouseover = () => {
  toggleMonthsBtn.style.transform = "scale(1.1)";
  toggleMonthsBtn.style.background = "#0056b3";
};
toggleMonthsBtn.onmouseout = () => {
  toggleMonthsBtn.style.transform = "scale(1)";
  toggleMonthsBtn.style.background = "#007bff";
};
toggleMonthsBtn.style.zIndex = "1000";
document.body.appendChild(toggleMonthsBtn);
monthTabsDiv.style.display = "none";
toggleMonthsBtn.onclick = () => {
  monthTabsDiv.style.display = monthTabsDiv.style.display === "none" ? "block" : "none";
};

// ========== Ø²Ø± ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ==========
const toggleAdminBtn = document.createElement("button");
toggleAdminBtn.id = "toggleAdminBtn";
toggleAdminBtn.textContent = "âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…";
toggleAdminBtn.style.backgroundColor = "#6c757d";
toggleAdminBtn.style.color = "white";
toggleAdminBtn.style.border = "none";
toggleAdminBtn.style.width = "100%";
toggleAdminBtn.style.padding = "10px";
toggleAdminBtn.style.marginTop = "15px";
toggleAdminBtn.style.fontSize = "16px";
toggleAdminBtn.style.borderRadius = "5px";
toggleAdminBtn.style.cursor = "pointer";
toggleAdminBtn.style.transition = "background 0.2s ease";
toggleAdminBtn.onmouseover = () => { toggleAdminBtn.style.backgroundColor = "#5a6268"; };
toggleAdminBtn.onmouseout = () => {
  if (adminPanel.style.maxHeight === "0px") toggleAdminBtn.style.backgroundColor = "#6c757d";
};
const logoutBtn = document.querySelector("button[onclick='logout()']");
logoutBtn.parentNode.insertBefore(toggleAdminBtn, logoutBtn);
const adminPanel = document.getElementById("adminPanel");
adminPanel.style.maxHeight = "0px";
adminPanel.style.overflow = "hidden";
adminPanel.style.transition = "max-height 0.4s ease";
toggleAdminBtn.onclick = () => {
  if (adminPanel.style.maxHeight === "0px") {
    adminPanel.style.maxHeight = adminPanel.scrollHeight + "px";
    toggleAdminBtn.style.backgroundColor = "green";
  } else {
    adminPanel.style.maxHeight = "0px";
    toggleAdminBtn.style.backgroundColor = "#6c757d";
  }
};

// ========== Ø­Ø°Ù Ù…ØªÙ‚Ø¯Ù… ==========
function advancedDelete() {
  const choice = prompt(
    "Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:\n1 - Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙ‚Ø·\n2 - Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n3 - Ø­Ø°Ù Ø§Ù„ØªØ§Ø´ÙŠØ±Ø§Øª (Ø´ÙØªØŒ Ù†ØµØŒ âŒ)\n4 - Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
  );
  if (!choice || !["1","2","3","4"].includes(choice.trim())) {
    alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­.");
    return;
  }
  const adminPass = prompt("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ØªØ£ÙƒÙŠØ¯:");
  db.ref("users/admin/password").once("value").then(snapshot => {
    const realAdminPass = snapshot.val();
    if (adminPass !== realAdminPass) {
      alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
      return;
    }
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!")) return;
    switch(choice.trim()) {
      case "1":
        db.ref("employees").remove()
          .then(() => alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙ‚Ø·."))
          .catch(e => alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: " + e.message));
        break;
      case "2":
        db.ref("users").remove()
          .then(() => alert("âœ… ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†."))
          .catch(e => alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: " + e.message));
        break;
      case "3":
        db.ref("attendance").remove()
          .then(() => alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ§Ø´ÙŠØ±Ø§Øª."))
          .catch(e => alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ§Ø´ÙŠØ±Ø§Øª: " + e.message));
        break;
      case "4":
        Promise.all([
          db.ref("employees").remove(),
          db.ref("attendance").remove(),
          db.ref("users").once("value").then(snapshot => {
            const users = snapshot.val() || {};
            const updates = {};
            Object.keys(users).forEach(username => {
              if (username !== currentUser) updates[username] = null;
            });
            return db.ref("users").update(updates);
          })
        ]).then(() => {
          alert("âœ… ØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø§ Ø¹Ø¯Ø§ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ.");
        }).catch(e => {
          alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
        });
        break;
    }
  });
}
document.addEventListener("DOMContentLoaded", () => {
  const btnDeleteData = document.getElementById("btnDeleteData");
  if (btnDeleteData) btnDeleteData.addEventListener("click", advancedDelete);
});

// ========== Ø·Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
function checkForcedLogoutOnLogin(userKey) {
  return db.ref("forcedLogout/" + userKey).once("value").then(snapshot => {
    if (snapshot.exists()) {
      localStorage.removeItem('loggedUser');
      alert("âŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.");
      db.ref("forcedLogout/" + userKey).remove();
      location.reload();
      return true;
    }
    return false;
  });
}
if (localStorage.getItem('loggedUser')) {
  const savedUser = JSON.parse(localStorage.getItem('loggedUser'));
  checkForcedLogoutOnLogin(savedUser.user);
}
setInterval(() => {
  if (currentUser) {
    db.ref("forcedLogout/" + currentUser).once("value").then(snapshot => {
      if (snapshot.exists()) {
        localStorage.removeItem('loggedUser');
        alert("âŒ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±.");
        db.ref("forcedLogout/" + currentUser).remove();
        location.reload();
      }
    });
  }
}, 3000);

// ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ==========
function setEmpStatsEnabled(enabled) {
  db.ref("settings/showEmpStats").set(enabled ? true : false);
}
function getEmpStatsEnabled() {
  return db.ref("settings/showEmpStats").once("value").then(snap => !!snap.val());
}
function setEmpStatsMode(mode, value) {
  db.ref("settings/empStatsMode").set({mode, value: value || ""});
}
function getEmpStatsMode() {
  return db.ref("settings/empStatsMode").once("value").then(snap => snap.val() || {mode:"all",value:""});
}
const toggleEmpStatsBtn = document.getElementById("toggleEmpStatsBtn");
const empStatsTab = document.getElementById("empStatsTab");
const empStatsTabContent = document.getElementById("empStatsTabContent");
const closeEmpStatsTab = document.getElementById("closeEmpStatsTab");
if (closeEmpStatsTab) {
  closeEmpStatsTab.onclick = () => { empStatsTab.style.display = "none"; };
}
function openEmpStatsTab(html) {
  empStatsTabContent.innerHTML = html;
  empStatsTab.style.display = "flex";
}
if (toggleEmpStatsBtn) {
  toggleEmpStatsBtn.onclick = function() {
    let html = `
      <div style="margin-bottom:15px;">
        <b>Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:</b>
        <div style="margin-top:7px;">
          <button id="showAllStatsBtn" class="small-button" style="background:#28a745;color:white;">Ø¹Ø±Ø¶ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
          <button id="showUserStatsBtn" class="small-button" style="background:#007bff;color:white;">Ø¹Ø±Ø¶ Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ÙŠÙ†</button>
          <button id="showEmpStatsBtn" class="small-button" style="background:#ffc107;color:black;">Ø¹Ø±Ø¶ Ù„Ù…ÙˆØ¸Ù Ù…Ø¹ÙŠÙ† ÙÙ‚Ø·</button>
        </div>
      </div>
      <div id="empStatsAdminOptions" style="margin-bottom:20px;"></div>
      <div style="border-top:1px solid #eee;margin:10px 0 15px 0;"></div>
      <div>
        <b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</b>
        <div id="empStatsTabNames" style="margin-top:7px;display:flex;flex-wrap:wrap;gap:7px;"></div>
        <div id="empStatsTabResult" style="margin-top:15px;font-size:15px;"></div>
      </div>
    `;
    openEmpStatsTab(html);
    const namesDiv = document.getElementById("empStatsTabNames");
    const resultDiv = document.getElementById("empStatsTabResult");
    namesDiv.innerHTML = "";
    employees.forEach(emp => {
      const btn = document.createElement("button");
      btn.textContent = emp;
      btn.className = "small-button";
      btn.style.background = "#007bff";
      btn.style.color = "white";
      btn.onclick = function() {
        db.ref("attendance").once("value").then(snapshot => {
          const data = snapshot.val() || {};
          let shift = 0, half = 0, x = 0;
          Object.values(data).forEach(day => {
            if (day[emp] === "Ø´ÙØª") shift++;
            if (day[emp] === "Ù†Øµ") half++;
            if (day[emp] === "âŒ") x++;
          });
          resultDiv.innerHTML = `
            <b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${emp}:</b><br>
            âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙØª: <b>${shift}</b><br>
            ğŸŒ“ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Øµ: <b>${half}</b><br>
            ğŸ–ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¬Ø§Ø²Ø§Øª: <b>${x}</b>
          `;
        });
      };
      namesDiv.appendChild(btn);
    });
    document.getElementById("showAllStatsBtn").onclick = function() {
      setEmpStatsEnabled(true);
      setEmpStatsMode("all", "");
      document.getElementById("empStatsAdminOptions").innerHTML = "<span style='color:green'>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>";
    };
    document.getElementById("showUserStatsBtn").onclick = function() {
      db.ref("users").once("value").then(snapshot => {
        const users = snapshot.val() || {};
        let html = "<b>Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…:</b><br>";
        Object.keys(users).forEach(u => {
          html += `<button class="small-button" style="margin:3px 2px;background:#007bff;color:white;" onclick="window.setEmpStatsModeForUser('${u}')">${u}</button>`;
        });
        document.getElementById("empStatsAdminOptions").innerHTML = html;
      });
    };
    document.getElementById("showEmpStatsBtn").onclick = function() {
      let html = "<b>Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù:</b><br>";
      employees.forEach(emp => {
        html += `<button class="small-button" style="margin:3px 2px;background:#ffc107;color:black;" onclick="window.setEmpStatsModeForEmp('${emp}')">${emp}</button>`;
      });
      document.getElementById("empStatsAdminOptions").innerHTML = html;
    };
    window.setEmpStatsModeForUser = function(username) {
      setEmpStatsEnabled(true);
      setEmpStatsMode("user", username);
      document.getElementById("empStatsAdminOptions").innerHTML = `<span style='color:green'>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: <b>${username}</b></span>`;
    };
    window.setEmpStatsModeForEmp = function(emp) {
      setEmpStatsEnabled(true);
      setEmpStatsMode("employee", emp);
      document.getElementById("empStatsAdminOptions").innerHTML = `<span style='color:green'>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù <b>${emp}</b> ÙÙ‚Ø· Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>`;
    };
    getEmpStatsMode().then(modeObj => {
      let txt = "";
      if (modeObj.mode === "all") txt = "<span style='color:green'>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>";
      else if (modeObj.mode === "user") txt = `<span style='color:green'>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: <b>${modeObj.value}</b></span>`;
      else if (modeObj.mode === "employee") txt = `<span style='color:green'>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸Ù <b>${modeObj.value}</b> ÙÙ‚Ø· Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>`;
      document.getElementById("empStatsAdminOptions").innerHTML = txt;
    });
  };
}

// ========== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ==========
const userEmpStatsDiv = document.createElement("div");
userEmpStatsDiv.id = "userEmpStatsDiv";
userEmpStatsDiv.style.margin = "20px 0";
userEmpStatsDiv.style.padding = "10px";
userEmpStatsDiv.style.background = "#f8f9fa";
userEmpStatsDiv.style.border = "1px solid #ddd";
userEmpStatsDiv.style.borderRadius = "7px";
userEmpStatsDiv.style.display = "none";
document.getElementById("mainContent").appendChild(userEmpStatsDiv);

function renderUserEmpStats() {
  Promise.all([getEmpStatsEnabled(), getEmpStatsMode()]).then(([enabled, modeObj]) => {
    if (!enabled) {
      userEmpStatsDiv.style.display = "none";
      return;
    }
    let allow = false, onlyEmp = null;
    if (modeObj.mode === "all") allow = true;
    else if (modeObj.mode === "user" && currentUser === modeObj.value) allow = true;
    else if (modeObj.mode === "employee") { allow = true; onlyEmp = modeObj.value; }
    if (!allow) { userEmpStatsDiv.style.display = "none"; return; }
    let html = "<b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:</b><div id='userEmpStatsNames' style='margin-top:7px;display:flex;flex-wrap:wrap;gap:7px;'></div><div id='userEmpStatsResult' style='margin-top:15px;font-size:15px;'></div>";
    userEmpStatsDiv.innerHTML = html;
    const namesDiv = document.getElementById("userEmpStatsNames");
    const resultDiv = document.getElementById("userEmpStatsResult");
    namesDiv.innerHTML = "";
    employees.forEach(emp => {
      if (onlyEmp && emp !== onlyEmp) return;
      const btn = document.createElement("button");
      btn.textContent = emp;
      btn.className = "small-button";
      btn.style.background = "#007bff";
      btn.style.color = "white";
      btn.onclick = function() {
        db.ref("attendance").once("value").then(snapshot => {
          const data = snapshot.val() || {};
          let shift = 0, half = 0, x = 0;
          Object.values(data).forEach(day => {
            if (day[emp] === "Ø´ÙØª") shift++;
            if (day[emp] === "Ù†Øµ") half++;
            if (day[emp] === "âŒ") x++;
          });
          resultDiv.innerHTML = `
            <b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${emp}:</b><br>
            âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙØª: <b>${shift}</b><br>
            ğŸŒ“ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Øµ: <b>${half}</b><br>
            ğŸ–ï¸ Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø¬Ø§Ø²Ø§Øª: <b>${x}</b>
          `;
        });
      };
      namesDiv.appendChild(btn);
    });
    userEmpStatsDiv.style.display = "block";
  });
}
function tryShowUserEmpStats() {
  if (typeof employees !== "undefined" && employees.length > 0) renderUserEmpStats();
}
const origLoadEmployees = loadEmployees;
loadEmployees = function() {
  return origLoadEmployees.apply(this, arguments).then(() => {
    tryShowUserEmpStats();
  });
};
if (localStorage.getItem('loggedUser')) tryShowUserEmpStats();
db.ref("settings/empStatsMode").on("value", () => renderUserEmpStats());

// Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
function deleteEmployee(index) {
  const empName = employees[index];
  if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù "${empName}"ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±Ù‡ Ø£ÙŠØ¶Ø§.`)) return;
  // Ø§Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  employees.splice(index, 1);
  // Ø­Ø¯Ø« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  db.ref("employees").set(employees)
    .then(() => {
      // Ø§Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…
      db.ref("attendance").once("value").then(snapshot => {
        const attendance = snapshot.val() || {};
        Object.keys(attendance).forEach(dayKey => {
          if (attendance[dayKey][empName] !== undefined) {
            delete attendance[dayKey][empName];
          }
        });
        return db.ref("attendance").set(attendance);
      }).then(() => {
        alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ±Ù‡ Ø¨Ù†Ø¬Ø§Ø­.");
        loadEmployeesTable();
        generateTable();
        logActivity("Ø­Ø°Ù Ù…ÙˆØ¸Ù", empName); // <-- Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ù‡Ù†Ø§
      });
    })
    .catch(err => {
      console.error(err);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù.");
    });
}

// Ø²Ø± ÙØªØ­ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
document.getElementById("btnFeaturesTab").onclick = function() {
  document.getElementById("featuresTab").style.display = "flex";
  renderFeaturesTab();
};
document.getElementById("closeFeaturesTab").onclick = function() {
  document.getElementById("featuresTab").style.display = "none";
};

// ========== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ==========
function renderFeaturesTab() {
  let html = `
    <div class="feature-section">
      <h4>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h4>
      <div id="activityLogBox" style="min-height:40px;text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
    <div class="feature-section">
      <h4>ğŸ”” Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
      <input type="text" id="notifyMsg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§" style="width:100%;margin-bottom:7px;" maxlength="120"/>
      <button id="sendNotifyBtn" style="background:#2196f3;color:white;padding:7px 15px;border-radius:5px;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
      <div id="notifyStatus" style="margin-top:7px;font-size:13px;color:#388e3c;"></div>
    </div>
    <div class="feature-section">
      <h4>ğŸ”„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±</h4>
      <input type="password" id="adminOldPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" style="width:100%;margin-bottom:7px;" />
      <input type="password" id="adminNewPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" style="width:100%;margin-bottom:7px;" />
      <button id="changeAdminPassBtn" style="background:#ff9800;color:white;padding:7px 15px;border-radius:5px;">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
      <div id="adminPassStatus" style="margin-top:7px;font-size:13px;color:#388e3c;"></div>
    </div>
    <div class="feature-section">
      <h4>ğŸ—‚ï¸ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
      <button onclick="backupData()" style="background:#4caf50;color:white;padding:7px 15px;border-radius:5px;">ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
      <div id="backupStatus" style="margin-top:7px;font-size:13px;color:#388e3c;"></div>
    </div>
  `;
  document.getElementById("featuresTabContent").innerHTML = html;
  loadActivityLog();

  // Ø¥ØµÙ„Ø§Ø­ Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  document.getElementById("sendNotifyBtn").onclick = sendNotification;

  // Ø¥ØµÙ„Ø§Ø­ Ø²Ø± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±
  document.getElementById("changeAdminPassBtn").onclick = changeAdminPassword;
}

// ========== Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª ==========
function logActivity(action, details) {
  if (!currentUser) return; // Ø¥ØµÙ„Ø§Ø­: Ù„Ø§ ØªØ³Ø¬Ù„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…
  const now = new Date();
  const dateStr = now.toLocaleDateString('ar-EG');
  const timeStr = now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute:'2-digit', second:'2-digit' });
  const log = {
    user: currentUser,
    action,
    details,
    date: dateStr,
    time: timeStr
  };
  db.ref("activityLog").push(log);
}

function loadActivityLog() {
  db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
    const logs = [];
    snapshot.forEach(child => logs.push(child.val()));
    logs.reverse();
    let html = `<table class="activity-log-table">
      <tr>
        <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
        <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
        <th>ØªÙØ§ØµÙŠÙ„</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„ÙˆÙ‚Øª</th>
      </tr>`;
    if (logs.length === 0) {
      html += `<tr><td colspan="5">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`;
    } else {
      logs.forEach(log => {
        html += `<tr>
          <td>${log.user || ""}</td>
          <td>${log.action || ""}</td>
          <td>${log.details || ""}</td>
          <td>${log.date || ""}</td>
          <td>${log.time || ""}</td>
        </tr>`;
      });
    }
    html += `</table>`;
    const box = document.getElementById("activityLogBox");
    if (box) box.innerHTML = html;
  });
}

// ========== Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ==========
function sendNotification() {
  const msgInput = document.getElementById("notifyMsg");
  const statusDiv = document.getElementById("notifyStatus");
  const msg = msgInput.value.trim();
  if (!msg) {
    statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©.";
    return;
  }
  db.ref("notifications").push({
    msg,
    date: new Date().toLocaleString('ar-EG'),
    from: currentUser
  }).then(() => {
    statusDiv.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.";
    msgInput.value = "";
    logActivity("Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±", msg);
  }).catch(() => {
    statusDiv.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±.";
  });
}

// ========== ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± ==========
function changeAdminPassword() {
  const oldPass = document.getElementById("adminOldPass").value;
  const newPass = document.getElementById("adminNewPass").value;
  const statusDiv = document.getElementById("adminPassStatus");
  if (!oldPass || !newPass) {
    statusDiv.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.";
    return;
  }
  db.ref("users/admin/password").once("value").then(snapshot => {
    if (!snapshot.exists() || snapshot.val() !== oldPass) {
      statusDiv.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
      return;
    }
    db.ref("users/admin/password").set(newPass).then(() => {
      statusDiv.textContent = "âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.";
      document.getElementById("adminOldPass").value = "";
      document.getElementById("adminNewPass").value = "";
      logActivity("ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±", "ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");
    });
  }).catch(() => {
    statusDiv.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.";
  });
}

// ========== Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
function backupData() {
  document.getElementById("backupStatus").textContent = "Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ø³Ø®Ø©...";
  Promise.all([
    db.ref("employees").once("value"),
    db.ref("attendance").once("value"),
    db.ref("users").once("value")
  ]).then(([empSnap, attSnap, usersSnap]) => {
    const data = {
      employees: empSnap.val() || {},
      attendance: attSnap.val() || {},
      users: usersSnap.val() || {}
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "backup-" + new Date().toISOString().slice(0,10) + ".json";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 500);
    document.getElementById("backupStatus").textContent = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.";
    logActivity("ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  });
}
</script>
</body>
</htm
