<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نظام حضور هي هي </title>
  <meta name="description" content="نظام حضور وانصراف الموظفين - سجل حضور الموظفين وغيابهم بسهولة واحترافية. برنامج حضور وانصراف عربي مجاني وسهل الاستخدام.">
  <meta name="keywords" content="نظام حضور, نظام حضور وانصراف, برنامج حضور, برنامج حضور وانصراف, حضور الموظفين, نظام حضور هي هي, سجل حضور, attendance system, employee attendance, حضور الكتروني, برنامج دوام, نظام دوام, حضور وانصراف مجاني, حضور وانصراف عربي">
  <meta name="robots" content="index, follow">
  <script src="crypto-utils.js"></script>
  <style>
    #adminPanel {
      box-shadow: 0 2px 12px rgba(151, 86, 86, 0.067);
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      background-color: #f4f4f4;
      margin: 0; padding: 0;
    }
    .container {
      max-width: 700px;
      margin: auto;
      padding: 20px;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    h2 { text-align: center; color: #333; }
    input, button, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background-color: #0056b3; }
    button:active { background-color: #1976d2; }
    #mainContent, #adminPanel { display: none; }
    #attendanceTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    #attendanceTable th {
      border: 1px solid #000000;
      padding: 10px 8px;
      text-align: center;
      background: #000000;
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.5px;
      border-bottom: 2.5px solid #000000;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      transition: background 0.2s;
      box-shadow: 0 2px 8px #e3eafc;
    }
    @media (max-width: 767px) {
      #attendanceTable th {
        font-size: 15px;
        padding: 7px 4px;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
      }
    }
    #attendanceTable td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }
    .editor-tag { font-size: 12px; color: #555; }
    .error { color: red; text-align: center; margin: 10px 0; }
    .loading { text-align: center; color: #666; margin: 10px 0; }
    #adminPanel { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
    #adminPanel h3 { margin-top: 0; text-align: center; }
    table#usersTable, table#employeesTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table#usersTable th, table#usersTable td,
    table#employeesTable th, table#employeesTable td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .small-button {
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 3px;
    }
    .btn-edit { background-color: #28a745; color: white; border: none; }
    .btn-delete { background-color: #dc3545; color: white; border: none; }
    .btn-toggle { background-color: #ffc107; color: black; border: none; }
    @media (max-width: 767px) {
      .container { padding: 10px; }
      input, button, select { font-size: 14px; padding: 8px; }
      #attendanceTable th, #attendanceTable td { font-size: 18px; padding: 3px; }
    }
    .tooltip-wrapper { position: relative; display: inline-block; cursor: help; }
    .tooltip-wrapper .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #361fa7;
      color: #fff;
      text-align: right;
      padding: 8px;
      border-radius: 6px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      right: 50%;
      transform: translateX(50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      line-height: 1.4;
    }
    .tooltip-wrapper.show .tooltip-text { visibility: visible; opacity: 1; }
    .checkbox-label {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }
    .checkbox-label input[type="checkbox"] {
      transform: none;
      vertical-align: middle;
      margin: 0;
    }
    #sidebarMenu {
      position: fixed;
      top: 0;
      right: 0;
      width: 0;
      height: 100vh;
      background: #fff;
      box-shadow: -2px 0 12px #0002;
      overflow-x: hidden;
  transition: width 0.13s cubic-bezier(.4,1.4,.6,1), padding-top 0.13s cubic-bezier(.4,1.4,.6,1);
      z-index: 5000;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding-top: 0;
    }
    #sidebarMenu.open {
      width: 210px;
      padding-top: 30px;
    }
    #sidebarMenu .sidebar-header {
      width: 100%;
      padding: 14px 18px 8px 18px;
      background: #007bff;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      text-align: right;
      border-bottom: 1px solid #eee;
      letter-spacing: 0.5px;
    }
    #sidebarMenu button {
      width: 88%;
      margin: 8px 6%;
      padding: 8px;
      font-size: 15px;
      border-radius: 6px;
      border: none;
      background: #f4f4f4;
      color: #333;
      cursor: pointer;
      text-align: right;
  transition: background 0.08s;
    }
    #sidebarMenu button:hover {
      background: #e0e0e0;
      transition: background 0.08s;
    }
    #sidebarToggleBtn, #sidebarCloseBtn {
      position: fixed;
      top: 14px;
      right: 14px;
      width: 34px;
      height: 34px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      z-index: 5100;
      box-shadow: 0 2px 8px #0002;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    #sidebarCloseBtn {
      background: rgba(0,0,0,0.08);
      color: #333;
      font-size: 18px;
      border: none;
      box-shadow: none;
      width: 30px;
      height: 30px;
      right: 18px;
      top: 18px;
      opacity: 0.7;
    }
    #sidebarCloseBtn:hover {
      background: #f4f4f4;
      opacity: 1;
    }
    @media (max-width: 600px) {
      #sidebarMenu.open {
        width: 75vw;
        max-width: 340px;
        min-width: 180px;
        border-top-left-radius: 18px;
        border-bottom-left-radius: 18px;
        transition: width 0.13s cubic-bezier(.4,1.4,.6,1);
      }
      #sidebarMenu {
        transition: width 0.13s cubic-bezier(.4,1.4,.6,1), padding-top 0.13s cubic-bezier(.4,1.4,.6,1);
        border-top-left-radius: 18px;
        border-bottom-left-radius: 18px;
      }
      #sidebarToggleBtn, #sidebarCloseBtn { right: 8px; top: 8px; }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- نافذة تفاصيل اليوم -->
  <div id="dayDetailsModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:10000;align-items:center;justify-content:center;">
    <div style="background:#fff;max-width:420px;width:97vw;max-height:90vh;overflow:auto;border-radius:16px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;">
      <button id="closeDayDetailsModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
      <div id="dayDetailsTitle" style="font-size:20px;color:#1976d2;font-weight:600;text-align:center;margin-bottom:12px;"></div>
      <div id="dayDetailsTable"></div>
      <div id="dayDetailsStatus" style="margin-top:10px;font-size:14px;text-align:center;"></div>
    </div>
  </div>
  <!-- عنصر التحميل الاحترافي -->
  <div id="loaderSpinner" style="display:none;justify-content:center;align-items:center;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.55);z-index:99999;">
    <div style="display:flex;flex-direction:column;align-items:center;">
          <div style="background:linear-gradient(135deg,#e3f0ff 60%,#cbe6ff 100%);padding:10px;border-radius:50%;box-shadow:0 6px 32px #1976d244;display:flex;justify-content:center;align-items:center;margin-bottom:12px;">
            <img id="loaderUserImg" src="sticker.webp" alt="صورة المستخدم" style="width:140px;height:140px;border-radius:50%;object-fit:cover;object-position:top center;box-shadow:0 2px 18px #1976d244;">
          </div>
          <div style="color:#1976d2;font-size:20px;font-weight:600;letter-spacing:0.5px;">اصبر النت ضعيف والله...</div>
          <div style="color:#555;font-size:15px;margin-top:7px;">يتم تحميل البيانات بشكل آمن</div>
    </div>
    <style>
      .loader-user-img {
        animation: rotateUserImg 1.1s linear infinite;
      }
      @keyframes rotateUserImg {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </div>

  <!-- تسجيل الدخول -->
  <div id="loginBox">
    <div style="display:flex;justify-content:center;align-items:center;margin-bottom:22px;">
      <div class="login-user-img-wrapper">
        <img src="sticker.webp" alt="صورة المستخدم" class="login-user-img">
      </div>
    </div>
    <style>
      .login-user-img-wrapper {
        background: linear-gradient(135deg,#90caf9 0%,#e3f0ff 60%,#cbe6ff 100%);
        padding: 13px;
        border-radius: 50%;
        box-shadow: 0 8px 32px #1976d244, 0 2px 18px #1976d244;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: box-shadow 0.2s, transform 0.2s;
      }
      .login-user-img-wrapper:hover {
        box-shadow: 0 16px 48px #1976d288, 0 4px 24px #1976d244;
        transform: scale(1.04);
      }
      .login-user-img {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        object-fit: cover;
        object-position: top center;
        box-shadow: 0 2px 18px #1976d244, 0 0px 0px #fff;
        border: 4px solid #fff;
        transition: box-shadow 0.2s, border 0.2s;
      }
      .login-user-img-wrapper:hover .login-user-img {
        box-shadow: 0 8px 32px #1976d288, 0 2px 18px #1976d244;
        border: 4px solid #90caf9;
      }
    </style>
    <h2>تسجيل الدخول</h2>
    <input type="text" id="username" placeholder="اسم المستخدم" autocomplete="off" />
    <input type="password" id="password" placeholder="كلمة المرور" autocomplete="off" />
    <button onclick="login()">دخول</button>
    <div id="loginMessage"></div>
    <div style="text-align:center; margin-top:10px; font-size:14px; color:#555; font-style:italic; line-height:1.3;">
      بتصميم المهندس سجاد رشيد<br />
      insta: e ._ mg
    </div>
  </div>

  <!-- المحتوى الرئيسي وجدول الحضور -->
  <div id="mainContent">
    <h2>📋 جدول الحضور </h2>
    <button id="btnDownloadPDF" style="margin-bottom:10px;" onclick="downloadPDF()">⬇️ تحميل PDF</button>
    <table id="attendanceTable">
      <thead>
        <tr>
          <th id="dateHeaderTh" style="background: linear-gradient(90deg, #e3f0ff 0%, #cbe6ff 100%); color: #1976d2; font-weight: bold; font-size: 18px; border-bottom: 2.5px solid #90caf9; letter-spacing: 0.5px; display:none;">التاريخ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
<style>
  .day-details-table { width:100%; border-collapse:collapse; margin-bottom:8px; }
  .day-details-table th, .day-details-table td { border:1px solid #e0e0e0; padding:7px 4px; text-align:center; }
  .day-details-table th { background:#e3f0ff; color:#1976d2; font-size:16px; }
  .day-details-select { width:100%; padding:6px; border-radius:6px; border:1px solid #ccc; font-size:15px; }
  .day-details-user { font-size:13px; color:#888; }
  .day-details-time { font-size:12px; color:#aaa; }
  @media (max-width:600px) { .day-details-table th, .day-details-table td { font-size:13px; padding:5px 2px; } }
</style>
    <button onclick="saveData()">💾 حفظ التعديلات</button>
    <button onclick="logout()" style="background-color: #dc3545; margin-top: 10px;">🚪 تسجيل خروج</button>
  <h3 style="margin-top:20px;">📊 الإحصائيات</h3>
  <div id="statsBox">—</div>
  <!-- إحصائيات الموظفين أسفل الجدول -->
  <div id="empStatsBelowTable" style="margin:30px 0 0 0;"></div>
  </div>

  <!-- مكان ظهور إحصائيات الموظفين أسفل جدول الحضور -->
  <div id="empStatsBelowTable" style="margin:30px 0 0 0;"></div>
  <!-- لوحة تحكم الـ Admin -->
  <div id="adminPanel" style="display:none">
    <h3>لوحة تحكم المدير</h3>
    <h4>إدارة الموظفين</h4>
    <input type="text" id="newEmployeeName" placeholder="اسم الموظف الجديد" />
    <button onclick="addEmployee()">➕ إضافة موظف</button>
    <table id="employeesTable">
      <thead>
        <tr><th>اسم الموظف</th><th>حذف</th></tr>
      </thead>
      <tbody id="employeesBody"></tbody>
    </table>
    <hr />
    <h4>إدارة المستخدمين</h4>
    <input type="text" id="newUserName" placeholder="اسم المستخدم الجديد" />
    <input type="password" id="newUserPass" placeholder="كلمة المرور" />
    <label class="checkbox-label">
      <input type="checkbox" id="newUserCanEdit" checked />صلاحية تعديل الجدول
    </label>
    <button onclick="addUser()">➕ إنشاء مستخدم</button>
    <table id="usersTable">
      <thead>
        <tr>
          <th>اسم المستخدم</th>
          <th>الصلاحية (تعديل؟)</th>
          <th>تغيير الصلاحية</th>
          <th>حذف المستخدم</th>
          <th>تسجيل خروج إجباري</th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
    <button id="toggleEmpStatsBtn" style="background:#17a2b8;color:white;font-size:13px;padding:7px 12px;margin-bottom:10px;cursor:pointer;">
      📊 تفاصيل إحصائيات الموظفين
    </button>
    <div id="empStatsTab" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:2000;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:500px;width:95vw;max-height:90vh;overflow:auto;border-radius:12px;box-shadow:0 8px 32px #0002;padding:25px 20px 20px 20px;position:relative;">
        <button id="closeEmpStatsTab" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
        <h3 style="text-align:center;margin-bottom:18px;">📊 إحصائيات الموظفين</h3>
        <div id="empStatsTabContent"></div>
      </div>
    </div>
    <button id="btnDeleteData" style="background-color:#dc3545; color:white; font-size:12px; padding:5px 10px; margin-top:15px; cursor:pointer;">
      🗑️ حذف بيانات متقدمة
    </button>
    <!-- أضف زر الميزات المتقدمة بعد زر حذف البيانات المتقدمة في لوحة التحكم -->
    <button id="btnFeaturesTab" style="background:#673ab7;color:white;font-size:13px;padding:7px 12px;margin-bottom:10px;cursor:pointer;">
      ⭐️سجل النشاطات
    </button>
    <div id="featuresTab" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:3000;align-items:center;justify-content:center;">
      <div style="background:#fff;max-width:520px;width:97vw;max-height:92vh;overflow:auto;border-radius:14px;box-shadow:0 8px 32px #0002;padding:25px 18px 18px 18px;position:relative;">
        <button id="closeFeaturesTab" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#673ab7;">⭐️ تفاصيل السجلات</h3>
        <div id="featuresTabContent"></div>
      </div>
    </div>
    <style>
      @media (max-width: 600px) {
        #featuresTab > div {
          max-width: 99vw !important;
          padding: 10px 2vw 10px 2vw !important;
        }
        #featuresTab h3 { font-size: 18px !important; }
      }
      .feature-section {
        background: #f6f8fa;
        border-radius: 10px;
        margin-bottom: 18px;
        padding: 13px 12px;
        box-shadow: 0 1px 6px #0001;
      }
      .feature-section h4 {
        margin: 0 0 7px 0;
        color: #3f51b5;
        font-size: 16px;
      }
      .activity-log-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 7px;
        font-size: 14px;
      }
      .activity-log-table th, .activity-log-table td {
        border: 1px solid #ccc;
        padding: 5px 4px;
        text-align: center;
      }
      .activity-log-table th {
        background: #ede7f6;
        color: #673ab7;
      }
    </style>
  </div>
</div>

<!-- تم حذف الأنماط المكررة للـ sidebarMenu لتقليل التكرار -->
<button id="sidebarToggleBtn" style="display:none;">☰</button>
<button id="sidebarCloseBtn" style="display:none;">✖</button>
<div id="sidebarMenu">
  <div class="sidebar-header" id="sidebarUserName"></div>
  <button onclick="saveData()" style="background:#0dc149;color:white;"> 💾 حفظ التعديلات</button>
  <button onclick="logout()" style="background:#dc3545;color:white;">🚪 تسجيل خروج</button>
  <button id="sidebarAdminBtn" style="background:#000000;color:white;display:none;">⚙️ لوحة التحكم</button>
  <button id="sidebarMonthsManagerBtn" style="background:#1976d2;color:white;display:none;margin-top:2px;">📅 إدارة الأشهر</button>
  <button id="sidebarEmpStatsBtn" style="background:#17a2b8;color:white;display:none;">📊 تفاصيل إحصائيات الموظفين</button>
  <button id="sidebarNotificationsBtn" style="background:#ff4081;color:white;display:none;">🔔 الإشعارات</button>
  <button id="sidebarDeleteDataBtn" style="background:#dc3545;color:white;display:none;">🗑️ حذف بيانات متقدمة</button>
  <button id="sidebarFeaturesTabBtn" style="background:#673ab7;color:white;display:none;">⭐️سجل النشاطات</button>
  <button id="sidebarChangePassBtn" style="background:#2196f3;color:white;">🔑 تغيير كلمة المرور</button>
  <!-- أضف زر التحكم في صلاحيات سجل النشاطات للمدير في القائمة الجانبية -->
  <button id="sidebarUserControlBtn" style="background:#009688;color:white;display:none;">👥 صلاحيات سجل النشاطات</button>
  <!-- زر الملاحظات -->
  <button id="sidebarNotesBtn" style="background:#ffb300;color:#333;display:none;">📝 الملاحظات</button>
  <!-- زر إعدادات الملاحظات للمدير فقط -->
  <button id="sidebarNotesSettingsBtn" style="background:#ff9800;color:#222;display:none;">⚙️ إعدادات الملاحظات</button>
  <!-- أزرار إدارة قاعدة البيانات -->

</div>
<script>
// دالة فتح نافذة تفاصيل اليوم
function showDayDetailsModal(dayKey, dayLabel) {
  const modal = document.getElementById("dayDetailsModal");
  const titleDiv = document.getElementById("dayDetailsTitle");
  const tableDiv = document.getElementById("dayDetailsTable");
  const statusDiv = document.getElementById("dayDetailsStatus");
  titleDiv.textContent = `تفاصيل يوم: ${dayLabel}`;
  statusDiv.textContent = "";
  const monthKey = `${year}_${(month+1).toString().padStart(2,'0')}`;
  db.ref(`dayDetails/${monthKey}/${dayKey}`).once("value").then(snap => {
    const data = snap.val() || {};
    // استخدم DocumentFragment لتجميع الصفوف
    const fragment = document.createDocumentFragment();
    // رأس الجدول
    const table = document.createElement('table');
    table.className = 'day-details-table';
    const thead = document.createElement('thead');
    thead.innerHTML = `<tr><th>الموظف</th><th>الاختيار</th><th>آخر تعديل</th></tr>`;
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    employees.forEach(emp => {
      const val = data[emp]?.value || "";
      const user = data[emp]?.user || "—";
      const time = data[emp]?.time || "—";
      const tr = document.createElement('tr');
      // اسم الموظف
      const tdEmp = document.createElement('td');
      tdEmp.textContent = emp;
      tr.appendChild(tdEmp);
      // قائمة الاختيار
      const tdSelect = document.createElement('td');
      const select = document.createElement('select');
      select.className = 'day-details-select';
      select.setAttribute('data-emp', emp);
      ["—", "600", "22", "مشتركة", "❌"].forEach(optionVal => {
        const option = document.createElement('option');
        option.value = optionVal === "—" ? "" : optionVal;
        option.textContent = optionVal;
        if (val === option.value) option.selected = true;
        select.appendChild(option);
      });
      tdSelect.appendChild(select);
      tr.appendChild(tdSelect);
      // آخر تعديل
      const tdEdit = document.createElement('td');
      let userColor = (user === "admin") ? "#1fa745" : (user === "—" ? "#555" : "#dc3545");
      function toEnglishDate(str) {
        if (!str || str === "—") return "—";
        return str.replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d)).replace(/،/g, ",");
      }
      tdEdit.innerHTML = `<span class='day-details-user' style='color:${userColor};font-weight:bold;'>${user}</span><br><span class='day-details-time' style='color:#000;'>${toEnglishDate(time)}</span>`;
      tr.appendChild(tdEdit);
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    fragment.appendChild(table);
    // زر الحفظ
    const saveBtn = document.createElement('button');
    saveBtn.id = 'saveDayDetailsBtn';
    saveBtn.textContent = '💾 حفظ التعديلات';
    saveBtn.style = 'background:#1976d2;color:white;padding:8px 18px;border:none;border-radius:7px;font-size:16px;margin-top:8px;cursor:pointer;';
    fragment.appendChild(saveBtn);
    tableDiv.innerHTML = '';
    tableDiv.appendChild(fragment);
    modal.style.display = "flex";
    document.getElementById("closeDayDetailsModal").onclick = function() { modal.style.display = "none"; };
    saveBtn.onclick = function() {
      const selects = tableDiv.querySelectorAll(".day-details-select");
      const updates = {};
      let changed = false;
      employees.forEach(emp => {
        const sel = Array.from(selects).find(s => s.getAttribute("data-emp") === emp);
        const newValue = sel ? sel.value : "";
        const oldValue = data[emp]?.value || "";
        if (newValue !== oldValue) {
          updates[emp] = { value: newValue, user: currentUser, time: new Date().toLocaleString('ar-EG') };
          changed = true;
        } else if (data[emp]) {
          updates[emp] = data[emp];
        }
      });
      if (!changed) {
        statusDiv.textContent = "لا يوجد أي تعديل لحفظه.";
        return;
      }
      db.ref(`dayDetails/${monthKey}/${dayKey}`).set(updates).then(()=>{
        statusDiv.textContent = "✅ تم حفظ التعديلات";
        setTimeout(()=>{ modal.style.display = "none"; }, 900);
      });
    };
  });
}
// دالة تتحقق أن الشهر المعروض هو الشهر الحالي
function isCurrentMonthSelected() {
  const now = new Date();
  return (month === now.getMonth() && year === now.getFullYear());
}

// دالة منع التعديل على الأشهر السابقة
function preventEditIfNotCurrentMonth() {
  if (!isCurrentMonthSelected()) {
    alert('❌ لا يمكن التعديل أو الحذف أو الإضافة على بيانات الأشهر السابقة.');
    return false;
  }
  return true;
}
  // زر إعدادات الملاحظات (للمدير فقط)
document.getElementById("sidebarNotesSettingsBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  setTimeout(showNotesSettingsTab, 100);
};

  // نافذة إعدادات الملاحظات
  function showNotesSettingsTab() {
    let modal = document.getElementById("notesSettingsModal");
    if (!modal) {
      modal = document.createElement("div");
      modal.id = "notesSettingsModal";
      modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:8000;display:flex;align-items:center;justify-content:center;`;
      modal.innerHTML = `
        <div style=\"background:#fff;max-width:440px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:30px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;border:2px solid #ff9800;\">
          <button id=\"closeNotesSettingsBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">✖</button>
          <div style=\"font-size:20px;color:#ff9800;margin-bottom:18px;font-weight:600;text-align:center;\">⚙️ إعدادات صلاحيات الملاحظات</div>
          <div id=\"notesSettingsContent\" style=\"overflow-y:auto;max-height:60vh;\">جاري التحميل...</div>
        </div>
        <style>
          @media (max-width: 600px) {
            #notesSettingsModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
            #notesSettingsModal div { font-size:16px !important; }
          }
          #closeNotesSettingsBtn:hover { background:#b71c1c !important; }
        </style>
      `;
      document.body.appendChild(modal);
      document.getElementById("closeNotesSettingsBtn").onclick = function() { modal.remove(); };
    } else {
      modal.style.display = "flex";
    }
    // تحميل المستخدمين وصلاحياتهم
    db.ref("users").once("value").then(snapshot => {
      const users = snapshot.val() || {};
      let html = `<table style='width:100%;border-collapse:collapse;margin-bottom:10px;'>
        <tr><th style='background:#f6f6f6;'>المستخدم</th><th style='background:#f6f6f6;'>صلاحية الملاحظات</th></tr>`;
      Object.entries(users).forEach(([username, data]) => {
        if (username === "admin") return;
        const perm = data.notesPermission || "edit";
        html += `<tr>
          <td style='padding:7px 4px;'>${username}</td>
          <td style='padding:7px 4px;'>
            <select data-user='${username}' class='notePermSelect' style='font-size:15px;'>
              <option value='edit' ${perm==="edit"?"selected":""}>يستطيع التعديل</option>
              <option value='read' ${perm==="read"?"selected":""}>قراءة فقط</option>
              <option value='none' ${perm==="none"?"selected":""}>مخفي تمامًا</option>
            </select>
          </td>
        </tr>`;
      });
      html += `</table><div style='font-size:13px;color:#555;'>حدد صلاحية الملاحظات لكل مستخدم. التغيير فوري.</div>`;
      document.getElementById("notesSettingsContent").innerHTML = html;
      Array.from(document.getElementsByClassName("notePermSelect")).forEach(sel => {
        sel.onchange = function() {
          const user = sel.getAttribute("data-user");
          const val = sel.value;
          db.ref("users/"+user+"/notesPermission").set(val).then(()=>{
            logActivity("تغيير صلاحية الملاحظات","تم تغيير صلاحية الملاحظات للمستخدم: "+user+" إلى: "+(val==="edit"?"تعديل":val==="read"?"قراءة فقط":"مخفي"));
            updateSidebarVisibility();
          });
        };
      });
    });
  }
  // زر فتح تبويبة الملاحظات
  document.getElementById("sidebarNotesBtn").onclick = function() {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(showNotesTab, 100);
  };

  // تبويبة الملاحظات الاحترافية
  function showNotesTab() {
    let notesTab = document.getElementById("notesTab");
    if (!notesTab) {
      notesTab = document.createElement("div");
      notesTab.id = "notesTab";
      notesTab.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:7000;display:flex;align-items:center;justify-content:center;`;
      notesTab.innerHTML = `
        <div style=\"background:#fff;max-width:430px;width:97vw;border-radius:16px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;\">
          <button id=\"closeNotesTabBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">✖</button>
          <div style=\"font-size:20px;color:#333;margin-bottom:18px;font-weight:600;text-align:center;\">📝 ملاحظات الموظفين</div>
          <div id=\"notesTabContent\" style=\"overflow-y:auto;max-height:60vh;\"></div>
        </div>
        <style>
          @media (max-width: 600px) {
            #notesTab > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
            #notesTab div { font-size:16px !important; }
          }
          #closeNotesTabBtn:hover { background:#b71c1c !important; }
        </style>
      `;
      document.body.appendChild(notesTab);
      document.getElementById("closeNotesTabBtn").onclick = function() { notesTab.remove(); };
    } else {
      notesTab.style.display = "flex";
    }
    renderNotesTabContent();
  }

  // عرض صناديق الملاحظات لكل موظف
  function renderNotesTabContent() {
    // إذا تم استدعاء الدالة من نافذة الملاحظات الجانبية، أظهرها هناك، وإلا أظهرها أسفل الجدول
    let notesDiv = document.getElementById("notesTabContent");
    let notesSection = document.getElementById("notesSection");
    if (notesSection && notesSection.style.display !== "none") {
      notesDiv = notesSection.querySelector("#notesTabContent");
    }
    notesDiv.innerHTML = "جاري التحميل...";
    // جلب بيانات الملاحظات، الحضور، الرواتب دفعة واحدة
    Promise.all([
      db.ref("notes").once("value"),
      db.ref("attendance").once("value"),
      db.ref("salaries").once("value"),
      db.ref("users/"+currentUser).once("value")
    ]).then(([notesSnap, attSnap, salSnap, userSnap]) => {
      const notes = notesSnap.val() || {};
      const attendance = attSnap.val() || {};
      const salaries = salSnap.val() || {};
      const userData = userSnap.val() || {};
      const perm = userData.notesPermission || "edit";
      // حساب إحصائيات الحضور لكل موظف
      const stats = {};
      employees.forEach(emp => { stats[emp] = { shift: 0, half: 0, vac: 0 }; });
      Object.entries(attendance).forEach(([dateStr, day]) => {
        // فقط الشهر الحالي
        let parts = dateStr.split("-");
        if (parts.length === 3) {
          let dYear = parseInt(parts[0]);
          let dMonth = parseInt(parts[1]) - 1;
          if (dYear === year && dMonth === month) {
            employees.forEach(emp => {
              const val = day[emp];
              if (val === "شفت") stats[emp].shift++;
              if (val === "نص") stats[emp].half++;
              if (val === "❌") stats[emp].vac++;
            });
          }
        }
      });
      let html = "";
      employees.forEach(emp => {
        let noteVal = notes[emp] ? notes[emp] : "";
        let isEmpty = noteVal.trim() === "";
        html += `<div class="note-box" style="border:1.5px solid #e3eafc; margin:18px 0 22px 0; border-radius:13px; background:linear-gradient(135deg,#f8fafc 70%,#e3eafc 100%); box-shadow:0 2px 12px #3f51b511; transition:box-shadow 0.2s;">`;
        // اسم الموظف
        html += `<div style=\"font-weight:700; color:#3f51b5; font-size:18px; padding:13px 16px 0 16px; letter-spacing:0.2px;\">👤 ${emp}</div>`;
        // خانة الملاحظة وزر الحفظ
        if (perm === "edit") {
          html += `<textarea id='noteInput_${emp}' style='width:94%;min-height:60px;margin:13px 3%;border-radius:8px;border:1.2px solid #bfc7e3;padding:9px;font-size:15.5px;resize:vertical;background:#fff;transition:border 0.2s;'>${noteVal}</textarea>`;
          html += `<div style='display:flex;align-items:center;justify-content:space-between;margin:0 3% 13px 3%;'>`;
          html += isEmpty ? `<span style='color:#b0b0b0;font-size:13px;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>🛈</span>لا توجد ملاحظة بعد</span>` : `<span style='color:#607d8b;font-size:13px;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>📝</span>تمت آخر مراجعة</span>`;
          html += `<button class='saveNoteBtn' data-emp='${emp}' style='background:linear-gradient(90deg,#3f51b5 60%,#5c6bc0 100%);color:white;padding:7px 22px;border:none;border-radius:7px;font-size:15.5px;cursor:pointer;box-shadow:0 2px 8px #3f51b522;font-weight:600;transition:background 0.2s;'>💾 حفظ</button>`;
          html += `</div>`;
        } else if (perm === "read") {
          html += `<textarea id='noteInput_${emp}' style='width:94%;min-height:60px;margin:13px 3%;border-radius:8px;border:1.2px solid #bfc7e3;padding:9px;font-size:15.5px;background:#f5f7fa;resize:vertical;' readonly>${noteVal}</textarea>`;
          html += isEmpty ? `<div style='color:#b0b0b0;font-size:13px;padding:0 3% 13px 3%;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>🛈</span>لا توجد ملاحظة بعد</div>` : `<div style='color:#607d8b;font-size:13px;padding:0 3% 13px 3%;display:flex;align-items:center;gap:3px;'><span style='font-size:17px;'>📝</span>تمت آخر مراجعة</div>`;
        } else {
          html += `<div style='color:#888;font-size:14px;padding:13px;'>لا يوجد صلاحية لعرض الملاحظات</div>`;
        }
        html += `</div>`;
      });
      notesDiv.innerHTML = html;
      // إذا كنا في القسم أسفل الجدول، أظهر القسم
      if (notesSection) notesSection.style.display = "block";
      if (perm === "edit") {
        Array.from(document.getElementsByClassName("saveNoteBtn")).forEach(btn => {
          btn.onclick = function() {
            const emp = btn.getAttribute("data-emp");
            const noteVal = document.getElementById(`noteInput_${emp}`).value;
            db.ref("notes/" + emp).set(noteVal).then(() => {
              btn.textContent = "✅ تم الحفظ";
              setTimeout(() => { btn.textContent = "💾 حفظ الملاحظة"; }, 1200);
              logActivity(
                "تعديل ملاحظة موظف",
                `<span style='color:#007bff;font-weight:bold;'>${emp}</span> | <span style='color:#ffb300;'>${noteVal.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`,
                { type: "note", emp: emp }
              );
            });
          };
        });
      }
    });
  }
  // عرض الملاحظات أسفل الجدول تلقائياً بعد تحميل الصفحة إذا كان للمستخدم صلاحية
  document.addEventListener("DOMContentLoaded", function() {
  // هجرة كلمات المرور القديمة تلقائيًا عند بدء النظام
  if (typeof migrateAllPlaintextUsers === "function") {
    migrateAllPlaintextUsers();
  }
    db.ref("users/"+currentUser).once("value").then(snap=>{
      const data = snap.val()||{};
      const perm = data.notesPermission || "edit";
      if (perm === "edit" || perm === "read") {
        let notesSection = document.getElementById("notesSection");
        if (notesSection) {
          notesSection.style.display = "block";
          renderNotesTabContent();
        }
      }
    });
  });
  // تحديث ظهور الأزرار حسب الدور وصلاحية المستخدم
  function updateSidebarVisibility() {
    const sidebarToggleBtn = document.getElementById("sidebarToggleBtn");
    const sidebarMenu = document.getElementById("sidebarMenu");
    const sidebarCloseBtn = document.getElementById("sidebarCloseBtn");
    const isAdmin = currentUserRole === "admin";
// أزرار المدير فقط
    ["sidebarAdminBtn","sidebarMonthsManagerBtn","sidebarEmpStatsBtn","sidebarDeleteDataBtn","sidebarFeaturesTabBtn","sidebarChangePassBtn","sidebarUserControlBtn","sidebarNotesSettingsBtn","sidebarNotificationsBtn"].forEach(id=>{
// زر الإشعارات للمدير
document.getElementById("sidebarNotificationsBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  setTimeout(showNotificationsManager, 100);
};

function showNotificationsManager() {
  let modal = document.getElementById("notificationsManagerModal");
  if (modal) { modal.style.display = "flex"; return; }
  modal = document.createElement("div");
  modal.id = "notificationsManagerModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9100;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style="background:#fff;max-width:420px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;">
      <button id="closeNotificationsManagerBtn" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
      <div style="font-size:21px;color:#ff4081;margin-bottom:10px;font-weight:700;text-align:center;letter-spacing:0.2px;">🔔 إرسال إشعار</div>
      <div style="margin-bottom:10px;">
        <label style="font-size:15px;font-weight:500;">المستلم:
          <select id="notificationTarget" multiple style="width:100%;padding:7px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;margin-top:5px;min-height:38px;max-height:120px;overflow:auto;"></select>
          <div style="font-size:12px;color:#888;margin-top:3px;">يمكنك اختيار أكثر من موظف بالضغط مع Ctrl أو Shift</div>
        </label>
      </div>
      <textarea id="notificationMsg" placeholder="اكتب نص الإشعار هنا..." style="width:100%;min-height:60px;border-radius:7px;border:1px solid #ccc;padding:7px;font-size:15px;margin-bottom:10px;"></textarea>
      <button id="sendNotificationBtn" style="background:#ff4081;color:white;padding:9px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;font-weight:600;">إرسال الإشعار</button>
    </div>
    <style>
      @media (max-width: 600px) {
        #notificationsManagerModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #notificationsManagerModal div { font-size:16px !important; }
      }
      #closeNotificationsManagerBtn:hover { background:#b71c1c !important; }
      #sendNotificationBtn:hover { background:#c51162 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("closeNotificationsManagerBtn").onclick = function() { modal.style.display = "none"; };
  // تحميل المستخدمين
  db.ref("users").once("value").then(snap=>{
    const users = snap.val()||{};
    let sel = document.getElementById("notificationTarget");
    sel.innerHTML = `<option value="all">جميع المستخدمين</option>`;
    Object.keys(users).forEach(u=>{
      if(u!=="admin") sel.innerHTML += `<option value="${u}">${u}</option>`;
    });
  });
  document.getElementById("sendNotificationBtn").onclick = function() {
    const sel = document.getElementById("notificationTarget");
    const selected = Array.from(sel.selectedOptions).map(opt=>opt.value);
    const msg = document.getElementById("notificationMsg").value.trim();
    if(!msg) return alert("❌ يرجى كتابة نص الإشعار");
    const notif = {msg,time:Date.now(),from:currentUser};
    if(selected.includes("all")) {
      db.ref("notifications/all").set(notif).then(()=>{
        alert("✅ تم إرسال الإشعار للجميع");
        modal.style.display = "none";
      });
    } else if(selected.length>0) {
      let promises = selected.map(u=>db.ref("notifications/"+u).set(notif));
      Promise.all(promises).then(()=>{
        alert("✅ تم إرسال الإشعار للموظفين المحددين");
        modal.style.display = "none";
      });
    } else {
      alert("❌ يرجى اختيار مستلم واحد على الأقل");
    }
  };
}
// مراقبة الإشعارات لحظياً للمستخدم الحالي
window.listenForNotifications = function listenForNotifications() {
  if(!currentUser) return;
  // تجاهل استقبال الإشعارات للمدير
  if(currentUser === 'admin') return;
  // إشعار مخصص للمستخدم
  db.ref("notifications/"+currentUser).on("value", snap => {
    const notif = snap.val();
    if(notif) showNotificationPopup(notif,()=>{
      db.ref("notifications/"+currentUser).remove();
    });
  });
  // إشعار عام للجميع
  db.ref("notifications/all").on("value", snap => {
    const notif = snap.val();
    if(notif) showNotificationPopup(notif,()=>{
      db.ref("notifications/all").remove();
    });
  });
}

// نافذة منبثقة احترافية للإشعار
function showNotificationPopup(notif, onOk) {
  let old = document.getElementById("notificationPopup");
  if(old) old.remove();
  const modal = document.createElement("div");
  modal.id = "notificationPopup";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:12000;display:flex;align-items:center;justify-content:center;`;
  let sender = notif.from === 'admin' ? 'المدير' : (notif.from||'');
  modal.innerHTML = `
    <div style="background:linear-gradient(135deg,#e8eaf6 60%,#c5cae9 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #3f51b522;position:relative;text-align:center;animation:fadeIn 0.3s;">
      <button id="closeNotifPopupBtn" style="position:absolute;top:10px;left:10px;background:#3f51b5;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
      <div style="font-size:21px;color:#3f51b5;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;">🔔 إشعار من ${sender}</div>
      <div style="font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#e3eafc;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #3f51b511;">${notif.msg.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
      <button id="notifOkBtn" style="background:linear-gradient(90deg,#3f51b5 60%,#5c6bc0 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #3f51b522;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;">حسنًا</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #notificationPopup > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #notificationPopup div { font-size:16px !important; }
      }
      #closeNotifPopupBtn:hover { background:#283593 !important; }
      #notifOkBtn:hover { background:#283593 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("notifOkBtn").onclick = () => { modal.remove(); if(onOk) onOk(); };
  document.getElementById("closeNotifPopupBtn").onclick = () => { modal.remove(); if(onOk) onOk(); };
}
      const el = document.getElementById(id);
      if (el) el.style.display = isAdmin ? "block" : "none";
    });
// نافذة إدارة الأشهر الاحترافية
document.getElementById("sidebarMonthsManagerBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  setTimeout(showMonthsManagerModal, 100);
};

function showMonthsManagerModal() {
  let modal = document.getElementById("monthsManagerModal");
  if (modal) { modal.style.display = "flex"; return; }
  modal = document.createElement("div");
  modal.id = "monthsManagerModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9000;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div id="monthsManagerModalInner" style="background:#fff;max-width:480px;width:97vw;border-radius:18px;box-shadow:0 8px 32px #0002;padding:24px 10px 14px 10px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;">
      <button id="closeMonthsManagerBtn" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
      <div style="font-size:21px;color:#1976d2;margin-bottom:10px;font-weight:700;text-align:center;letter-spacing:0.2px;">📅 إدارة الأشهر</div>
      <div id="monthsManagerContent" style="overflow-x:auto;max-height:60vh;padding-bottom:4px;">جاري التحميل...</div>
      <div style="margin-top:12px;text-align:center;display:flex;flex-wrap:wrap;gap:7px;justify-content:center;">
        <button id="addNewMonthBtn" style="background:#1976d2;color:white;padding:10px 16px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">➕ إضافة شهر</button>
        <button id="toggleAutoMonthBtn" style="background:#ffb300;color:#333;padding:10px 16px;border:none;border-radius:8px;font-size:16px;cursor:pointer;">—</button>
      </div>
      <div style="font-size:13px;color:#888;margin-top:10px;text-align:center;">يمكنك إدارة الأشهر، إغلاقها، إخفائها، إضافة ملاحظات، نسخ أو حذف شهر، والمزيد من هنا.</div>
    </div>
    <style>
      #monthsManagerModalInner table {
        width: 100%;
        border-collapse: collapse;
        font-size: 15px;
        margin-bottom: 8px;
        background: #fafbfc;
      }
      #monthsManagerModalInner th, #monthsManagerModalInner td {
        border: 1px solid #e0e0e0;
        padding: 7px 4px;
        text-align: center;
      }
      #monthsManagerModalInner th {
        background: #e3f0ff;
        color: #1976d2;
        font-size: 15px;
      }
      #monthsManagerModalInner td {
        font-size: 15px;
      }
      #monthsManagerModalInner button.advMonthBtn {
        padding: 4px 10px;
        font-size: 14px;
        border-radius: 6px;
        margin: 0 2px;
      }
      @media (max-width: 600px) {
        #monthsManagerModalInner {
          max-width: 99vw !important;
          padding: 10px 2vw 10px 2vw !important;
        }
        #monthsManagerModalInner table, #monthsManagerModalInner th, #monthsManagerModalInner td {
          font-size: 13px !important;
          padding: 5px 2px !important;
        }
        #monthsManagerModalInner button, #monthsManagerModalInner .advMonthBtn {
          font-size: 13px !important;
          padding: 7px 8px !important;
        }
      }
      #closeMonthsManagerBtn:hover { background:#b71c1c !important; }
      #addNewMonthBtn:hover { background:#1565c0 !important; color:#fff; }
      #toggleAutoMonthBtn:hover { background:#ff9800 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("closeMonthsManagerBtn").onclick = function() { modal.style.display = "none"; };
  loadMonthsManagerContent();
}

function loadMonthsManagerContent() {
  const contentDiv = document.getElementById("monthsManagerContent");
  contentDiv.innerHTML = "جاري التحميل...";
  Promise.all([
    db.ref("monthsSettings").once("value"),
    db.ref("attendance").once("value"),
    db.ref("employees").once("value"),
    db.ref("monthsNotes").once("value"),
    db.ref("activityLog").once("value")
  ]).then(([settingsSnap, attSnap, empSnap, notesSnap, logSnap]) => {
    const settings = settingsSnap.val() || { auto: true, closed: {}, hidden: {} };
    const data = attSnap.val() || {};
    const allEmployees = empSnap.val() || {};
    const monthsNotes = notesSnap.val() || {};
    const activityLog = logSnap.val() || {};
    const monthsSet = new Set();
    Object.keys(data).forEach(key => {
      const parts = key.split("-");
      if (parts.length === 3) {
        const m = parseInt(parts[1]) - 1;
        const y = parseInt(parts[0]);
        monthsSet.add(`${y}-${m}`);
      }
    });
    if (settings.manual && Array.isArray(settings.manual)) {
      settings.manual.forEach(m => monthsSet.add(m));
    }
    const monthsArr = Array.from(monthsSet).sort((a,b)=>{
      const [ya,ma]=a.split('-').map(Number), [yb,mb]=b.split('-').map(Number);
      return ya!==yb?ya-yb:ma-mb;
    });
    let html = `<table style='width:100%;border-collapse:collapse;margin-bottom:10px;'>
      <tr><th>الشهر</th><th>الحالة</th><th>إغلاق</th><th>إخفاء</th><th>خيارات متقدمة</th></tr>`;
    monthsArr.forEach(m => {
      const [y,mo] = m.split('-');
      const label = `${arMonths[parseInt(mo)]} ${y}`;
      const isClosed = settings.closed && settings.closed[m];
      const isHidden = settings.hidden && settings.hidden[m];
      const isDefault = settings.defaultMonth === m;
      // حساب عدد الموظفين وعدد أيام الحضور لهذا الشهر
    let empKey = `employees_${y}_${(parseInt(mo)+1).toString().padStart(2,'0')}`;
    let empArr = allEmployees[empKey] ? Object.values(allEmployees[empKey]) : [];
    let empCount = empArr.length;
    let daysCount = Object.keys(data).filter(k => k.startsWith(`${y}-${parseInt(mo)+1}`)).length;
      html += `<tr>
        <td><span style="font-weight:bold;">${label}</span><br><span style="font-size:12px;color:#888;">عدد الموظفين: ${empCount} | أيام: ${daysCount}</span></td>
        <td>${isClosed ? '<span style="color:#d32f2f;font-weight:bold;">مغلق</span>' : '<span style="color:#388e3c;font-weight:bold;">مفتوح</span>'}${isDefault ? '<br><span style="color:#1976d2;font-size:12px;">افتراضي</span>':''}</td>
        <td><input type='checkbox' data-month='${m}' class='closeMonthChk' ${isClosed?'checked':''}></td>
        <td><input type='checkbox' data-month='${m}' class='hideMonthChk' ${isHidden?'checked':''}></td>
        <td>
          <button class='advMonthBtn' data-month='${m}' style='background:#eee;color:#333;font-size:13px;padding:3px 8px;border-radius:5px;border:none;cursor:pointer;'>⚙️ إدارة</button>
        </td>
      </tr>`;
    });
    html += `</table>`;
    contentDiv.innerHTML = html;
    // ربط الأحداث
    Array.from(document.getElementsByClassName('closeMonthChk')).forEach(chk => {
      chk.onchange = function() {
        const m = chk.getAttribute('data-month');
        db.ref('monthsSettings/closed/'+m).set(chk.checked);
      };
    });
    Array.from(document.getElementsByClassName('hideMonthChk')).forEach(chk => {
      chk.onchange = function() {
        const m = chk.getAttribute('data-month');
        db.ref('monthsSettings/hidden/'+m).set(chk.checked);
      };
    });
    // خيارات متقدمة لكل شهر
    Array.from(document.getElementsByClassName('advMonthBtn')).forEach(btn => {
      btn.onclick = function() {
        const m = btn.getAttribute('data-month');
        showMonthAdvancedOptions(m, monthsArr, settings, data, allEmployees, monthsNotes, activityLog);
      };
    });
  });
  // زر إضافة شهر جديد
  document.getElementById('addNewMonthBtn').onclick = function() {
    let now = new Date();
    let y = now.getFullYear(), m = now.getMonth();
    let nextM = m+1, nextY = y;
    if (nextM > 11) { nextM = 0; nextY++; }
    const key = `${nextY}-${nextM}`;
    db.ref('monthsSettings/manual').once('value').then(snap => {
      let arr = snap.val() || [];
      if (!arr.includes(key)) arr.push(key);
      db.ref('monthsSettings/manual').set(arr).then(loadMonthsManagerContent);
    });
  };
  // زر تفعيل/تعطيل الوضع التلقائي
  db.ref('monthsSettings/auto').once('value').then(snap => {
    const auto = snap.val() !== false;
    const btn = document.getElementById('toggleAutoMonthBtn');
    btn.textContent = auto ? '🔄 الوضع التلقائي: مفعل' : '⏸️ الوضع التلقائي: معطل';
    btn.style.background = auto ? '#ffb300' : '#bdbdbd';
    btn.onclick = function() {
      db.ref('monthsSettings/auto').set(!auto).then(loadMonthsManagerContent);
    };
  });
}

// نافذة الخيارات المتقدمة لكل شهر
function showMonthAdvancedOptions(m, monthsArr, settings, data, allEmployees, monthsNotes, activityLog) {
  let advModal = document.getElementById("monthAdvModal");
  if (advModal) advModal.remove();
  advModal = document.createElement("div");
  advModal.id = "monthAdvModal";
  advModal.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9500;display:flex;align-items:center;justify-content:center;";
  const [y, mo] = m.split('-');
  const label = `${arMonths[parseInt(mo)]} ${y}`;
  let empKey = `employees_${y}_${(parseInt(mo)+1).toString().padStart(2,'0')}`;
  let empCount = allEmployees[empKey] ? Object.values(allEmployees[empKey]).length : 0;
  let daysCount = Object.keys(data).filter(k => k.startsWith(`${y}-${parseInt(mo)+1}`)).length;
  let note = monthsNotes[m] || "";
  let isClosed = settings.closed && settings.closed[m];
  let isHidden = settings.hidden && settings.hidden[m];
  let isDefault = settings.defaultMonth === m;
  let closeMsg = settings.closeMsg && settings.closeMsg[m] ? settings.closeMsg[m] : "";
  // سجل النشاطات لهذا الشهر فقط
  let monthLog = Object.values(activityLog).filter(l => l.month === m || (l.details && l.details.includes(m)));
  advModal.innerHTML = `
    <div style="background:#fff;max-width:440px;width:97vw;border-radius:16px;box-shadow:0 8px 32px #0002;padding:28px 18px 18px 18px;position:relative;display:flex;flex-direction:column;animation:fadeIn 0.3s;">
      <button id="closeMonthAdvModalBtn" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
      <div style="font-size:20px;color:#1976d2;margin-bottom:10px;font-weight:600;text-align:center;">⚙️ إدارة شهر: ${label}</div>
      <div style="font-size:13px;color:#888;margin-bottom:8px;">عدد الموظفين: ${empCount} | أيام: ${daysCount}</div>
      <label style="font-size:15px;font-weight:500;">اسم الشهر:
        <input id="renameMonthInput" type="text" value="${label}" style="width:70%;margin:0 0 8px 0;padding:5px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;">
        <button id="renameMonthBtn" style="background:#1976d2;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">تغيير</button>
      </label>
      <label style="font-size:15px;font-weight:500;">ملاحظة إدارية:
        <textarea id="monthNoteInput" style="width:95%;min-height:40px;margin:0 0 8px 0;border-radius:6px;border:1px solid #ccc;font-size:15px;">${note}</textarea>
        <button id="saveMonthNoteBtn" style="background:#ffb300;color:#333;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">حفظ</button>
      </label>
      <label style="font-size:15px;font-weight:500;">رسالة عند قفل الشهر:
        <input id="closeMsgInput" type="text" value="${closeMsg}" style="width:80%;margin:0 0 8px 0;padding:5px 8px;border-radius:6px;border:1px solid #ccc;font-size:15px;">
        <button id="saveCloseMsgBtn" style="background:#d32f2f;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">حفظ</button>
      </label>
      <div style="margin:8px 0 0 0;display:flex;gap:7px;flex-wrap:wrap;">
        <button id="setDefaultMonthBtn" style="background:${isDefault?'#1976d2':'#eee'};color:${isDefault?'#fff':'#333'};padding:4px 10px;border:none;border-radius:6px;font-size:14px;">${isDefault?'افتراضي حالياً':'تعيين كافتراضي'}</button>
        <button id="copyMonthBtn" style="background:#2196f3;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">نسخ بيانات إلى شهر آخر</button>
        <button id="deleteMonthBtn" style="background:#dc3545;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;">حذف الشهر</button>
        <button id="restoreMonthBtn" style="background:#388e3c;color:white;padding:4px 10px;border:none;border-radius:6px;font-size:14px;display:${isHidden?'inline-block':'none'};">استعادة الشهر</button>
      </div>
      <div style="margin:12px 0 0 0;">
        <b>سجل النشاطات لهذا الشهر:</b>
        <div style="max-height:90px;overflow:auto;border:1px solid #eee;border-radius:7px;padding:5px 7px;background:#fafafa;font-size:13px;">
          ${monthLog.length ? monthLog.map(l=>`<div style='border-bottom:1px solid #eee;margin-bottom:3px;'>${l.time||''} - ${l.user||''}: ${l.action||''}</div>`).join('') : 'لا يوجد نشاطات.'}
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(advModal);
  document.getElementById("closeMonthAdvModalBtn").onclick = function() { advModal.remove(); };
  // إعادة التسمية (فقط واجهة، الاسم في القوائم)
  document.getElementById("renameMonthBtn").onclick = function() {
    const newName = document.getElementById("renameMonthInput").value.trim();
    if (!newName) return alert("❌ الاسم لا يمكن أن يكون فارغاً");
    db.ref('monthsSettings/renames/'+m).set(newName).then(()=>{
      alert('✅ تم تغيير اسم الشهر في القوائم فقط');
      advModal.remove();
      loadMonthsManagerContent();
    });
  };
  // ملاحظة إدارية
  document.getElementById("saveMonthNoteBtn").onclick = function() {
    const noteVal = document.getElementById("monthNoteInput").value;
    db.ref('monthsNotes/'+m).set(noteVal).then(()=>{
      alert('✅ تم حفظ الملاحظة');
    });
  };
  // رسالة القفل
  document.getElementById("saveCloseMsgBtn").onclick = function() {
    const msg = document.getElementById("closeMsgInput").value;
    db.ref('monthsSettings/closeMsg/'+m).set(msg).then(()=>{
      alert('✅ تم حفظ الرسالة');
    });
  };
  // تعيين كافتراضي
  document.getElementById("setDefaultMonthBtn").onclick = function() {
    db.ref('monthsSettings/defaultMonth').set(m).then(()=>{
      alert('✅ تم تعيين الشهر كافتراضي');
      advModal.remove();
      loadMonthsManagerContent();
    });
  };
  // نسخ بيانات شهر
  document.getElementById("copyMonthBtn").onclick = function() {
    let target = prompt('أدخل السنة والشهر الهدف (مثال: 2025-8)');
    if (!target || !/^\d{4}-\d{1,2}$/.test(target)) return alert('❌ صيغة غير صحيحة');
    // نسخ الموظفين
    let srcEmpKey = empKey;
    let tgtEmpKey = `employees_${target.split('-')[0]}_${(parseInt(target.split('-')[1])+1).toString().padStart(2,'0')}`;
    db.ref(srcEmpKey).once('value').then(snap=>{
      db.ref(tgtEmpKey).set(snap.val()||[]);
    });
    // نسخ الحضور
    Object.keys(data).filter(k=>k.startsWith(`${y}-${parseInt(mo)+1}`)).forEach(dayKey=>{
      let tgtDayKey = target+'-'+dayKey.split('-')[2];
      db.ref('attendance/'+tgtDayKey).set(data[dayKey]);
    });
    alert('✅ تم نسخ بيانات الشهر');
  };
  // حذف شهر
  document.getElementById("deleteMonthBtn").onclick = function() {
    if (!confirm('هل أنت متأكد من حذف الشهر؟ سيتم حذف جميع بيانات الحضور والموظفين لهذا الشهر.')) return;
    // حذف الموظفين
    db.ref(empKey).remove();
    // حذف الحضور
    Object.keys(data).filter(k=>k.startsWith(`${y}-${parseInt(mo)+1}`)).forEach(dayKey=>{
      db.ref('attendance/'+dayKey).remove();
    });
    // حذف الملاحظة
    db.ref('monthsNotes/'+m).remove();
    // حذف من monthsSettings.manual إذا كان يدوي
    db.ref('monthsSettings/manual').once('value').then(snap=>{
      let arr = snap.val()||[];
      arr = arr.filter(x=>x!==m);
      db.ref('monthsSettings/manual').set(arr);
    });
    alert('✅ تم حذف الشهر');
    advModal.remove();
    loadMonthsManagerContent();
  };
  // استعادة شهر مخفي
  document.getElementById("restoreMonthBtn").onclick = function() {
    db.ref('monthsSettings/hidden/'+m).set(false).then(()=>{
      alert('✅ تم استعادة الشهر');
      advModal.remove();
      loadMonthsManagerContent();
    });
  };
}

    // زر الملاحظات: يظهر فقط إذا كان للمستخدم صلاحية (edit أو read)
    db.ref("users/"+currentUser).once("value").then(snap=>{
      const data = snap.val()||{};
      const perm = data.notesPermission || "edit";
      const notesBtn = document.getElementById("sidebarNotesBtn");
      if (notesBtn) {
        if (perm === "edit" || perm === "read") {
          notesBtn.style.display = "block";
        } else {
          notesBtn.style.display = "none";
        }
      }
    });

    // زر سجل النشاطات يظهر فقط إذا كان للمستخدم صلاحية
    db.ref("users/" + currentUser).once("value").then(snapshot => {
      const data = snapshot.val() || {};
      let logBtn = document.getElementById("sidebarUserLogBtn");
      if (data.canViewLog) {
        if (!logBtn) {
          logBtn = document.createElement("button");
          logBtn.id = "sidebarUserLogBtn";
          logBtn.style = "background:#673ab7;color:white;";
          logBtn.textContent = "📋 سجل النشاطات";
          logBtn.onclick = function() {
            document.getElementById("sidebarMenu").classList.remove("open");
            // نافذة سجل النشاطات للمستخدم
            let modal = document.getElementById("userLogModal");
            if (!modal) {
              modal = document.createElement("div");
              modal.id = "userLogModal";
              modal.style.position = "fixed";
              modal.style.top = "0";
              modal.style.left = "0";
              modal.style.width = "100vw";
              modal.style.height = "100vh";
              modal.style.background = "rgba(0,0,0,0.35)";
              modal.style.zIndex = "7000";
              modal.style.display = "flex";
              modal.style.alignItems = "center";
              modal.style.justifyContent = "center";
              modal.innerHTML = `
                <div style="background:#fff;max-width:400px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;">
                  <button id="closeUserLogModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">✖</button>
                  <h3 style="text-align:center;margin-bottom:18px;color:#673ab7;">📋 سجل النشاطات</h3>
                  <div id="userLogContent">جاري التحميل...</div>
                </div>
              `;
              document.body.appendChild(modal);
              document.getElementById("closeUserLogModal").onclick = function() {
                modal.style.display = "none";
              };
            } else {
              modal.style.display = "flex";
            }
            // تحميل سجل النشاطات لهذا المستخدم فقط
            db.ref("activityLog").orderByChild("user").equalTo(currentUser).limitToLast(30).once("value").then(snapshot => {
              const log = snapshot.val() || {};
              let html = `<table class="activity-log-table">
                <tr>
                  <th>الوقت</th>
                  <th>النشاط</th>
                  <th>الوصف</th>
                </tr>`;
              Object.values(log).reverse().forEach(item => {
                html += `<tr>
                  <td>${toEnglishNumbers(item.time || "")}</td>
                  <td>${item.action || ""}</td>
                  <td>${item.details || ""}</td>
                </tr>`;
              });
              html += `</table>`;
              document.getElementById("userLogContent").innerHTML = html;
            });
          };
          sidebarMenu.appendChild(logBtn);
        } else {
          logBtn.style.display = "block";
        }
      } else {
        if (logBtn) logBtn.style.display = "none";
      }
    });

    if (localStorage.getItem('loggedUser')) {
      sidebarToggleBtn.style.display = sidebarMenu.classList.contains("open") ? "none" : "flex";
      sidebarCloseBtn.style.display = sidebarMenu.classList.contains("open") ? "flex" : "none";
    } else {
      sidebarToggleBtn.style.display = "none";
      sidebarCloseBtn.style.display = "none";
      sidebarMenu.classList.remove("open");
    }
  }
  // زر فتح القائمة الجانبية
  document.getElementById("sidebarToggleBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.add("open");
    document.getElementById("sidebarToggleBtn").style.display = "none";
    document.getElementById("sidebarCloseBtn").style.display = "flex";
    // عرض اسم المستخدم أعلى القائمة
    const sidebarUserName = document.getElementById("sidebarUserName");
    sidebarUserName.textContent = currentUser ? "👤 " + currentUser : "غير مسجل";
    updateSidebarVisibility();
  };
  // زر إغلاق القائمة الجانبية
  document.getElementById("sidebarCloseBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    document.getElementById("sidebarCloseBtn").style.display = "none";
    document.getElementById("sidebarToggleBtn").style.display = "flex";
    updateSidebarVisibility();
  };
  // ربط أزرار القائمة الجانبية بأزرار الموقع الأصلية
  document.getElementById("sidebarAdminBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>document.getElementById("toggleAdminBtn").click(),100);
  };
  document.getElementById("sidebarEmpStatsBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>document.getElementById("toggleEmpStatsBtn").click(),100);
  };
  document.getElementById("sidebarDeleteDataBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>document.getElementById("btnDeleteData").click(),100);
  };
  document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
    document.getElementById("sidebarMenu").classList.remove("open");
    setTimeout(()=>{
      document.getElementById("btnFeaturesTab").click();
      document.getElementById("featuresTab").style.display = "flex";
      const featuresTabContent = document.getElementById("featuresTabContent");
      featuresTabContent.innerHTML = `
        <div class="feature-section">
          <h4>سجل النشاطات</h4>
          <div id="activityLogBox">جاري التحميل...</div>
        </div>
        <div class="feature-section">
          <h4>معلومات النظام</h4>
          <ul style="margin:0;padding:0 0 0 15px;">
            <li>عدد الموظفين الحالي: <b>${employees.length}</b></li>
            <li>اسم المستخدم الحالي: <b>${currentUser}</b></li>
            <li>الدور: <b>${currentUserRole}</b></li>
          </ul>
        </div>
      `;
      db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
        const log = snapshot.val() || {};
        let html = `<table class="activity-log-table">
          <tr>
            <th>الوقت</th>
            <th>المستخدم</th>
            <th>النشاط</th>
            <th>الوصف</th>
          </tr>`;
        Object.values(log).reverse().forEach(item => {
          html += `<tr>
            <td>${toEnglishNumbers(item.time || "")}</td>
            <td>${item.user || ""}</td>
            <td>${item.action || ""}</td>
            <td>${item.details || ""}</td>
          </tr>`;
        });
        html += `</table>`;
        document.getElementById("activityLogBox").innerHTML = html;
      });
      // زر إغلاق التبويبة
      const closeBtn = document.getElementById("closeFeaturesTab");
      if (closeBtn) {
        closeBtn.onclick = () => {
          document.getElementById("featuresTab").style.display = "none";
        };
      }
    },100);
  };
  // إخفاء جميع الأزرار الخارجية
  document.addEventListener("DOMContentLoaded", () => {
    ["btnDownloadPDF", "toggleAdminBtn", "toggleEmpStatsBtn", "btnDeleteData", "btnFeaturesTab"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    });
    updateSidebarVisibility();
  });
  window.addEventListener("storage", updateSidebarVisibility);
  window.addEventListener("focus", updateSidebarVisibility);
  setInterval(updateSidebarVisibility, 1000);
</script>
<!-- نهاية الإضافة -->

<!-- سجل النشاطات - تحسين التفاصيل -->
<script>
// سجل النشاطات
function logActivity(action, details, extra = {}) {
  const now = new Date();
  const time = toEnglishNumbers(now.toLocaleDateString('ar-EG')) + ' ' + toEnglishNumbers(now.toLocaleTimeString('ar-EG'));
  let style = "";
  if (extra && extra.type === "note") {
    style = "background:#fffde7;border-left:5px solid #ffb300;";
  }
  db.ref("activityLog").push({
    time,
    action,
    details,
    user: currentUser,
    ...extra,
    style
  });
}

// تحويل الأرقام العربية إلى إنجليزية
function toEnglishNumbers(str) {
  return str.replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d));
}

// حفظ التعديلات فقط عند وجود تغيير فعلي
async function saveData() {
  if (!currentUserCanEdit) {
    alert("❌ ليس لديك صلاحية تعديل الجدول.");
    return;
  }
  const days = getDays();
  // الموظفين لهذا الشهر فقط من قاعدة البيانات الشهرية
  let monthEmployees = employees.slice();
  try {
    const attendanceSnapshot = await db.ref("attendance").once("value");
    const savedData = attendanceSnapshot.val() || {};
    const updatedData = {...savedData};
    let changes = [];
    let anyChange = false;
    days.forEach((day, dayIndex) => {
      if (!updatedData[day.key]) updatedData[day.key] = {};
      let dayChanged = false;
      monthEmployees.forEach((employee, empIndex) => {
        const selectElement = document.getElementById(`d${dayIndex}e${empIndex}`);
        if (selectElement) {
          const newValue = selectElement.value;
          const oldValue = savedData[day.key] ? savedData[day.key][employee] : "";
          if (newValue !== oldValue) {
            updatedData[day.key][employee] = newValue;
            dayChanged = true;
            anyChange = true;
            changes.push({
              user: currentUser,
              day: day.key,
              employee,
              old: oldValue,
              new: newValue,
              time: new Date().toLocaleString('ar-EG')
            });
          }
        }
      });
      if (dayChanged) {
        updatedData[day.key].__editor = currentUser;
        const now = new Date();
        const ts = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
        updatedData[day.key].__editedAt = ts;
      }
    });
    if (!anyChange) {
      alert("لا يوجد أي تعديل لحفظه.");
      return;
    }
    await db.ref("attendance").set(updatedData);
    alert("✅ تم حفظ التعديلات بنجاح");
    generateTable();
    changes.forEach(change => {
      logActivity(
        "تعديل جدول الحضور",
        `
          <span style="color:#007bff;font-weight:bold;">${change.user}</span>
          قام بتعديل حضور الموظف
          <span style="color:#673ab7;font-weight:bold;">${change.employee}</span>
          في اليوم
          <span style="color:#009688;font-weight:bold;">${change.day}</span>
          من
          <span style="background:#d4edda;padding:2px 6px;border-radius:5px;">${change.old || "بدون"}</span>
          إلى
          <span style="background:#fff9db;padding:2px 6px;border-radius:5px;">${change.new || "بدون"}</span>
        `,
        { time: change.time, user: change.user }
      );
    });
  } catch (error) {
    console.error("خطأ في حفظ البيانات:", error);
    alert("❌ خطأ في حفظ البيانات");
  }
}

// زر ميزات متقدمة + زر الإغلاق
document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("btnFeaturesTab").click();
  document.getElementById("featuresTab").style.display = "flex";
  const featuresTabContent = document.getElementById("featuresTabContent");
  featuresTabContent.innerHTML = `
    <div class="feature-section">
      <h4>سجل النشاطات</h4>
      <div id="activityLogBox">جاري التحميل...</div>
    </div>
    <div class="feature-section">
      <h4>معلومات النظام</h4>
      <ul style="margin:0;padding:0 0 0 15px;">
        <li>عدد الموظفين الحالي: <b>${employees.length}</b></li>
        <li>اسم المستخدم الحالي: <b>${currentUser}</b></li>
        <li>الدور: <b>${currentUserRole}</b></li>
      </ul>
    </div>
  `;
  db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
      const log = snapshot.val() || {};
      let html = `<table class="activity-log-table" style="width:100%;border-collapse:collapse;">
        <tr>
          <th style='background:#f0f0f0;padding:7px;'>الوقت</th>
          <th style='background:#f0f0f0;padding:7px;'>المستخدم</th>
          <th style='background:#f0f0f0;padding:7px;'>النشاط</th>
          <th style='background:#f0f0f0;padding:7px;'>الوصف</th>
        </tr>`;
      Object.values(log).reverse().forEach(item => {
        html += `<tr style='${item.style || ""}'>
          <td>${toEnglishNumbers(item.time || "")}</td>
          <td>${item.user || ""}</td>
          <td>${item.action || ""}</td>
          <td>${item.details || ""}</td>
        </tr>`;
      });
      html += `</table>`;
      document.getElementById("activityLogBox").innerHTML = html;
  });
  // زر إغلاق التبويبة
  const closeBtn = document.getElementById("closeFeaturesTab");
  if (closeBtn) {
    closeBtn.onclick = () => {
      document.getElementById("featuresTab").style.display = "none";
    };
  }
};


// نافذة تحكم صلاحيات سجل النشاطات للمدير
document.getElementById("sidebarUserControlBtn").onclick = function() {
  // إنشاء نافذة منبثقة احترافية
  let modal = document.getElementById("userLogControlModal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "userLogControlModal";
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100vw";
    modal.style.height = "100vh";
    modal.style.background = "rgba(0,0,0,0.35)";
    modal.style.zIndex = "8000";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.innerHTML = `
      <div style="background:#fff;max-width:420px;width:95vw;border-radius:14px;box-shadow:0 8px 32px #0002;padding:28px 20px 20px 20px;position:relative;">
        <button id="closeUserLogControlModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#009688;">👥 إدارة صلاحيات سجل النشاطات</h3>
        <div id="userLogControlContent" style="min-height:70px;">جاري التحميل...</div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById("closeUserLogControlModal").onclick = function() {
      modal.style.display = "none";
    };
  } else {
    modal.style.display = "flex";
  }

  // تحميل المستخدمين وصلاحياتهم
  db.ref("users").once("value").then(snapshot => {
    const users = snapshot.val() || {};
    let html = `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <th style="background:#f6f6f6;">المستخدم</th>
        <th style="background:#f6f6f6;">الوصول لسجل النشاطات</th>
      </tr>`;
    Object.entries(users).forEach(([username, data]) => {
      if (username === "admin") return; // لا تظهر للمدير نفسه
      html += `<tr>
        <td style="padding:7px 4px;">${username}</td>
        <td style="padding:7px 4px;">
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" ${data.canViewLog ? "checked" : ""} onchange="window.setUserLogAccess('${username}', this.checked)">
            <span style="font-size:13px;color:${data.canViewLog ? '#28a745':'#dc3545'};">${data.canViewLog ? 'مفعل':'معطل'}</span>
          </label>
        </td>
      </tr>`;
    });
    html += `</table>
      <div style="margin-top:10px;font-size:13px;color:#555;">
        عند تفعيل الصلاحية يظهر زر سجل النشاطات للمستخدم في القائمة الجانبية.<br>
        عند التعطيل يختفي الزر مباشرة من عند المستخدم.
      </div>`;
    document.getElementById("userLogControlContent").innerHTML = html;
    window.setUserLogAccess = function(username, enabled) {
      db.ref("users/" + username + "/canViewLog").set(enabled).then(() => {
        logActivity("تغيير صلاحية سجل النشاطات", `تم ${enabled ? 'تفعيل' : 'تعطيل'} سجل النشاطات للمستخدم: ${username}`);
        updateSidebarVisibility();
      });
    };
  });
}
</script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// ========== إعداد Firebase ==========
const firebaseConfig = {
  apiKey: "AIzaSyDh8KquT-8Slr6B5SAGoyGj2zOEusyiEg4",
  authDomain: "sjad-b3946.firebaseapp.com",
  databaseURL: "https://sjad-b3946-default-rtdb.firebaseio.com",
  projectId: "sjad-b3946",
  storageBucket: "sjad-b3946.appspot.com",
  messagingSenderId: "1001672753514",
  appId: "1:1001672753514:web:eac813b6e25621f5d16513",
  measurementId: "G-EV0NVW2036"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// دوال إدارة قاعدة البيانات
function clearDatabase() {
  // نافذة إدخال كلمة مرور المدير
  let passModal = document.getElementById("adminPassModal");
  if (passModal) passModal.remove();
  passModal = document.createElement("div");
  passModal.id = "adminPassModal";
  passModal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  passModal.innerHTML = `
    <div style=\"background:#fff;max-width:350px;width:90vw;padding:22px 18px 18px 18px;border-radius:14px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;\">
      <button id=\"closeAdminPassModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">✖</button>
      <div style=\"font-size:17px;color:#333;margin-bottom:18px;\">يرجى إدخال كلمة مرور المدير للتأكيد:</div>
      <input id=\"adminPassInput\" type=\"password\" style=\"width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;\" />
      <button id=\"adminPassConfirmBtn\" style=\"background:#007bff;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;\">تأكيد</button>
    </div>
  `;
  document.body.appendChild(passModal);
  document.getElementById("adminPassConfirmBtn").onclick = function() {
    const adminPass = document.getElementById("adminPassInput").value;
    passModal.remove();
    db.ref("users/admin/password").once("value").then(async snapshot => {
      const realAdminPass = snapshot.val();
      const ok = await verifyPassword(realAdminPass, adminPass);
      if (!ok) {
        alert("❌ كلمة المرور غير صحيحة!");
        return;
      }
      if (confirm('هل أنت متأكد من مسح جميع بيانات قاعدة البيانات؟')) {
        db.ref('/').remove()
          .then(async () => {
            // إعادة إنشاء حساب المدير بعد المسح مباشرة بكلمة مرور مشفرة
            const hashObj = await hashPassword('admin');
            await db.ref('users/admin').set({
              password: hashObj,
              role: 'admin',
              canEdit: true
            });
            alert('تم مسح جميع البيانات بنجاح! تم إعادة إنشاء حساب المدير الافتراضي.');
          })
          .catch(err => alert('حدث خطأ أثناء المسح: ' + err.message));
      }
    });
  };
  document.getElementById("closeAdminPassModalBtn").onclick = function() { passModal.remove(); };
}


let employees = [];
let employeeIds = [];
// ========== استرجاع الجلسة عند تحديث الصفحة ========== (مع مراقبة صلاحية التعديل)
document.addEventListener("DOMContentLoaded", function() {
  // ميزة الإنشاء التلقائي لحساب المدير إذا تم حذفه
  db.ref("users/admin").once("value").then(async snap => {
    if (!snap.exists()) {
      let hashObj = null;
      if (typeof hashPassword === "function") {
        hashObj = await hashPassword("admin");
      } else {
        hashObj = "admin";
      }
      await db.ref("users/admin").set({
        password: hashObj,
        role: "admin",
        canEdit: true
      });
      console.log("تم إنشاء حساب المدير تلقائياً: admin/admin");
    }
  });

  // إظهار علامة التحميل فقط إذا كان المستخدم مسجل دخول
  var loader = document.getElementById("loaderSpinner");
  if (localStorage.getItem('loggedUser')) {
    loader.style.display = "flex";
    const userObj = JSON.parse(localStorage.getItem('loggedUser'));
    currentUser = userObj.user;
    currentUserRole = userObj.role;
    currentUserCanEdit = userObj.canEdit;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    if (currentUserRole === "admin") {
      document.getElementById("adminPanel").style.display = "block";
      loadUsers();
      loadEmployeesTable();
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }
    // جلب صلاحيات allowedStatsEmps و canViewSalary وتخزينها في window.currentUserData
    db.ref("users/"+currentUser).once("value").then(snap => {
      window.currentUserData = snap.val() || {};
      // عند تحميل الموظفين والجدول، إخفِ علامة التحميل فقط بعد اكتمال الجدول
      const empKey = `employees_${year}_${(month+1).toString().padStart(2,'0')}`;
      loadEmployees(empKey).then(() => {
        generateTable();
        if (typeof tryShowUserEmpStats === "function") tryShowUserEmpStats();
      });
    });
    if (typeof checkForcedLogoutOnLogin === "function") checkForcedLogoutOnLogin(currentUser);
    if (typeof updateSidebarVisibility === "function") updateSidebarVisibility();
    if (typeof loadAvailableMonths === "function") loadAvailableMonths();
    listenForNotifications();

    // مراقبة صلاحية التعديل للمستخدم الحالي وتحديثها فوراً
    if (currentUser !== "admin") {
      db.ref("users/" + currentUser + "/canEdit").on("value", function(snap) {
        const newCanEdit = !!snap.val();
        if (currentUserCanEdit !== newCanEdit) {
          currentUserCanEdit = newCanEdit;
          if (!window.currentUserData) window.currentUserData = {};
          window.currentUserData.canEdit = newCanEdit;
          updateEditabilityUI(newCanEdit);
          generateTable();
          if (!currentUserCanEdit) {
            showPermissionRevokedModal();
          }
        }
      });
    }

    function updateEditabilityUI(canEdit) {
      document.querySelectorAll('select[data-attendance-select]').forEach(sel => {
        sel.disabled = !canEdit;
      });
      document.querySelectorAll('.btn-edit, .btn-save, .btn-delete, .btn-add').forEach(btn => {
        btn.disabled = !canEdit;
        if (!canEdit) btn.classList.add('disabled');
        else btn.classList.remove('disabled');
      });
    }
    ["allowedStatsEmps","canViewSalary"].forEach(key => {
      db.ref("users/"+currentUser+"/"+key).on("value", function(snap) {
        if (!window.currentUserData) window.currentUserData = {};
        window.currentUserData[key] = snap.val();
        db.ref("attendance").once("value").then(snap2 => {
          calculateStats(snap2.val() || {});
          if (typeof renderUserEmpStats === "function") renderUserEmpStats();
        });
      });
    });
  }
});
const statuses = ["", "شفت", "نص", "❌"];
let month = new Date().getMonth();
const year = new Date().getFullYear();
const arMonths = ["يناير","فبراير","مارس","إبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
let currentUser = "";
let currentUserRole = "";
let currentUserCanEdit = false;

// ========== سجل النشاطات ==========
function logActivity(action, details, extra = {}) {
  const now = new Date();
  const time = toEnglishNumbers(now.toLocaleDateString('ar-EG')) + ' ' + toEnglishNumbers(now.toLocaleTimeString('ar-EG'));
  db.ref("activityLog").push({ time, action, details, user: currentUser, ...extra });
}

// ========== جلسة المستخدم ==========
function setSession(userObj) {
  currentUser = userObj.user;
  currentUserRole = userObj.role;
  currentUserCanEdit = userObj.canEdit;
  localStorage.setItem('loggedUser', JSON.stringify(userObj));
}
function clearSession() {
  currentUser = "";
  currentUserRole = "";
  currentUserCanEdit = false;
  localStorage.removeItem('loggedUser');
}

// ========== رسائل واجهة المستخدم ==========
function showMessage(message, isError = false) {
  const messageDiv = document.getElementById("loginMessage");
  if (!message) {
    messageDiv.innerHTML = "";
    messageDiv.className = "";
    return;
  }
  if (isError) {
    messageDiv.innerHTML = `
      <div style='animation:fadeIn 0.4s; background:linear-gradient(135deg,#fff6f6 60%,#ffe3e3 100%); border-radius:16px; box-shadow:0 6px 24px #d32f2f33; padding:22px 28px; display:flex; align-items:center; gap:18px; border:2.5px solid #d32f2f; margin:16px 0; position:relative;'>
        <span style='display:inline-block; animation:shake 0.5s;'>
          <svg width="38" height="38" viewBox="0 0 38 38" style="display:block;">
            <circle cx="19" cy="19" r="17" fill="#fff" stroke="#d32f2f" stroke-width="2.5"/>
            <line x1="12" y1="12" x2="26" y2="26" stroke="#d32f2f" stroke-width="3.5" stroke-linecap="round">
              <animate attributeName="stroke" values="#d32f2f;#ff1744;#d32f2f" dur="1.2s" repeatCount="indefinite"/>
            </line>
            <line x1="26" y1="12" x2="12" y2="26" stroke="#d32f2f" stroke-width="3.5" stroke-linecap="round">
              <animate attributeName="stroke" values="#d32f2f;#ff1744;#d32f2f" dur="1.2s" repeatCount="indefinite"/>
            </line>
          </svg>
        </span>
        <span style='color:#d32f2f; font-weight:bold; font-size:19px; letter-spacing:0.5px; text-shadow:0 2px 8px #d32f2f22;'>${message}</span>
      </div>
      <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
        @keyframes shake { 0% { transform:translateX(0);} 25% { transform:translateX(-4px);} 50% { transform:translateX(4px);} 75% { transform:translateX(-2px);} 100% { transform:translateX(0);} }
      </style>
    `;
    messageDiv.className = "error";
  } else if (message.includes("جاري تسجيل الدخول")) {
    messageDiv.innerHTML = `
      <div style='animation:fadeIn 0.4s; background:#f6f8fa; border-radius:12px; box-shadow:0 2px 12px #1976d222; padding:13px 18px; display:flex; align-items:center; gap:10px; border:1.5px solid #1976d2; margin:8px 0;'>
        <span class='login-spinner' style='width:24px;height:24px;display:inline-block;'>
          <svg width='24' height='24' viewBox='0 0 50 50' style='animation:spin 0.8s linear infinite;'>
            <circle cx='25' cy='25' r='20' fill='none' stroke='#e3eafc' stroke-width='6'/>
            <circle cx='25' cy='25' r='20' fill='none' stroke='#1976d2' stroke-width='6' stroke-linecap='round' stroke-dasharray='60 90' stroke-dashoffset='0'/>
          </svg>
        </span>
        <span style='color:#1976d2; font-weight:bold; font-size:16px;'>${message}</span>
      </div>
      <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
        @keyframes spin { 100% { transform:rotate(360deg);} }
      </style>
    `;
    messageDiv.className = "loading";
  } else {
    messageDiv.innerHTML = `
      <div style='animation:fadeIn 0.4s; background:#e3f0ff; border-radius:12px; box-shadow:0 2px 12px #1976d222; padding:13px 18px; display:flex; align-items:center; gap:10px; border:1.5px solid #1976d2; margin:8px 0;'>
        <span style='color:#1976d2; font-weight:bold; font-size:16px;'>${message}</span>
      </div>
      <style>
        @keyframes fadeIn { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
      </style>
    `;
    messageDiv.className = "loading";
  }
}

// ========== تسجيل الدخول ==========
function login() {
  const username = document.getElementById("username").value.trim().toLowerCase();
  const password = document.getElementById("password").value.trim();
  if (!username || !password) return showMessage(" يرجى إدخال اسم المستخدم وكلمة المرور", true);
  showMessage(" جاري تسجيل الدخول...");
  db.ref("users/" + username).once("value").then(async snapshot => {
    if (!snapshot.exists()) throw new Error("User not found");
    const userData = snapshot.val();
    const storedPass = userData.password;
    console.log("[LOGIN DEBUG] username:", username);
    console.log("[LOGIN DEBUG] entered password:", password);
    console.log("[LOGIN DEBUG] stored password object:", storedPass);
    const ok = await verifyPassword(storedPass, password);
    console.log("[LOGIN DEBUG] verifyPassword result:", ok);
    if (!ok) throw new Error("Wrong password");
    // إذا legacy، حدث كلمة المرور فوراً إلى صيغة hash
    if (typeof storedPass === 'string') {
      const hashObj = await hashPassword(password);
      await db.ref("users/" + username + "/password").set(hashObj);
    }
    setSession({user: username, role: userData.role || "user", canEdit: userData.canEdit !== undefined ? userData.canEdit : true});
    showMessage("");
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
  const empKey = `employees_${year}_${(month+1).toString().padStart(2,'0')}`;
  loadEmployees(empKey).then(generateTable);
    if (currentUserRole === "admin") {
      document.getElementById("adminPanel").style.display = "block";
      loadUsers();
      loadEmployeesTable();
    } else {
      document.getElementById("adminPanel").style.display = "none";
    }
    checkForcedLogoutOnLogin(username);
  }).catch(error => {
    showMessage(error.message === "User not found" ? " اسم المستخدم غير موجود" : " كلمة المرور غير صحيحة", true);
    console.error("[LOGIN ERROR]", error);
  });
}

function logout() {
  clearSession();
  document.getElementById("loginBox").style.display = "block";
  document.getElementById("mainContent").style.display = "none";
  document.getElementById("adminPanel").style.display = "none";
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  showMessage("");
}

// ========== تحميل الموظفين ==========
function loadEmployees() {
  
  // إظهار علامة التحميل
  document.getElementById("loaderSpinner").style.display = "flex";
  // جلب قائمة الموظفين الخاصة بالشهر الحالي فقط من المفتاح العام
  const empKey = `employees_${year}_${(month+1).toString().padStart(2,'0')}`;
  return db.ref("employees/" + empKey).once("value").then(snapshot => {
    const empObj = snapshot.exists() ? snapshot.val() : {};
  // ترتيب حسب الإضافة وليس أبجدي
  // Object.values(empObj) يحافظ على ترتيب الإضافة في جافاسكريبت
  employees = Object.values(empObj);
  employeeIds = Object.keys(empObj);
    const theadRow = document.querySelector("#attendanceTable thead tr");
    while (theadRow.children.length > 1) theadRow.removeChild(theadRow.lastChild);
    if (theadRow.children.length > 0) {
      const firstTh = theadRow.children[0];
      firstTh.style.background = '#e3f0ff';
      firstTh.style.color = '#222';
      firstTh.style.fontWeight = 'bold';
      firstTh.style.fontSize = '17px';
      firstTh.style.border = '1px solid #b0bec5';
      firstTh.style.boxShadow = 'none';
      firstTh.style.letterSpacing = '0.5px';
      firstTh.style.borderRadius = '0';
      firstTh.style.transition = 'background 0.2s';
    }
    employees.forEach(emp => {
      const th = document.createElement("th");
      th.textContent = emp;
      th.style.background = '#e3f0ff';
      th.style.color = '#222';
      th.style.fontWeight = 'bold';
      th.style.fontSize = '17px';
      th.style.border = '1px solid #b0bec5';
      th.style.boxShadow = 'none';
      th.style.letterSpacing = '0.5px';
      th.style.borderRadius = '0';
      th.style.transition = 'background 0.2s';
      theadRow.appendChild(th);
    });
    loadEmployeesTable();
    setTimeout(function(){ document.getElementById("loaderSpinner").style.display = "none"; }, 350);
  });
}

// ========== جدول الحضور ==========
// نسخ قائمة الموظفين من الشهر السابق إلى الشهر الحالي إذا لم تكن موجودة، مع احترام إعدادات الأشهر
function ensureMonthEmployees() {
  const empKey = `employees_${year}_${(month+1).toString().padStart(2, '0')}`;
  // تحقق من إعدادات الأشهر
  // لم يعد هناك نسخ تلقائي للموظفين من الشهر السابق
  return Promise.resolve();
}

// استدعاء الدالة عند تغيير الشهر أو السنة
window.addEventListener("DOMContentLoaded", ensureMonthEmployees);
function getDays() {
  const days = [];
  let date = new Date(year, month, 1);
  while (date.getMonth() === month) {
    const dayKey = `${year}-${month + 1}-${date.getDate()}`;
    const dayLabel = `${date.getDate()} ${arMonths[month]} (${date.toLocaleDateString('ar-EG', {weekday: 'long'})})`;
    days.push({key: dayKey, label: dayLabel});
    date.setDate(date.getDate() + 1);
  }
  return days;
}

function generateTable() {
  // إظهار علامة التحميل
  document.getElementById("loaderSpinner").style.display = "flex";
  const days = getDays();
  // تحديث عنوان الجدول باسم الشهر الحالي
  document.querySelector("#mainContent h2").textContent = `📋 جدول الحضور - ${arMonths[month]}`;
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  // إخفاء رأس عمود التاريخ أثناء التحميل
  var dateHeader = document.getElementById("dateHeaderTh");
  if(dateHeader) dateHeader.style.display = "none";
  db.ref("attendance").once("value").then(snapshot => {
    const savedData = snapshot.val() || {};
    // الموظفين لهذا الشهر فقط من قاعدة البيانات الشهرية
    let monthEmployees = employees.slice();
    days.forEach((day, dayIndex) => {
      const row = document.createElement("tr");
      const dateCell = document.createElement("td");
      let dateContent = toEnglishNumbers(day.label);
      if (savedData[day.key] && savedData[day.key].__editor) {
        const ts = savedData[day.key].__editedAt || "";
        const editor = savedData[day.key].__editor;
        const color = (editor === "admin") ? "#1fa745" : "#dc3545";
        dateContent += `<div class='editor-tag' style="color:${color};font-weight:bold;">
          🖊️ ${editor}${ts ? ' - ' + toEnglishNumbers(ts) : ''}
        </div>`;
      }
      // عند الضغط على اليوم، افتح نافذة التفاصيل
      dateCell.innerHTML = `<span style='cursor:pointer;' onclick='showDayDetailsModal("${day.key}", "${day.label}")'>${dateContent}</span>`;
      row.appendChild(dateCell);
      monthEmployees.forEach((employee, empIndex) => {
        const cell = document.createElement("td");
        const select = document.createElement("select");
        select.id = `d${dayIndex}e${empIndex}`;
        statuses.forEach(status => {
          const option = document.createElement("option");
          option.value = status;
          option.textContent = status;
          select.appendChild(option);
        });
        if (savedData[day.key] && savedData[day.key][employee] !== undefined) {
          select.value = savedData[day.key][employee];
        }
        if (select.value === "شفت") {
          cell.style.background = "#d4edda";
        } else if (select.value === "نص") {
          cell.style.background = "#fff9db";
        } else if (select.value === "❌") {
          cell.style.background = "#ffe3e3";
          cell.style.color = "#d32f2f";
          select.style.color = "#d32f2f";
        } else {
          cell.style.color = "";
          select.style.color = "";
        }
        if (!currentUserCanEdit || !isCurrentMonthSelected()) {
          select.setAttribute('disabled','disabled');
          select.addEventListener('change', (e)=>{ e.target.value = savedData[day.key] ? savedData[day.key][employee] : ""; });
        }
        select.addEventListener('change', function() {
          if (this.value === "شفت") {
            cell.style.background = "#d4edda";
            cell.style.color = "";
            select.style.color = "";
          } else if (this.value === "نص") {
            cell.style.background = "#fff9db";
            cell.style.color = "";
            select.style.color = "";
          } else if (this.value === "❌") {
            cell.style.background = "#ffe3e3";
            cell.style.color = "#d32f2f";
            select.style.color = "#d32f2f";
          } else {
            cell.style.background = "";
            cell.style.color = "";
            select.style.color = "";
          }
        });
        cell.appendChild(select);
        row.appendChild(cell);
      });
      tbody.appendChild(row);
    });
    // تعطيل زر الحفظ إذا لم يكن الشهر الحالي أو لا يوجد صلاحية
    const saveBtn = document.querySelector('button[onclick="saveData()"]');
    if (saveBtn) saveBtn.disabled = (!currentUserCanEdit || !isCurrentMonthSelected());
    calculateStats(savedData);
    if (typeof renderUserEmpStats === "function") renderUserEmpStats();
    // إظهار رأس عمود التاريخ بعد اكتمال تحميل الجدول
    if(dateHeader) dateHeader.style.display = "";
    // إخفاء علامة التحميل بعد اكتمال التحميل
    setTimeout(function(){ document.getElementById("loaderSpinner").style.display = "none"; }, 350);
  });
  // تعطيل جميع select وinput وtextarea وأزرار الحفظ إذا فقدت الصلاحية (احتياطي)
  setTimeout(()=>{
    if (!currentUserCanEdit || !isCurrentMonthSelected()) {
      document.querySelectorAll('#mainContent select, #mainContent input, #mainContent textarea').forEach(el=>{
        el.setAttribute('disabled','disabled');
      });
      const saveBtn = document.querySelector('button[onclick="saveData()"]');
      if (saveBtn) saveBtn.disabled = true;
    } else {
      document.querySelectorAll('#mainContent select, #mainContent input, #mainContent textarea').forEach(el=>{
        el.removeAttribute('disabled');
      });
      const saveBtn = document.querySelector('button[onclick="saveData()"]');
      if (saveBtn) saveBtn.disabled = false;
    }
  }, 100);
}

// ========== حفظ البيانات ==========

// Unified permission check for editing current month
function canEditCurrentMonth() {
  if (!isCurrentMonthSelected()) {
    alert("❌ لا يمكن تعديل جدول الحضور لشهر سابق.");
    return false;
  }
  if (!currentUserCanEdit) {
    alert("❌ ليس لديك صلاحية تعديل الجدول.");
    return false;
  }
  return true;
}

// Unified save function for attendance (days/employees)
async function saveAttendanceData() {
  if (!canEditCurrentMonth()) return;
  const days = getDays();
  try {
    const attendanceSnapshot = await db.ref("attendance").once("value");
    const savedData = attendanceSnapshot.val() || {};
    const updatedData = {...savedData};
    let changes = [];
    let anyChange = false;
    days.forEach((day, dayIndex) => {
      if (!updatedData[day.key]) updatedData[day.key] = {};
      let dayChanged = false;
      employees.forEach((employee, empIndex) => {
        const selectElement = document.getElementById(`d${dayIndex}e${empIndex}`);
        if (selectElement) {
          const newValue = selectElement.value;
          const oldValue = savedData[day.key] ? savedData[day.key][employee] : "";
          if (newValue !== oldValue) {
            updatedData[day.key][employee] = newValue;
            dayChanged = true;
            anyChange = true;
            changes.push({
              user: currentUser,
              day: day.key,
              employee,
              old: oldValue,
              new: newValue,
              time: new Date().toLocaleString('ar-EG')
            });
          }
        }
      });
      if (dayChanged) {
        updatedData[day.key].__editor = currentUser;
        const now = new Date();
        const ts = now.toLocaleDateString('ar-EG') + ' ' + now.toLocaleTimeString('ar-EG');
        updatedData[day.key].__editedAt = ts;
      }
    });
    if (!anyChange) {
      alert("لا يوجد أي تعديل لحفظه.");
      return;
    }
    await db.ref("attendance").set(updatedData);
    alert("✅ تم حفظ التعديلات بنجاح");
    generateTable();
    changes.forEach(change => {
      logActivity(
        "تعديل جدول الحضور",
        `
          <span style=\"color:#007bff;font-weight:bold;\">${change.user}</span>
          قام بتعديل حضور الموظف
          <span style=\"color:#673ab7;font-weight:bold;\">${change.employee}</span>
          في اليوم
          <span style=\"color:#009688;font-weight:bold;\">${change.day}</span>
          من
          <span style=\"background:#d4edda;padding:2px 6px;border-radius:5px;\">${change.old || "بدون"}</span>
          إلى
          <span style=\"background:#fff9db;padding:2px 6px;border-radius:5px;\">${change.new || "بدون"}</span>
        `,
        { time: change.time, user: change.user }
      );
    });
  } catch (error) {
    console.error("خطأ في حفظ البيانات:", error);
    alert("❌ خطأ في حفظ البيانات");
  }
}

// Unified save function for employees (add/update/delete)
async function saveEmployees(newEmployees) {
  if (!canEditCurrentMonth()) return;
  const empKey = `employees_${year}_${(month+1).toString().padStart(2,'0')}`;
  try {
    // توليد معرفات فريدة للموظفين الجدد إذا لم تكن موجودة
    let empObj = {};
    newEmployees.forEach((name, idx) => {
      // إذا كان الاسم موجود بالفعل بنفس المعرف، احتفظ به
      let id = employeeIds[idx] || ("id" + Date.now() + "_" + Math.floor(Math.random()*10000));
      empObj[id] = name;
    });
    await db.ref("employees/" + empKey).set(empObj);
  // ترتيب حسب الإضافة وليس أبجدي
  employees = Object.values(empObj);
  employeeIds = Object.keys(empObj);
    window.monthEmployees = employees.slice();
    loadEmployeesTable();
    generateTable();
    alert("✅ تم تحديث الموظفين لهذا الشهر فقط");
    logActivity("تحديث الموظفين", `تم تحديث قائمة الموظفين لهذا الشهر: ${employees.join(", ")}`);
  } catch (err) {
    console.error(err);
    alert("❌ حدث خطأ أثناء تحديث الموظفين");
  }
}

// Replace old saveData with unified function
function saveData() {
  saveAttendanceData();
}

// ========== إدارة المستخدمين والموظفين ==========
// ========== إدارة المستخدمين ========== 
// نافذة تأكيد احترافية
function showConfirmModal(message, onConfirm, onCancel) {
  let oldModal = document.getElementById("customConfirmModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "customConfirmModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:#fff;max-width:370px;width:92vw;padding:26px 18px 20px 18px;border-radius:16px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeConfirmModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;\">✖</button>
      <div style=\"font-size:18px;color:#333;margin-bottom:20px;font-weight:500;\">${message}</div>
      <div style=\"display:flex;gap:12px;justify-content:center;\">
        <button id=\"confirmModalYes\" style=\"background:#007bff;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #007bff22;transition:background 0.2s;\">تأكيد</button>
        <button id=\"confirmModalNo\" style=\"background:#6c757d;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #6c757d22;transition:background 0.2s;\">إلغاء</button>
      </div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #customConfirmModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #customConfirmModal div { font-size:16px !important; }
      }
      #closeConfirmModalBtn:hover { background:#b71c1c !important; }
      #confirmModalYes:hover { background:#0056b3 !important; }
      #confirmModalNo:hover { background:#343a40 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("confirmModalYes").onclick = () => { modal.remove(); if (onConfirm) onConfirm(); };
  document.getElementById("confirmModalNo").onclick = () => { modal.remove(); if (onCancel) onCancel(); };
  document.getElementById("closeConfirmModalBtn").onclick = () => { modal.remove(); if (onCancel) onCancel(); };
}
// تحميل جدول المستخدمين
async function loadUsers() {
  const snapshot = await db.ref("users").once("value");
  const users = snapshot.val() || {};
  const tbody = document.getElementById("usersBody");
  tbody.innerHTML = "";
  Object.entries(users).forEach(([username, data]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${username}</td>
      <td>${data.canEdit ? "نعم" : "لا"}</td>
      <td>
        <button class="small-button btn-toggle" onclick="toggleUserEdit('${username}', ${data.canEdit})">
          ${data.canEdit ? "قفل التعديل" : "فتح التعديل"}
        </button>
      </td>
      <td>
        ${username === currentUser ? "لا يمكن حذف نفسك" : `<button class="small-button btn-delete" onclick="deleteUser('${username}')">حذف</button>`}
      </td>
      <td>
        ${username === currentUser ? "—" : `<button class="small-button btn-delete" style="background:#ff9800;" onclick="forceLogoutUser('${username}')">تسجيل خروج</button>`}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// تسجيل خروج إجباري لمستخدم
async function forceLogoutUser(username) {
  if (username === currentUser) {
    alert("❌ لا يمكنك تسجيل خروج نفسك إجباريًا.");
    return;
  }
  showConfirmModal(`هل تريد تسجيل خروج المستخدم ${username} إجباريًا؟`, async () => {
    try {
      await db.ref("forcedLogout/" + username).set(true);
      alert("✅ تم إرسال أمر تسجيل الخروج الإجباري.");
      logActivity("تسجيل خروج إجباري", username);
    } catch (err) {
      alert("❌ حدث خطأ أثناء تنفيذ تسجيل الخروج الإجباري");
      console.error(err);
    }
  });
}

// تبديل صلاحية التعديل للمستخدم
async function toggleUserEdit(username, currentCanEdit) {
  if (username === currentUser) {
    alert("❌ لا يمكنك تغيير صلاحيتك الخاصة.");
    return;
  }
  await db.ref("users/" + username + "/canEdit").set(!currentCanEdit);
  loadUsers();
}

// حذف مستخدم مع نافذة منبثقة أنيقة وإخراج المستخدم فوراً
async function deleteUser(username) {
  if (username === currentUser) {
    showPermissionRevokedModal("لا يمكن حذف نفسك.");
    return;
  }
  showDeleteUserModal(username);
}

// دالة لضمان بقاء حساب المدير دائماً
async function ensureAdminAccount() {
  const snap = await db.ref("users").once("value");
  const users = snap.val() || {};
  if (!users.admin) {
    const hashObj = await hashPassword('admin');
    await db.ref('users/admin').set({
      password: hashObj,
      role: 'admin',
      canEdit: true
    });
  }
}

function showDeleteUserModal(username) {
  let oldModal = document.getElementById("deleteUserModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "deleteUserModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#fff7f7 60%,#fce4ec 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #e5737333;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeDeleteUserModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#e57373;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;box-shadow:0 2px 8px #e5737322;\">✖</button>
      <div style=\"font-size:21px;color:#d32f2f;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">🗑️ حذف مستخدم</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#fff3f3;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #e5737311;\">هل أنت متأكد من حذف المستخدم <b style='color:#d32f2f;'>${username}</b>؟<br>سيتم إخراجه فوراً ولن يتمكن من الدخول مجدداً إلا إذا أنشأته من جديد.</div>
      <button id=\"deleteUserConfirmBtn\" style=\"background:linear-gradient(90deg,#d32f2f 60%,#e57373 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #d32f2f22;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;\">تأكيد الحذف</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #deleteUserModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #deleteUserModal div { font-size:16px !important; }
      }
      #closeDeleteUserModalBtn:hover { background:#b71c1c !important; }
      #deleteUserConfirmBtn:hover { background:#b71c1c !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("deleteUserConfirmBtn").onclick = async () => {
    await db.ref("users/" + username).remove();
    await ensureAdminAccount();
    await db.ref("forcedLogout/" + username).set(true);
    if (username === currentUser) {
      localStorage.setItem('accountDeleted', 'true');
      clearSession && clearSession();
      location.reload();
      return;
    }
    loadUsers();
    logActivity("حذف مستخدم", username);
    modal.remove();
  };
// رسالة حذف الحساب عند تحميل الصفحة
document.addEventListener("DOMContentLoaded", function() {
  if (localStorage.getItem('accountDeleted')) {
    localStorage.removeItem('accountDeleted');
    showAccountDeletedModal();
  }
});

// نافذة رسالة حذف الحساب
function showAccountDeletedModal() {
  const modal = document.createElement("div");
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style="background:#fff3f3;padding:24px 18px;border-radius:12px;box-shadow:0 4px 20px #0002;text-align:center;">
      <div style="font-size:20px;color:#d32f2f;margin-bottom:12px;">❌ تم حذف حسابك</div>
      <div style="font-size:15px;color:#444;">تم حذف حسابك من النظام من قبل المدير.</div>
      <button onclick="this.parentElement.parentElement.remove()" style="margin-top:15px;padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:8px;cursor:pointer;">موافق</button>
    </div>
  `;
  document.body.appendChild(modal);
}
// عند تحميل الصفحة، إذا accountDeleted=true في localStorage، أظهر رسالة حذف الحساب فقط
document.addEventListener("DOMContentLoaded", function() {
  if (localStorage.getItem('accountDeleted')) {
    localStorage.removeItem('accountDeleted');
    showAccountDeletedModal();
  }
});
  document.getElementById("closeDeleteUserModalBtn").onclick = () => { modal.remove(); };
}

// تحديث showPermissionRevokedModal لقبول رسالة مخصصة (اختياري)
const _oldShowPermissionRevokedModal = window.showPermissionRevokedModal;
window.showPermissionRevokedModal = function(msg) {
  if (!msg) return _oldShowPermissionRevokedModal();
  let oldModal = document.getElementById("permRevokedModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "permRevokedModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#f7faff 60%,#e3eafc 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #1976d233;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closePermRevokedModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#e57373;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;box-shadow:0 2px 8px #e5737322;\">✖</button>
      <div style=\"font-size:19px;color:#d32f2f;margin-bottom:16px;font-weight:600;\">${msg}</div>
      <button id=\"permRevokedOkBtn\" style=\"background:linear-gradient(90deg,#1976d2 60%,#42a5f5 100%);color:white;padding:11px 0;border:none;border-radius:8px;font-size:17px;cursor:pointer;box-shadow:0 2px 8px #1976d222;width:90%;margin-top:8px;font-weight:600;transition:background 0.2s;\">حسناً</button>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #permRevokedModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #permRevokedModal div { font-size:16px !important; }
      }
      #closePermRevokedModalBtn:hover { background:#b71c1c !important; }
      #permRevokedOkBtn:hover { background:#1565c0 !important; }
    </style>
  `;
  document.body.appendChild(modal);
  document.getElementById("permRevokedOkBtn").onclick = () => { modal.remove(); };
  document.getElementById("closePermRevokedModalBtn").onclick = () => { modal.remove(); };
};

// إضافة مستخدم جديد
async function addUser() {
  if (!preventEditIfNotCurrentMonth()) return;
  const username = document.getElementById("newUserName").value.trim().toLowerCase();
  const password = document.getElementById("newUserPass").value.trim();
  const canEdit = document.getElementById("newUserCanEdit").checked;
  if (!username || !password) {
    alert("❌ يرجى إدخال اسم المستخدم وكلمة المرور");
    return;
  }
  const snapshot = await db.ref("users/" + username).once("value");
  if (snapshot.exists()) {
    alert("❌ اسم المستخدم موجود مسبقاً");
    return;
  }
  try {
    const hashObj = await hashPassword(password);
    await db.ref("users/" + username).set({ password: hashObj, role: "user", canEdit });
    alert("✅ تم إنشاء المستخدم بنجاح");
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPass").value = "";
    document.getElementById("newUserCanEdit").checked = true;
    loadUsers();
  } catch (err) {
    console.error(err);
    alert("❌ حدث خطأ أثناء إنشاء المستخدم");
  }
}

// ========== إدارة الموظفين ==========
function addEmployee() {
  if (!canEditCurrentMonth()) return;
  const name = document.getElementById("newEmployeeName").value.trim();
  if (!name) { alert("❌ يرجى إدخال اسم الموظف"); return; }
  if (employees.includes(name)) { alert("❌ الموظف موجود مسبقاً"); return; }
  // الموظف الجديد دائماً يظهر في نهاية الجدول (بدون ترتيب أبجدي)
  const newEmployees = [...employees, name];
  saveEmployees(newEmployees);
  document.getElementById("newEmployeeName").value = "";
}
function loadEmployeesTable() {
  const tbody = document.getElementById("employeesBody");
  tbody.innerHTML = "";
  employees.forEach((emp, idx) => {
    const tr = document.createElement("tr");
    const nameTd = document.createElement("td");
    nameTd.textContent = emp;
    nameTd.id = `employeeName_${idx}`;
    const actionsTd = document.createElement("td");
    const editBtn = document.createElement("button");
    editBtn.textContent = "✏️ تعديل";
    editBtn.className = "small-button btn-edit";
    editBtn.onclick = () => enableEmployeeEdit(idx);
    actionsTd.appendChild(editBtn);
    // زر الحذف يظهر فقط في الشهر الحالي
    if (isCurrentMonthSelected()) {
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "حذف";
      deleteBtn.className = "small-button btn-delete";
      deleteBtn.onclick = () => deleteEmployee(idx);
      actionsTd.appendChild(deleteBtn);
    }
    tr.appendChild(nameTd);
    tr.appendChild(actionsTd);
    tbody.appendChild(tr);
  });
}
function enableEmployeeEdit(index) {
  if (!canEditCurrentMonth()) return;
  const nameTd = document.getElementById(`employeeName_${index}`);
  const oldName = nameTd.textContent;
  nameTd.innerHTML = "";
  const input = document.createElement("input");
  input.type = "text";
  input.value = oldName;
  input.style.width = "80%";
  nameTd.appendChild(input);
  const saveBtn = document.createElement("button");
  saveBtn.textContent = "💾 حفظ";
  saveBtn.className = "small-button btn-edit";
  saveBtn.style.marginLeft = "5px";
  saveBtn.onclick = async () => {
    if (!canEditCurrentMonth()) return;
    const newName = input.value.trim();
    if (!newName) { alert("❌ اسم الموظف لا يمكن أن يكون فارغاً"); return; }
    if (employees.includes(newName)) { alert("❌ اسم الموظف موجود مسبقاً"); return; }
    // تحديث بيانات الحضور فقط لأيام الشهر الحالي
    const days = getDays();
    const attendanceSnapshot = await db.ref("attendance").once("value");
    const attendance = attendanceSnapshot.val() || {};
    days.forEach(day => {
      const dayKey = day.key;
      if (attendance[dayKey] && Object.prototype.hasOwnProperty.call(attendance[dayKey], oldName)) {
        attendance[dayKey][newName] = attendance[dayKey][oldName];
        delete attendance[dayKey][oldName];
      }
    });
    await db.ref("attendance").set(attendance);
    const newEmployees = employees.slice();
    newEmployees[index] = newName;
    saveEmployees(newEmployees);
  };
  nameTd.appendChild(saveBtn);
}

// ========== إحصائيات ==========
function calculateStats(savedData) {
  // جلب صلاحيات المستخدم الحالي
  db.ref("users/" + currentUser).once("value").then(userSnap => {
    const userData = userSnap.val() || {};
    const isAdmin = userData.role === "admin";
    const allowedEmps = isAdmin ? employees.slice() : (userData.allowedStatsEmps || []);
    const canViewSalary = isAdmin ? true : !!userData.canViewSalary;
    // بناء counts فقط للموظفين المسموحين
    const counts = {};
    allowedEmps.forEach(e=>{ counts[e]={'شفت':0,'نص':0,'❌':0}; });
    // تصفية البيانات حسب الشهر والسنة الحاليين
    Object.entries(savedData).forEach(([dateStr, day]) => {
      let parts = dateStr.split("-");
      if (parts.length === 3) {
        let dYear = parseInt(parts[0]);
        let dMonth = parseInt(parts[1]) - 1;
        if (dYear === year && dMonth === month) {
          allowedEmps.forEach(e=>{
            const val = day[e];
            if (val && counts[e][val] !== undefined) counts[e][val] += 1;
          });
        }
      }
    });
    const bestShift = Object.entries(counts).sort((a,b)=>b[1]["شفت"]-a[1]["شفت"])[0];
    const bestHalf  = Object.entries(counts).sort((a,b)=>b[1]["نص"]-a[1]["نص"])[0];
    const mostX     = Object.entries(counts).sort((a,b)=>b[1]["❌"]-a[1]["❌"])[0];
    const statsDiv = document.getElementById('statsBox');
    statsDiv.innerHTML = `
      <p>أكثر موظف شفت: <b>${bestShift ? bestShift[0]+` (${bestShift[1]["شفت"]})` : '—'}</b></p>
      <p>أكثر موظف نص: <b>${bestHalf ? bestHalf[0]+` (${bestHalf[1]["نص"]})` : '—'}</b></p>
      <p>أكثر موظف ❌: <b>${mostX ? mostX[0]+` (${mostX[1]["❌"]})` : '—'}</b></p>`;

    // عرض إحصائيات كل موظف أسفل الجدول بتصميم حديث مع الراتب
    const empStatsDiv = document.getElementById('empStatsBelowTable');
    if (empStatsDiv) {
      let html = `<div class="emp-stats-bar-official">
        <table class="emp-stats-table-official">
          <thead>
            <tr>
              <th>الموظف</th>
              <th>شفت</th>
              <th>نص</th>
              <th>إجازة</th>
              ${canViewSalary ? '<th>الراتب الكلي</th>' : ''}
            </tr>
          </thead>
          <tbody>`;
      allowedEmps.forEach(emp => {
        const shift = counts[emp]["شفت"] || 0;
        const half = counts[emp]["نص"] || 0;
        const vac = counts[emp]["❌"] || 0;
        const salary = (shift * 20000) + (half * 10000);
        html += `<tr>
          <td class="emp-name-official">${emp}</td>
          <td class="emp-stat-official shift">${shift}</td>
          <td class="emp-stat-official half">${half}</td>
          <td class="emp-stat-official vac">${vac}</td>
          ${canViewSalary ? `<td class="emp-salary-official">${salary.toLocaleString()} د.ع</td>` : ''}
        </tr>`;
      });
      html += `</tbody></table></div>`;
      empStatsDiv.innerHTML = html;
    }
  });
    // CSS احترافي ومتجاوب
    if (!document.getElementById('empStatsProStyle')) {
      const style = document.createElement('style');
      style.id = 'empStatsProStyle';
      style.innerHTML = `
        .emp-stats-bar-official {
          width: 100%;
          margin: 0 auto 18px auto;
          background: #f8f9fa;
          border-radius: 12px;
          box-shadow: 0 1px 8px #e3eafc33;
          padding: 0 0 8px 0;
          overflow-x: auto;
        }
        .emp-stats-table-official {
          width: 100%;
          border-collapse: collapse;
          font-size: 16px;
          background: none;
        }
        .emp-stats-table-official th, .emp-stats-table-official td {
          border: 1px solid #e0e0e0;
          padding: 8px 10px;
          text-align: center;
        }
        .emp-stats-table-official th {
          background: #e3f0ff;
          color: #1976d2;
          font-weight: bold;
          font-size: 17px;
        }
        .emp-name-official {
          color: #1976d2;
          font-weight: 600;
        }
        .emp-stat-official.shift { color: #28a745; font-weight: 500; }
        .emp-stat-official.half { color: #ff9800; font-weight: 500; }
        .emp-stat-official.vac { color: #d32f2f; font-weight: 500; }
        .emp-salary-official {
          color: #388e3c;
          font-weight: bold;
          background: #e8fbe8;
          border-radius: 6px;
        }
        @media (max-width: 900px) {
          .emp-stats-table-official th, .emp-stats-table-official td { font-size: 14px; padding: 6px 4px; }
        }
        @media (max-width: 600px) {
          .emp-stats-bar-official { border-radius: 7px; }
          .emp-stats-table-official th, .emp-stats-table-official td { font-size: 13px; padding: 5px 2px; }
        }
      `;
      document.head.appendChild(style);
    }
    // تأثير ripple احترافي مطور
    if (!window.rippleEffect) {
      window.rippleEffect = function(e, el) {
        // منع تكرار التأثيرات المتداخلة
        if (el.classList.contains('ripple-active')) return;
        el.classList.add('ripple-active');
        let rect = el.getBoundingClientRect();
        let ripple = document.createElement('span');
        ripple.className = 'ripple';
        let size = Math.max(rect.width, rect.height) * 1.1;
        ripple.style.width = ripple.style.height = size + 'px';
        let x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left - size/2;
        let y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top - size/2;
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        el.appendChild(ripple);
        setTimeout(()=>{ ripple.remove(); el.classList.remove('ripple-active'); }, 700);
      }
    }
  // ...existing code...
}

  // زر لترحيل كلمات المرور القديمة
// ========== Tabs للأشهر ==========

// زر عائم للأشهر بشكل دائري حديث
const monthsFab = document.createElement("div");
monthsFab.id = "monthsFab";
monthsFab.innerHTML = `<button id="fabMainMonth" class="fab-month"></button><div id="fabMonthsList" style="display:none;"></div>`;
monthsFab.style.position = "fixed";
monthsFab.style.bottom = "22px";
monthsFab.style.left = "22px";
monthsFab.style.zIndex = "9999";
document.body.appendChild(monthsFab);

function loadAvailableMonths() {
  Promise.all([
    db.ref("attendance").once("value"),
    db.ref("monthsSettings/manual").once("value"),
    db.ref("monthsSettings/hidden").once("value"),
    db.ref("users/" + (currentUser || "")).once("value")
  ]).then(([attSnap, manualSnap, hiddenSnap, userSnap]) => {
    const data = attSnap.val() || {};
    const manual = manualSnap.val() || [];
    const hidden = hiddenSnap.val() || {};
    const user = userSnap.val() || {};
    const isAdmin = user.role === "admin";
    const monthsSet = new Set();
    Object.keys(data).forEach(key => {
      const parts = key.split("-");
      if (parts.length === 3) {
        const m = parseInt(parts[1]) - 1;
        const y = parseInt(parts[0]);
        monthsSet.add(`${y}-${m}`);
      }
    });
    manual.forEach(m => monthsSet.add(m));
    // أضف الشهر الحالي دائماً
    const now = new Date();
    const currentMonthKey = `${now.getFullYear()}-${now.getMonth()}`;
    monthsSet.add(currentMonthKey);
    let monthsArr = Array.from(monthsSet).sort((a,b)=>{
      const [ya,ma]=a.split('-').map(Number), [yb,mb]=b.split('-').map(Number);
      return ya!==yb?ya-yb:ma-mb;
    });
    // إخفاء الأشهر المخفية عن غير المدير
    if (!isAdmin) {
      monthsArr = monthsArr.filter(m => !hidden[m]);
    }
    renderMonthFab(monthsArr);
  });
}

function renderMonthFab(months) {
  const fabBtn = document.getElementById("fabMainMonth");
  const fabList = document.getElementById("fabMonthsList");
  // الزر الرئيسي: إيموجي فقط
  fabBtn.textContent = "📅";
  fabBtn.title = `تغيير الشهر`;
  fabBtn.style.background = "#007bff";
  fabBtn.style.color = "white";
  fabBtn.style.fontWeight = "bold";
  fabBtn.style.fontSize = "20px";
  fabBtn.style.boxShadow = "0 2px 8px #007bff44";
  fabBtn.style.transition = "box-shadow 0.2s";
  fabBtn.onmouseenter = ()=>fabBtn.style.boxShadow = "0 4px 16px #007bff77";
  fabBtn.onmouseleave = ()=>fabBtn.style.boxShadow = "0 2px 8px #007bff44";
  fabBtn.onclick = function() {
    fabList.style.display = fabList.style.display === "none" ? "flex" : "none";
  };
  fabList.innerHTML = "";
  fabList.style.position = "absolute";
  fabList.style.bottom = "60px";
  fabList.style.left = "0";
  fabList.style.flexDirection = "column";
  fabList.style.gap = "8px";
  fabList.style.alignItems = "flex-start";
  fabList.style.transition = "all 0.2s";
  // تحسين عرض القائمة على الهاتف
  fabList.style.background = "#fff";
  fabList.style.borderRadius = "12px";
  fabList.style.boxShadow = "0 4px 16px #007bff22";
  fabList.style.padding = "8px 6px";
  fabList.style.minWidth = "48px";
  fabList.style.maxHeight = "60vh";
  fabList.style.overflowY = "auto";
  months.slice().reverse().forEach(m => {
    const [y, mo] = m.split('-');
    const btn = document.createElement("button");
    btn.textContent = `${parseInt(mo)+1}-${y}`; // رقم الشهر والسنة
    btn.className = "fab-month fab-month-mini";
    btn.style.background = (parseInt(y) === year && parseInt(mo) === month) ? "#007bff" : "#f4f4f4";
    btn.style.color = (parseInt(y) === year && parseInt(mo) === month) ? "white" : "#333";
    btn.title = `${arMonths[parseInt(mo)]} ${y}`;
    btn.style.margin = "2px 0";
    btn.onclick = function() {
      month = parseInt(mo);
      window.year = parseInt(y);
      const empKey = `employees_${year}_${(month+1).toString().padStart(2,'0')}`;
      loadEmployees(empKey).then(() => {
        generateTable();
        renderMonthFab(months);
        fabList.style.display = "none";
      });
    };
    fabList.appendChild(btn);
  });
  // إغلاق القائمة عند الضغط خارجها (للموبايل)
  document.addEventListener('click', function fabListClose(e) {
    if (!fabList.contains(e.target) && e.target !== fabBtn) {
      fabList.style.display = "none";
      document.removeEventListener('click', fabListClose);
    }
  });
}

// CSS للأزرار العائمة
const fabStyle = document.createElement("style");
fabStyle.innerHTML = `
  .fab-month {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    outline: none;
    box-shadow: 0 2px 8px #007bff44;
    background: #007bff;
    color: white;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0;
    transition: box-shadow 0.2s, background 0.2s, color 0.2s;
  }
  .fab-month-mini {
    width: 36px;
    height: 36px;
    font-size: 16px;
    margin-bottom: 2px;
    background: #f4f4f4;
    color: #333;
    border: 2px solid #007bff22;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s, border 0.2s;
  }
  .fab-month-mini:hover {
    background: #007bff;
    color: white;
    border: 2px solid #007bff;
  }
  @media (max-width: 600px) {
    #monthsFab {
      left: 8px !important;
      bottom: 8px !important;
    }
    .fab-month, .fab-month-mini {
      width: 34px !important;
      height: 34px !important;
      font-size: 15px !important;
    }
    #fabMonthsList {
      min-width: 38px !important;
      padding: 5px 2px !important;
      border-radius: 10px !important;
      box-shadow: 0 2px 8px #007bff22 !important;
      gap: 4px !important;
    }
  }
`;
document.head.appendChild(fabStyle);
if (localStorage.getItem('loggedUser')) { loadAvailableMonths(); }

// ========== زر فتح/إغلاق لوحة التحكم ==========
const toggleAdminBtn = document.createElement("button");
toggleAdminBtn.id = "toggleAdminBtn";
toggleAdminBtn.textContent = "⚙️ لوحة التحكم";
toggleAdminBtn.style.backgroundColor = "#6c757d";
toggleAdminBtn.style.color = "white";
toggleAdminBtn.style.border = "none";
toggleAdminBtn.style.width = "100%";
toggleAdminBtn.style.padding = "10px";
toggleAdminBtn.style.marginTop = "15px";
toggleAdminBtn.style.fontSize = "16px";
toggleAdminBtn.style.borderRadius = "5px";
toggleAdminBtn.style.cursor = "pointer";
toggleAdminBtn.style.transition = "background 0.2s ease";
toggleAdminBtn.onmouseover = () => { toggleAdminBtn.style.backgroundColor = "#5a6268"; };
toggleAdminBtn.onmouseout = () => {
  if (adminPanel.style.maxHeight === "0px") toggleAdminBtn.style.backgroundColor = "#6c757d";
};
const logoutBtn = document.querySelector("button[onclick='logout()']");
logoutBtn.parentNode.insertBefore(toggleAdminBtn, logoutBtn);
const adminPanel = document.getElementById("adminPanel");
adminPanel.style.maxHeight = "0px";
adminPanel.style.overflow = "hidden";
adminPanel.style.transition = "max-height 0.4s ease";
toggleAdminBtn.onclick = () => {
  if (adminPanel.style.maxHeight === "0px") {
    adminPanel.style.maxHeight = adminPanel.scrollHeight + "px";
    toggleAdminBtn.style.backgroundColor = "green";
    setTimeout(() => {
      adminPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 200);
  } else {
    adminPanel.style.maxHeight = "0px";
    toggleAdminBtn.style.backgroundColor = "#6c757d";
  }
};

// ========== حذف متقدم ==========
function advancedDelete() {
  // نافذة اختيار العملية بشكل أزرار واضحة
  let modal = document.getElementById("deleteChoiceModal");
  if (modal) modal.remove();
  modal = document.createElement("div");
  modal.id = "deleteChoiceModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:#fff;max-width:370px;width:92vw;padding:26px 18px 20px 18px;border-radius:16px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <button id=\"closeDeleteChoiceModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;transition:background 0.2s;\">✖</button>
      <div style=\"font-size:18px;color:#333;margin-bottom:20px;font-weight:500;\">اختر العملية التي تريد تنفيذها:</div>
      <div style=\"display:flex;flex-direction:column;gap:10px;align-items:center;\">
        <button class=\"deleteOpBtn\" data-op=\"1\" style=\"background:#e91e63;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">1 - حذف الموظفين فقط</button>
        <button class=\"deleteOpBtn\" data-op=\"2\" style=\"background:#9c27b0;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">2 - حذف حسابات المستخدمين</button>
        <button class=\"deleteOpBtn\" data-op=\"3\" style=\"background:#ff9800;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">3 - حذف التاشيرات (شفت، نص، ❌)</button>
        <button class=\"deleteOpBtn\" data-op=\"4\" style=\"background:#009688;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">4 - حذف سجل النشاطات</button>
        <button class=\"deleteOpBtn\" data-op=\"5\" style=\"background:#607d8b;color:white;padding:10px 22px;border:none;border-radius:7px;font-size:16px;cursor:pointer;\">5 - حذف كل البيانات</button>
        <button onclick=\"clearDatabase()\" style=\"background:#e53935;color:white;margin-top:10px;width:100%;font-size:15px;padding:8px 0;border-radius:7px;\">🗑️ مسح جميع بيانات قاعدة البيانات</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  document.getElementById("closeDeleteChoiceModalBtn").onclick = function() { modal.remove(); };
  Array.from(document.getElementsByClassName("deleteOpBtn")).forEach(btn => {
    btn.onclick = function() {
      const choice = btn.getAttribute("data-op");
      modal.remove();
      // نافذة إدخال كلمة مرور المدير
      let passModal = document.getElementById("adminPassModal");
      if (passModal) passModal.remove();
      passModal = document.createElement("div");
      passModal.id = "adminPassModal";
      passModal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;display:flex;align-items:center;justify-content:center;`;
      passModal.innerHTML = `
        <div style=\"background:#fff;max-width:350px;width:90vw;padding:22px 18px 18px 18px;border-radius:14px;box-shadow:0 8px 32px #0002;position:relative;text-align:center;\">
          <button id=\"closeAdminPassModalBtn\" style=\"position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;\">✖</button>
          <div style=\"font-size:17px;color:#333;margin-bottom:18px;\">يرجى إدخال كلمة مرور المدير للتأكيد:</div>
          <input id=\"adminPassInput\" type=\"password\" style=\"width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;\" />
          <button id=\"adminPassConfirmBtn\" style=\"background:#007bff;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;\">تأكيد</button>
        </div>
      `;
      document.body.appendChild(passModal);
      document.getElementById("adminPassConfirmBtn").onclick = async function() {
        const adminPass = document.getElementById("adminPassInput").value;
        passModal.remove();
        const snapshot = await db.ref("users/admin/password").once("value");
        const realAdminPass = snapshot.val();
        const ok = await verifyPassword(realAdminPass, adminPass);
        if (!ok) {
          alert("❌ كلمة المرور غير صحيحة!");
          return;
        }
        // نافذة تأكيد نهائي
        showConfirmModal("هل أنت متأكد من تنفيذ هذا الإجراء؟ لا يمكن التراجع عنه!", () => {
          switch(choice) {
            case "1": {
              // حذف موظفي الشهر الحالي فقط
              const empKey = `employees_${year}_${(month+1).toString().padStart(2,'0')}`;
              db.ref("employees/" + empKey).remove()
                .then(() => alert("✅ تم حذف موظفي الشهر الحالي فقط."))
                .catch(e => alert("❌ خطأ في حذف الموظفين: " + e.message));
              break;
            }
            case "2":
              db.ref("users").remove()
                .then(() => alert("✅ تم حذف حسابات المستخدمين."))
                .catch(e => alert("❌ خطأ في حذف حسابات المستخدمين: " + e.message));
              break;
            case "3": {
              // حذف التاشيرات (الحضور) للشهر الحالي فقط
              const days = getDays();
              const updates = {};
              days.forEach(day => { updates[day.key] = null; });
              db.ref("attendance").update(updates)
                .then(() => alert("✅ تم حذف تاشيرات الشهر الحالي فقط."))
                .catch(e => alert("❌ خطأ في حذف التاشيرات: " + e.message));
              break;
            }
            case "4":
              db.ref("activityLog").remove()
                .then(() => alert("✅ تم حذف سجل النشاطات."))
                .catch(e => alert("❌ خطأ في حذف سجل النشاطات: " + e.message));
              break;
            case "5":
              Promise.all([
                db.ref("employees").remove(),
                db.ref("attendance").remove(),
                db.ref("activityLog").remove(),
                db.ref("users").once("value").then(snapshot => {
                  const users = snapshot.val() || {};
                  const updates = {};
                  Object.keys(users).forEach(username => {
                    if (username !== currentUser) updates[username] = null;
                  });
                  return db.ref("users").update(updates);
                })
              ]).then(() => {
                alert("✅ تم حذف كل البيانات ما عدا حسابك الحالي.");
              }).catch(e => {
                alert("❌ خطأ في حذف البيانات: " + e.message);
              });
              break;
          }
        });
      };
      document.getElementById("closeAdminPassModalBtn").onclick = function() { passModal.remove(); };
    };
  });
}
document.addEventListener("DOMContentLoaded", () => {
  const btnDeleteData = document.getElementById("btnDeleteData");
  if (btnDeleteData) btnDeleteData.addEventListener("click", advancedDelete);
});

// ========== طرد المستخدم ==========
function checkForcedLogoutOnLogin(userKey) {
  return db.ref("forcedLogout/" + userKey).once("value").then(snapshot => {
    if (snapshot.exists()) {
      localStorage.removeItem('loggedUser');
      db.ref("users/" + userKey).once("value").then(userSnap => {
        if (!userSnap.exists()) {
          showAccountDeletedModal();
        } else {
          showForcedLogoutModal();
        }
      });
      db.ref("forcedLogout/" + userKey).remove();
      setTimeout(()=>location.reload(), 2500);
      return true;
    }
    return false;
  });
}

// نافذة أنيقة عند حذف حساب المستخدم من قبل المدير
function showAccountDeletedModal() {
  let oldModal = document.getElementById("accountDeletedModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "accountDeletedModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#fff7f7 60%,#fce4ec 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #e5737333;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <div style=\"font-size:21px;color:#d32f2f;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">🚫 تم حذف حسابك</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#fff3f3;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #e5737311;\">تم حذف حسابك من قبل المدير.<br>لن تتمكن من الدخول إلا إذا تم إنشاؤه من جديد.</div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #accountDeletedModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #accountDeletedModal div { font-size:16px !important; }
      }
    </style>
  `;
  document.body.appendChild(modal);
}

// نافذة أنيقة عند تسجيل خروج المستخدم إجباريًا (احتياط)
function showForcedLogoutModal() {
  let oldModal = document.getElementById("forcedLogoutModal");
  if (oldModal) oldModal.remove();
  const modal = document.createElement("div");
  modal.id = "forcedLogoutModal";
  modal.style = `position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;display:flex;align-items:center;justify-content:center;`;
  modal.innerHTML = `
    <div style=\"background:linear-gradient(135deg,#f7faff 60%,#e3eafc 100%);max-width:370px;width:92vw;padding:32px 20px 22px 20px;border-radius:18px;box-shadow:0 8px 32px #1976d233;position:relative;text-align:center;animation:fadeIn 0.3s;\">
      <div style=\"font-size:21px;color:#1976d2;margin-bottom:18px;font-weight:700;letter-spacing:0.2px;\">🚪 تم تسجيل خروجك</div>
      <div style=\"font-size:16.5px;color:#2d3a4a;line-height:1.8;margin-bottom:16px;background:#f3f7ff;border-radius:8px;padding:10px 7px 8px 7px;box-shadow:0 1px 4px #1976d211;\">تم تسجيل خروجك من قبل المدير.<br>لن تتمكن من استخدام النظام حتى تعيد تسجيل الدخول.</div>
    </div>
    <style>
      @keyframes fadeIn { from { opacity:0; transform:scale(0.95);} to { opacity:1; transform:scale(1);} }
      @media (max-width: 600px) {
        #forcedLogoutModal > div { max-width:99vw !important; padding:18px 2vw 18px 2vw !important; }
        #forcedLogoutModal div { font-size:16px !important; }
      }
    </style>
  `;
  document.body.appendChild(modal);
}
if (localStorage.getItem('loggedUser')) {
  const savedUser = JSON.parse(localStorage.getItem('loggedUser'));
  checkForcedLogoutOnLogin(savedUser.user);
}
setInterval(() => {
  if (currentUser) {
    db.ref("forcedLogout/" + currentUser).once("value").then(snapshot => {
      if (snapshot.exists()) {
        localStorage.removeItem('loggedUser');
        showForcedLogoutModal();
        db.ref("forcedLogout/" + currentUser).remove();
        setTimeout(()=>location.reload(), 2500);
      }
    });
  }
}, 3000);

// ========== إحصائيات الموظفين للمستخدمين ==========
function setEmpStatsEnabled(enabled) {
  db.ref("settings/showEmpStats").set(enabled ? true : false);
}
function getEmpStatsEnabled() {
  return db.ref("settings/showEmpStats").once("value").then(snap => !!snap.val());
}
function setEmpStatsMode(mode, value) {
  db.ref("settings/empStatsMode").set({mode, value: value || ""});
}
function getEmpStatsMode() {
  return db.ref("settings/empStatsMode").once("value").then(snap => snap.val() || {mode:"all",value:""});
}
// نافذة تفاصيل إحصائيات الموظفين للمدير
document.getElementById("toggleEmpStatsBtn").onclick = function() {
  let tab = document.getElementById("empStatsTab");
  tab.style.display = "flex";
  document.getElementById("closeEmpStatsTab").onclick = function() { tab.style.display = "none"; };
  renderEmpStatsTabContent();
};

// عرض إعدادات صلاحيات الإحصائيات لكل مستخدم
function renderEmpStatsTabContent() {
  const contentDiv = document.getElementById("empStatsTabContent");
  contentDiv.innerHTML = "جاري التحميل...";
  Promise.all([
    db.ref("users").once("value"),
    db.ref(`employees_${year}_${(month+1).toString().padStart(2,'0')}`).once("value")
  ]).then(([usersSnap, empsSnap]) => {
    const users = usersSnap.val() || {};
    // استخدم نفس منطق تحميل الموظفين الشهري
    const employeesList = empsSnap.exists() ? Object.values(empsSnap.val()) : [];
    let html = `<div style='font-size:15px;color:#333;margin-bottom:10px;text-align:center;'>تحكم بعرض إحصائيات الموظفين للمستخدمين</div>`;
    html += `<table style='width:100%;border-collapse:collapse;'>
      <tr style='background:#f6f6f6;'>
        <th>المستخدم</th>
        <th>الموظفون المسموح عرضهم</th>
        <th>عرض الرواتب</th>
      </tr>`;
    Object.entries(users).forEach(([username, data]) => {
      if (username === "admin") return;
      const allowedEmps = data.allowedStatsEmps || [];
      const canViewSalary = !!data.canViewSalary;
      html += `<tr>
        <td style='padding:7px 4px;'>${username}</td>
        <td style='padding:7px 4px;'>
          <select multiple data-user='${username}' class='allowedEmpsSelect' style='width:140px;min-height:38px;font-size:15px;'>
            ${employeesList.map(emp => `<option value='${emp}' ${allowedEmps.includes(emp)?"selected":""}>${emp}</option>`).join("")}
          </select>
        </td>
        <td style='padding:7px 4px;text-align:center;'>
  <label style='display:inline-flex;align-items:center;gap:7px;'>
    <span style='font-size:15px;color:#1976d2;'>الرواتب</span>
    <input type='checkbox' data-user='${username}' class='canViewSalaryCheckbox' ${canViewSalary?"checked":""} />
  </label>
</td>
      </tr>`;
    });
    html += `</table><div style='font-size:13px;color:#555;margin-top:8px;'>حدد الموظفين المسموح عرضهم لكل مستخدم، وخيار عرض الرواتب. التغيير فوري.</div>`;
    contentDiv.innerHTML = html;

    // حفظ الموظفين المسموح عرضهم عند التغيير
    Array.from(document.getElementsByClassName("allowedEmpsSelect")).forEach(sel => {
      sel.onchange = function() {
        const user = sel.getAttribute("data-user");
        const selected = Array.from(sel.selectedOptions).map(opt => opt.value);
        // تحديث قاعدة البيانات
        db.ref("users/"+user+"/allowedStatsEmps").set(selected).then(()=>{
          logActivity("تغيير صلاحية إحصائيات الموظفين","تم تغيير الموظفين المسموح عرضهم للمستخدم: "+user+" إلى: "+selected.join(", "));
        });
        // إذا كان المستخدم الحالي هو المتأثر، حدث الإحصائيات فوراً (بدون انتظار قاعدة البيانات)
        if (user === currentUser) {
          // تحديث صلاحيات المستخدم الحالي في الذاكرة
          if (window.currentUserData) window.currentUserData.allowedStatsEmps = selected;
          // إعادة حساب الإحصائيات فوراً
          db.ref("attendance").once("value").then(snap => {
            calculateStats(snap.val() || {});
          });
        }
      };
    });
    // حفظ خيار الرواتب عند التغيير
    Array.from(document.getElementsByClassName("canViewSalaryCheckbox")).forEach(chk => {
      chk.onchange = function() {
        const user = chk.getAttribute("data-user");
        const val = chk.checked;
        // تحديث قاعدة البيانات
        db.ref("users/"+user+"/canViewSalary").set(val).then(()=>{
          logActivity("تغيير صلاحية الرواتب","تم تغيير صلاحية عرض الرواتب للمستخدم: "+user+" إلى: "+(val?"نعم":"لا"));
        });
        // إذا كان المستخدم الحالي هو المتأثر، حدث الإحصائيات فوراً (بدون انتظار قاعدة البيانات)
        if (user === currentUser) {
          if (window.currentUserData) window.currentUserData.canViewSalary = val;
          db.ref("attendance").once("value").then(snap => {
            calculateStats(snap.val() || {});
          });
        }
      };
    });
    // مراقبة تغييرات صلاحيات المستخدم الحالي بشكل فوري (Realtime)
    if (typeof window._statsPermsListenerSet === "undefined") {
      window._statsPermsListenerSet = true;
      ["allowedStatsEmps","canViewSalary"].forEach(key => {
        db.ref("users/"+currentUser+"/"+key).on("value", function() {
          db.ref("attendance").once("value").then(snap => {
            calculateStats(snap.val() || {});
          });
        });
      });
    }
  });
}

// ========== إحصائيات للمستخدمين ==========
const userEmpStatsDiv = document.createElement("div");
userEmpStatsDiv.id = "userEmpStatsDiv";
userEmpStatsDiv.style.margin = "20px 0";
userEmpStatsDiv.style.padding = "10px";
userEmpStatsDiv.style.background = "#f8f9fa";
userEmpStatsDiv.style.border = "1px solid #ddd";
userEmpStatsDiv.style.borderRadius = "7px";
userEmpStatsDiv.style.display = "none";
document.getElementById("mainContent").appendChild(userEmpStatsDiv);

function renderUserEmpStats() {
  Promise.all([getEmpStatsEnabled(), getEmpStatsMode()]).then(([enabled, modeObj]) => {
    if (!enabled) {
      userEmpStatsDiv.style.display = "none";
      return;
    }
    let allow = false, onlyEmp = null;
    if (modeObj.mode === "all") allow = true;
    else if (modeObj.mode === "user" && currentUser === modeObj.value) allow = true;
    else if (modeObj.mode === "employee") { allow = true; onlyEmp = modeObj.value; }
    if (!allow) { userEmpStatsDiv.style.display = "none"; return; }
    let html = `
      <b>إحصائيات الموظفين:</b>
      <div id='userEmpStatsGrid' style='margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:13px;'></div>
      <style>
        @media (max-width:600px){
          #userEmpStatsGrid{grid-template-columns:1fr;gap:8px;}
        }
        .emp-card{background:#f8f9fa;border-radius:10px;box-shadow:0 1px 6px #0001;padding:15px 10px;display:flex;flex-direction:column;align-items:center;transition:box-shadow 0.2s;}
        .emp-card .emp-name{font-weight:bold;font-size:16px;color:#007bff;margin-bottom:7px;}
        .emp-card .emp-stats{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
        .emp-card .stat{display:flex;align-items:center;gap:4px;font-size:14px;background:#fff;border-radius:6px;padding:4px 9px;margin:2px 0;box-shadow:0 1px 3px #0001;}
        .emp-card .stat.shift{color:#28a745;}
        .emp-card .stat.half{color:#ffc107;}
        .emp-card .stat.absent{color:#dc3545;}
      </style>
    `;
    userEmpStatsDiv.innerHTML = html;
    const gridDiv = document.getElementById("userEmpStatsGrid");
    gridDiv.innerHTML = "<div style='text-align:center;width:100%;color:#888;'>جاري التحميل...</div>";
    db.ref("attendance").once("value").then(snapshot => {
      const data = snapshot.val() || {};
      // استخدم صلاحيات المستخدم الحالي من الذاكرة إذا كان هو المتأثر
      let allowedEmps, canViewSalary;
      if (typeof window.currentUserData !== "undefined") {
        allowedEmps = window.currentUserData.allowedStatsEmps || [];
        canViewSalary = !!window.currentUserData.canViewSalary;
      } else {
        allowedEmps = [];
        canViewSalary = false;
      }
      // إذا كان المدير، يرى الجميع
      let showEmps = (currentUserRole === "admin") ? window.monthEmployees : allowedEmps;
      // إذا لم يتم تحديد صلاحيات، يرى الجميع
      if (!Array.isArray(showEmps) || showEmps.length === 0) showEmps = window.monthEmployees;
      // تحقق من وجود موظفين
      if (!Array.isArray(showEmps) || showEmps.length === 0) {
        gridDiv.innerHTML = "<div style='text-align:center;width:100%;color:#888;'>لا يوجد موظفون لهذا الشهر.</div>";
        userEmpStatsDiv.style.display = "block";
        return;
      }
      // تحقق من وجود بيانات حضور للشهر الحالي
      let hasAttendance = false;
      Object.entries(data).forEach(([dateStr, day]) => {
        let parts = dateStr.split("-");
        if (parts.length === 3) {
          let dYear = parseInt(parts[0]);
          let dMonth = parseInt(parts[1]) - 1;
          if (dYear === year && dMonth === month) hasAttendance = true;
        }
      });
      if (!hasAttendance) {
        gridDiv.innerHTML = "<div style='text-align:center;width:100%;color:#888;'>لا توجد بيانات حضور لهذا الشهر.</div>";
        userEmpStatsDiv.style.display = "block";
        return;
      }
      gridDiv.innerHTML = "";
      showEmps.forEach(emp => {
        if (onlyEmp && emp !== onlyEmp) return;
        let shift=0, half=0, x=0;
        Object.entries(data).forEach(([dateStr, day]) => {
          let parts = dateStr.split("-");
          if (parts.length === 3) {
            let dYear = parseInt(parts[0]);
            let dMonth = parseInt(parts[1]) - 1;
            if (dYear === year && dMonth === month) {
              if (day[emp] === "شفت") shift++;
              if (day[emp] === "نص") half++;
              if (day[emp] === "❌") x++;
            }
          }
        });
        const salary = (shift * 20000) + (half * 10000);
        const card = document.createElement("div");
        card.className = "emp-card";
        card.innerHTML = `
          <div class='emp-name'>${emp}</div>
          <div class='emp-stats'>
            <div class='stat shift'>✅ شفت: <b>${shift}</b></div>
            <div class='stat half'>🌓 نص: <b>${half}</b></div>
            <div class='stat absent'>🏖️ اجازة: <b>${x}</b></div>
          </div>
          ${canViewSalary || currentUserRole === "admin" ? `<div class='emp-salary' style='margin-top:8px;font-size:15px;color:#222;background:#e3f7e3;padding:6px 0;border-radius:7px;width:100%;text-align:center;'>💰 الراتب الكلي: <b>${salary.toLocaleString()} د.ع</b></div>` : ""}
        `;
        gridDiv.appendChild(card);
      });
      userEmpStatsDiv.style.display = "block";
    });
  });
}
function tryShowUserEmpStats() {
if (typeof window.monthEmployees !== "undefined" && window.monthEmployees.length > 0) renderUserEmpStats();
}
const origLoadEmployees = loadEmployees;
loadEmployees = function() {
  return origLoadEmployees.apply(this, arguments).then(() => {
    if (typeof window.monthEmployees !== "undefined" && window.monthEmployees.length > 0) {
      renderUserEmpStats();
    }
  });
};
if (localStorage.getItem('loggedUser')) tryShowUserEmpStats();
db.ref("settings/empStatsMode").on("value", () => renderUserEmpStats());

// ========== تغيير كلمة مرور المدير ==========
// تعديل: السماح فقط للمدير بتغيير كلمة المرور
function changeAdminPassword() {
  const oldPass = document.getElementById("adminOldPass").value;
  const newPass = document.getElementById("adminNewPass").value;
  const statusDiv = document.getElementById("adminPassStatus");
  if (currentUserRole !== "admin") {
    statusDiv.textContent = "❌ فقط المدير يمكنه تغيير كلمة المرور.";
    return;
  }
  if (!oldPass || !newPass) {
    statusDiv.textContent = "يرجى إدخال جميع الحقول.";
    return;
  }
  db.ref("users/admin/password").once("value").then(snapshot => {
    if (!snapshot.exists() || snapshot.val() !== oldPass) {
      statusDiv.textContent = "كلمة المرور الحالية غير صحيحة.";
      return;
    }
    db.ref("users/admin/password").set(newPass).then(() => {
      statusDiv.textContent = "✅ تم تغيير كلمة المرور بنجاح.";
      document.getElementById("adminOldPass").value = "";
      document.getElementById("adminNewPass").value = "";
      logActivity("تغيير كلمة مرور المدير", `تم تغيير كلمة المرور من قبل: ${currentUser}`);
    });
  }).catch(() => {
    statusDiv.textContent = "❌ حدث خطأ أثناء تغيير كلمة المرور.";
  });
}

// ========== حذف موظف ==========
// تعديل: السماح فقط للمدير بالحذف والتحقق من وجود الموظف
function deleteEmployee(index) {
  if (!canEditCurrentMonth()) return;
  if (currentUserRole !== "admin") {
    alert("❌ فقط المدير يمكنه حذف الموظفين.");
    return;
  }
  const empName = employees[index];
  if (!empName) {
    alert("❌ الموظف غير موجود.");
    return;
  }
  showConfirmModal(`هل أنت متأكد من حذف الموظف \"${empName}\"؟ سيتم حذف جميع بيانات حضوره أيضا.`, async () => {
    if (!canEditCurrentMonth()) return;
    const newEmployees = employees.slice();
    newEmployees.splice(index, 1);
    // Remove employee attendance
    const attendanceSnapshot = await db.ref("attendance").once("value");
    const attendance = attendanceSnapshot.val() || {};
    Object.keys(attendance).forEach(dayKey => {
      if (attendance[dayKey][empName] !== undefined) {
        delete attendance[dayKey][empName];
      }
    });
    await db.ref("attendance").set(attendance);
    saveEmployees(newEmployees);
    logActivity("حذف موظف", `تم حذف الموظف: ${empName} وجميع بيانات حضوره`);
  });
}

// ========== نسخ احتياطي للبيانات ==========
// تعديل: التعامل مع الأخطاء بشكل أفضل
function backupData() {
  document.getElementById("backupStatus").textContent = "جاري تجهيز النسخة...";
  Promise.all([
    db.ref("employees").once("value"),
    db.ref("attendance").once("value"),
    db.ref("users").once("value")
  ]).then(([empSnap, attSnap, usersSnap]) => {
    const data = {
      employees: empSnap.val() || {},
      attendance: attSnap.val() || {},
      users: usersSnap.val() || {}
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "backup-" + new Date().toISOString().slice(0,10) + ".json";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 500);
    document.getElementById("backupStatus").textContent = "✅ تم تحميل النسخة الاحتياطية.";
    logActivity("تحميل نسخة احتياطية", "تم تحميل نسخة احتياطية من البيانات");
  }).catch((err) => {
    document.getElementById("backupStatus").textContent = "❌ حدث خطأ أثناء النسخ الاحتياطي.";
    console.error("Backup error:", err);
  });
}
</script>

<!-- إضافة: نافذة تغيير كلمة المرور -->
<div id="changePassModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:6000;align-items:center;justify-content:center;">
  <div style="background:#fff;max-width:340px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;">
    <button id="closeChangePassModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:28px;height:28px;font-size:16px;cursor:pointer;">✖</button>
    <h3 style="text-align:center;margin-bottom:18px;color:#2196f3;">🔑 تغيير كلمة المرور</h3>
    <div id="changePassForm"></div>
    <div id="changePassStatus" style="margin-top:10px;font-size:14px;text-align:center;"></div>
  </div>
</div>
<script>
// فتح نافذة تغيير كلمة المرور
document.getElementById("sidebarChangePassBtn").onclick = function() {
  document.getElementById("sidebarMenu").classList.remove("open");
  showChangePassForm();
};

function showChangePassForm() {
  const modal = document.getElementById("changePassModal");
  const formDiv = document.getElementById("changePassForm");
  const statusDiv = document.getElementById("changePassStatus");
  statusDiv.textContent = "";
  // إذا المدير، يمكنه اختيار أي مستخدم أو نفسه
  if (currentUserRole === "admin") {
    db.ref("users").once("value").then(snapshot => {
      const users = snapshot.val() || {};
      let html = `<div style='margin-bottom:10px;font-size:15px;color:#1976d2;font-weight:bold;'>إدارة المستخدمين وكلمات المرور</div>
        <label style='font-size:14px;'>اختر المستخدم:</label>
        <select id="changePassUser" style="width:100%;margin-bottom:10px;">`;
      Object.keys(users).forEach(u => {
        html += `<option value="${u}" ${u===currentUser?'selected':''}>${u}${u==='admin'?' (مدير)':''}</option>`;
      });
      html += `</select>
        <label style='font-size:14px;'>اسم مستخدم جديد:</label>
        <input type="text" id="changeUserName" placeholder="اكتب اسم المستخدم الجديد (اختياري)" style="margin-bottom:8px;" />
        <label style='font-size:14px;'>كلمة مرور جديدة:</label>
        <input type="password" id="changePassNew" placeholder="اكتب كلمة المرور الجديدة (اختياري)" style="margin-bottom:8px;" />
        <button id="changeUserSubmit" style="background:#2196f3;color:white;width:100%;margin-top:8px;font-size:16px;">حفظ التغييرات</button>
        <button id="resetPassBtn" style="background:#ff9800;color:white;width:100%;margin-top:8px;font-size:16px;">إعادة ضبط كلمة المرور (بدون الحاجة للكلمة القديمة)</button>
        <div style='margin-top:10px;font-size:13px;color:#555;'>يمكنك تغيير اسم المستخدم أو كلمة المرور لأي مستخدم بسهولة.<br>زر إعادة الضبط يسمح لك بتعيين كلمة مرور جديدة مباشرة إذا نسي المستخدم كلمة المرور القديمة.</div>`;
      formDiv.innerHTML = html;
      modal.style.display = "flex";
      // تغيير اسم المستخدم أو كلمة المرور بدون الحاجة لكلمة المرور القديمة
      document.getElementById("changeUserSubmit").onclick = async function() {
        const user = document.getElementById("changePassUser").value;
        const newPass = document.getElementById("changePassNew").value;
        const newUserName = document.getElementById("changeUserName").value.trim();
        let changed = false;
        // تغيير اسم المستخدم إذا تم إدخال اسم جديد ولم يكن مستخدم مسبقًا
        if (newUserName && !users[newUserName]) {
          const userDataSnap = await db.ref("users/" + user).once("value");
          const userData = userDataSnap.val();
          await db.ref("users/" + newUserName).set(userData);
          await db.ref("users/" + user).remove();
          statusDiv.textContent = `✅ تم تغيير اسم المستخدم إلى: ${newUserName}`;
          logActivity("تغيير اسم مستخدم", `تم تغيير اسم المستخدم من ${user} إلى ${newUserName} بواسطة: ${currentUser}`);
          changed = true;
        } else if (newUserName && users[newUserName]) {
          statusDiv.textContent = "❌ اسم المستخدم الجديد مستخدم بالفعل.";
          return;
        }
        // تغيير كلمة المرور إذا تم إدخال كلمة مرور جديدة
        if (newPass) {
          const hashObj = await hashPassword(newPass);
          const targetUser = newUserName && !users[newUserName] ? newUserName : user;
          await db.ref("users/" + targetUser + "/password").set(hashObj);
          statusDiv.textContent += (changed ? "<br>" : "") + "✅ تم تغيير كلمة المرور بنجاح.";
          logActivity("تغيير كلمة مرور", `تم تغيير كلمة المرور للمستخدم: ${targetUser} بواسطة: ${currentUser}`);
          changed = true;
        }
        if (!changed) {
          statusDiv.textContent = "يرجى إدخال اسم مستخدم جديد أو كلمة مرور جديدة.";
        }
        document.getElementById("changePassNew").value = "";
        document.getElementById("changeUserName").value = "";
      };
      // إعادة ضبط كلمة المرور بدون الحاجة للكلمة القديمة
      document.getElementById("resetPassBtn").onclick = async function() {
        const user = document.getElementById("changePassUser").value;
        let newPass = "";
        // نافذة احترافية لإدخال كلمة المرور الجديدة
        let passModal = document.createElement("div");
        passModal.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:center;justify-content:center;";
        passModal.innerHTML = `<div style='background:#fff;max-width:340px;width:95vw;border-radius:12px;box-shadow:0 8px 32px #0002;padding:22px 18px 18px 18px;position:relative;text-align:center;'>
          <h3 style='color:#ff9800;margin-bottom:12px;'>إعادة ضبط كلمة المرور</h3>
          <div style='margin-bottom:10px;font-size:15px;'>أدخل كلمة المرور الجديدة للمستخدم <b style='color:#1976d2;'>${user}</b>:</div>
          <input type='password' id='newPassInput' style='width:90%;padding:8px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;margin-bottom:14px;' placeholder='كلمة المرور الجديدة' />
          <button id='confirmNewPassBtn' style='background:#2196f3;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;'>تأكيد</button>
          <button id='cancelNewPassBtn' style='background:#dc3545;color:white;padding:8px 18px;border:none;border-radius:6px;font-size:16px;cursor:pointer;margin-left:8px;'>إلغاء</button>
        </div>`;
        document.body.appendChild(passModal);
        document.getElementById('confirmNewPassBtn').onclick = async function() {
          newPass = document.getElementById('newPassInput').value;
          if (!newPass) {
            statusDiv.textContent = "يرجى إدخال كلمة مرور جديدة.";
            passModal.remove();
            return;
          }
          const hashObj = await hashPassword(newPass);
          await db.ref("users/" + user + "/password").set(hashObj);
          statusDiv.textContent = "✅ تم إعادة ضبط كلمة المرور بنجاح.";
          logActivity("إعادة ضبط كلمة مرور", `تم إعادة ضبط كلمة المرور للمستخدم: ${user} بواسطة: ${currentUser}`);
          passModal.remove();
        };
        document.getElementById('cancelNewPassBtn').onclick = function() {
          passModal.remove();
        };
      };
    });
  } else {
    let html = `
      <input type="text" id="changeUserName" placeholder="اسم مستخدم جديد (اختياري)" style="margin-bottom:8px;" />
      <input type="password" id="changePassOld" placeholder="كلمة المرور الحالية" style="margin-bottom:8px;" />
      <input type="password" id="changePassNew" placeholder="كلمة المرور الجديدة" style="margin-bottom:8px;" />
      <button id="changePassSubmit" style="background:#2196f3;color:white;width:100%;margin-top:8px;">تغيير كلمة المرور</button>
      <button id="resetPassBtn" style="background:#ff9800;color:white;width:100%;margin-top:8px;">إعادة ضبط كلمة المرور (إذا نسيت القديمة)</button>`;
    formDiv.innerHTML = html;
    modal.style.display = "flex";
    document.getElementById("changePassSubmit").onclick = async function() {
      const oldPass = document.getElementById("changePassOld").value;
      const newPass = document.getElementById("changePassNew").value;
      const newUserName = document.getElementById("changeUserName").value.trim();
      if (!oldPass || !newPass) return statusDiv.textContent = "يرجى إدخال جميع الحقول.";
      const passSnap = await db.ref("users/" + currentUser + "/password").once("value");
      const stored = passSnap.val();
      const ok = await verifyPassword(stored, oldPass);
      if (!ok) return statusDiv.textContent = "كلمة المرور الحالية غير صحيحة.";
      const hashObj = await hashPassword(newPass);
      await db.ref("users/" + currentUser + "/password").set(hashObj);
      // تغيير اسم المستخدم إذا تم إدخال اسم جديد ولم يكن مستخدم مسبقًا
      const usersSnap = await db.ref("users").once("value");
      const users = usersSnap.val() || {};
      if (newUserName && !users[newUserName]) {
        const userDataSnap = await db.ref("users/" + currentUser).once("value");
        const userData = userDataSnap.val();
        await db.ref("users/" + newUserName).set(userData);
        await db.ref("users/" + currentUser).remove();
        statusDiv.textContent = `✅ تم تغيير كلمة المرور واسم المستخدم إلى: ${newUserName}`;
        logActivity("تغيير اسم مستخدم", `تم تغيير اسم المستخدم من ${currentUser} إلى ${newUserName}`);
      } else {
        statusDiv.textContent = "✅ تم تغيير كلمة المرور بنجاح.";
      }
      logActivity("تغيير كلمة مرور", `تم تغيير كلمة المرور للمستخدم: ${currentUser}`);
      document.getElementById("changePassOld").value = "";
      document.getElementById("changePassNew").value = "";
      document.getElementById("changeUserName").value = "";
    };
    // إعادة ضبط كلمة المرور إذا نسيت القديمة
    document.getElementById("resetPassBtn").onclick = async function() {
      const newPass = prompt("أدخل كلمة المرور الجديدة:");
      if (!newPass) return statusDiv.textContent = "يرجى إدخال كلمة مرور جديدة.";
      const hashObj = await hashPassword(newPass);
      await db.ref("users/" + currentUser + "/password").set(hashObj);
      statusDiv.textContent = "✅ تم إعادة ضبط كلمة المرور بنجاح.";
      logActivity("إعادة ضبط كلمة مرور", `تم إعادة ضبط كلمة المرور للمستخدم: ${currentUser}`);
    };
  }
}
document.getElementById("closeChangePassModal").onclick = function() {
  document.getElementById("changePassModal").style.display = "none";
};

// ========== تحديث ظهور الأزرار حسب الدور ========== 
// تم دمج دالة updateSidebarVisibility في الأعلى مع منطق موحد وتجنب التكرار

// ========== فتح وإغلاق القائمة الجانبية ==========
document.getElementById("sidebarToggleBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.add("open");
  document.getElementById("sidebarToggleBtn").style.display = "none";
  document.getElementById("sidebarCloseBtn").style.display = "flex";
  // عرض اسم المستخدم أعلى القائمة
  const sidebarUserName = document.getElementById("sidebarUserName");
  sidebarUserName.textContent = currentUser ? "👤 " + currentUser : "غير مسجل";
  updateSidebarVisibility();
};
document.getElementById("sidebarCloseBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("sidebarCloseBtn").style.display = "none";
  document.getElementById("sidebarToggleBtn").style.display = "flex";
  updateSidebarVisibility();
};

// ========== ربط أزرار القائمة الجانبية بأزرار الموقع الأصلية ==========
document.getElementById("sidebarAdminBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("toggleAdminBtn").click();
};
document.getElementById("sidebarEmpStatsBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("toggleEmpStatsBtn").click();
};
document.getElementById("sidebarDeleteDataBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("btnDeleteData").click();
};
document.getElementById("sidebarFeaturesTabBtn").onclick = () => {
  document.getElementById("sidebarMenu").classList.remove("open");
  document.getElementById("btnFeaturesTab").click();
  document.getElementById("featuresTab").style.display = "flex";
  const featuresTabContent = document.getElementById("featuresTabContent");
  featuresTabContent.innerHTML = `
    <div class="feature-section">
      <h4>سجل النشاطات</h4>
      <div id="activityLogBox">جاري التحميل...</div>
    </div>
    <div class="feature-section">
      <h4>معلومات النظام</h4>
      <ul style="margin:0;padding:0 0 0 15px;">
        <li>عدد الموظفين الحالي: <b>${employees.length}</b></li>
        <li>اسم المستخدم الحالي: <b>${currentUser}</b></li>
        <li>الدور: <b>${currentUserRole}</b></li>
      </ul>
    </div>
  `;
  db.ref("activityLog").limitToLast(30).once("value").then(snapshot => {
    const log = snapshot.val() || {};
    let html = `<table class="activity-log-table">
      <tr>
        <th>الوقت</th>
        <th>المستخدم</th>
        <th>النشاط</th>
        <th>الوصف</th>
      </tr>`;
    Object.values(log).reverse().forEach(item => {
      html += `<tr>
        <td>${toEnglishNumbers(item.time || "")}</td>
        <td>${item.user || ""}</td>
        <td>${item.action || ""}</td>
        <td>${item.details || ""}</td>
      </tr>`;
    });
    html += `</table>`;
    document.getElementById("activityLogBox").innerHTML = html;
  });
  // زر إغلاق التبويبة
  const closeBtn = document.getElementById("closeFeaturesTab");
  if (closeBtn) {
    closeBtn.onclick = () => {
      document.getElementById("featuresTab").style.display = "none";
    };
  }
};

// نافذة تحكم صلاحيات سجل النشاطات للمدير
document.getElementById("sidebarUserControlBtn").onclick = function() {
  // إنشاء نافذة منبثقة احترافية
  let modal = document.getElementById("userLogControlModal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "userLogControlModal";
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100vw";
    modal.style.height = "100vh";
    modal.style.background = "rgba(0,0,0,0.35)";
    modal.style.zIndex = "8000";
    modal.style.display = "flex";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.innerHTML = `
      <div style="background:#fff;max-width:420px;width:95vw;border-radius:14px;box-shadow:0 8px 32px #0002;padding:28px 20px 20px 20px;position:relative;">
        <button id="closeUserLogControlModal" style="position:absolute;top:10px;left:10px;background:#dc3545;color:white;border:none;border-radius:50%;width:32px;height:32px;font-size:18px;cursor:pointer;">✖</button>
        <h3 style="text-align:center;margin-bottom:18px;color:#009688;">👥 إدارة صلاحيات سجل النشاطات</h3>
        <div id="userLogControlContent" style="min-height:70px;">جاري التحميل...</div>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById("closeUserLogControlModal").onclick = function() {
      modal.style.display = "none";
    };
  } else {
    modal.style.display = "flex";
  }

  // تحميل المستخدمين وصلاحياتهم
  db.ref("users").once("value").then(snapshot => {
    const users = snapshot.val() || {};
    let html = `<table style="width:100%;border-collapse:collapse;margin-bottom:10px;">
      <tr>
        <th style="background:#f6f6f6;">المستخدم</th>
        <th style="background:#f6f6f6;">الوصول لسجل النشاطات</th>
        <th style="background:#f6f6f6;">نوع الصلاحية</th>
      </tr>`;
    Object.entries(users).forEach(([username, data]) => {
      if (username === "admin") return; // لا تظهر للمدير نفسه
      html += `<tr>
        <td style="padding:7px 4px;">${username}</td>
        <td style="padding:7px 4px;">
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" ${data.canViewLog ? "checked" : ""} onchange="window.setUserLogAccess('${username}', this.checked)">
            <span style="font-size:13px;color:${data.canViewLog ? '#28a745':'#dc3545'};">${data.canViewLog ? 'مفعل':'معطل'}</span>
          </label>
        </td>
        <td style="padding:7px 4px;">
          <select onchange="window.setUserLogType('${username}', this.value)" style="font-size:13px;">
            <option value="all" ${!data.logViewType || data.logViewType==="all" ? "selected" : ""}>كل السجل</option>
            <option value="self" ${data.logViewType==="self" ? "selected" : ""}>سجل المستخدم فقط</option>
          </select>
        </td>
      </tr>`;
    });
    html += `</table>
      <div style="margin-top:10px;font-size:13px;color:#555;">
        عند تفعيل الصلاحية يظهر زر سجل النشاطات للمستخدم في القائمة الجانبية.<br>
        نوع الصلاحية:<br>
        <b>كل السجل:</b> يرى كل النشاطات لجميع المستخدمين.<br>
        <b>سجل المستخدم فقط:</b> يرى فقط نشاطاته هو.<br>
        عند التعطيل يختفي الزر مباشرة من عند المستخدم.
      </div>`;
    document.getElementById("userLogControlContent").innerHTML = html;
    window.setUserLogAccess = function(username, enabled) {
      db.ref("users/" + username + "/canViewLog").set(enabled).then(() => {
        logActivity("تغيير صلاحية سجل النشاطات", `تم ${enabled ? 'تفعيل' : 'تعطيل'} سجل النشاطات للمستخدم: ${username}`);
        updateSidebarVisibility();
      });
    };
    window.setUserLogType = function(username, type) {
      db.ref("users/" + username + "/logViewType").set(type).then(() => {
        logActivity("تغيير نوع صلاحية سجل النشاطات", `تم تغيير نوع الصلاحية للمستخدم: ${username} إلى: ${type === 'all' ? 'كل السجل' : 'سجل المستخدم فقط'}`);
        updateSidebarVisibility();
      });
    };
  });
}

</script>
</body>
</html>
